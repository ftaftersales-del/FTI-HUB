v<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTI-HUB - DMS</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      max-width: 1100px;
      margin: 0 auto 16px auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    button {
      padding: 6px 10px;
      cursor: pointer;
      margin-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 0.9em;
    }
    th {
      background: #f0f0f0;
    }
    #status {
      margin-bottom: 8px;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h2>DMS - Gestione Utenze</h2>
      <div>
        <button onclick="goBack()">Torna al Main</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="status">Verifica permessi...</div>

    <div id="content" style="display:none;">
      <button onclick="reloadUsers()">Ricarica elenco utenti</button>
      <div id="users-table-container" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentUserData = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      currentUser = user;

      try {
        const doc = await db.collection('Users').doc(user.uid).get();

        if (!doc.exists) {
          document.getElementById('status').innerText =
            "Profilo admin non trovato.";
          return;
        }

        const data = doc.data();
        currentUserData = data;

        if (data.isAdmin !== true) {
          document.getElementById('status').innerText =
            "Non hai i permessi per accedere al DMS.";
          setTimeout(() => {
            window.location.href = "FTHUBAS.html";
          }, 1500);
          return;
        }

        document.getElementById('status').innerText =
          "Sei loggato come admin.";
        document.getElementById('content').style.display = 'block';

        // Carica l'elenco utenti (potrà dare errori permessi se le rules non lo consentono)
        reloadUsers();

      } catch (e) {
        console.error("Errore nel controllo permessi admin:", e);
        document.getElementById('status').innerText =
          "Errore nel controllo permessi: " + e.message;
      }
    });

    async function reloadUsers() {
      const container = document.getElementById('users-table-container');
      container.innerHTML = "Caricamento utenti...";

      try {
        const snap = await db.collection('Users').get();

        if (snap.empty) {
          container.innerHTML = "<p>Nessun utente trovato.</p>";
          return;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Dealer</th>
                <th>Ruolo</th>
                <th>Stato</th>
                <th>Admin</th>
                <th>Distributore</th>
              </tr>
            </thead>
            <tbody>
        `;

        snap.forEach(doc => {
          const u = doc.data();
          html += `
            <tr>
              <td>${u.displayName || '-'}</td>
              <td>${u.Email || '-'}</td>
              <td>${u.dealerId || '-'}</td>
              <td>${u.role || '-'}</td>
              <td>${u.Status || '-'}</td>
              <td>${u.isAdmin ? 'Sì' : 'No'}</td>
              <td>${u.isDistributorUser ? 'Sì' : 'No'}</td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;

      } catch (e) {
        console.error("Errore nel caricamento utenti dal DMS:", e);

        if (e.code === "permission-denied") {
          container.innerHTML =
            "<p><strong>Errore permessi Firestore.</strong><br>" +
            "Le regole attuali non permettono la lettura di tutti gli utenti. " +
            "Quando avremo stabilito le regole per gli admin, qui comparirà l'elenco.</p>";
        } else {
          container.innerHTML =
            "Errore nel caricamento utenti: " + e.message;
        }
      }
    }

    function goBack() {
      window.location.href = "FTHUBAS.html";
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
</body>
</html>
