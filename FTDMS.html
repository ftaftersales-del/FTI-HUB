<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTI-HUB - DMS</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      max-width: 1100px;
      margin: 0 auto 16px auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    button {
      padding: 6px 10px;
      cursor: pointer;
      margin-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 0.9em;
    }
    th {
      background: #f0f0f0;
    }
    #status {
      margin-bottom: 8px;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h2>DMS - Gestione Utenze e Dealers</h2>
      <div>
        <button onclick="goBack()">Torna al Main</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="status">Verifica permessi...</div>

    <div id="content" style="display:none;">

      <!-- LISTA DEALERS -->
      <div class="card" style="margin-top:20px;">
        <h3>Elenco Dealers</h3>
        <div id="dealers-table-container">Caricamento dealers...</div>
      </div>

      <!-- DEALER SELEZIONATO -->
      <div class="card" style="margin-top:20px;">
        <h3>Dealer Selezionato</h3>
        <div id="selected-dealer">Nessun dealer selezionato.</div>
      </div>

      <!-- LISTA UTENTI -->
      <div class="card" style="margin-top:20px;">
        <h3>Utenti</h3>
        <p style="margin-top:0;">
          Seleziona un dealer dalla tabella sopra per filtrare gli utenti di quel dealer.
        </p>
        <button onclick="reloadUsers()">Ricarica elenco utenti</button>
        <div id="users-table-container" style="margin-top:12px;"></div>
      </div>

    </div>
  </div>

  <script>
    let currentUser = null;
    let currentUserData = null;
    window.selectedDealer = null;

    // =========================
    //   CONTROLLO LOGIN E ADMIN
    // =========================
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      currentUser = user;

      try {
        // Leggo il profilo dell'utente corrente da Users/{uid}
        const doc = await db.collection('Users').doc(user.uid).get();

        if (!doc.exists) {
          document.getElementById('status').innerText =
            "Profilo admin non trovato in Users.";
          return;
        }

        const data = doc.data();
        currentUserData = data;

        // Verifico se è admin
        if (data.isAdmin !== true) {
          document.getElementById('status').innerText =
            "Non hai i permessi per accedere al DMS.";
          setTimeout(() => {
            window.location.href = "FTHUBAS.html";
          }, 1500);
          return;
        }

        document.getElementById('status').innerText =
          "Sei loggato come admin.";
        document.getElementById('content').style.display = 'block';

        // Carico dealers e utenti
        loadDealers();
        reloadUsers();

      } catch (e) {
        console.error("Errore nel controllo permessi admin:", e);
        document.getElementById('status').innerText =
          "Errore nel controllo permessi: " + e.message;
      }
    });

    // =========================
    //   CARICAMENTO DEALERS
    // =========================
    async function loadDealers() {
      const container = document.getElementById("dealers-table-container");
      container.innerHTML = "Caricamento dealers...";

      try {
        const snap = await db.collection("dealers").get();

        if (snap.empty) {
          container.innerHTML = "<p>Nessun dealer trovato.</p>";
          return;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Codice</th>
                <th>Nome</th>
                <th>Città</th>
                <th>Provincia</th>
                <th>Regione</th>
                <th>Dealer</th>
                <th>Workshop</th>
                <th>RSA</th>
                <th>Attivo</th>
              </tr>
            </thead>
            <tbody>
        ";

        snap.forEach(doc => {
          const d = doc.data();

          html += `
            <tr onclick="selectDealer('${doc.id}')" style="cursor:pointer;">
              <td>${d.dealerID || doc.id}</td>
              <td>${d["Sub-Dealer Name"] || "-"}</td>
              <td>${d.City || "-"}</td>
              <td>${d.Province || "-"}</td>
              <td>${d.Region || "-"}</td>
              <td>${d.Dealer ? "✔️" : "❌"}</td>
              <td>${d.Workshop ? "✔️" : "❌"}</td>
              <td>${d.RSA ? "✔️" : "❌"}</td>
              <td>${d.active === false ? "❌" : "✔️"}</td>
            </tr>
          `;
        });

        html += "</tbody></table>";
        container.innerHTML = html;

      } catch (err) {
        console.error("Errore nel caricamento dealer:", err);
        container.innerHTML =
          "<p>Errore caricamento dealer: " + err.message + "</p>";
      }
    }

    // =========================
    //   SELEZIONE DEALER
    // =========================
    function selectDealer(dealerId) {
      window.selectedDealer = dealerId;

      document.getElementById("selected-dealer").innerHTML =
        `<strong>Dealer selezionato:</strong> ${dealerId}`;

      // quando seleziono un dealer ricarico utenti filtrati
      reloadUsers();
    }

    // =========================
    //   CARICAMENTO UTENTI
    // =========================
    async function reloadUsers() {
      const container = document.getElementById('users-table-container');
      container.innerHTML = "Caricamento utenti...";

      try {
        let query = db.collection('Users');

        // Se ho un dealer selezionato → filtro per quel dealer
        if (window.selectedDealer) {
          query = query.where('dealerId', '==', window.selectedDealer);
        } else {
          // Se non è selezionato nulla:
          // - se utente admin del distributore → può vedere tutti
          // - altrimenti filtriamo sul suo dealer
          if (!currentUserData.isDistributorUser && currentUserData.dealerId) {
            query = query.where('dealerId', '==', currentUserData.dealerId);
          }
        }

        const snap = await query.get();

        if (snap.empty) {
          container.innerHTML = "<p>Nessun utente trovato per questo filtro.</p>";
          return;
        }

let html = `
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Email</th>
        <th>Dealer</th>
        <th>Ruolo</th>
        <th>Stato</th>
        <th>Admin</th>
        <th>Distributore</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody>
`;


snap.forEach(doc => {
  const u = doc.data();
  html += `
    <tr>
      <td>${u.displayName || '-'}</td>
      <td>${u.Email || u.email || '-'}</td>
      <td>${u.dealerId || '-'}</td>
      <td>${u.role || '-'}</td>
      <td>${u.Status || '-'}</td>
      <td>${u.isAdmin ? 'Sì' : 'No'}</td>
      <td>${u.isDistributorUser ? 'Sì' : 'No'}</td>
      <td>
        <button onclick="updateUserStatus('${doc.id}', 'active')">Attiva</button>
        <button onclick="updateUserStatus('${doc.id}', 'suspended')">Sospendi</button>
        <button onclick="updateUserStatus('${doc.id}', 'blocked')">Blocca</button>
      </td>
    </tr>
  `;
});



        html += `</tbody></table>`;
        container.innerHTML = html;

      } catch (e) {
        console.error("Errore nel caricamento utenti dal DMS:", e);

        if (e.code === "permission-denied") {
          container.innerHTML =
            "<p><strong>Errore permessi Firestore.</strong><br>" +
            "Le regole attuali non permettono la lettura dell'elenco utenti. " +
            "Quando abiliterai gli admin a leggere più utenti, qui comparirà la tabella.</p>";
        } else {
          container.innerHTML =
            "Errore nel caricamento utenti: " + e.message;
        }
      }
    }
// =========================
//   AGGIORNA STATO UTENTE
// =========================
async function updateUserStatus(userId, newStatus) {
  const conferma = confirm(
    "Vuoi impostare lo stato dell'utente su: " + newStatus + "?"
  );
  if (!conferma) return;

  try {
    await db.collection('Users').doc(userId).update({
      Status: newStatus
    });
    alert("Stato utente aggiornato a: " + newStatus);
    reloadUsers();
  } catch (e) {
    console.error("Errore aggiornamento stato utente:", e);
    alert("Errore aggiornando lo stato utente: " + e.message);
  }
}

    // =========================
    //   NAVIGAZIONE
    // =========================
    function goBack() {
      window.location.href = "FTHUBAS.html";
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
</body>
</html>
