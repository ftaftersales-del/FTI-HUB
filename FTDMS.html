<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>FTI-HUB - DMS</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      max-width: 1200px;
      margin: 0 auto 16px auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    button {
      padding: 6px 10px;
      cursor: pointer;
      margin-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 0.9em;
    }
    th {
      background: #f0f0f0;
    }
    #status {
      margin-bottom: 8px;
      font-size: 0.95em;
    }
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .field {
      flex: 1 1 180px;
    }
    .field label {
      font-size: 0.8em;
      display: block;
      margin-bottom: 2px;
    }
    .field input,
    .field textarea {
      width: 100%;
      padding: 4px 6px;
      font-size: 0.9em;
      box-sizing: border-box;
    }
    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 8px;
      font-size: 0.9em;
    }
    #dealer-form-panel {
      display: none;
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 12px;
    }
    .dealer-row.selected {
      background: #e3f2fd;
    }
    .toolbar {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h2>DMS - Gestione Dealers e Utenze</h2>
      <div>
        <button onclick="goBack()">Torna al Main</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="status">Verifica permessi...</div>

    <div id="content" style="display:none;">

      <!-- SEZIONE DEALERS -->
      <div class="card" style="margin-top:20px;">
        <div class="toolbar">
          <strong>Dealers</strong>
          <button onclick="openDealerFormNew()">Nuovo dealer</button>
          <button onclick="openDealerFormEdit()">Modifica dealer selezionato</button>
        </div>

        <div id="dealers-table-container">Caricamento dealers...</div>

        <!-- PANNELLO FORM DEALER (NASCOSTO DI DEFAULT) -->
        <div id="dealer-form-panel">
          <h3 id="dealer-form-title">Nuovo dealer</h3>

          <div class="field-row">
            <div class="field">
              <label for="dealerIDInput">Codice Dealer (dealerID) *</label>
              <input id="dealerIDInput" type="text" placeholder="Es. FT001">
            </div>
            <div class="field">
              <label for="subDealerNameInput">Sub-Dealer Name</label>
              <input id="subDealerNameInput" type="text" placeholder="Es. F-Trucks Italia SpA">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="accountTypeInput">Account_Type</label>
              <input id="accountTypeInput" type="text" placeholder="Es. Admin">
            </div>
            <div class="field">
              <label for="tipoElementoInput">Tipo di elemento</label>
              <input id="tipoElementoInput" type="text" placeholder="Es. Elemento">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="address1Input">Address1</label>
              <input id="address1Input" type="text" placeholder="Via / Viale...">
            </div>
            <div class="field">
              <label for="cityInput">City</label>
              <input id="cityInput" type="text" placeholder="Città">
            </div>
            <div class="field">
              <label for="provinceInput">Province</label>
              <input id="provinceInput" type="text" placeholder="Es. MI">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="regionInput">Region</label>
              <input id="regionInput" type="text" placeholder="Es. Lombardia">
            </div>
            <div class="field">
              <label for="zipCodeInput">Zip Code</label>
              <input id="zipCodeInput" type="text" placeholder="CAP">
            </div>
            <div class="field">
              <label for="countryInput">Country</label>
              <input id="countryInput" type="text" placeholder="Es. Italy">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="coverageRadiusInput">Coverage Radius (km)</label>
              <input id="coverageRadiusInput" type="text" placeholder="km o vuoto">
            </div>
            <div class="field">
              <label for="laborStdInput">LaborRateStd</label>
              <input id="laborStdInput" type="text" placeholder="Es. 47">
            </div>
            <div class="field">
              <label for="laborWarrantyInput">LaborRateWarranty</label>
              <input id="laborWarrantyInput" type="text" placeholder="Es. 59">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="ibanInput">IBAN</label>
              <input id="ibanInput" type="text" placeholder="IBAN">
            </div>
            <div class="field">
              <label for="vatNumberInput">Vat Number</label>
              <input id="vatNumberInput" type="text" placeholder="P.IVA">
            </div>
            <div class="field">
              <label for="languageInput">Language</label>
              <input id="languageInput" type="text" placeholder="Es. Italian">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="percorsoInput">Percorso</label>
              <input id="percorsoInput" type="text" placeholder="Percorso logico / lista">
            </div>
            <div class="field">
              <label for="dealerNotesInput">Notes</label>
              <textarea id="dealerNotesInput" rows="2" placeholder="Note"></textarea>
            </div>
          </div>

          <div class="checkbox-row">
            <label><input id="dealerCheckbox" type="checkbox"> Dealer</label>
            <label><input id="workshopCheckbox" type="checkbox"> Workshop</label>
            <label><input id="rsaCheckbox" type="checkbox"> RSA</label>
            <label><input id="isDistributorCheckbox" type="checkbox"> Distributore</label>
            <label><input id="activeCheckbox" type="checkbox" checked> Attivo</label>
          </div>

          <hr>

          <h4>Dati Dealer</h4>
          <div class="field-row">
            <div class="field">
              <label for="dealerContactNameInput">Dealer_ContactName</label>
              <input id="dealerContactNameInput" type="text">
            </div>
            <div class="field">
              <label for="dealerEmailInput">Dealer_EmailMain</label>
              <input id="dealerEmailInput" type="email">
            </div>
            <div class="field">
              <label for="dealerPhoneInput">Dealer_PhoneMain</label>
              <input id="dealerPhoneInput" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="dealerFaxInput">Dealer Fax Number</label>
              <input id="dealerFaxInput" type="text">
            </div>
            <div class="field">
              <label for="dealerOpenTimeInput">Dealer_OpenTime</label>
              <input id="dealerOpenTimeInput" type="text" placeholder="Es. 08:00">
            </div>
            <div class="field">
              <label for="dealerCloseTimeInput">Dealer_CloseTime</label>
              <input id="dealerCloseTimeInput" type="text" placeholder="Es. 18:00">
            </div>
          </div>

          <hr>

          <h4>Dati Workshop</h4>
          <div class="field-row">
            <div class="field">
              <label for="workshopContactNameInput">Workshop_ContactName</label>
              <input id="workshopContactNameInput" type="text">
            </div>
            <div class="field">
              <label for="workshopEmailInput">Workshop_EmailMain</label>
              <input id="workshopEmailInput" type="email">
            </div>
            <div class="field">
              <label for="workshopPhoneInput">Workshop_PhoneMain</label>
              <input id="workshopPhoneInput" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="workshopOpenTimeInput">Workshop_OpenTime</label>
              <input id="workshopOpenTimeInput" type="text">
            </div>
            <div class="field">
              <label for="workshopCloseTimeInput">Workshop_CloseTime</label>
              <input id="workshopCloseTimeInput" type="text">
            </div>
          </div>

          <hr>

          <h4>Dati RSA</h4>
          <div class="field-row">
            <div class="field">
              <label for="rsaContactNameInput">RSA_ContactName</label>
              <input id="rsaContactNameInput" type="text">
            </div>
            <div class="field">
              <label for="rsaEmailInput">RSA_EmailMain</label>
              <input id="rsaEmailInput" type="email">
            </div>
            <div class="field">
              <label for="rsaPhoneInput">RSA_PhoneMain</label>
              <input id="rsaPhoneInput" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="rsaOpenTimeInput">RSA_OpenTime</label>
              <input id="rsaOpenTimeInput" type="text">
            </div>
            <div class="field">
              <label for="rsaCloseTimeInput">RSA_CloseTime</label>
              <input id="rsaCloseTimeInput" type="text">
            </div>
          </div>

          <div style="margin-top:12px;">
            <button onclick="saveDealer()">Salva dealer</button>
            <button onclick="closeDealerForm()">Chiudi</button>
          </div>
        </div>
      </div>

      <!-- DEALER SELEZIONATO + UTENTI -->
      <div class="card" style="margin-top:20px;">
        <h3>Dealer selezionato</h3>
        <div id="selected-dealer">Nessun dealer selezionato.</div>
      </div>

      <div class="card" style="margin-top:20px;">
        <h3>Utenti del dealer</h3>
        <div id="users-table-container">
          Seleziona un dealer dalla tabella per vedere gli utenti.
        </div>
      </div>

    </div>
  </div>

  <script>
    let currentUser = null;
    let currentUserData = null;
    let selectedDealer = null;        // id del dealer selezionato (FT001, ecc.)
    let dealerFormMode = "new";       // "new" o "edit"
    let dealerFormEditingId = null;   // id originale quando in edit

    // =========================
    //   CONTROLLO LOGIN E ADMIN
    // =========================
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      currentUser = user;

      try {
        const doc = await db.collection("Users").doc(user.uid).get();
        if (!doc.exists) {
          document.getElementById("status").innerText =
            "Profilo admin non trovato in Users.";
          return;
        }

        const data = doc.data();
        currentUserData = data;

        if (data.isAdmin !== true) {
          document.getElementById("status").innerText =
            "Non hai i permessi per accedere al DMS.";
          setTimeout(() => {
            window.location.href = "FTHUBAS.html";
          }, 1500);
          return;
        }

        document.getElementById("status").innerText =
          "Sei loggato come admin.";
        document.getElementById("content").style.display = "block";

        loadDealers();
        // utenti verranno caricati solo dopo selezione dealer

      } catch (e) {
        console.error("Errore nel controllo permessi admin:", e);
        document.getElementById("status").innerText =
          "Errore nel controllo permessi: " + e.message;
      }
    });

    // =========================
    //   FORM DEALER: APERTURA
    // =========================
    function resetDealerForm() {
      dealerFormEditingId = null;
      dealerFormMode = "new";

      document.getElementById("dealerIDInput").value = "";
      document.getElementById("dealerIDInput").disabled = false;

      document.getElementById("subDealerNameInput").value = "";
      document.getElementById("accountTypeInput").value = "";
      document.getElementById("tipoElementoInput").value = "";

      document.getElementById("address1Input").value = "";
      document.getElementById("cityInput").value = "";
      document.getElementById("provinceInput").value = "";
      document.getElementById("regionInput").value = "";
      document.getElementById("zipCodeInput").value = "";
      document.getElementById("countryInput").value = "";

      document.getElementById("coverageRadiusInput").value = "";
      document.getElementById("laborStdInput").value = "";
      document.getElementById("laborWarrantyInput").value = "";
      document.getElementById("ibanInput").value = "";
      document.getElementById("vatNumberInput").value = "";
      document.getElementById("languageInput").value = "";
      document.getElementById("percorsoInput").value = "";
      document.getElementById("dealerNotesInput").value = "";

      document.getElementById("dealerCheckbox").checked = false;
      document.getElementById("workshopCheckbox").checked = false;
      document.getElementById("rsaCheckbox").checked = false;
      document.getElementById("isDistributorCheckbox").checked = false;
      document.getElementById("activeCheckbox").checked = true;

      document.getElementById("dealerContactNameInput").value = "";
      document.getElementById("dealerEmailInput").value = "";
      document.getElementById("dealerPhoneInput").value = "";
      document.getElementById("dealerFaxInput").value = "";
      document.getElementById("dealerOpenTimeInput").value = "";
      document.getElementById("dealerCloseTimeInput").value = "";

      document.getElementById("workshopContactNameInput").value = "";
      document.getElementById("workshopEmailInput").value = "";
      document.getElementById("workshopPhoneInput").value = "";
      document.getElementById("workshopOpenTimeInput").value = "";
      document.getElementById("workshopCloseTimeInput").value = "";

      document.getElementById("rsaContactNameInput").value = "";
      document.getElementById("rsaEmailInput").value = "";
      document.getElementById("rsaPhoneInput").value = "";
      document.getElementById("rsaOpenTimeInput").value = "";
      document.getElementById("rsaCloseTimeInput").value = "";
    }

    function openDealerFormNew() {
      resetDealerForm();
      dealerFormMode = "new";
      document.getElementById("dealer-form-title").innerText = "Nuovo dealer";
      document.getElementById("dealer-form-panel").style.display = "block";
    }

    async function openDealerFormEdit() {
      if (!selectedDealer) {
        alert("Seleziona prima un dealer dalla tabella.");
        return;
      }

      resetDealerForm();
      dealerFormMode = "edit";
      dealerFormEditingId = selectedDealer;
      document.getElementById("dealer-form-title").innerText =
        "Modifica dealer " + selectedDealer;

      // carico dati da Firestore
      try {
        const doc = await db.collection("dealers").doc(selectedDealer).get();
        if (!doc.exists) {
          alert("Dealer non trovato in Firestore.");
          return;
        }
        const d = doc.data();

        document.getElementById("dealerIDInput").value = d.dealerID || doc.id;
        document.getElementById("dealerIDInput").disabled = true; // non permettiamo di cambiare l'ID in modifica

        document.getElementById("subDealerNameInput").value = d["Sub-Dealer Name"] || "";
        document.getElementById("accountTypeInput").value = d.Account_Type || "";
        document.getElementById("tipoElementoInput").value = d["Tipo di elemento"] || "";

        document.getElementById("address1Input").value = d.Address1 || "";
        document.getElementById("cityInput").value = d.City || "";
        document.getElementById("provinceInput").value = d.Province || "";
        document.getElementById("regionInput").value = d.Region || "";
        document.getElementById("zipCodeInput").value = d["Zip Code"] || "";
        document.getElementById("countryInput").value = d.Country || "";

        document.getElementById("coverageRadiusInput").value = d["Coverage Radius (km)"] || "";
        document.getElementById("laborStdInput").value = d.LaborRateStd || "";
        document.getElementById("laborWarrantyInput").value = d.LaborRateWarranty || "";
        document.getElementById("ibanInput").value = d.IBAN || "";
        document.getElementById("vatNumberInput").value = d["Vat Number"] || "";
        document.getElementById("languageInput").value = d.Language || "";
        document.getElementById("percorsoInput").value = d.Percorso || "";
        document.getElementById("dealerNotesInput").value = d.Notes || "";

        document.getElementById("dealerCheckbox").checked = !!d.Dealer;
        document.getElementById("workshopCheckbox").checked = !!d.Workshop;
        document.getElementById("rsaCheckbox").checked = !!d.RSA;
        document.getElementById("isDistributorCheckbox").checked = !!d.isDistributor;
        document.getElementById("activeCheckbox").checked = d.active !== false;

        document.getElementById("dealerContactNameInput").value = d.Dealer_ContactName || "";
        document.getElementById("dealerEmailInput").value = d.Dealer_EmailMain || "";
        document.getElementById("dealerPhoneInput").value = d.Dealer_PhoneMain || "";
        document.getElementById("dealerFaxInput").value = d["Dealer Fax Number"] || "";
        document.getElementById("dealerOpenTimeInput").value = d.Dealer_OpenTime || "";
        document.getElementById("dealerCloseTimeInput").value = d.Dealer_CloseTime || "";

        document.getElementById("workshopContactNameInput").value = d.Workshop_ContactName || "";
        document.getElementById("workshopEmailInput").value = d.Workshop_EmailMain || "";
        document.getElementById("workshopPhoneInput").value = d.Workshop_PhoneMain || "";
        document.getElementById("workshopOpenTimeInput").value = d.Workshop_OpenTime || "";
        document.getElementById("workshopCloseTimeInput").value = d.Workshop_CloseTime || "";

        document.getElementById("rsaContactNameInput").value = d.RSA_ContactName || "";
        document.getElementById("rsaEmailInput").value = d.RSA_EmailMain || "";
        document.getElementById("rsaPhoneInput").value = d.RSA_PhoneMain || "";
        document.getElementById("rsaOpenTimeInput").value = d.RSA_OpenTime || "";
        document.getElementById("rsaCloseTimeInput").value = d.RSA_CloseTime || "";

        document.getElementById("dealer-form-panel").style.display = "block";
      } catch (e) {
        console.error("Errore caricando dealer:", e);
        alert("Errore caricando il dealer per la modifica: " + e.message);
      }
    }

    function closeDealerForm() {
      document.getElementById("dealer-form-panel").style.display = "none";
    }

    // =========================
    //   SALVATAGGIO DEALER
    // =========================
    async function saveDealer() {
      const dealerID = document.getElementById("dealerIDInput").value.trim();
      if (!dealerID) {
        alert("Il campo 'Codice Dealer (dealerID)' è obbligatorio.");
        return;
      }

      const conferma = confirm(
        "Salvare il dealer con codice: " + dealerID + "?"
      );
      if (!conferma) return;

      const subDealerName = document.getElementById("subDealerNameInput").value.trim();
      const accountType = document.getElementById("accountTypeInput").value.trim();
      const tipoElemento = document.getElementById("tipoElementoInput").value.trim();

      const address1 = document.getElementById("address1Input").value.trim();
      const city = document.getElementById("cityInput").value.trim();
      const province = document.getElementById("provinceInput").value.trim();
      const region = document.getElementById("regionInput").value.trim();
      const zipCode = document.getElementById("zipCodeInput").value.trim();
      const country = document.getElementById("countryInput").value.trim();

      const coverageRadius = document.getElementById("coverageRadiusInput").value.trim();
      const laborStd = document.getElementById("laborStdInput").value.trim();
      const laborWarranty = document.getElementById("laborWarrantyInput").value.trim();
      const iban = document.getElementById("ibanInput").value.trim();
      const vatNumber = document.getElementById("vatNumberInput").value.trim();
      const language = document.getElementById("languageInput").value.trim();
      const percorso = document.getElementById("percorsoInput").value.trim();
      const notes = document.getElementById("dealerNotesInput").value.trim();

      const dealerFlag = document.getElementById("dealerCheckbox").checked;
      const workshopFlag = document.getElementById("workshopCheckbox").checked;
      const rsaFlag = document.getElementById("rsaCheckbox").checked;
      const isDistributorFlag = document.getElementById("isDistributorCheckbox").checked;
      const activeFlag = document.getElementById("activeCheckbox").checked;

      const dealerContactName = document.getElementById("dealerContactNameInput").value.trim();
      const dealerEmail = document.getElementById("dealerEmailInput").value.trim();
      const dealerPhone = document.getElementById("dealerPhoneInput").value.trim();
      const dealerFax = document.getElementById("dealerFaxInput").value.trim();
      const dealerOpenTime = document.getElementById("dealerOpenTimeInput").value.trim();
      const dealerCloseTime = document.getElementById("dealerCloseTimeInput").value.trim();

      const workshopContactName = document.getElementById("workshopContactNameInput").value.trim();
      const workshopEmail = document.getElementById("workshopEmailInput").value.trim();
      const workshopPhone = document.getElementById("workshopPhoneInput").value.trim();
      const workshopOpenTime = document.getElementById("workshopOpenTimeInput").value.trim();
      const workshopCloseTime = document.getElementById("workshopCloseTimeInput").value.trim();

      const rsaContactName = document.getElementById("rsaContactNameInput").value.trim();
      const rsaEmail = document.getElementById("rsaEmailInput").value.trim();
      const rsaPhone = document.getElementById("rsaPhoneInput").value.trim();
      const rsaOpenTime = document.getElementById("rsaOpenTimeInput").value.trim();
      const rsaCloseTime = document.getElementById("rsaCloseTimeInput").value.trim();

      const dealerDoc = {
        dealerID: dealerID,
        "Sub-Dealer Name": subDealerName || "",
        Account_Type: accountType || "",
        "Tipo di elemento": tipoElemento || "",
        Address1: address1 || "",
        City: city || "",
        Province: province || "",
        Region: region || "",
        "Zip Code": zipCode || "",
        Country: country || "",
        "Coverage Radius (km)": coverageRadius || "",
        LaborRateStd: laborStd || "",
        LaborRateWarranty: laborWarranty || "",
        IBAN: iban || "",
        "Vat Number": vatNumber || "",
        Language: language || "",
        Percorso: percorso || "",
        Notes: notes || "",
        Dealer: dealerFlag,
        Workshop: workshopFlag,
        RSA: rsaFlag,
        isDistributor: isDistributorFlag,
        active: activeFlag,
        Dealer_ContactName: dealerContactName || "",
        Dealer_EmailMain: dealerEmail || "",
        Dealer_PhoneMain: dealerPhone || "",
        "Dealer Fax Number": dealerFax || "",
        Dealer_OpenTime: dealerOpenTime || "",
        Dealer_CloseTime: dealerCloseTime || "",
        Workshop_ContactName: workshopContactName || "",
        Workshop_EmailMain: workshopEmail || "",
        Workshop_PhoneMain: workshopPhone || "",
        Workshop_OpenTime: workshopOpenTime || "",
        Workshop_CloseTime: workshopCloseTime || "",
        RSA_ContactName: rsaContactName || "",
        RSA_EmailMain: rsaEmail || "",
        RSA_PhoneMain: rsaPhone || "",
        RSA_OpenTime: rsaOpenTime || "",
        RSA_CloseTime: rsaCloseTime || ""
      };

      try {
        const docId = dealerFormMode === "edit" && dealerFormEditingId
          ? dealerFormEditingId
          : dealerID;

        await db.collection("dealers").doc(docId).set(dealerDoc);

        alert("Dealer salvato con successo.");
        closeDealerForm();
        loadDealers();

      } catch (e) {
        console.error("Errore creazione/modifica dealer:", e);
        alert("Errore salvando il dealer: " + e.message);
      }
    }

    // =========================
    //   CARICAMENTO DEALERS
    // =========================
    async function loadDealers() {
      const container = document.getElementById("dealers-table-container");
      container.innerHTML = "Caricamento dealers...";

      try {
        const snap = await db.collection("dealers").get();

        if (snap.empty) {
          container.innerHTML = "<p>Nessun dealer trovato.</p>";
          return;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Codice</th>
                <th>Nome</th>
                <th>Città</th>
                <th>Provincia</th>
                <th>Regione</th>
                <th>Dealer</th>
                <th>Workshop</th>
                <th>RSA</th>
                <th>Attivo</th>
              </tr>
            </thead>
            <tbody>
        `;

        snap.forEach(doc => {
          const d = doc.data();
          const rowId = doc.id;
          const isSelected = selectedDealer === rowId;
          html += `
            <tr class="dealer-row ${isSelected ? "selected" : ""}"
                onclick="selectDealer('${rowId}')"
                style="cursor:pointer;">
              <td>${d.dealerID || rowId}</td>
              <td>${d["Sub-Dealer Name"] || "-"}</td>
              <td>${d.City || "-"}</td>
              <td>${d.Province || "-"}</td>
              <td>${d.Region || "-"}</td>
              <td>${d.Dealer ? "✔️" : "❌"}</td>
              <td>${d.Workshop ? "✔️" : "❌"}</td>
              <td>${d.RSA ? "✔️" : "❌"}</td>
              <td>${d.active === false ? "❌" : "✔️"}</td>
            </tr>
          `;
        });

        html += "</tbody></table>";
        container.innerHTML = html;

      } catch (err) {
        console.error("Errore nel caricamento dealer:", err);
        container.innerHTML =
          "<p>Errore caricamento dealer: " + err.message + "</p>";
      }
    }

    // =========================
    //   SELEZIONE DEALER
    // =========================
    function selectDealer(dealerId) {
      selectedDealer = dealerId;
      document.getElementById("selected-dealer").innerHTML =
        `<strong>Dealer selezionato:</strong> ${dealerId}`;
      loadDealers();   // per evidenziare la riga selezionata
      reloadUsers();   // per caricare utenti del dealer
    }

    // =========================
    //   CARICAMENTO UTENTI
    // =========================
    async function reloadUsers() {
      const container = document.getElementById("users-table-container");

      if (!selectedDealer) {
        container.innerHTML =
          "Seleziona un dealer dalla tabella per vedere gli utenti.";
        return;
      }

      container.innerHTML = "Caricamento utenti...";

      try {
        let query = db.collection("Users").where("dealerId", "==", selectedDealer);
        const snap = await query.get();

        if (snap.empty) {
          container.innerHTML = "<p>Nessun utente trovato per questo dealer.</p>";
          return;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Dealer</th>
                <th>Ruolo</th>
                <th>Stato</th>
                <th>Admin</th>
                <th>Distributore</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
        `;

        snap.forEach(doc => {
          const u = doc.data();
          html += `
            <tr>
              <td>${u.displayName || "-"}</td>
              <td>${u.Email || u.email || "-"}</td>
              <td>${u.dealerId || "-"}</td>
              <td>${u.role || "-"}</td>
              <td>${u.Status || "-"}</td>
              <td>${u.isAdmin ? "Sì" : "No"}</td>
              <td>${u.isDistributorUser ? "Sì" : "No"}</td>
              <td>
                <button onclick="updateUserStatus('${doc.id}', 'active')">Attiva</button>
                <button onclick="updateUserStatus('${doc.id}', 'suspended')">Sospendi</button>
                <button onclick="updateUserStatus('${doc.id}', 'blocked')">Blocca</button>
              </td>
            </tr>
          `;
        });

        html += "</tbody></table>";
        container.innerHTML = html;

      } catch (e) {
        console.error("Errore nel caricamento utenti dal DMS:", e);
        container.innerHTML =
          "Errore nel caricamento utenti: " + e.message;
      }
    }

    // =========================
    //   AGGIORNA STATO UTENTE
    // =========================
    async function updateUserStatus(userId, newStatus) {
      const conferma = confirm(
        "Vuoi impostare lo stato dell'utente su: " + newStatus + "?"
      );
      if (!conferma) return;

      try {
        await db.collection("Users").doc(userId).update({
          Status: newStatus
        });
        alert("Stato utente aggiornato a: " + newStatus);
        reloadUsers();
      } catch (e) {
        console.error("Errore aggiornamento stato utente:", e);
        alert("Errore aggiornando lo stato utente: " + e.message);
      }
    }

    // =========================
    //   NAVIGAZIONE
    // =========================
    function goBack() {
      window.location.href = "FTHUBAS.html";
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
</body>
</html>
