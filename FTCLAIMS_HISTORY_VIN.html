<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>FTCLAIMS - Storico Manutenzioni VIN</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 18px;
    }
    h1 { font-size: 18px; margin: 0 0 6px; }
    .subtitle { font-size: 13px; color: #666; margin-bottom: 12px; }

    .card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 14px;
      max-width: 1100px;
      margin: 0 auto 12px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .banner { margin: 10px 0 12px; padding: 10px 12px; border-radius: 6px; font-size: 13px; display: none; }
    .banner.success { background: #e9fff0; border: 1px solid #bfeccc; color: #0f6a2a; display: block; }
    .banner.error { background: #ffe9ea; border: 1px solid #f1b7bb; color: #8a1f28; display: block; }
    .banner.info { background: #eef5ff; border: 1px solid #c9dcff; color: #184a99; display: block; }

    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: end; }
    label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #333; }
    input {
      width: 320px;
      box-sizing: border-box;
      padding: 8px 10px;
      border: 1px solid #d6d6d6;
      border-radius: 6px;
      font-size: 14px;
    }
    .btn {
      border: none;
      border-radius: 6px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn.primary { background: #007bff; color: #fff; }
    .btn.secondary { background: #6c757d; color: #fff; }
    .btn.light { background: #e9ecef; color: #111; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .small { font-size: 12px; color: #555; }
    .mutedBox { background: #f8f8f8; border: 1px dashed #ddd; padding: 10px; border-radius: 8px; font-size: 13px; color: #444; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 8px; text-align: left; vertical-align: top; }
    th { background: #fafafa; font-weight: bold; position: sticky; top: 0; z-index: 1; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #f1f3f5;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Storico Manutenzioni VIN</h1>
    <div class="subtitle">Consulta le manutenzioni reclamate (Service Contract) salvate in storico.</div>

    <div id="banner" class="banner"></div>

    <div class="row">
      <div>
        <label>VIN</label>
        <input id="vinInput" type="text" placeholder="Es: XXXXXXXXXXXXXXXXX" />
        <div class="small" style="margin-top:6px;">Inserisci il telaio e premi “Cerca”.</div>
      </div>

      <button id="btnSearch" class="btn primary">Cerca</button>
      <button id="btnClear" class="btn light">Pulisci</button>
      <button id="btnHome" class="btn secondary">Home</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between; align-items:center;">
      <div>
        <div class="small"><strong>Risultati</strong></div>
        <div id="summary" class="small">Nessuna ricerca eseguita.</div>
      </div>
    </div>

    <div id="results" class="mutedBox" style="margin-top:10px;">
      Inserisci un VIN per visualizzare lo storico.
    </div>
  </div>

  <script>
    (function () {
      // Firebase
      const auth = window.auth || firebase.auth();
      const db = window.db || firebase.firestore();
      window.auth = auth;
      window.db = db;

      const bannerEl = document.getElementById("banner");
      const vinInput = document.getElementById("vinInput");
      const btnSearch = document.getElementById("btnSearch");
      const btnClear = document.getElementById("btnClear");
      const btnHome = document.getElementById("btnHome");
      const resultsEl = document.getElementById("results");
      const summaryEl = document.getElementById("summary");

      function showBanner(type, msg) {
        bannerEl.className = "banner " + (type || "");
        bannerEl.textContent = msg || "";
        bannerEl.style.display = "block";
      }
      function clearBanner() {
        bannerEl.style.display = "none";
        bannerEl.textContent = "";
        bannerEl.className = "banner";
      }

      function normalizeVin(v) {
        return (v || "").toString().trim().toUpperCase();
      }

      function dateToSortableNumber(d) {
        // ritorna ms epoch, 0 se non valido
        if (!d) return 0;
        if (d instanceof Date && !isNaN(d.getTime())) return d.getTime();
        return 0;
      }

      function parseAnyDate(v) {
        // supporta: Firestore Timestamp, Date, number, string ISO
        try {
          if (!v) return null;
          if (v && typeof v.toDate === "function") {
            const d = v.toDate();
            return isNaN(d.getTime()) ? null : d;
          }
          if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
          if (typeof v === "number") {
            const d = new Date(v);
            return isNaN(d.getTime()) ? null : d;
          }
          if (typeof v === "string") {
            const d = new Date(v);
            return isNaN(d.getTime()) ? null : d;
          }
          const d = new Date(v);
          return isNaN(d.getTime()) ? null : d;
        } catch (e) {
          return null;
        }
      }

      function fmtDateIT(d) {
        if (!d) return "";
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      function safe(v) {
        return (v == null) ? "" : String(v);
      }

      function renderTable(vin, rows) {
        if (!rows.length) {
          resultsEl.className = "mutedBox";
          resultsEl.textContent = "Nessun record trovato per questo VIN.";
          summaryEl.textContent = `VIN: ${vin} — 0 record`;
          return;
        }

        // ordina client-side per orderdate DESC
        rows.sort((a, b) => dateToSortableNumber(b._orderDateObj) - dateToSortableNumber(a._orderDateObj));

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width:170px;">Order Date</th>
              <th style="width:90px;">KM</th>
              <th style="width:110px;">Ore motore</th>
              <th>Pacchetto</th>
              <th style="width:110px;">Family</th>
              <th style="width:90px;">VOITH</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector("tbody");
        rows.forEach(r => {
          const tr = document.createElement("tr");

          const d = r._orderDateObj ? fmtDateIT(r._orderDateObj) : "";
          const km = (r.km == null) ? "" : r.km;
          const eh = (r.engineHours == null) ? "" : r.engineHours;
          const label = safe(r.label_it);
          const family = safe(r.family);
          const voith = (r.voith === true) ? `<span class="pill">SI</span>` : `<span class="pill">NO</span>`;

          tr.innerHTML = `
            <td>${d}</td>
            <td>${safe(km)}</td>
            <td>${safe(eh)}</td>
            <td>${label}</td>
            <td>${family}</td>
            <td>${voith}</td>
          `;
          tbody.appendChild(tr);
        });

        resultsEl.className = "";
        resultsEl.innerHTML = "";
        resultsEl.appendChild(table);

        summaryEl.textContent = `VIN: ${vin} — ${rows.length} record`;
      }

      async function searchVin() {
        clearBanner();
        const vin = normalizeVin(vinInput.value);

        if (!vin) {
          showBanner("error", "Inserisci un VIN.");
          return;
        }
        if (vin.length < 8) {
          showBanner("error", "VIN troppo corto. Controlla il telaio.");
          return;
        }

        btnSearch.disabled = true;
        resultsEl.className = "mutedBox";
        resultsEl.textContent = "Caricamento…";
        summaryEl.textContent = `VIN: ${vin} — caricamento…`;

        try {
          // Leggiamo i record dalla subcollection:
          // MaintenanceHistory/{vin}/Records
          const ref = db.collection("MaintenanceHistory").doc(vin).collection("Records");
          const snap = await ref.limit(500).get(); // limite alto ma sensato; di solito saranno poche righe

          const rows = [];
          snap.forEach(doc => {
            const d = doc.data() || {};
            // orderdate richiesto: può essere stringa o timestamp
            const od = parseAnyDate(d.orderdate);
            rows.push({
              id: doc.id,
              vin: d.vin || vin,
              orderdate: d.orderdate || null,
              km: (d.km != null) ? d.km : null,
              engineHours: (d.engineHours != null) ? d.engineHours : null,
              label_it: d.label_it || "",
              family: d.family || "",
              voith: (d.voith === true),
              _orderDateObj: od
            });
          });

          renderTable(vin, rows);

          if (!rows.length) showBanner("info", "Nessun record trovato per questo VIN.");
          else showBanner("success", "Storico caricato.");
        } catch (e) {
          console.error(e);
          showBanner("error", "Errore lettura storico: " + e.message);
          resultsEl.className = "mutedBox";
          resultsEl.textContent = "Errore nel caricamento. Controlla le rules e riprova.";
          summaryEl.textContent = "Errore caricamento.";
        } finally {
          btnSearch.disabled = false;
        }
      }

      function clearUI() {
        clearBanner();
        vinInput.value = "";
        summaryEl.textContent = "Nessuna ricerca eseguita.";
        resultsEl.className = "mutedBox";
        resultsEl.textContent = "Inserisci un VIN per visualizzare lo storico.";
      }

      // Buttons
      btnHome.addEventListener("click", () => window.location.href = "FTHUBAS.html");
      btnSearch.addEventListener("click", searchVin);
      btnClear.addEventListener("click", clearUI);

      // Enter to search
      vinInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchVin();
      });

      // Auth gate
      auth.onAuthStateChanged((user) => {
        if (!user) {
          showBanner("error", "Utente non autenticato. Reindirizzamento…");
          setTimeout(() => window.location.href = "index.html", 800);
        }
      });
    })();
  </script>
</body>
</html>
