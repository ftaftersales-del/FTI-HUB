<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FTCLAIMS - Storico Manutenzioni VIN</title>

  <link rel="stylesheet" href="ftstyle.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Page-specific CSS (solo UI) -->
  <style>
    body{ overscroll-behavior: none; }

    .page-kicker{
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .page-title{
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.2px;
    }
    .page-subtitle{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      flex-wrap: wrap;
    }
    .field{
      min-width: 260px;
      flex: 1;
    }

    /* Banner messaggi */
    .banner{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      display: none;
    }
    .banner.success{
      background: var(--ok-bg);
      border-color: var(--ok-bd);
      color: var(--ok-tx);
      display: block;
    }
    .banner.error{
      background: rgba(255,235,238,.9);
      border-color: rgba(239,154,154,.85);
      color: #b42318;
      display: block;
    }
    .banner.info{
      background: rgba(227,242,253,.75);
      border-color: rgba(144,202,249,.9);
      color: #184a99;
      display: block;
    }

    /* Tabella */
    .table-wrap{
      margin-top: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      border: 1px solid rgba(230,232,240,.92);
      background: #fff;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 860px;
    }
    thead th{
      background: rgba(243,245,250,.9);
      font-weight: 900;
      color: var(--text);
      border-bottom: 1px solid rgba(230,232,240,.92);
      padding: 10px 12px;
      text-align:left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td{
      border-bottom: 1px solid rgba(230,232,240,.92);
      padding: 10px 12px;
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom: none; }

    .pill{
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(241,243,245,.9);
      border: 1px solid rgba(229,231,235,.9);
      white-space: nowrap;
    }

    .mutedBox{
      background: rgba(255,255,255,.75);
      border: 1px dashed rgba(230,232,240,.95);
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .summary{
      font-size: 13px;
      color: var(--muted);
    }

    @media (max-width: 720px){
      .page-title{ font-size: 22px; }
    }
  </style>
</head>

<body class="ft-page has-topbar">

  <!-- TOPBAR (HOME a destra) -->
  <div class="ft-topbar">
    <div class="ft-topbar__inner">
      <div class="ft-topbar__left">
        <div class="ft-topbar__brand">FTI-HUB</div>
        <div class="ft-topbar__subtitle">FTCLAIMS_HISTORY_VIN ‚Ä¢ Storico manutenzioni</div>
      </div>

      <div class="ft-topbar__center">
        <div id="userInfoTop" class="ft-topbar__userinfo">Utente: -</div>
      </div>

      <div class="ft-topbar__right">
        <a href="FTHUBAS.html" class="ft-home-btn">üè† Home</a>
      </div>
    </div>
  </div>

  <div class="ft-container">
    <div class="card pad">

      <div class="page-kicker">FTCLAIMS - Storico Manutenzioni VIN</div>
      <h1 class="page-title">Storico manutenzioni per VIN</h1>
      <p class="page-subtitle">
        Consulta le manutenzioni reclamate (Service Contract) salvate in storico.
      </p>

      <div id="banner" class="banner"></div>

      <hr class="sep">

      <div class="section">
        <div class="section-head">
          <div>
            <h3 class="section-title">Ricerca VIN</h3>
            <div class="section-sub">Inserisci il telaio e premi ‚ÄúCerca‚Äù.</div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="vinInput">VIN</label>
            <input id="vinInput" type="text" placeholder="Es: NM0KCTP60XSB93275" />
          </div>

          <button id="btnSearch" class="btn btn-primary" type="button">Cerca</button>
          <button id="btnClear" class="btn" type="button">Pulisci</button>
        </div>
      </div>

      <div class="section" style="margin-top:14px;">
        <div class="section-head" style="margin-bottom: 8px;">
          <div>
            <h3 class="section-title">Risultati</h3>
            <div id="summary" class="summary">Nessuna ricerca eseguita.</div>
          </div>
        </div>

        <div id="results" class="mutedBox">
          Inserisci un VIN per visualizzare lo storico.
        </div>
      </div>

    </div>
  </div>

  <script>
    (function () {
      // Firebase (usa quelli globali di firebase-config.js se presenti)
      const auth = window.auth || firebase.auth();
      const db   = window.db   || firebase.firestore();
      window.auth = auth;
      window.db   = db;

      const bannerEl  = document.getElementById("banner");
      const vinInput  = document.getElementById("vinInput");
      const btnSearch = document.getElementById("btnSearch");
      const btnClear  = document.getElementById("btnClear");
      const resultsEl = document.getElementById("results");
      const summaryEl = document.getElementById("summary");
      const userInfoTop = document.getElementById("userInfoTop");

      function showBanner(type, msg) {
        bannerEl.className = "banner " + (type || "");
        bannerEl.textContent = msg || "";
        bannerEl.style.display = "block";
      }
      function clearBanner() {
        bannerEl.style.display = "none";
        bannerEl.textContent = "";
        bannerEl.className = "banner";
      }

      function normalizeVin(v) {
        return (v || "").toString().trim().toUpperCase();
      }

      function parseAnyDate(v) {
        // supporta: Firestore Timestamp, Date, number, string ISO
        try {
          if (!v) return null;
          if (v && typeof v.toDate === "function") {
            const d = v.toDate();
            return isNaN(d.getTime()) ? null : d;
          }
          if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
          if (typeof v === "number") {
            const d = new Date(v);
            return isNaN(d.getTime()) ? null : d;
          }
          if (typeof v === "string") {
            const d = new Date(v);
            return isNaN(d.getTime()) ? null : d;
          }
          const d = new Date(v);
          return isNaN(d.getTime()) ? null : d;
        } catch (e) {
          return null;
        }
      }

      function dateToSortableNumber(d) {
        if (!d) return 0;
        if (d instanceof Date && !isNaN(d.getTime())) return d.getTime();
        return 0;
      }

      function fmtDateIT(d) {
        if (!d) return "";
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      function safe(v) {
        return (v == null) ? "" : String(v);
      }

      function renderTable(vin, rows) {
        if (!rows.length) {
          resultsEl.className = "mutedBox";
          resultsEl.textContent = "Nessun record trovato per questo VIN.";
          summaryEl.textContent = `VIN: ${vin} ‚Äî 0 record`;
          return;
        }

        // orderdate DESC
        rows.sort((a, b) => dateToSortableNumber(b._orderDateObj) - dateToSortableNumber(a._orderDateObj));

        const wrap = document.createElement("div");
        wrap.className = "table-wrap";

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width:170px;">Order Date</th>
              <th style="width:90px;">KM</th>
              <th style="width:110px;">Ore motore</th>
              <th>Pacchetto</th>
              <th style="width:110px;">Family</th>
              <th style="width:90px;">VOITH</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector("tbody");
        rows.forEach(r => {
          const tr = document.createElement("tr");

          const d = r._orderDateObj ? fmtDateIT(r._orderDateObj) : "";
          const km = (r.km == null) ? "" : r.km;
          const eh = (r.engineHours == null) ? "" : r.engineHours;
          const label = safe(r.label_it);
          const family = safe(r.family);
          const voith = (r.voith === true) ? `<span class="pill">SI</span>` : `<span class="pill">NO</span>`;

          tr.innerHTML = `
            <td>${safe(d)}</td>
            <td>${safe(km)}</td>
            <td>${safe(eh)}</td>
            <td>${safe(label)}</td>
            <td>${safe(family)}</td>
            <td>${voith}</td>
          `;
          tbody.appendChild(tr);
        });

        wrap.appendChild(table);

        resultsEl.className = "";
        resultsEl.innerHTML = "";
        resultsEl.appendChild(wrap);

        summaryEl.textContent = `VIN: ${vin} ‚Äî ${rows.length} record`;
      }

      async function searchVin() {
        clearBanner();
        const vin = normalizeVin(vinInput.value);

        if (!vin) {
          showBanner("error", "Inserisci un VIN.");
          return;
        }
        if (vin.length < 8) {
          showBanner("error", "VIN troppo corto. Controlla il telaio.");
          return;
        }

        btnSearch.disabled = true;
        resultsEl.className = "mutedBox";
        resultsEl.textContent = "Caricamento‚Ä¶";
        summaryEl.textContent = `VIN: ${vin} ‚Äî caricamento‚Ä¶`;

        try {
          // MaintenanceHistory/{vin}/Records
          const ref = db.collection("MaintenanceHistory").doc(vin).collection("Records");
          const snap = await ref.limit(500).get();

          const rows = [];
          snap.forEach(doc => {
            const d = doc.data() || {};
            const od = parseAnyDate(d.orderdate);

            rows.push({
              id: doc.id,
              vin: d.vin || vin,
              orderdate: d.orderdate || null,
              km: (d.km != null) ? d.km : null,
              engineHours: (d.engineHours != null) ? d.engineHours : null,
              label_it: d.label_it || "",
              family: d.family || "",
              voith: (d.voith === true),
              _orderDateObj: od
            });
          });

          renderTable(vin, rows);

          if (!rows.length) showBanner("info", "Nessun record trovato per questo VIN.");
          else showBanner("success", "Storico caricato.");
        } catch (e) {
          console.error(e);
          showBanner("error", "Errore lettura storico: " + e.message);
          resultsEl.className = "mutedBox";
          resultsEl.textContent = "Errore nel caricamento. Controlla le rules e riprova.";
          summaryEl.textContent = "Errore caricamento.";
        } finally {
          btnSearch.disabled = false;
        }
      }

      function clearUI() {
        clearBanner();
        vinInput.value = "";
        summaryEl.textContent = "Nessuna ricerca eseguita.";
        resultsEl.className = "mutedBox";
        resultsEl.textContent = "Inserisci un VIN per visualizzare lo storico.";
      }

      // Eventi UI
      btnSearch.addEventListener("click", searchVin);
      btnClear.addEventListener("click", clearUI);
      vinInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchVin();
      });

      // Auth gate + user banner
      auth.onAuthStateChanged((user) => {
        if (userInfoTop) {
          userInfoTop.textContent = "Utente: " + (user ? (user.email || user.uid) : "non loggato");
        }

        if (!user) {
          showBanner("error", "Utente non autenticato. Reindirizzamento‚Ä¶");
          setTimeout(() => window.location.href = "index.html", 800);
        }
      });
    })();
  </script>
</body>
</html>
