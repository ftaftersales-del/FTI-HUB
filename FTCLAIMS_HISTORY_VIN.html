<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FTCLAIMS - Storico Manutenzioni (VIN)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0 14px;
    }
    input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      min-width: 280px;
      font-size: 14px;
    }
    button {
      padding: 8px 12px;
      border: 0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #1d6fff; color: #fff; }
    .btn-secondary { background: #e9eefc; color: #1d3f8b; }
    .small-text { color: #666; font-size: 12px; }
    .status {
      margin-top: 8px;
      padding: 10px;
      border-radius: 8px;
      background: #f7f7f7;
      border: 1px solid #eee;
      font-size: 13px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #fafafa;
      font-weight: bold;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="container">
    <h2>Storico Manutenzioni - Ricerca per VIN</h2>
    <div class="small-text">
      Accesso in lettura consentito a tutti gli utenti autenticati.
    </div>

    <div class="row">
      <input id="vinInput" type="text" placeholder="Inserisci VIN (es: WF0...)" />
      <button id="searchBtn" class="btn-primary">Cerca</button>
      <button id="clearBtn" class="btn-secondary">Pulisci</button>
    </div>

    <div id="status" class="status">Inserisci un VIN e premi “Cerca”.</div>

    <div style="overflow:auto;">
      <table id="resultsTable" style="display:none;">
        <thead>
          <tr>
            <th>VIN</th>
            <th>Order Date</th>
            <th>KM</th>
            <th>Ore Motore</th>
            <th>label_it</th>
            <th>family</th>
            <th>voith</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

<script>
  if (typeof firebase === "undefined" || !firebase.auth || !firebase.firestore) {
    alert("Firebase non disponibile. Controlla i riferimenti agli script.");
  }

  const auth = firebase.auth();
  const db = firebase.firestore();

  const vinInput = document.getElementById("vinInput");
  const searchBtn = document.getElementById("searchBtn");
  const clearBtn = document.getElementById("clearBtn");
  const statusDiv = document.getElementById("status");
  const table = document.getElementById("resultsTable");
  const body = document.getElementById("resultsBody");

  function setStatus(msg) {
    statusDiv.textContent = msg;
  }

  function normalizeVin(v) {
    return (v || "").toString().trim().toUpperCase();
  }

  function formatDateAny(v) {
    if (!v) return "";
    // Timestamp Firestore
    if (v.toDate) {
      const d = v.toDate();
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return dd + "/" + mm + "/" + yyyy;
    }
    // string YYYY-MM-DD -> DD/MM/YYYY
    if (typeof v === "string" && /^\d{4}-\d{2}-\d{2}$/.test(v)) {
      const parts = v.split("-");
      return parts[2] + "/" + parts[1] + "/" + parts[0];
    }
    return String(v);
  }

  function safeNum(v) {
    if (v === null || v === undefined) return "";
    const n = Number(String(v).replace(",", "."));
    return isNaN(n) ? "" : String(n);
  }

  function renderRows(rows) {
    body.innerHTML = "";

    if (!rows.length) {
      table.style.display = "none";
      setStatus("Nessun record trovato per questo VIN.");
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");

      const tdVin = document.createElement("td");
      tdVin.textContent = r.vin || "";
      tdVin.className = "mono";

      const tdOrder = document.createElement("td");
      tdOrder.textContent = formatDateAny(r.orderDate);

      const tdKm = document.createElement("td");
      tdKm.textContent = safeNum(r.km);

      const tdEh = document.createElement("td");
      tdEh.textContent = safeNum(r.engineHours);

      const tdLabel = document.createElement("td");
      tdLabel.textContent = r.label_it || "";

      const tdFamily = document.createElement("td");
      tdFamily.textContent = r.family || "";

      const tdVoith = document.createElement("td");
      tdVoith.textContent = r.voith || "";

      tr.appendChild(tdVin);
      tr.appendChild(tdOrder);
      tr.appendChild(tdKm);
      tr.appendChild(tdEh);
      tr.appendChild(tdLabel);
      tr.appendChild(tdFamily);
      tr.appendChild(tdVoith);

      body.appendChild(tr);
    });

    table.style.display = "";
    setStatus("Trovati " + rows.length + " record.");
  }

  async function searchByVin() {
    const vin = normalizeVin(vinInput.value);
    if (!vin) {
      setStatus("Inserisci un VIN valido.");
      table.style.display = "none";
      body.innerHTML = "";
      return;
    }

    setStatus("Ricerca in corso per VIN " + vin + " ...");
    table.style.display = "none";
    body.innerHTML = "";

    try {
      // Records: ordinamento preferito per data (discendente)
      // NB: se orderDate è stringa "YYYY-MM-DD", orderBy funziona correttamente.
      const ref = db
        .collection("MaintenanceHistory")
        .doc(vin)
        .collection("Records");

      let snap;
      try {
        snap = await ref.orderBy("orderDate", "desc").get();
      } catch (e) {
        // fallback se manca indice o campo
        snap = await ref.get();
      }

      const rows = [];
      snap.forEach(doc => {
        const d = doc.data() || {};
        rows.push({
          vin: d.vin || vin,
          orderDate: d.orderDate || null,
          km: d.km != null ? d.km : null,
          engineHours: d.engineHours != null ? d.engineHours : null,
          label_it: d.label_it || "",
          family: d.family || "",
          voith: d.voith || ""
        });
      });

      // Se non è arrivato ordinato, provo a ordinare lato client
      rows.sort((a,b) => {
        const da = a.orderDate && a.orderDate.toDate ? a.orderDate.toDate().getTime() : (typeof a.orderDate==="string" ? Date.parse(a.orderDate) : 0);
        const dbb = b.orderDate && b.orderDate.toDate ? b.orderDate.toDate().getTime() : (typeof b.orderDate==="string" ? Date.parse(b.orderDate) : 0);
        return dbb - da;
      });

      renderRows(rows);
    } catch (err) {
      console.error(err);
      setStatus("Errore durante la ricerca: " + err.message);
    }
  }

  clearBtn.addEventListener("click", () => {
    vinInput.value = "";
    table.style.display = "none";
    body.innerHTML = "";
    setStatus("Inserisci un VIN e premi “Cerca”.");
    vinInput.focus();
  });

  searchBtn.addEventListener("click", searchByVin);
  vinInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") searchByVin();
  });

  // Gate autenticazione
  auth.onAuthStateChanged((user) => {
    if (!user) {
      alert("Devi effettuare l'accesso per consultare lo storico manutenzioni.");
      // Se hai una pagina login specifica, cambia qui:
      window.location.href = "index.html";
      return;
    }
    vinInput.focus();
  });
</script>
</body>
</html>
