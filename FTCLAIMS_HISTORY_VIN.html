<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FTCLAIMS - Storico Manutenzioni per VIN</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-functions-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:18px; }
    .container { max-width: 1200px; margin:auto; background:#fff; padding:16px 18px 20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    h1 { margin:0 0 6px; font-size:18px; }
    .sub { margin:0 0 14px; color:#666; font-size:13px; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .user { font-size:12px; color:#555; }

    .card { background:#fff; border:1px solid #eee; border-radius:10px; padding:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:end; }
    label { display:block; font-size:12px; font-weight:bold; margin-bottom:4px; color:#333; }
    input { width: 360px; max-width: 100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px; box-sizing:border-box; }

    button { padding:8px 12px; border:0; border-radius:6px; cursor:pointer; font-size:13px; }
    button.primary { background:#0d6efd; color:#fff; }
    button.secondary { background:#6c757d; color:#fff; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .msg { margin:12px 0; padding:10px 12px; border-radius:8px; display:none; font-size:13px; }
    .msg.ok { display:block; background:#eaffea; border:1px solid #bde5bd; color:#1f7a1f; }
    .msg.err{ display:block; background:#ffecec; border:1px solid #f0b3b3; color:#a21f1f; }

    .small { font-size:12px; color:#666; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#f1f1f1; }

    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:13px; vertical-align:top; }
    th { background:#fafafa; }

    details { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:8px 10px; margin-top:8px; }
    summary { cursor:pointer; font-weight:bold; }

    .two { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .box { background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; }
    .box h4 { margin:0 0 8px; font-size:12px; }
    .list { margin:0; padding-left:18px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="top">
      <div>
        <h1>Storico manutenzioni per VIN</h1>
        <p class="sub">
          Pagina <b>solo lettura</b>. Mostra SOLO manutenzioni (<b>SERVICE CONTRACT</b>) su claim card <b>non</b> in stato <b>Cancellata</b>.
        </p>
      </div>
      <div class="user" id="userInfo">Verifica login...</div>
    </div>

    <div id="msg" class="msg"></div>

    <div class="card">
      <div class="row">
        <div>
          <label for="vinInput">VIN (telaio)</label>
          <input id="vinInput" type="text" placeholder="Es: NM0..." />
        </div>

        <button id="btnSearch" class="primary">Cerca</button>
        <button id="btnPdf" class="secondary" disabled>Scarica PDF</button>
        <button id="btnHome" class="secondary">Home</button>
      </div>

      <div class="small" id="summary" style="margin-top:10px;"></div>
      <div id="results"></div>
    </div>
  </div>

  <script>
    (function () {
      const auth = window.auth || firebase.auth();
      const db   = window.db   || firebase.firestore();
      const functions = firebase.functions();

      window.auth = auth;
      window.db = db;

      const userInfo = document.getElementById("userInfo");
      const vinInput = document.getElementById("vinInput");
      const btnSearch = document.getElementById("btnSearch");
      const btnPdf = document.getElementById("btnPdf");
      const btnHome = document.getElementById("btnHome");
      const msg = document.getElementById("msg");
      const results = document.getElementById("results");
      const summary = document.getElementById("summary");

      // cache Maintenance templates (dealer-side) per righe quando non salvate nel claim
      const maintenanceTemplateCache = new Map(); // docId -> data
      let lastDataset = null; // { vin, rows:[...] }

      function showMsg(text, ok) {
        msg.textContent = text;
        msg.className = "msg " + (ok ? "ok" : "err");
      }
      function clearMsg() {
        msg.textContent = "";
        msg.className = "msg";
        msg.style.display = "none";
      }

      function normVin(v) { return (v || "").toString().trim().toUpperCase(); }
      function safe(v) { return v == null ? "" : String(v); }
      function fmtDateISO(v) {
        if (!v) return "";
        if (typeof v === "string" && v.length >= 10) return v.slice(0,10);
        try {
          const d = new Date(v);
          if (isNaN(d.getTime())) return "";
          return d.toISOString().slice(0,10);
        } catch { return ""; }
      }

      // ===== Maintenance template helpers (dealer-side) =====
      function isDealerVisible(item) {
        const vis = item && item.visibility ? item.visibility : null;
        if (!vis) return true;
        return vis.dealer !== false;
      }
      function isVoithOnly(item) {
        const c = item && item.conditions ? item.conditions : null;
        return !!(c && c.voithOnly === true);
      }

      async function getMaintenanceTemplate(docId) {
        if (!docId) return null;
        if (maintenanceTemplateCache.has(docId)) return maintenanceTemplateCache.get(docId);
        const snap = await db.collection("Maintenance").doc(docId).get();
        const data = snap.exists ? (snap.data() || null) : null;
        maintenanceTemplateCache.set(docId, data);
        return data;
      }

      function splitItems(items, voithOn) {
        const list = Array.isArray(items) ? items : [];
        const filtered = list
          .filter(isDealerVisible)
          .filter(it => voithOn ? true : !isVoithOnly(it));

        const labour = filtered.filter(it => String(it.kind || "").toUpperCase() === "LABOUR");
        const parts  = filtered.filter(it => String(it.kind || "").toUpperCase() === "PART");
        return { labour, parts };
      }

      // Preferisci righe salvate nel claim (dealer-side). Se non ci sono, fallback template.
      async function getDealerSideRowsForClaim(claimData) {
        const sc = claimData.serviceContract || {};
        const voithOn = sc.voith === true;

        const labourDealer = Array.isArray(sc.labourDealer) ? sc.labourDealer : null;
        const partsDealer  = Array.isArray(sc.partsDealer)  ? sc.partsDealer  : null;

        if (labourDealer || partsDealer) {
          return { source: "claim", labour: labourDealer || [], parts: partsDealer || [] };
        }

        const templateDocId = sc.templateDocId || (sc.family && sc.key ? (sc.family + "_" + sc.key) : null);
        const tpl = await getMaintenanceTemplate(templateDocId);
        const { labour, parts } = splitItems(tpl && tpl.items, voithOn);

        const mapRow = (it) => ({
          code: it.code || "",
          description: it.description || "",
          qty: (it.qty != null ? it.qty : ""),
          note: it.note || ""
        });

        return { source: "template", labour: labour.map(mapRow), parts: parts.map(mapRow) };
      }

      // ===== Call backend (Cloud Function) =====
      const getHistory = firebase.functions().httpsCallable("getVinMaintenanceHistory");

      async function searchVin() {
        clearMsg();
        results.innerHTML = "";
        summary.textContent = "";
        btnPdf.disabled = true;
        lastDataset = null;

        const vin = normVin(vinInput.value);
        if (!vin || vin.length < 10) {
          showMsg("Inserisci un VIN valido.", false);
          return;
        }

        btnSearch.disabled = true;
        showMsg("Ricerca in corso...", true);

        try {
          const res = await getHistory({ vin });
          const payload = res && res.data ? res.data : null;

          if (!payload || !payload.rows) {
            showMsg("Risposta backend non valida.", false);
            return;
          }

          const rows = payload.rows || [];
          const cardsCount = payload.cardsCount || 0;

          showMsg(`Trovate ${rows.length} manutenzioni (SERVICE CONTRACT) su ${cardsCount} claim card non cancellate.`, true);
          summary.textContent = `VIN: ${vin} • ClaimCard valide: ${cardsCount} • Manutenzioni trovate: ${rows.length}`;

          renderResults(rows);
          lastDataset = { vin, rows };
          btnPdf.disabled = rows.length === 0;

        } catch (e) {
          console.error(e);
          showMsg("Errore durante la ricerca: " + (e.message || e), false);
        } finally {
          btnSearch.disabled = false;
        }
      }

      function renderResults(rows) {
        results.innerHTML = "";

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>ClaimCard</th>
              <th>Data ordine</th>
              <th>KM</th>
              <th>Ore</th>
              <th>Claim</th>
              <th>Tipo manutenzione</th>
              <th>Stato claim</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tb = table.querySelector("tbody");

        if (!rows.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="7" class="small">Nessuna manutenzione trovata.</td>`;
          tb.appendChild(tr);
          results.appendChild(table);
          return;
        }

        rows
          .sort((a,b) => (safe(a.orderDate) < safe(b.orderDate) ? 1 : -1))
          .forEach(r => {
            const code = r.claimCardCode || r.claimCardId;
            const orderDate = fmtDateISO(r.orderDate);
            const km = (r.km != null) ? r.km : "";
            const hrs = (r.engineHours != null) ? r.engineHours : "";
            const claimStatus = r.claimStatus || "";
            const maintKey = r.maintenanceKey || "";
            const maintLabel = r.maintenanceLabel || "";
            const maintType = maintLabel ? `${maintKey} – ${maintLabel}` : (maintKey || "-");

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><span class="pill">${safe(code)}</span></td>
              <td>${safe(orderDate)}</td>
              <td>${safe(km)}</td>
              <td>${safe(hrs)}</td>
              <td>${safe(r.claimCode)}</td>
              <td>${safe(maintType)}</td>
              <td>${safe(claimStatus)}</td>
            `;
            tb.appendChild(tr);

            const det = document.createElement("details");
            det.innerHTML = `<summary>Dettagli righe (dealer) – ${safe(r.claimCode)}</summary>
              <div class="two">
                <div class="box">
                  <h4>Manodopera</h4>
                  <ul class="list" id="lab_${r.claimCardId}_${r.claimCode}"><li class="small">Carico…</li></ul>
                </div>
                <div class="box">
                  <h4>Ricambi</h4>
                  <ul class="list" id="par_${r.claimCardId}_${r.claimCode}"><li class="small">Carico…</li></ul>
                </div>
              </div>`;
            results.appendChild(det);

            // Render righe: preferisco payload dealer-side (se presente), altrimenti template (via Firestore)
            setTimeout(async () => {
              try {
                const claimData = r._claimDataForRows || null; // se backend ce lo passa
                const sc = r.serviceContract || null;

                let data = null;
                if (claimData) {
                  data = await getDealerSideRowsForClaim(claimData);
                } else if (sc) {
                  data = await getDealerSideRowsForClaim({ serviceContract: sc });
                } else {
                  data = { labour: [], parts: [] };
                }

                const labUl = document.getElementById(`lab_${r.claimCardId}_${r.claimCode}`);
                const parUl = document.getElementById(`par_${r.claimCardId}_${r.claimCode}`);

                const renderUl = (ul, arr) => {
                  ul.innerHTML = "";
                  if (!arr || !arr.length) {
                    const li = document.createElement("li");
                    li.className = "small";
                    li.textContent = "Nessuna riga.";
                    ul.appendChild(li);
                    return;
                  }
                  arr.forEach(x => {
                    const li = document.createElement("li");
                    li.textContent =
                      (x.code ? x.code + " – " : "") +
                      (x.description || "") +
                      (x.qty !== "" && x.qty != null ? (" (Q.tà: " + x.qty + ")") : "") +
                      (x.note ? (" • " + x.note) : "");
                    ul.appendChild(li);
                  });
                };

                renderUl(labUl, data.labour || []);
                renderUl(parUl, data.parts || []);
              } catch (e) {
                console.error(e);
              }
            }, 0);
          });

        results.appendChild(table);
      }

      async function downloadPdf() {
        if (!lastDataset || !lastDataset.rows || !lastDataset.rows.length) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "mm", format: "a4" });

        const vin = lastDataset.vin;
        const now = new Date();
        const stamp = now.toISOString().slice(0,19).replace("T"," ");

        let y = 12;
        doc.setFontSize(14);
        doc.text("FTCLAIMS - Storico Manutenzioni (Service Contract)", 14, y);
        y += 7;
        doc.setFontSize(11);
        doc.text("VIN: " + vin, 14, y);
        y += 6;
        doc.setFontSize(9);
        doc.text("Generato: " + stamp, 14, y);
        y += 6;

        const sorted = lastDataset.rows.slice().sort((a,b) => (safe(a.orderDate) > safe(b.orderDate) ? 1 : -1));

        for (const r of sorted) {
          const code = r.claimCardCode || r.claimCardId;
          const orderDate = fmtDateISO(r.orderDate);
          const km = (r.km != null) ? r.km : "";
          const hrs = (r.engineHours != null) ? r.engineHours : "";

          const maintKey = r.maintenanceKey || "";
          const maintLabel = r.maintenanceLabel || "";
          const maintType = maintLabel ? `${maintKey} – ${maintLabel}` : (maintKey || "-");

          doc.setFontSize(11);
          doc.text(`ClaimCard ${code} • Claim ${r.claimCode}`, 14, y); y += 5;

          doc.setFontSize(9);
          doc.text(`Data ordine: ${orderDate}   KM: ${km}   Ore: ${hrs}`, 14, y); y += 5;
          doc.text(`Tipo manutenzione: ${maintType}`, 14, y); y += 4;

          // Righe dealer-side
          const claimData = r._claimDataForRows ? r._claimDataForRows : { serviceContract: r.serviceContract || {} };
          const rowsData = await getDealerSideRowsForClaim(claimData);

          const labourRows = (rowsData.labour || []).map(x => [safe(x.code), safe(x.description), safe(x.qty), safe(x.note)]);
          doc.autoTable({
            startY: y,
            head: [["Manodopera - Codice", "Descrizione", "Q.tà", "Note"]],
            body: labourRows.length ? labourRows : [["", "Nessuna riga.", "", ""]],
            styles: { fontSize: 8 },
            headStyles: { fillColor: [245,245,245] }
          });
          y = doc.lastAutoTable.finalY + 4;

          const partsRows = (rowsData.parts || []).map(x => [safe(x.code), safe(x.description), safe(x.qty), safe(x.note)]);
          doc.autoTable({
            startY: y,
            head: [["Ricambi - Codice", "Descrizione", "Q.tà", "Note"]],
            body: partsRows.length ? partsRows : [["", "Nessuna riga.", "", ""]],
            styles: { fontSize: 8 },
            headStyles: { fillColor: [245,245,245] }
          });
          y = doc.lastAutoTable.finalY + 10;

          if (y > 270) { doc.addPage(); y = 14; }
        }

        doc.save(`FTCLAIMS_StoricoManutenzioni_${vin}.pdf`);
      }

      // UI
      btnHome.addEventListener("click", () => window.location.href = "FTHUBAS.html");
      btnSearch.addEventListener("click", searchVin);
      btnPdf.addEventListener("click", downloadPdf);
      vinInput.addEventListener("keydown", (e) => { if (e.key === "Enter") searchVin(); });

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          userInfo.textContent = "Non autenticato";
          showMsg("Devi fare login.", false);
          setTimeout(() => window.location.href = "index.html", 1200);
          return;
        }
        userInfo.textContent = user.displayName || user.email || user.uid;
        clearMsg();
      });

    })();
  </script>
</body>
</html>
