  <script>
    (function () {
      const userInfoDiv = document.getElementById('userInfo');

      // --- Controlli base su Firebase / auth / db ---
      try {
        if (typeof firebase === 'undefined') {
          userInfoDiv.textContent = "Errore: Firebase non è caricato (controlla gli script in <head>).";
          return;
        }
      } catch (e) {
        userInfoDiv.textContent = "Errore JS iniziale: " + e.message;
        console.error(e);
        return;
      }

      // Se nel tuo firebase-config.js NON hai definito auth / db globali,
      // togli i commenti alle due righe seguenti:
      // const auth = firebase.auth();
      // const db   = firebase.firestore();

      if (typeof auth === 'undefined' || typeof db === 'undefined') {
        userInfoDiv.textContent = "Errore: variabili 'auth' o 'db' non definite. Controlla firebase-config.js.";
        return;
      }

      // Lista di collezioni candidate per i dati VIN
      const VIN_COLLECTIONS = [
        "DBVIN",
        "VIN",
        "warranty_contracts",
        "warranty_contracts_FULL"
      ];

      let currentAccount = null;

      async function loadCurrentUserInfo(user) {
        const userRef = db.collection('Users').doc(user.uid);
        const userSnap = await userRef.get();
        if (!userSnap.exists) {
          throw new Error("Profilo utente non trovato nel database (collezione 'Users').");
        }

        const userData = userSnap.data();
        const roleId   = userData.role || "User";

        currentAccount = { firebaseUser: user, userData, roleId };
        return currentAccount;
      }

      function renderUserInfo() {
        if (!currentAccount) return;
        const { firebaseUser, userData, roleId } = currentAccount;

        userInfoDiv.innerHTML = `
          <p><strong>Utente:</strong> ${userData.displayName || firebaseUser.email}</p>
          <p><strong>Dealer ID:</strong> ${userData.dealerId || '-'}</p>
          <p><strong>Ruolo:</strong> ${roleId}</p>
        `;
      }

      // === Controllo accesso: solo Admin e User ===
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          userInfoDiv.textContent = "Utente non autenticato. Verrai reindirizzato…";
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
          return;
        }

        try {
          await loadCurrentUserInfo(user);

          const roleId = currentAccount.roleId;
          if (!(roleId === 'Admin' || roleId === 'User')) {
            userInfoDiv.textContent = "Non hai i permessi per accedere a questa pagina.";
            setTimeout(() => {
              window.location.href = "FTHUBAS.html";
            }, 1500);
            return;
          }

          renderUserInfo();
        } catch (err) {
          console.error("Errore caricamento utente:", err);
          userInfoDiv.textContent = "Errore nel controllo dei permessi: " + err.message;
        }
      });

      // === GESTIONE BOTTONI ===
      const btnCancel = document.getElementById('btnCancel');
      const btnCheckCoverage = document.getElementById('btnCheckCoverage');
      const btnNext = document.getElementById('btnNext');

      btnCancel.addEventListener('click', () => {
        window.location.href = "FTHUBAS.html";
      });

      btnCheckCoverage.addEventListener('click', async () => {
        await handleCheckCoverage();
      });

      btnNext.addEventListener('click', () => {
        const vin = document.getElementById('vinInput').value.trim().toUpperCase();
        const dataOrdineStr = document.getElementById('dataOrdineInput').value;

        const claimState = { vin, dataOrdine: dataOrdineStr };
        sessionStorage.setItem("currentClaimStep1", JSON.stringify(claimState));

        window.location.href = "FTCLAIMS_STEP2.html";
      });

      // === FUNZIONI SUPPORTO UI ===
      function showMessage(type, text) {
        const area = document.getElementById('resultArea');
        area.style.display = 'block';
        area.className = '';
        if (type === 'error') {
          area.classList.add('error');
        } else if (type === 'success') {
          area.classList.add('success');
        }
        area.innerHTML = text;
      }

      function clearMessage() {
        const area = document.getElementById('resultArea');
        area.style.display = 'none';
        area.className = '';
        area.textContent = '';
      }

      function startOfDay(date) {
        const d = new Date(date);
        d.setHours(0,0,0,0);
        return d;
      }

      function getDateFromField(value) {
        if (!value) return null;
        // Timestamp Firestore
        if (value.toDate && typeof value.toDate === "function") {
          return startOfDay(value.toDate());
        }
        // Stringa tipo "2025-07-23"
        if (typeof value === "string") {
          const d = new Date(value);
          if (!isNaN(d.getTime())) return startOfDay(d);
        }
        // Millisecondi epoch
        if (typeof value === "number") {
          const d = new Date(value);
          if (!isNaN(d.getTime())) return startOfDay(d);
        }
        return null;
      }

      function isDateWithinRange(target, start, end) {
        if (!start || !end) return false;
        const t = startOfDay(target).getTime();
        const s = startOfDay(start).getTime();
        const e = startOfDay(end).getTime();
        return t >= s && t <= e;
      }

      // === Cerca il VIN provando più collezioni ===
      async function findVinDocument(vin) {
        for (const col of VIN_COLLECTIONS) {
          try {
            const snap = await db.collection(col)
              .where("vin", "==", vin)
              .limit(1)
              .get();

            console.log(`[FTCLAIMS] Ricerca VIN ${vin} in collezione '${col}' -> docs:`, snap.size);

            if (!snap.empty) {
              const doc = snap.docs[0];
              return { collection: col, doc, data: doc.data() };
            }
          } catch (e) {
            console.error(`[FTCLAIMS] Errore query su collezione '${col}':`, e);
          }
        }
        return null;
      }

      // === LOGICA CONTROLLO COPERTURA ===
      async function handleCheckCoverage() {
        clearMessage();
        btnNext.style.display = "none";

        const vinInput = document.getElementById('vinInput');
        const dataOrdineInput = document.getElementById('dataOrdineInput');

        let vin = vinInput.value.trim().toUpperCase();
        const dataOrdineStr = dataOrdineInput.value;

        if (!vin) {
          showMessage('error', "Inserisci il numero di telaio (VIN).");
          return;
        }
        if (!dataOrdineStr) {
          showMessage('error', "Inserisci la data di apertura dell'ordine di lavoro.");
          return;
        }

        const dataOrdine = startOfDay(new Date(dataOrdineStr));
        if (isNaN(dataOrdine.getTime())) {
          showMessage('error', "La data inserita non è valida.");
          return;
        }

        const oggi = startOfDay(new Date());
        const minDate = startOfDay(new Date());
        minDate.setDate(minDate.getDate() - 90);

        if (dataOrdine > oggi) {
          showMessage('error', "La data dell'ordine di lavoro non può essere futura.");
          return;
        }

        if (dataOrdine < minDate) {
          showMessage('error', "È possibile aprire una pratica solo entro 90 giorni dalla data dell'ordine di lavoro.");
          return;
        }

        try {
          showMessage('success', "Ricerca del telaio in corso…");
          btnCheckCoverage.disabled = true;

          const result = await findVinDocument(vin);

          if (!result) {
            showMessage(
              'error',
              "Telaio non trovato nelle collezioni: " +
              VIN_COLLECTIONS.join(", ") +
              ".<br>Controlla il nome esatto della collezione in Firestore e il campo 'vin'."
            );
            btnCheckCoverage.disabled = false;
            return;
          }

          const { collection, data } = result;
          console.log("[FTCLAIMS] VIN trovato in collezione:", collection, data);

          // Mappatura ai tuoi campi reali di copertura:
          // COMPLETA -> FULL LINE
          const fullStart  = getDateFromField(data.completa_data_start);
          const fullEnd    = getDateFromField(data.completa_data_end);

          // CATENA CINEMATICA -> DRIVE LINE
          const driveStart = getDateFromField(data.catcinematica_data_start);
          const driveEnd   = getDateFromField(data.catcinematica_data_end);

          // CONTRATTO DI MANUTENZIONE
          const maintStart = getDateFromField(data.contratto_data_start);
          const maintEnd   = getDateFromField(data.contratto_data_end);

          const copertureValide = [];

          if (isDateWithinRange(dataOrdine, fullStart, fullEnd)) {
            copertureValide.push({ tipo: "FULL LINE (COMPLETA)", start: fullStart, end: fullEnd });
          }
          if (isDateWithinRange(dataOrdine, driveStart, driveEnd)) {
            copertureValide.push({ tipo: "DRIVE LINE (CAT. CINEMATICA)", start: driveStart, end: driveEnd });
          }
          if (isDateWithinRange(dataOrdine, maintStart, maintEnd)) {
            copertureValide.push({ tipo: "CONTRATTO DI MANUTENZIONE", start: maintStart, end: maintEnd });
          }

          if (copertureValide.length === 0) {
            showMessage(
              'error',
              "Alla data dell'ordine di lavoro non risulta alcuna copertura valida (FULL LINE, DRIVE LINE o CONTRATTO DI MANUTENZIONE) per questo telaio."
            );
            btnCheckCoverage.disabled = false;
            return;
          }

          const formatDate = (d) => {
            if (!d) return "-";
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            return `${dd}/${mm}/${yyyy}`;
          };

          let html = `<strong>Telaio:</strong> ${vin}<br>`;
          html += `<strong>Data ordine di lavoro:</strong> ${formatDate(dataOrdine)}<br>`;
          html += `<strong>Collezione dati VIN:</strong> ${collection}<br><br>`;
          html += `<strong>Coperture valide alla data selezionata:</strong><ul>`;

          copertureValide.forEach(c => {
            html += `<li>${c.tipo}: dal ${formatDate(c.start)} al ${formatDate(c.end)}</li>`;
          });
          html += `</ul>`;
          html += `<br>Puoi procedere con la creazione della pratica di garanzia.`;

          showMessage('success', html);
          btnNext.style.display = "inline-block";
          btnCheckCoverage.disabled = false;

        } catch (err) {
          console.error("Errore durante il controllo copertura:", err);
          showMessage('error', "Errore durante il controllo della copertura: " + err.message);
          btnCheckCoverage.disabled = false;
        }
      }
    })();
  </script>
