<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTCLAIMS - Creazione Pratica (Step 1)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .top-bar {
      background: #003366;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h1 {
      margin: 0;
      font-size: 20px;
    }

    .top-bar .top-actions button {
      margin-left: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .top-bar .home-btn {
      background: #ffffff;
      color: #003366;
      font-weight: bold;
    }

    .top-bar .logout-btn {
      background: #cc0000;
      color: #ffffff;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .error-box {
      padding: 10px;
      border-radius: 6px;
      background: #ffe5e5;
      color: #990000;
      border: 1px solid #ffcccc;
      margin-bottom: 15px;
      display: none;
    }

    .info-box {
      padding: 8px;
      border-radius: 6px;
      background: #e6f2ff;
      color: #003366;
      border: 1px solid #b3d1ff;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .section {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #003366;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px 20px;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 13px;
      margin-bottom: 3px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .form-group input[readonly],
    .form-group textarea[readonly] {
      background: #f0f0f0;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .buttons-row {
      margin-top: 15px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #0066cc;
      color: #fff;
    }

    .btn-secondary {
      background: #cccccc;
      color: #000;
    }

    .btn-danger {
      background: #cc0000;
      color: #fff;
    }

    .small {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <h1>FTCLAIMS - Creazione Pratica (Step 1)</h1>
    <div class="top-actions">
      <button class="top-bar home-btn" id="btn-home">Home</button>
      <button class="top-bar logout-btn" id="btn-logout">Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="error-box" class="error-box"></div>
    <div id="info-box" class="info-box">
      Inserisci VIN, data ordine di lavoro e chilometraggio, quindi premi "Ricerca veicolo".
    </div>

    <!-- DATI ORDINE DI LAVORO -->
    <div class="section">
      <div class="section-title">Dati Ordine di Lavoro</div>
      <div class="form-grid-3">
        <div class="form-group">
          <label for="vin-input">VIN</label>
          <input type="text" id="vin-input" maxlength="17">
        </div>
        <div class="form-group">
          <label for="order-date-input">Data Ordine di Lavoro</label>
          <input type="date" id="order-date-input">
        </div>
        <div class="form-group">
          <label for="order-number-input">Numero Ordine di Lavoro</label>
          <input type="text" id="order-number-input">
        </div>
        <div class="form-group">
          <label for="km-input">Km attuali</label>
          <input type="number" id="km-input" min="0">
        </div>
        <div class="form-group">
          <label for="engine-hours-input">Ore motore</label>
          <input type="number" id="engine-hours-input" min="0">
        </div>
        <div class="form-group">
          <label for="claim-type-input">Tipo pratica</label>
          <select id="claim-type-input">
            <option value="WARRANTY" selected>Reclamo di Garanzia (WARRANTY)</option>
          </select>
        </div>
      </div>
      <div class="buttons-row" style="margin-top:15px;">
        <button class="btn btn-secondary" id="btn-reset">Annulla / Pulisci</button>
        <button class="btn btn-primary" id="btn-search-vehicle">Ricerca veicolo</button>
      </div>
      <div class="small">
        Nota: anche in assenza di copertura attiva, sarà comunque possibile creare la pratica.
      </div>
    </div>

    <!-- DATI VEICOLO -->
    <div class="section">
      <div class="section-title">Dati veicolo</div>
      <div class="form-grid-2">
        <div class="form-group">
          <label for="vehicle-customer">Customer</label>
          <input type="text" id="vehicle-customer" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-plate">Registration Plate</label>
          <input type="text" id="vehicle-plate" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-reg-date">Registration Date</label>
          <input type="text" id="vehicle-reg-date" readonly>
        </div>
      </div>
    </div>

    <!-- COPERTURA GARANZIA -->
    <div class="section">
      <div class="section-title">Copertura Garanzia alla data dell'Ordine di Lavoro</div>
      <div class="form-grid-2">
        <div class="form-group">
          <label for="coverage-type">Tipo copertura (FULL LINE / DRIVE LINE)</label>
          <input type="text" id="coverage-type" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-start">Data inizio</label>
          <input type="text" id="coverage-start" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-end">Data fine</label>
          <input type="text" id="coverage-end" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-notes">Note copertura</label>
          <textarea id="coverage-notes" readonly></textarea>
        </div>
      </div>
    </div>

    <!-- CONTRATTO DI MANUTENZIONE -->
    <div class="section">
      <div class="section-title">Contratto di Manutenzione (se presente)</div>
      <div class="form-grid-2">
        <div class="form-group">
          <label for="sc-start">Data inizio</label>
          <input type="text" id="sc-start" readonly>
        </div>
        <div class="form-group">
          <label for="sc-end">Data fine</label>
          <input type="text" id="sc-end" readonly>
        </div>
        <div class="form-group">
          <label for="sc-options">Opzioni presenti</label>
          <textarea id="sc-options" readonly></textarea>
        </div>
      </div>
    </div>

    <!-- CREAZIONE CLAIM CARD -->
    <div class="section">
      <div class="section-title">Creazione Claim Card</div>
      <div class="form-grid-2">
        <div class="form-group">
          <label for="open-date-input">Data apertura pratica</label>
          <input type="date" id="open-date-input">
        </div>
        <div class="form-group">
          <label>Dealer / Utente apertura</label>
          <input type="text" id="open-dealer-user" readonly>
        </div>
      </div>
      <div class="buttons-row">
        <button class="btn btn-danger" id="btn-cancel">Torna a Home</button>
        <button class="btn btn-primary" id="btn-create-claim" disabled>
          Crea pratica e vai allo Step 2
        </button>
      </div>
      <div class="small">
        Il pulsante "Crea pratica" si abilita dopo la ricerca veicolo.
      </div>
    </div>
  </div>

<script>
  console.log("FTCLAIMS Step1 – script avviato");

  const appAuth = window.auth || firebase.auth();
  const appDb   = window.db   || firebase.firestore();
  window.auth = appAuth;
  window.db   = appDb;

  let currentUser = null;
  let currentUserInfo = { dealer: '', fullName: '' };
  let currentContext = null; // conterrà tutti i dati da salvare

  const WARRANTY_API_URL = 'https://verifica-garanzia-backend.onrender.com/verifica'; // adattalo se serve

  function showError(message) {
    const box = document.getElementById('error-box');
    box.textContent = message;
    box.style.display = 'block';
    console.error("[FTCLAIMS_STEP1] ERRORE:", message);
  }

  function clearError() {
    const box = document.getElementById('error-box');
    box.textContent = '';
    box.style.display = 'none';
  }

  function setInfo(message) {
    const box = document.getElementById('info-box');
    box.textContent = message;
    console.log("[FTCLAIMS_STEP1] INFO:", message);
  }

  async function loadUserInfo(user) {
    const userDocRef = appDb.collection('Users').doc(user.uid);
    const snap = await userDocRef.get();

    let dealer = '';
    let fullName = '';

    if (snap.exists) {
      const data = snap.data();
      dealer =
        data.dealerId ||
        data.dealerID ||
        data.DealerID ||
        '';
      fullName =
        data.fullName ||
        data.name ||
        data.displayName ||
        user.email ||
        user.uid;
    } else {
      fullName = user.email || user.uid;
    }

    currentUserInfo = { dealer, fullName };
    document.getElementById('open-dealer-user').value =
      (dealer ? dealer + ' - ' : '') + fullName;
  }

  function resetForm() {
    clearError();
    setInfo('Inserisci VIN, data ordine di lavoro e chilometraggio, quindi premi "Ricerca veicolo".');

    document.getElementById('vin-input').value = '';
    document.getElementById('order-date-input').value = '';
    document.getElementById('order-number-input').value = '';
    document.getElementById('km-input').value = '';
    document.getElementById('engine-hours-input').value = '';
    document.getElementById('claim-type-input').value = 'WARRANTY';

    document.getElementById('vehicle-customer').value = '';
    document.getElementById('vehicle-plate').value = '';
    document.getElementById('vehicle-reg-date').value = '';

    document.getElementById('coverage-type').value = '';
    document.getElementById('coverage-start').value = '';
    document.getElementById('coverage-end').value = '';
    document.getElementById('coverage-notes').value = '';

    document.getElementById('sc-start').value = '';
    document.getElementById('sc-end').value = '';
    document.getElementById('sc-options').value = '';

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('open-date-input').value = `${yyyy}-${mm}-${dd}`;

    currentContext = null;
    document.getElementById('btn-create-claim').disabled = true;
  }

  // Carica dati veicolo/coperture dal tuo backend
  async function fetchWarrantyData(vin, orderDate, km, engineHours) {
    // ATTENZIONE: adatta questa chiamata alla tua API reale.
    const url = `${WARRANTY_API_URL}?vin=${encodeURIComponent(vin)}&date=${encodeURIComponent(orderDate)}&km=${encodeURIComponent(km || 0)}&engineHours=${encodeURIComponent(engineHours || 0)}`;
    console.log('Chiamata warranty API:', url);

    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Errore HTTP ' + response.status);
    }
    const data = await response.json();
    console.log('Risposta API:', data);

    // Qui faccio assunzioni minime sulla struttura; adattale se serve.
    const vehicle = {
      vin: data.vin || vin,
      customer: data.customer || (data.vehicle && data.vehicle.customer) || '',
      registrationPlate: data.registrationPlate || (data.vehicle && data.vehicle.registrationPlate) || null,
      registrationDate: data.registrationDate || (data.vehicle && data.vehicle.registrationDate) || null
    };

    const coverageSrc = data.warrantyCoverage || data.coverage || {};
    const serviceContractSrc = data.serviceContract || {};

    const coverage = {
      type: coverageSrc.type || '',
      startDate: coverageSrc.startDate || '',
      endDate: coverageSrc.endDate || '',
      notes: coverageSrc.notes || ''
    };

    const serviceContract = {
      startDate: serviceContractSrc.startDate || '',
      endDate: serviceContractSrc.endDate || '',
      options: serviceContractSrc.options || '',
      notes: serviceContractSrc.notes || ''
    };

    return { vehicle, coverage, serviceContract };
  }

  async function handleSearchVehicle() {
    clearError();

    const vin = document.getElementById('vin-input').value.trim().toUpperCase();
    const orderDate = document.getElementById('order-date-input').value;
    const orderNumber = document.getElementById('order-number-input').value.trim();
    const km = document.getElementById('km-input').value;
    const engineHours = document.getElementById('engine-hours-input').value;

    if (!vin || vin.length < 5) {
      showError('Inserisci un VIN valido.');
      return;
    }
    if (!orderDate) {
      showError('Inserisci la data dell\'ordine di lavoro.');
      return;
    }

    setInfo('Ricerca veicolo e coperture in corso...');
    document.getElementById('btn-create-claim').disabled = true;

    try {
      const result = await fetchWarrantyData(vin, orderDate, km, engineHours);

      // Popola i campi in sola lettura
      document.getElementById('vehicle-customer').value = result.vehicle.customer || '';
      document.getElementById('vehicle-plate').value    = result.vehicle.registrationPlate || '';
      document.getElementById('vehicle-reg-date').value = result.vehicle.registrationDate || '';

      document.getElementById('coverage-type').value  = result.coverage.type || '';
      document.getElementById('coverage-start').value = result.coverage.startDate || '';
      document.getElementById('coverage-end').value   = result.coverage.endDate || '';
      document.getElementById('coverage-notes').value = result.coverage.notes || '';

      document.getElementById('sc-start').value   = result.serviceContract.startDate || '';
      document.getElementById('sc-end').value     = result.serviceContract.endDate || '';
      document.getElementById('sc-options').value = result.serviceContract.options || '';

      // Prepara il contesto da salvare
      currentContext = {
        vin: result.vehicle.vin || vin,
        customer: result.vehicle.customer || '',
        registrationPlate: result.vehicle.registrationPlate || null,
        registrationDate: result.vehicle.registrationDate || null,

        orderDate: orderDate,
        orderNumber: orderNumber || null,
        km: km ? Number(km) : null,
        engineHours: engineHours ? Number(engineHours) : null,

        coverage: result.coverage,
        serviceContract: result.serviceContract,
        type: document.getElementById('claim-type-input').value || 'WARRANTY'
      };

      setInfo('Dati veicolo e coperture caricati. Puoi creare la pratica.');
      document.getElementById('btn-create-claim').disabled = false;

    } catch (e) {
      console.error(e);
      showError('Errore durante la ricerca veicolo / coperture: ' + e.message);
      setInfo('Si è verificato un errore durante la ricerca.');
    }
  }

  async function generateClaimCode(orderDateString) {
    let year;
    if (orderDateString) {
      const d = new Date(orderDateString);
      if (!isNaN(d.getTime())) year = d.getFullYear();
    }
    if (!year) year = new Date().getFullYear();

    const counterDocId = `ClaimCardCounter_${year}`;
    const counterRef   = appDb.collection('Settings').doc(counterDocId);

    const sequence = await appDb.runTransaction(async (tx) => {
      const snap = await tx.get(counterRef);
      let current = 0;
      if (snap.exists && typeof snap.data().current === 'number') {
        current = snap.data().current;
      }
      const next = current + 1;
      tx.set(counterRef, { current: next }, { merge: true });
      return next;
    });

    const seqStr = String(sequence).padStart(6, '0');
    const code   = `W${year}${seqStr}`;
    console.log("Codice pratica generato:", code);
    return { code, year, sequence };
  }

  async function handleCreateClaim() {
    clearError();

    if (!currentContext) {
      showError('Prima esegui la ricerca veicolo.');
      return;
    }
    if (!currentUser) {
      showError('Utente non autenticato.');
      return;
    }

    const openDate = document.getElementById('open-date-input').value;
    if (!openDate) {
      showError('Inserisci la data di apertura pratica.');
      return;
    }

    setInfo('Generazione codice pratica e salvataggio su Firestore...');
    document.getElementById('btn-create-claim').disabled = true;

    try {
      const { code, year, sequence } = await generateClaimCode(currentContext.orderDate);

      const payload = {
        code: code,
        year: year,
        sequence: sequence,

        type: currentContext.type || 'WARRANTY',
        status: 'Aperta',

        orderDate: currentContext.orderDate || null,
        orderNumber: currentContext.orderNumber || null,
        openDate: openDate || null,

        openDealer: currentUserInfo.dealer || null,
        openUser: currentUserInfo.fullName || null,
        openUserUid: currentUser.uid,

        km: currentContext.km != null ? currentContext.km : null,
        engineHours: currentContext.engineHours != null ? currentContext.engineHours : null,

        vehicle: {
          vin: currentContext.vin || null,
          customer: currentContext.customer || null,
          registrationPlate: currentContext.registrationPlate || null,
          registrationDate: currentContext.registrationDate || null
        },

        coverage: {
          type: currentContext.coverage.type || null,
          startDate: currentContext.coverage.startDate || null,
          endDate: currentContext.coverage.endDate || null,
          notes: currentContext.coverage.notes || null
        },

        maintenanceContract: {
          startDate: currentContext.serviceContract.startDate || null,
          endDate: currentContext.serviceContract.endDate || null,
          options: currentContext.serviceContract.options || null,
          notes: currentContext.serviceContract.notes || null
        },

        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      console.log('Payload ClaimCard da salvare:', payload);

      // *** QUI usiamo il codice pratica come ID documento ***
      await appDb.collection('ClaimCards').doc(code).set(payload);

      // Salvo codice pratica e contesto per lo step 2
      sessionStorage.setItem('ftclaims_claimCode', code);
      sessionStorage.setItem('ftclaims_context', JSON.stringify({
        vin: payload.vehicle.vin,
        customer: payload.vehicle.customer,
        registrationPlate: payload.vehicle.registrationPlate,
        registrationDate: payload.vehicle.registrationDate,
        orderDate: payload.orderDate,
        warrantyCoverage: payload.coverage,
        serviceContract: payload.maintenanceContract
      }));

      setInfo('Pratica creata correttamente. Passo allo Step 2...');
      window.location.href = 'FTCLAIMS_step2.html';

    } catch (e) {
      console.error('Errore durante la creazione della pratica:', e);
      showError('Errore durante la creazione della pratica: ' + e.message);
      setInfo('Si è verificato un errore nel salvataggio della pratica.');
      document.getElementById('btn-create-claim').disabled = false;
    }
  }

  async function initPage(user) {
    currentUser = user;
    await loadUserInfo(user);
    resetForm();
  }

  appAuth.onAuthStateChanged(async (user) => {
    console.log("onAuthStateChanged FTCLAIMS Step1:", user ? user.uid : "NESSUN UTENTE");
    if (!user) {
      window.location.href = 'FTLOGIN.html';
      return;
    }
    try {
      await initPage(user);
    } catch (e) {
      console.error(e);
      showError('Errore inizializzazione pagina: ' + e.message);
    }
  });

  // Eventi UI
  document.getElementById('btn-home').addEventListener('click', () => {
    window.location.href = 'FTHUBAS.html';
  });

  document.getElementById('btn-logout').addEventListener('click', async () => {
    try {
      await appAuth.signOut();
      window.location.href = 'FTLOGIN.html';
    } catch (e) {
      console.error(e);
      alert('Errore durante il logout.');
    }
  });

  document.getElementById('btn-reset').addEventListener('click', resetForm);
  document.getElementById('btn-cancel').addEventListener('click', () => {
    window.location.href = 'FTHUBAS.html';
  });
  document.getElementById('btn-search-vehicle').addEventListener('click', handleSearchVehicle);
  document.getElementById('btn-create-claim').addEventListener('click', handleCreateClaim);
</script>

</body>
</html>
