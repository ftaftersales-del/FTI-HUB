<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTCLAIMS - Nuova pratica di garanzia</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px 25px 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
    }

    #userInfo {
      font-size: 13px;
      color: #555;
      margin-bottom: 15px;
    }
    #userInfo p {
      margin: 0;
    }

    .field-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #btnCheckCoverage {
      background-color: #007bff;
      color: white;
    }
    #btnNext {
      background-color: #28a745;
      color: white;
    }
    #btnCancel {
      background-color: #dc3545;
      color: white;
      margin-left: auto;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #resultArea {
      margin-top: 20px;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    #resultArea.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #resultArea.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Nuova pratica di garanzia – Verifica copertura</h2>

    <div id="userInfo">Verifica accesso in corso...</div>

    <div class="field-group">
      <label for="vinInput">Telaio (VIN)</label>
      <input type="text" id="vinInput" placeholder="Inserisci il numero di telaio">
    </div>

    <div class="field-group">
      <label for="dataOrdineInput">Data apertura ordine di lavoro</label>
      <input type="date" id="dataOrdineInput">
    </div>

    <!-- NUOVO: selezione tipologia pratica -->
    <div class="field-group" id="tipoPraticaGroup" style="display:none;">
      <label for="tipoPratica">Tipologia pratica</label>
      <select id="tipoPratica">
        <!-- opzioni riempite via JavaScript -->
      </select>
    </div>

    <div class="buttons">
      <button id="btnCheckCoverage">Controlla copertura</button>
      <button id="btnNext" style="display:none;" disabled>Avanti</button>
      <button id="btnCancel">Annulla</button>
    </div>

    <div id="resultArea"></div>
  </div>

  <script>
    (function () {
      console.log("FTCLAIMS – file caricato con menu tipologia pratica");

      const userInfoDiv = document.getElementById('userInfo');

      // --- Controlli base su Firebase / auth / db ---
      try {
        if (typeof firebase === 'undefined') {
          userInfoDiv.textContent = "Errore: Firebase non è caricato (controlla gli script in <head>).";
          return;
        }
      } catch (e) {
        userInfoDiv.textContent = "Errore JS iniziale: " + e.message;
        console.error(e);
        return;
      }

      const auth = window.auth || firebase.auth();
      const db   = window.db   || firebase.firestore();
      window.auth = auth;
      window.db   = db;

      // ⚠️ NOME DELLA COLLEZIONE VIN (quella che ora funziona per te)
      const VIN_COLLECTION = "DBVIN";

      let currentAccount = null;

      async function loadCurrentUserInfo(user) {
        const userRef = db.collection('Users').doc(user.uid);
        const userSnap = await userRef.get();
        if (!userSnap.exists) {
          throw new Error("Profilo utente non trovato nel database (collezione 'Users').");
        }

        const userData = userSnap.data();
        const roleId   = userData.role || "User";

        currentAccount = { firebaseUser: user, userData, roleId };
        return currentAccount;
      }

      function renderUserInfo() {
        if (!currentAccount) return;
        const { firebaseUser, userData, roleId } = currentAccount;

        userInfoDiv.innerHTML = `
          <p><strong>Utente:</strong> ${userData.displayName || firebaseUser.email}</p>
          <p><strong>Dealer ID:</strong> ${userData.dealerId || '-'}</p>
          <p><strong>Ruolo:</strong> ${roleId}</p>
        `;
      }

      // === Controllo accesso: solo Admin e User ===
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          userInfoDiv.textContent = "Utente non autenticato. Verrai reindirizzato…";
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
          return;
        }

        try {
          await loadCurrentUserInfo(user);

          const roleId = currentAccount.roleId;
          if (!(roleId === 'Admin' || roleId === 'User')) {
            userInfoDiv.textContent = "Non hai i permessi per accedere a questa pagina.";
            setTimeout(() => {
              window.location.href = "FTHUBAS.html";
            }, 1500);
            return;
          }

          renderUserInfo();
        } catch (err) {
          console.error("Errore caricamento utente:", err);
          userInfoDiv.textContent = "Errore nel controllo dei permessi: " + err.message;
        }
      });

      // === GESTIONE BOTTONI E SELECT ===
      const btnCancel = document.getElementById('btnCancel');
      const btnCheckCoverage = document.getElementById('btnCheckCoverage');
      const btnNext = document.getElementById('btnNext');
      const tipoPraticaGroup = document.getElementById('tipoPraticaGroup');
      const tipoPraticaSelect = document.getElementById('tipoPratica');

      btnCancel.addEventListener('click', () => {
        window.location.href = "FTHUBAS.html";
      });

      btnCheckCoverage.addEventListener('click', async () => {
        await handleCheckCoverage();
      });

      tipoPraticaSelect.addEventListener('change', () => {
        btnNext.disabled = !tipoPraticaSelect.value;
      });

      btnNext.addEventListener('click', () => {
        const vin = document.getElementById('vinInput').value.trim().toUpperCase();
        const dataOrdineStr = document.getElementById('dataOrdineInput').value;
        const tipoPratica = tipoPraticaSelect.value;

        if (!tipoPratica) {
          alert("Seleziona una tipologia di pratica.");
          return;
        }

        const claimState = {
          vin,
          dataOrdine: dataOrdineStr,
          tipoPratica
        };
        sessionStorage.setItem("currentClaimStep1", JSON.stringify(claimState));

        window.location.href = "FTCLAIMS_STEP2.html";
      });

      function resetTipoPratica() {
        tipoPraticaSelect.innerHTML = "";
        tipoPraticaGroup.style.display = "none";
        btnNext.style.display = "none";
        btnNext.disabled = true;
      }

      function populateTipoPraticaOptions(hasWarrantyCoverage, hasMaintenanceCoverage) {
        // hasWarrantyCoverage = FULL LINE o DRIVE LINE attiva
        // hasMaintenanceCoverage = contratto manutenzione attivo

        tipoPraticaSelect.innerHTML = "";

        const addOption = (value, label) => {
          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = label;
          tipoPraticaSelect.appendChild(opt);
        };

        // placeholder
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "-- Seleziona tipologia pratica --";
        placeholder.disabled = true;
        placeholder.selected = true;
        tipoPraticaSelect.appendChild(placeholder);

        // voci sempre disponibili
        addOption("PDI", "PDI");
        addOption("FSA", "FSA");
        addOption("GOODWILL", "Goodwill");
        addOption("SOLO_RSA", "Solo RSA");

        // Reclamo di Garanzia solo se FULL o DRIVE attiva
        if (hasWarrantyCoverage) {
          addOption("RECLAMO_GARANZIA", "Reclamo di Garanzia");
        }

        // Contratto di Manutenzione solo se copertura manutenzione attiva
        if (hasMaintenanceCoverage) {
          addOption("CONTRATTO_MANUTENZIONE", "Contratto di Manutenzione");
        }

        tipoPraticaGroup.style.display = "block";
        btnNext.style.display = "inline-block";
        btnNext.disabled = true;
      }

      // === FUNZIONI SUPPORTO UI ===
      function showMessage(type, text) {
        const area = document.getElementById('resultArea');
        area.style.display = 'block';
        area.className = '';
        if (type === 'error') {
          area.classList.add('error');
        } else if (type === 'success') {
          area.classList.add('success');
        }
        area.innerHTML = text;
      }

      function clearMessage() {
        const area = document.getElementById('resultArea');
        area.style.display = 'none';
        area.className = '';
        area.textContent = '';
      }

      function startOfDay(date) {
        const d = new Date(date);
        d.setHours(0,0,0,0);
        return d;
      }

      function getDateFromField(value) {
        if (!value) return null;
        if (value.toDate && typeof value.toDate === "function") {
          return startOfDay(value.toDate());
        }
        if (typeof value === "string") {
          const d = new Date(value);
          if (!isNaN(d.getTime())) return startOfDay(d);
        }
        if (typeof value === "number") {
          const d = new Date(value);
          if (!isNaN(d.getTime())) return startOfDay(d);
        }
        return null;
      }

      function isDateWithinRange(target, start, end) {
        if (!start || !end) return false;
        const t = startOfDay(target).getTime();
        const s = startOfDay(start).getTime();
        const e = startOfDay(end).getTime();
        return t >= s && t <= e;
      }

      // === LOGICA CONTROLLO COPERTURA ===
      async function handleCheckCoverage() {
        clearMessage();
        resetTipoPratica();

        const vinInput = document.getElementById('vinInput');
        const dataOrdineInput = document.getElementById('dataOrdineInput');

        let vin = vinInput.value.trim().toUpperCase();
        const dataOrdineStr = dataOrdineInput.value;

        if (!vin) {
          showMessage('error', "Inserisci il numero di telaio (VIN).");
          return;
        }
        if (!dataOrdineStr) {
          showMessage('error', "Inserisci la data di apertura dell'ordine di lavoro.");
          return;
        }

        const dataOrdine = startOfDay(new Date(dataOrdineStr));
        if (isNaN(dataOrdine.getTime())) {
          showMessage('error', "La data inserita non è valida.");
          return;
        }

        const oggi = startOfDay(new Date());
        const minDate = startOfDay(new Date());
        minDate.setDate(minDate.getDate() - 90);

        if (dataOrdine > oggi) {
          showMessage('error', "La data dell'ordine di lavoro non può essere futura.");
          return;
        }

        if (dataOrdine < minDate) {
          showMessage('error', "È possibile aprire una pratica solo entro 90 giorni dalla data dell'ordine di lavoro.");
          return;
        }

        try {
          showMessage('success', "Ricerca del telaio in corso…");
          btnCheckCoverage.disabled = true;

          const snapshot = await db.collection(VIN_COLLECTION)
            .where("vin", "==", vin)
            .limit(1)
            .get();

          console.log("[FTCLAIMS] Query VIN su collezione", VIN_COLLECTION, " → docs:", snapshot.size);

          if (snapshot.empty) {
            showMessage(
              'error',
              "Telaio non trovato nella collezione Firestore '" + VIN_COLLECTION +
              "' (campo 'vin')."
            );
            btnCheckCoverage.disabled = false;
            return;
          }

          const doc = snapshot.docs[0];
          const data = doc.data();
          console.log("[FTCLAIMS] Documento VIN:", doc.id, data);

          // Mappatura ai campi reali:
          // COMPLETA -> FULL LINE
          const fullStart  = getDateFromField(data.completa_data_start);
          const fullEnd    = getDateFromField(data.completa_data_end);

          // CATENA CINEMATICA -> DRIVE LINE
          const driveStart = getDateFromField(data.catcinematica_data_start);
          const driveEnd   = getDateFromField(data.catcinematica_data_end);

          // CONTRATTO DI MANUTENZIONE
          const maintStart = getDateFromField(data.contratto_data_start);
          const maintEnd   = getDateFromField(data.contratto_data_end);

          const hasFullCoverage  = isDateWithinRange(dataOrdine, fullStart, fullEnd);
          const hasDriveCoverage = isDateWithinRange(dataOrdine, driveStart, driveEnd);
          const hasMaintCoverage = isDateWithinRange(dataOrdine, maintStart, maintEnd);

          const hasWarrantyCoverage = hasFullCoverage || hasDriveCoverage;
          const hasAnyCoverage = hasWarrantyCoverage || hasMaintCoverage;

          // Prepariamo testo riepilogo
          const formatDate = (d) => {
            if (!d) return "-";
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            return `${dd}/${mm}/${yyyy}`;
          };

          let html = `<strong>Telaio:</strong> ${vin}<br>`;
          html += `<strong>Data ordine di lavoro:</strong> ${formatDate(dataOrdine)}<br><br>`;

          if (hasAnyCoverage) {
            html += `<strong>Coperture valide alla data selezionata:</strong><ul>`;
            if (hasFullCoverage) {
              html += `<li>FULL LINE (COMPLETA): dal ${formatDate(fullStart)} al ${formatDate(fullEnd)}</li>`;
            }
            if (hasDriveCoverage) {
              html += `<li>DRIVE LINE (CAT. CINEMATICA): dal ${formatDate(driveStart)} al ${formatDate(driveEnd)}</li>`;
            }
            if (hasMaintCoverage) {
              html += `<li>CONTRATTO DI MANUTENZIONE: dal ${formatDate(maintStart)} al ${formatDate(maintEnd)}</li>`;
            }
            html += `</ul>`;
            html += `<br>Seleziona la tipologia di pratica dal menu sottostante.`;
          } else {
            html += `<strong>Alla data selezionata non risulta alcuna copertura FULL LINE, DRIVE LINE o CONTRATTO DI MANUTENZIONE attiva per questo telaio.</strong>`;
            html += `<br><br>Puoi comunque procedere selezionando una delle tipologie disponibili (PDI, FSA, Goodwill, Solo RSA).`;
          }

          showMessage('success', html);

          // Popoliamo il menu a tendina in base alle coperture
          populateTipoPraticaOptions(hasWarrantyCoverage, hasMaintCoverage);

          btnCheckCoverage.disabled = false;

        } catch (err) {
          console.error("Errore durante il controllo copertura:", err);
          showMessage('error', "Errore durante il controllo della copertura: " + err.message);
          btnCheckCoverage.disabled = false;
          resetTipoPratica();
        }
      }
    })();
  </script>
</body>
</html>
