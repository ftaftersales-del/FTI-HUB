<!DOCTYPE html>
<html lang="it" data-ft-title="FTCIRCAS - Circolari">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FTCIRCAS - Circolari</title>

  <link rel="stylesheet" href="ftstyle.css">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    /* ===============================
       FTCIRCAS - Stili specifici pagina
       =============================== */

    .ftcircas-wrap{
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .page-head h2{
      margin: 0;
      letter-spacing: -0.2px;
    }

    .muted{
      color: var(--muted);
      font-size: 13px;
    }

    .grid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    .panel h3{
      margin: 0 0 10px 0;
      font-size: 15px;
      letter-spacing: -0.1px;
    }

    .folders{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 55vh;
      overflow:auto;
      padding-right:4px;
    }
    .folder{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      cursor: pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      background: #fff;
      transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
    }
    .folder:hover{ box-shadow: var(--shadow); }
    .folder.active{
      border-color: rgba(0,52,120,.35);
      background: rgba(0,94,220,.06);
    }

    .badge-soft{
      background: #f1f5f9;
      color: var(--text);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid var(--border);
      white-space: nowrap;
    }

    .row-inline{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .col{ flex:1; min-width:200px; }
    .col.small{ max-width:220px; }

    .sep{
      border: none;
      border-top: 1px solid var(--border);
      margin: 12px 0;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .circular{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: #fff;
      box-shadow: var(--shadow);
    }

    /* ===== Accordion circolari ===== */
    .circ-body{ display:none; margin-top: 10px; }
    .circular.is-open .circ-body{ display:block; }

    .circ-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .circ-number{
      font-weight: 900;
      letter-spacing: -0.1px;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .text{
      margin-top: 10px;
      white-space: pre-wrap;
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      line-height: 1.45;
      color: var(--text);
    }

    .attachments{
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .attachments ul{
      margin: 6px 0 0 0;
      padding-left: 18px;
    }
    .attachments li{ margin: 3px 0; }

    .actions{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .smallnote{
      font-size: 12px;
      color: var(--muted);
    }

    .hidden{ display:none; }

    .toast{
      padding: 10px 12px;
      background: #0f172a;
      color: #fff;
      border-radius: 14px;
      position: fixed;
      bottom: 16px;
      right: 16px;
      max-width: min(520px, calc(100% - 32px));
      box-shadow: 0 14px 34px rgba(15, 23, 42, 0.20);
      display:none;
      z-index: 9999;
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-wrap;
      border: 1px solid rgba(255,255,255,.08);
    }
  </style>
</head>

<body class="ft-page">
  <div class="ft-container ftcircas-wrap">
    <div class="card pad">

      <div class="page-head">
        <div>
          <h2>FTCIRCAS - Circolari</h2>
          <div class="muted" id="userLine">Caricamento utente...</div>
        </div>
      </div>

      <div class="grid">

        <!-- Sidebar cartelle -->
        <div class="panel">
          <h3>Cartelle</h3>
          <div class="muted">Clicca per filtrare. “Tutte” mostra tutto.</div>
          <div style="height:10px"></div>

          <div class="folders" id="foldersList"></div>

          <div id="folderCreateBox" class="hidden">
            <hr class="sep">
            <h3>Crea cartella</h3>

            <label>Nome cartella</label>
            <input id="newFolderName" type="text" placeholder="Es. Tecniche, Commerciali, Garanzia..." />

            <div style="height:10px"></div>
            <button class="btn btn-primary" onclick="createFolder()">Crea cartella</button>
          </div>
        </div>

        <!-- Main -->
        <div class="panel">
          <h3>Ricerca e filtri</h3>

          <div class="row-inline">
            <div class="col">
              <label>Ricerca (numero, testo, cartella)</label>
              <input id="searchInput" type="text" placeholder="Es. FT-2025-001, parola nel testo..." oninput="applyFilters()" />
            </div>

            <div class="col small">
              <label>Cartella</label>
              <select id="folderFilter" onchange="applyFilters()"></select>
            </div>

            <div class="col small">
              <label>Dal</label>
              <input id="dateFrom" type="date" onchange="applyFilters()" />
            </div>

            <div class="col small">
              <label>Al</label>
              <input id="dateTo" type="date" onchange="applyFilters()" />
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="muted" id="resultsInfo"></div>

          <div id="circularCreateBox" class="hidden">
            <hr class="sep">
            <h3>Pubblica nuova circolare (solo Distributore)</h3>

            <div class="row-inline">
              <div class="col small">
                <label>Numero circolare</label>
                <input id="cNumber" type="text" placeholder="FT-2025-001" />
              </div>
              <div class="col small">
                <label>Data pubblicazione</label>
                <input id="cPublishDate" type="date" />
              </div>
              <div class="col">
                <label>Cartella</label>
                <select id="cFolder"></select>
              </div>
            </div>

            <div style="height:10px"></div>

            <label>Testo circolare</label>
            <textarea id="cText" placeholder="Scrivi qui il testo della circolare..."></textarea>

            <div style="height:10px"></div>

            <label>Allegati (PDF o ZIP, max 100MB ciascuno)</label>
            <input id="cFiles" type="file" multiple accept=".pdf,.zip,application/pdf,application/zip,application/x-zip-compressed" />

            <div class="actions" style="margin-top:10px">
              <button class="btn btn-primary" id="btnPublish" onclick="publishCircular()">Pubblica circolare</button>
              <span class="smallnote" id="publishStatus"></span>
            </div>
          </div>

          <hr class="sep">

          <h3>Circolari</h3>
          <div class="list" id="circularsList"></div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const storage = firebase.storage();

    let currentUser = null;
    let currentUserData = null;

    let folders = [];      // [{id, name}]
    let circulars = [];    // [{id, ...data}]
    let filtered = [];

    let selectedFolderId = "ALL";

    function toast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => (t.style.display = "none"), 3500);
    }

    function isDistributor() {
      return !!(currentUserData && currentUserData.isDistributorUser === true);
    }

    function formatDateIT(ts) {
      try {
        const d = ts && ts.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if (!d) return "-";
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      } catch (e) {
        return "-";
      }
    }

    function parseDateInputToTimestamp(value) {
      if (!value) return null;
      const d = new Date(value + "T00:00:00");
      return firebase.firestore.Timestamp.fromDate(d);
    }

    function normalizeText(s) {
      return (s || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "");
    }

    async function loadUser(user) {
      const snap = await db.collection("Users").doc(user.uid).get();
      if (!snap.exists) throw new Error("Profilo utente non trovato in /Users");

      currentUserData = snap.data();
      currentUser = user;

      const dealerId = currentUserData.dealerId || "-";
      const role = currentUserData.role || "-";

      document.getElementById("userLine").textContent =
        `Utente: ${currentUser.email} • DealerID: ${dealerId} • Ruolo: ${role}${isDistributor() ? " • Distributore" : ""}`;

      document.getElementById("folderCreateBox").classList.toggle("hidden", !isDistributor());
      document.getElementById("circularCreateBox").classList.toggle("hidden", !isDistributor());
    }

    async function loadFolders() {
      const snap = await db.collection("CircularFolders").orderBy("name", "asc").get();
      folders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderFolders();
      fillFolderSelects();
    }

    async function loadCirculars() {
      const snap = await db.collection("Circulars").orderBy("publishDate", "desc").get();
      circulars = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilters();
    }

    function fillFolderSelects() {
      const ff = document.getElementById("folderFilter");
      ff.innerHTML = "";

      const optAll = document.createElement("option");
      optAll.value = "ALL";
      optAll.textContent = "Tutte";
      ff.appendChild(optAll);

      for (const f of folders) {
        const o = document.createElement("option");
        o.value = f.id;
        o.textContent = f.name || f.id;
        ff.appendChild(o);
      }

      const cf = document.getElementById("cFolder");
      if (cf) {
        cf.innerHTML = "";

        const o0 = document.createElement("option");
        o0.value = "";
        o0.textContent = "Seleziona cartella...";
        cf.appendChild(o0);

        for (const f of folders) {
          const o = document.createElement("option");
          o.value = f.id;
          o.textContent = f.name || f.id;
          cf.appendChild(o);
        }
      }
    }

    function renderFolders() {
      const root = document.getElementById("foldersList");
      root.innerHTML = "";

      const countByFolder = {};
      for (const c of circulars) {
        const fid = c.folderId || "NONE";
        countByFolder[fid] = (countByFolder[fid] || 0) + 1;
      }

      const all = document.createElement("div");
      all.className = "folder" + (selectedFolderId === "ALL" ? " active" : "");
      all.onclick = () => {
        selectedFolderId = "ALL";
        document.getElementById("folderFilter").value = "ALL";
        applyFilters();
        renderFolders();
      };
      all.innerHTML = `<div><strong>Tutte</strong></div><div class="badge-soft">${circulars.length}</div>`;
      root.appendChild(all);

      for (const f of folders) {
        const el = document.createElement("div");
        el.className = "folder" + (selectedFolderId === f.id ? " active" : "");
        const cnt = countByFolder[f.id] || 0;

        el.onclick = () => {
          selectedFolderId = f.id;
          document.getElementById("folderFilter").value = f.id;
          applyFilters();
          renderFolders();
        };

        el.innerHTML = `<div><strong>${(f.name || f.id)}</strong></div><div class="badge-soft">${cnt}</div>`;
        root.appendChild(el);
      }
    }

    function applyFilters() {
      const q = normalizeText(document.getElementById("searchInput").value);
      const folderSel = document.getElementById("folderFilter").value || "ALL";
      const df = document.getElementById("dateFrom").value;
      const dt = document.getElementById("dateTo").value;

      const fromTs = df ? new Date(df + "T00:00:00").getTime() : null;
      const toTs   = dt ? new Date(dt + "T23:59:59").getTime() : null;

      filtered = circulars.filter(c => {
        const folderOk = (folderSel === "ALL") ? true : (c.folderId === folderSel);
        if (!folderOk) return false;

        const pub = c.publishDate && c.publishDate.toDate ? c.publishDate.toDate().getTime() : null;
        if (fromTs && pub && pub < fromTs) return false;
        if (toTs && pub && pub > toTs) return false;

        if (!q) return true;

        const hay = normalizeText(
          (c.number || "") + " " +
          (c.folderName || "") + " " +
          (c.text || "")
        );
        return hay.includes(q);
      });

      document.getElementById("resultsInfo").textContent =
        `Risultati: ${filtered.length} / ${circulars.length}`;

      renderCirculars();
    }

    async function renderCirculars() {
      const root = document.getElementById("circularsList");
      root.innerHTML = "";

      const url = new URL(window.location.href);
      const targetId = url.searchParams.get("circular");

      for (const c of filtered) {
        const box = document.createElement("div");
        box.className = "circular";
        box.id = "circ_" + c.id;

        const head = document.createElement("div");
        head.className = "circ-row";

        const num = document.createElement("div");
        num.className = "circ-number";
        num.textContent = c.number || c.id;

        const right = document.createElement("div");
        right.className = "actions";

        const btnToggle = document.createElement("button");
        btnToggle.className = "btn";
        btnToggle.setAttribute("data-role", "toggle");
        btnToggle.textContent = "Apri dettaglio";
        btnToggle.onclick = () => toggleCircular(c.id, true);
        right.appendChild(btnToggle);

        if (isDistributor()) {
          const btnDel = document.createElement("button");
          btnDel.className = "btn danger";
          btnDel.textContent = "Elimina circolare";
          btnDel.onclick = () => deleteCircular(c.id);
          right.appendChild(btnDel);
        }

        head.appendChild(num);
        head.appendChild(right);

        const body = document.createElement("div");
        body.className = "circ-body";
        body.innerHTML = `
          <div class="meta">Pubblicazione: ${formatDateIT(c.publishDate)} • Cartella: ${c.folderName || "-"}</div>
          <div class="text"></div>
          <div class="attachments">
            <div><strong>Allegati</strong> <span class="smallnote">(clicca per scaricare)</span></div>
            <ul id="att_${c.id}"><li class="smallnote">Caricamento...</li></ul>
          </div>
        `;
        body.querySelector(".text").textContent = c.text || "";

        box.appendChild(head);
        box.appendChild(body);
        root.appendChild(box);

        loadAttachmentsInto(c.id);

        if (targetId && targetId === c.id) {
          setTimeout(() => toggleCircular(c.id, false), 150);
        }
      }

      if (!filtered.length) {
        root.innerHTML = `<div class="muted">Nessuna circolare trovata con i filtri attuali.</div>`;
      }
    }

    function toggleCircular(id, userClick) {
      const el = document.getElementById("circ_" + id);
      if (!el) return;

      const btn = el.querySelector('.actions [data-role="toggle"]');
      const isOpen = el.classList.contains("is-open");

      if (isOpen) {
        el.classList.remove("is-open");
        if (btn) btn.textContent = "Apri dettaglio";
        if (userClick) clearCircularParamIfMatches(id);
        return;
      }

      // Chiudi tutte le altre (accordion one-open)
      document.querySelectorAll("#circularsList .circular.is-open").forEach((other) => {
        if (other.id === ("circ_" + id)) return;

        other.classList.remove("is-open");
        const b = other.querySelector('.actions [data-role="toggle"]');
        if (b) b.textContent = "Apri dettaglio";
      });

      el.classList.add("is-open");
      if (btn) btn.textContent = "Chiudi";

      setCircularParam(id);
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function setCircularParam(id) {
      const url = new URL(window.location.href);
      url.searchParams.set("circular", id);
      history.replaceState({}, "", url.toString());
    }

    function clearCircularParamIfMatches(id) {
      const url = new URL(window.location.href);
      if (url.searchParams.get("circular") === id) {
        url.searchParams.delete("circular");
        history.replaceState({}, "", url.toString());
      }
    }

    async function loadAttachmentsInto(circularId) {
      const ul = document.getElementById("att_" + circularId);
      if (!ul) return;

      ul.innerHTML = `<li class="smallnote">Caricamento...</li>`;
      try {
        const snap = await db.collection("Circulars").doc(circularId).collection("attachments").orderBy("uploadedAt", "asc").get();

        if (snap.empty) {
          ul.innerHTML = `<li class="smallnote">Nessun allegato.</li>`;
          return;
        }

        ul.innerHTML = "";
        for (const d of snap.docs) {
          const a = d.data();
          const li = document.createElement("li");

          const link = document.createElement("a");
          link.href = "#";
          link.textContent = a.name || "Allegato";
          link.onclick = async (ev) => {
            ev.preventDefault();
            try {
              const url = await storage.ref(a.storagePath).getDownloadURL();
              window.open(url, "_blank");
            } catch (e) {
              alert("Impossibile scaricare: " + e.message);
            }
          };
          li.appendChild(link);

          if (isDistributor()) {
            const del = document.createElement("button");
            del.className = "btn danger";
            del.style.marginLeft = "10px";
            del.style.padding = "6px 10px";
            del.textContent = "Elimina";
            del.onclick = () => deleteAttachment(circularId, d.id, a.storagePath);
            li.appendChild(del);
          }

          ul.appendChild(li);
        }
      } catch (e) {
        console.error(e);
        ul.innerHTML = `<li class="smallnote">Errore caricamento allegati: ${e.message}</li>`;
      }
    }

    async function createFolder() {
      const name = (document.getElementById("newFolderName").value || "").trim();
      if (name.length < 2) return alert("Nome cartella troppo corto.");

      try {
        await db.collection("CircularFolders").add({
          name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdByUid: currentUser.uid,
          createdByName: currentUserData.displayName || ""
        });

        document.getElementById("newFolderName").value = "";
        toast("Cartella creata.");
        await loadFolders();
      } catch (e) {
        console.error(e);
        alert("Errore creazione cartella: " + e.message);
      }
    }

    function validateCircularNumber(num) {
      return /^FT-\d{4}-\d{3}$/.test(num);
    }

    async function publishCircular() {
      const btn = document.getElementById("btnPublish");
      const status = document.getElementById("publishStatus");

      const number = (document.getElementById("cNumber").value || "").trim().toUpperCase();
      const dateStr = document.getElementById("cPublishDate").value;
      const folderId = document.getElementById("cFolder").value;
      const text = (document.getElementById("cText").value || "").trim();
      const files = document.getElementById("cFiles").files;

      if (!validateCircularNumber(number)) return alert("Numero circolare non valido. Formato richiesto: FT-2025-001");
      if (!dateStr) return alert("Seleziona la data di pubblicazione.");
      if (!folderId) return alert("Seleziona una cartella.");
      if (!text) return alert("Inserisci il testo della circolare.");

      const publishDate = parseDateInputToTimestamp(dateStr);
      const folder = folders.find(f => f.id === folderId);
      const folderName = folder ? (folder.name || folder.id) : "";

      for (const file of files) {
        const okType = (file.type === "application/pdf" || file.type === "application/zip" || file.type === "application/x-zip-compressed");
        const okExt = file.name.toLowerCase().endsWith(".pdf") || file.name.toLowerCase().endsWith(".zip");
        if (!okType && !okExt) return alert("Sono ammessi solo PDF o ZIP.");
        if (file.size >= 100 * 1024 * 1024) return alert("Un allegato supera i 100MB: " + file.name);
      }

      btn.disabled = true;
      status.textContent = "Pubblicazione in corso...";

      try {
        const circularRef = db.collection("Circulars").doc(number);

        const existing = await circularRef.get();
        if (existing.exists) {
          btn.disabled = false;
          status.textContent = "";
          return alert("Esiste già una circolare con questo numero (univoco).");
        }

        await circularRef.set({
          number,
          publishDate,
          folderId,
          folderName,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdByUid: currentUser.uid,
          createdByName: currentUserData.displayName || "",
          requiresAck: true,
        });

        if (files && files.length) {
          status.textContent = `Caricamento allegati (0/${files.length})...`;
          let i = 0;

          for (const file of files) {
            i += 1;
            const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
            const path = `circulars/${number}/${Date.now()}_${safeName}`;

            await storage.ref(path).put(file);

            await circularRef.collection("attachments").add({
              name: file.name,
              storagePath: path,
              size: file.size,
              contentType: file.type || "",
              uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
              uploadedByUid: currentUser.uid,
              uploadedByName: currentUserData.displayName || ""
            });

            status.textContent = `Caricamento allegati (${i}/${files.length})...`;
          }
        }

        document.getElementById("cNumber").value = "";
        document.getElementById("cPublishDate").value = "";
        document.getElementById("cFolder").value = "";
        document.getElementById("cText").value = "";
        document.getElementById("cFiles").value = "";

        toast("Circolare pubblicata.");
        status.textContent = "";

        await loadCirculars();
        renderFolders();

      } catch (e) {
        console.error(e);
        alert("Errore pubblicazione: " + e.message);
        status.textContent = "";
      } finally {
        btn.disabled = false;
      }
    }

    async function deleteAttachment(circularId, attDocId, storagePath) {
      if (!confirm("Eliminare questo allegato?")) return;

      try {
        if (storagePath) await storage.ref(storagePath).delete();
        await db.collection("Circulars").doc(circularId).collection("attachments").doc(attDocId).delete();
        toast("Allegato eliminato.");
        loadAttachmentsInto(circularId);
      } catch (e) {
        console.error(e);
        alert("Errore eliminazione allegato: " + e.message);
      }
    }

    async function deleteCircular(circularId) {
      if (!confirm(`Eliminare la circolare ${circularId}?\nVerranno eliminati anche gli allegati.`)) return;

      try {
        const cRef = db.collection("Circulars").doc(circularId);

        const attSnap = await cRef.collection("attachments").get();
        for (const d of attSnap.docs) {
          const a = d.data();
          if (a.storagePath) {
            try { await storage.ref(a.storagePath).delete(); } catch (e) { console.warn("delete storage fail", e); }
          }
          await d.ref.delete();
        }

        const ackSnap = await cRef.collection("ack").get();
        for (const d of ackSnap.docs) await d.ref.delete();

        await cRef.delete();

        toast("Circolare eliminata.");
        await loadCirculars();
        renderFolders();
      } catch (e) {
        console.error(e);
        alert("Errore eliminazione circolare: " + e.message);
      }
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "/FTI-HUB/index.html";
        return;
      }
      try {
        await loadUser(user);
        await loadFolders();
        await loadCirculars();
        renderFolders();
      } catch (e) {
        console.error(e);
        alert("Errore caricamento FTCIRCAS: " + e.message);
      }
    });
  </script>

  <!-- Topbar globale (inject + spacer) -->
  <script src="ft-topbar.js"></script>
</body>
</html>
