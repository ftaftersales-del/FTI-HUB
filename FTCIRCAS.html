<!DOCTYPE html>
<html lang="it" data-ft-title="FTCIRCAS - Circolari">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FTCIRCAS - Circolari</title>

  <!-- Stile globale HUB -->
  <link rel="stylesheet" href="ftstyle.css">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    /* ===============================
       FTCIRCAS – layout locale
       (NO colori globali)
       =============================== */

    .ftcircas-wrap{ max-width:1200px; margin:0 auto; }

    .page-head{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .page-head h2{ margin:0; }

    #userLine{ display:none !important; }

    .grid{
      display:grid;
      grid-template-columns:300px 1fr;
      gap:14px;
    }
    @media(max-width:980px){
      .grid{ grid-template-columns:1fr; }
    }

    .folders{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:55vh;
      overflow:auto;
    }

    .folder{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:.15s;
    }
    .folder:hover{ box-shadow:var(--shadow); }
    .folder.active{
      border-color:rgba(0,52,120,.35);
      background:rgba(0,94,220,.06);
    }

    .row-inline{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .col{ flex:1; min-width:200px; }
    .col.small{ max-width:220px; }

    .list{ display:flex; flex-direction:column; gap:10px; }

    .circular{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
    }

    .circ-body{ display:none; margin-top:10px; }
    .circular.is-open .circ-body{ display:block; }

    .circ-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .circ-number{ font-weight:900; }

    .meta{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }

    .text{
      margin-top:10px;
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      white-space:pre-wrap;
    }

    .attachments{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:10px;
    }
    .attachments ul{ margin:6px 0 0; padding-left:18px; }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    .toast{
      position:fixed;
      bottom:16px;
      right:16px;
      background:#0f172a;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      display:none;
      z-index:9999;
      font-size:13px;
      max-width:min(520px,calc(100% - 32px));
    }
  </style>
</head>

<body class="ft-page">
  <div class="ft-container ftcircas-wrap">
    <div class="card pad">

      <div class="page-head">
        <div>
          <h2>FTCIRCAS - Circolari</h2>
          <div id="userLine" class="muted">Caricamento utente…</div>
        </div>
      </div>

      <div class="grid">

        <!-- SIDEBAR -->
        <div class="panel">
          <h3>Cartelle</h3>
          <div class="muted">Clicca per filtrare. “Tutte” mostra tutto.</div>
          <div style="height:10px"></div>

          <div id="foldersList" class="folders"></div>

          <div id="folderCreateBox" class="hidden">
            <hr class="sep">
            <h3>Crea cartella</h3>

            <label>Nome cartella</label>
            <input id="newFolderName" type="text" placeholder="Es. Tecniche, Commerciali, Garanzia…">

            <div style="height:10px"></div>
            <button class="btn btn-primary" onclick="createFolder()">Crea cartella</button>
          </div>
        </div>

        <!-- MAIN -->
        <div class="panel">
          <h3>Ricerca e filtri</h3>

          <div class="row-inline">
            <div class="col">
              <label>Ricerca</label>
              <input id="searchInput" type="text" oninput="applyFilters()">
            </div>
            <div class="col small">
              <label>Cartella</label>
              <select id="folderFilter" onchange="applyFilters()"></select>
            </div>
            <div class="col small">
              <label>Dal</label>
              <input id="dateFrom" type="date" onchange="applyFilters()">
            </div>
            <div class="col small">
              <label>Al</label>
              <input id="dateTo" type="date" onchange="applyFilters()">
            </div>
          </div>

          <div style="height:10px"></div>
          <div id="resultsInfo" class="muted"></div>

          <div id="circularCreateBox" class="hidden">
            <hr class="sep">
            <h3>Pubblica nuova circolare (solo Distributore)</h3>

            <div class="row-inline">
              <div class="col small">
                <label>Numero</label>
                <input id="cNumber" type="text">
              </div>
              <div class="col small">
                <label>Data</label>
                <input id="cPublishDate" type="date">
              </div>
              <div class="col">
                <label>Cartella</label>
                <select id="cFolder"></select>
              </div>
            </div>

            <div style="height:10px"></div>
            <label>Testo</label>
            <textarea id="cText"></textarea>

            <div style="height:10px"></div>
            <label>Allegati (PDF / ZIP)</label>
            <input id="cFiles" type="file" multiple>

            <div class="actions" style="margin-top:10px">
              <button id="btnPublish" class="btn btn-primary" onclick="publishCircular()">Pubblica</button>
              <span id="publishStatus" class="muted"></span>
            </div>
          </div>

          <hr class="sep">
          <h3>Circolari</h3>
          <div id="circularsList" class="list"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ===============================
       SCRIPT
       =============================== -->
  <script>
    const storage = firebase.storage();
    let currentUser, currentUserData;
    let folders = [], circulars = [], filtered = [];
    let selectedFolderId = "ALL";

    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toast);
      window.__toast = setTimeout(()=>t.style.display="none",3500);
    }

    function isDistributor(){
      return !!(currentUserData && currentUserData.isDistributorUser);
    }

    function setTopbar(text){
      if (window.FTTopbar?.setMeta) FTTopbar.setMeta(text);
      else if (window.FTSetUserInfo) FTSetUserInfo(text);
      else window.dispatchEvent(new CustomEvent("ft:setMeta",{detail:{text}}));
    }

    async function loadUser(user){
      const snap = await db.collection("Users").doc(user.uid).get();
      currentUserData = snap.data();
      currentUser = user;

      const info =
        `Utente: ${user.email} • DealerID: ${currentUserData.dealerId || "-"} • Ruolo: ${currentUserData.role || "-"}`;

      setTopbar(info);
      document.getElementById("folderCreateBox").classList.toggle("hidden", !isDistributor());
      document.getElementById("circularCreateBox").classList.toggle("hidden", !isDistributor());
    }

    async function loadFolders(){
      const snap = await db.collection("CircularFolders").orderBy("name").get();
      folders = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderFolders();
      fillFolderSelects();
    }

    async function loadCirculars(){
      const snap = await db.collection("Circulars").orderBy("publishDate","desc").get();
      circulars = snap.docs.map(d=>({id:d.id,...d.data()}));
      applyFilters();
    }

    function fillFolderSelects(){
      const f = document.getElementById("folderFilter");
      const c = document.getElementById("cFolder");
      f.innerHTML = `<option value="ALL">Tutte</option>`;
      c.innerHTML = `<option value="">Seleziona cartella…</option>`;
      folders.forEach(x=>{
        f.innerHTML += `<option value="${x.id}">${x.name}</option>`;
        c.innerHTML += `<option value="${x.id}">${x.name}</option>`;
      });
    }

    function renderFolders(){
      const root = document.getElementById("foldersList");
      root.innerHTML = "";

      const make = (id,name,count)=> {
        const d = document.createElement("div");
        d.className = "folder" + (selectedFolderId===id?" active":"");
        d.onclick = ()=>{ selectedFolderId=id; document.getElementById("folderFilter").value=id; applyFilters(); };
        d.innerHTML = `<strong>${name}</strong><span>${count}</span>`;
        root.appendChild(d);
      };

      make("ALL","Tutte",circulars.length);
      folders.forEach(f=>make(f.id,f.name,circulars.filter(c=>c.folderId===f.id).length));
    }

    function applyFilters(){
      const q = document.getElementById("searchInput").value.toLowerCase();
      const fid = document.getElementById("folderFilter").value;
      filtered = circulars.filter(c=>{
        if (fid!=="ALL" && c.folderId!==fid) return false;
        if (!q) return true;
        return (c.number||"").toLowerCase().includes(q) || (c.text||"").toLowerCase().includes(q);
      });
      document.getElementById("resultsInfo").textContent =
        `Risultati: ${filtered.length} / ${circulars.length}`;
      renderCirculars();
    }

    function renderCirculars(){
      const root = document.getElementById("circularsList");
      root.innerHTML = "";
      if (!filtered.length){
        root.innerHTML = `<div class="muted">Nessuna circolare trovata.</div>`;
        return;
      }
      filtered.forEach(c=>{
        const box = document.createElement("div");
        box.className = "circular";
        box.innerHTML = `
          <div class="circ-row">
            <div class="circ-number">${c.number}</div>
            <div class="actions">
              <button class="btn" onclick="this.closest('.circular').classList.toggle('is-open')">Apri dettaglio</button>
            </div>
          </div>
          <div class="circ-body">
            <div class="meta">${c.folderName || ""}</div>
            <div class="text">${c.text || ""}</div>
          </div>`;
        root.appendChild(box);
      });
    }

    auth.onAuthStateChanged(async user=>{
      if (!user) return location.href="/FTI-HUB/index.html";
      await loadUser(user);
      await loadFolders();
      await loadCirculars();
    });
  </script>

  <!-- Topbar -->
  <script src="ft-topbar.js"></script>
</body>
</html>
