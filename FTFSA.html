<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FTFSA - Gestione FSA</title>

  <link rel="stylesheet" href="ftstyle.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Page-specific CSS: solo presentazione, nessuna logica -->
  <style>
    body{ overscroll-behavior: none; }

    .page-kicker{
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .page-title{
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.2px;
    }
    .page-subtitle{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }
    .toolbar .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .search-row{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      flex-wrap: wrap;
    }
    .search-row .field{
      flex: 1;
      min-width: 260px;
    }

    .status{
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .message{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
    }
    .message.info{
      background: var(--ok-bg);
      border-color: var(--ok-bd);
      color: var(--ok-tx);
    }
    .message.error{
      background: rgba(255,235,238,.9);
      border-color: rgba(239,154,154,.85);
      color: #b42318;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
      background: #fff;
      border: 1px solid rgba(230,232,240,.92);
      border-radius: 12px;
      overflow: hidden;
    }
    thead th{
      background: rgba(243,245,250,.9);
      font-weight: 900;
      color: var(--text);
      border-bottom: 1px solid rgba(230,232,240,.92);
      padding: 10px 12px;
      text-align:left;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(230,232,240,.92);
      padding: 10px 12px;
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom: none; }
    td.center{ text-align:center; }

    .status-icon{
      font-size: 20px;
      cursor: pointer;
      display: inline-block;
      user-select: none;
      line-height: 1;
    }
    .status-icon.performed::before{
      content: "‚úî";
      color: #2e7d32;
    }
    .status-icon.not-performed::before{
      content: "‚úñ";
      color: #fbc02d;
    }

    .pdf-icon{
      font-size: 18px;
      cursor: pointer;
      user-select: none;
      line-height: 1;
    }
    .pdf-icon::before{ content: "‚ûú"; }

    .footer-buttons{
      margin-top: 16px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Mobile: tabella scrollabile */
    .table-wrap{
      margin-top: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }
    .table-wrap table{ margin-top: 0; min-width: 980px; }

    @media (max-width: 720px){
      .page-title{ font-size: 22px; }
      .toolbar .actions{ width:100%; justify-content:flex-end; }
    }
  </style>
</head>

<body class="ft-page has-topbar">

  <!-- TOPBAR (HOME a destra) -->
  <div class="ft-topbar">
    <div class="ft-topbar__inner">
      <div class="ft-topbar__left">
        <div class="ft-topbar__brand">FTI-HUB</div>
        <div class="ft-topbar__subtitle">FTFSA ‚Ä¢ Campagne FSA</div>
      </div>

      <div class="ft-topbar__center">
        <div id="userInfoTop" class="ft-topbar__userinfo">Utente: -</div>
      </div>

      <div class="ft-topbar__right">
        <a href="FTHUBAS.html" class="ft-home-btn">üè† Home</a>
      </div>
    </div>
  </div>

  <div class="ft-container">
    <div class="card pad">

      <div class="toolbar">
        <div>
          <div class="page-kicker">FTFSA - Gestione FSA</div>
          <h1 class="page-title">Gestione campagne FSA</h1>
          <p class="page-subtitle">
            Cerca per telaio (VIN) e gestisci lo stato ‚ÄúCampagna eseguita‚Äù. Import Excel disponibile.
          </p>
        </div>

        <div class="actions">
          <button id="btnAggiornaFSA" class="btn btn-primary" type="button"
                  onclick="document.getElementById('inputFSAFile').click()">
            Aggiorna FSA
          </button>
          <input type="file" id="inputFSAFile" accept=".xls,.xlsx" style="display:none;">
        </div>
      </div>

      <hr class="sep">

      <div class="section">
        <div class="section-head">
          <div>
            <h3 class="section-title">Ricerca</h3>
            <div class="section-sub">Inserisci il VIN e premi Cerca.</div>
          </div>
        </div>

        <div class="search-row">
          <div class="field">
            <label for="searchTelaio">Telaio (VIN)</label>
            <input type="text" id="searchTelaio" placeholder="Inserisci il telaio (VIN)" />
          </div>
          <div>
            <button id="btnCerca" class="btn btn-primary" type="button">Cerca</button>
          </div>
        </div>

        <div id="searchStatus" class="status"></div>
      </div>

      <div id="messages"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Telaio</th>
              <th>Codice FSA</th>
              <th>Descrizione Campagna</th>
              <th>Data Inizio</th>
              <th>Data Fine</th>
              <th>Tipologia</th>
              <th>Campagna Eseguita</th>
              <th>Documento</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>

      <div class="footer-buttons">
        <button class="btn" type="button" onclick="window.location.href='FTHUBAS.html'">
          Torna a FTHUBAS
        </button>
      </div>

    </div>
  </div>

  <script>
    /* ========= Auth (solo UI: mostra utente in topbar) ========= */
    (function initAuthBanner(){
      try{
        if (typeof auth === "undefined" || !auth) return;
        const el = document.getElementById("userInfoTop");
        auth.onAuthStateChanged((user)=>{
          if (!el) return;
          if (!user) el.textContent = "Utente: non loggato";
          else el.textContent = "Utente: " + (user.email || user.uid);
        });
      }catch(e){
        console.warn("Auth banner non inizializzato:", e);
      }
    })();

    /* ========= Utility messaggi ========= */
    function showMessage(text, type = "info") {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      if (!text) return;

      const p = document.createElement("div");
      p.className = "message " + type;
      p.textContent = text;
      messagesDiv.appendChild(p);
    }

    /* ========= Utility date FSA ========= */
    function excelSerialToDateString(serial) {
      if (serial == null || serial === "") return "";
      const n = Number(serial);
      if (isNaN(n)) return String(serial);

      const base = new Date(Date.UTC(1899, 11, 30));
      const date = new Date(base.getTime() + n * 86400000);

      const day   = String(date.getUTCDate()).padStart(2, "0");
      const month = String(date.getUTCMonth() + 1).padStart(2, "0");
      const year  = date.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }

    function formatFsaDate(value) {
      if (value == null || value === "") return "";

      if (typeof value === "number") return excelSerialToDateString(value);

      if (typeof value === "string" && /^[0-9]+$/.test(value.trim())) {
        return excelSerialToDateString(Number(value.trim()));
      }

      return value;
    }

    /* ========= Lettura Excel ========= */
    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
            resolve(json);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    /* ========= Upload Excel / sostituzione FTFSA ========= */
    const inputFSAFile = document.getElementById("inputFSAFile");
    inputFSAFile.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      if (typeof db === "undefined" || !db) {
        alert("Firestore non inizializzato. Controllare firebase-config.js.");
        return;
      }

      if (!confirm("Questa operazione sostituir√† completamente la banca dati FSA. Vuoi continuare?")) {
        return;
      }

      showMessage("Importazione FSA in corso, attendere...", "info");

      try {
        const data = await readExcelFile(file);
        await replaceFSACollection(data);
        showMessage("Banca dati FSA aggiornata correttamente.", "info");
      } catch (error) {
        console.error("Errore durante l'importazione FSA:", error);
        showMessage("Errore durante l'importazione del file FSA.", "error");
      } finally {
        // reset input per permettere re-upload dello stesso file
        inputFSAFile.value = "";
      }
    });

    async function deleteAllDocsInCollection(collectionName) {
      const snapshot = await db.collection(collectionName).get();
      if (snapshot.empty) return;

      const batchSize = 400;
      let batch = db.batch();
      let count = 0;

      for (const doc of snapshot.docs) {
        batch.delete(doc.ref);
        count++;
        if (count >= batchSize) {
          await batch.commit();
          batch = db.batch();
          count = 0;
        }
      }

      if (count > 0) await batch.commit();
    }

    async function replaceFSACollection(rows) {
      await deleteAllDocsInCollection("FTFSA");

      const batchSize = 400;
      let batch = db.batch();
      let countInBatch = 0;

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];

        const vinRaw = row["Vin No"] || row["VIN No"] || row["VIN"] || row["Vin"] || "";
        const telaio = (vinRaw || "").toString().trim().toUpperCase();

        const codiceFSA = (row["Campaign Code"] || "").toString().trim();
        const descrCamp = (row["Campaign Description"] || "").toString().trim();
        const dataInizioRaw = (row["Starting Date"] || "").toString().trim();
        const dataFineRaw   = (row["End Date"] || "").toString().trim();
        const tipologia = (row["Fsa Type"] || "").toString().trim();

        const performedRaw = (row["Is Performed"] || "").toString().trim().toLowerCase();
        const isPerformed =
          performedRaw === "performed" ||
          performedRaw === "true" ||
          performedRaw === "yes" ||
          performedRaw === "si" ||
          performedRaw === "s√¨";

        if (!telaio && !codiceFSA) continue;

        const docId = telaio && codiceFSA ? (telaio + "_" + codiceFSA) : undefined;
        const docRef = docId ? db.collection("FTFSA").doc(docId) : db.collection("FTFSA").doc();

        const docData = {
          Telaio: telaio,
          CodiceFSA: codiceFSA,
          DescrizioneCampagna: descrCamp,
          DataInizio: dataInizioRaw,
          DataFine: dataFineRaw,
          Tipologia: tipologia,
          IsPerformed: isPerformed,
          pdfUrl: "",
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        batch.set(docRef, docData);
        countInBatch++;

        if (countInBatch >= batchSize) {
          await batch.commit();
          batch = db.batch();
          countInBatch = 0;
        }
      }

      if (countInBatch > 0) await batch.commit();
    }

    /* ========= Ricerca per telaio ========= */
    const btnCerca = document.getElementById("btnCerca");
    const searchTelaioInput = document.getElementById("searchTelaio");

    btnCerca.addEventListener("click", eseguiRicerca);
    searchTelaioInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") eseguiRicerca();
    });

    async function eseguiRicerca() {
      if (typeof db === "undefined" || !db) {
        showMessage("Firestore non inizializzato. Controllare firebase-config.js.", "error");
        return;
      }

      const vinInput = searchTelaioInput.value.trim();
      const searchStatus = document.getElementById("searchStatus");
      const tbody = document.getElementById("resultsBody");

      tbody.innerHTML = "";
      showMessage("");

      if (!vinInput) {
        searchStatus.textContent = "Inserire un telaio per la ricerca.";
        return;
      }

      const telaio = vinInput.toUpperCase();
      searchStatus.textContent = "Ricerca in corso...";

      try {
        const querySnap = await db
          .collection("FTFSA")
          .where("Telaio", "==", telaio)
          .get();

        if (querySnap.empty) {
          searchStatus.textContent = "Nessuna FSA trovata per il telaio inserito.";
          return;
        }

        searchStatus.textContent = `Trovate ${querySnap.size} campagne FSA per il telaio ${telaio}.`;
        renderResults(querySnap.docs);
      } catch (error) {
        console.error("Errore nella ricerca FSA:", error);
        searchStatus.textContent = "Errore durante la ricerca. Riprova.";
        showMessage("Errore durante la ricerca FSA.", "error");
      }
    }

    /* ========= Rendering tabella risultati ========= */
    function renderResults(docs) {
      const tbody = document.getElementById("resultsBody");
      tbody.innerHTML = "";

      docs.forEach((doc) => {
        const data = doc.data();
        const tr = document.createElement("tr");

        const tdTelaio = document.createElement("td");
        tdTelaio.textContent = data.Telaio || "";
        tr.appendChild(tdTelaio);

        const tdCodice = document.createElement("td");
        tdCodice.textContent = data.CodiceFSA || data["Campaign Code"] || "";
        tr.appendChild(tdCodice);

        const tdDescr = document.createElement("td");
        tdDescr.textContent = data.DescrizioneCampagna || data["Campaign Description"] || "";
        tr.appendChild(tdDescr);

        const rawStart = data.DataInizio || data["Starting Date"] || "";
        const rawEnd   = data.DataFine   || data["End Date"]     || "";

        const tdDataInizio = document.createElement("td");
        tdDataInizio.textContent = formatFsaDate(rawStart);
        tr.appendChild(tdDataInizio);

        const tdDataFine = document.createElement("td");
        tdDataFine.textContent = formatFsaDate(rawEnd);
        tr.appendChild(tdDataFine);

        const tdTipo = document.createElement("td");
        tdTipo.textContent = data.Tipologia || data["Fsa Type"] || "";
        tr.appendChild(tdTipo);

        const tdPerf = document.createElement("td");
        tdPerf.className = "center";

        const isPerformed = !!data.IsPerformed;
        const statusSpan = document.createElement("span");
        statusSpan.classList.add("status-icon");
        statusSpan.classList.add(isPerformed ? "performed" : "not-performed");
        statusSpan.dataset.docId = doc.id;
        statusSpan.dataset.value = isPerformed ? "true" : "false";
        statusSpan.title = "Clicca per cambiare stato";

        statusSpan.addEventListener("click", onTogglePerformed);

        tdPerf.appendChild(statusSpan);
        tr.appendChild(tdPerf);

        const tdDoc = document.createElement("td");
        tdDoc.className = "center";

        const pdfSpan = document.createElement("span");
        pdfSpan.classList.add("pdf-icon");
        pdfSpan.dataset.pdfUrl = data.pdfUrl || "";
        pdfSpan.title = "Apri documento";

        pdfSpan.addEventListener("click", () => {
          const url = pdfSpan.dataset.pdfUrl;
          if (url) {
            window.open(url, "_blank");
          } else {
            alert("Nessun documento caricato: contattare il Reparto Garanzia per informazioni");
          }
        });

        tdDoc.appendChild(pdfSpan);
        tr.appendChild(tdDoc);

        tbody.appendChild(tr);
      });
    }

    /* ========= Toggle campo IsPerformed ========= */
    async function onTogglePerformed(event) {
      if (typeof db === "undefined" || !db) {
        alert("Firestore non inizializzato.");
        return;
      }

      const span = event.currentTarget;
      const docId = span.dataset.docId;
      const currentVal = span.dataset.value === "true";
      const newVal = !currentVal;

      try {
        await db.collection("FTFSA").doc(docId).update({ IsPerformed: newVal });

        span.dataset.value = newVal ? "true" : "false";
        span.classList.toggle("performed", newVal);
        span.classList.toggle("not-performed", !newVal);
      } catch (error) {
        console.error("Errore nell'aggiornamento IsPerformed:", error);
        alert("Errore nell'aggiornamento dello stato FSA.");
      }
    }
  </script>
  <script src="ft-topbar.js?v=4"></script>

</body>
</html>
