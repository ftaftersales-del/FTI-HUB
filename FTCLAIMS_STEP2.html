<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTCLAIMS - Dettaglio Claim Card</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
    }

    .container {
      width: 100%;
      margin: 0;
      box-sizing: border-box;
      background: #ffffff;
      padding: 20px 30px 25px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      margin-top: 0;
      margin-bottom: 5px;
    }

    .subtitle {
      margin: 0 0 20px;
      color: #666;
      font-size: 14px;
    }

    .alert {
      padding: 10px 15px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }

    .alert-info {
      background-color: #e8f4ff;
      border: 1px solid #bcdcff;
      color: #24527a;
    }
    .alert-error {
      background-color: #ffe8e8;
      border: 1px solid #ffbcbc;
      color: #7a2424;
    }
    .alert-success {
      background-color: #e8ffec;
      border: 1px solid #bcffca;
      color: #247a3a;
    }

    .main-layout {
      display: flex;
      align-items: flex-start;
      gap: 20px;
    }

    .left-column {
      flex: 0 0 420px;
      max-width: 420px;
    }

    .right-column {
      flex: 1;
      min-width: 0;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px 12px 8px;
      background: #fafafa;
      margin-bottom: 12px;
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-column-gap: 10px;
    }

    .form-group {
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: 11px;
      margin-bottom: 3px;
      color: #555;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 5px 7px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
      background-color: #fff;
    }

    input[readonly],
    input:disabled,
    textarea:disabled {
      background-color: #f1f1f1;
      color: #555;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
    }

    .small-text {
      font-size: 11px;
      color: #777;
    }

    .actions {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .btn {
      padding: 7px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-primary {
      background-color: #007bff;
      color: #fff;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-danger {
      background-color: #dc3545;
      color: #fff;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
    }

    .right-panel {
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fbfbfb;
      padding: 12px;
      min-height: 400px;
    }

    .right-panel-header {
      margin-bottom: 8px;
    }

    .right-panel h3 {
      margin: 0;
      font-size: 15px;
    }

    .right-panel-placeholder {
      font-size: 13px;
      color: #777;
      margin-top: 8px;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .claims-list {
      margin-top: 8px;
    }

    .claim-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 8px 10px;
      margin-bottom: 6px;
      background: #ffffff;
    }

    .claim-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      cursor: pointer;
    }

    .claim-title {
      font-size: 13px;
      font-weight: bold;
    }

    .btn-delete-claim {
      padding: 4px 8px;
      font-size: 11px;
    }

    .claim-details {
      border-top: 1px solid #eee;
      margin-top: 6px;
      padding-top: 6px;
      font-size: 12px;
    }

    .claim-card.collapsed .claim-details {
      display: none;
    }

    @media (max-width: 992px) {
      .main-layout {
        flex-direction: column;
      }
      .left-column {
        max-width: 100%;
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Dettaglio Claim Card</h2>
    <p class="subtitle">Visualizza e gestisci i dati della pratica.</p>

    <div id="messageArea" class="alert alert-info"></div>

    <div class="main-layout">
      <!-- COLONNA SINISTRA -->
      <div class="left-column">

        <!-- Dati pratica -->
        <div class="card">
          <h3>Dati pratica</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="claimCode">Codice pratica</label>
              <input type="text" id="claimCode" readonly>
            </div>
            <div class="form-group">
              <label for="claimCardType">Tipologia</label>
              <input type="text" id="claimCardType" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="openDate">Data apertura</label>
              <input type="date" id="openDate" readonly>
            </div>
            <div class="form-group">
              <label for="orderDate">Data ordine di lavoro</label>
              <input type="date" id="orderDate" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="openUser">Nome operatore apertura</label>
              <input type="text" id="openUser" readonly>
            </div>
            <div class="form-group">
              <label for="openDealer">Dealer apertura</label>
              <input type="text" id="openDealer" readonly>
            </div>
          </div>

          <div class="form-group">
            <label for="claimStatus">Stato pratica</label>
            <select id="claimStatus"></select>
            <div class="small-text">
              Stati: Aperta, Inviata, Sospesa, In Valutazione, Conclusa, Cancellata.
            </div>
          </div>
        </div>

                <!-- Dati veicolo -->
        <div class="card">
          <h3>Dati veicolo</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="vin">VIN</label>
              <input type="text" id="vin" readonly>
            </div>
            <div class="form-group">
              <label for="customer">Customer</label>
              <input type="text" id="customer" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="registrationPlate">Registration Plate</label>
              <input type="text" id="registrationPlate">
            </div>
            <div class="form-group">
              <label for="registrationDate">Registration Date</label>
              <input type="date" id="registrationDate">
            </div>
          </div>
        </div>

        <!-- Copertura garanzia -->
        <div class="card">
          <h3>Copertura garanzia alla data dell'ordine di lavoro</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="coverageType">Tipo copertura</label>
              <input type="text" id="coverageType" readonly>
            </div>
            <div class="form-group">
              <label for="coverageStart">Data inizio</label>
              <input type="date" id="coverageStart" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="coverageEnd">Data fine</label>
              <input type="date" id="coverageEnd" readonly>
            </div>
            <div class="form-group"></div>
          </div>

          <div class="form-group" id="coverageNotesRow">
            <label for="coverageNotes">Note copertura (visibili solo al distributore)</label>
            <textarea id="coverageNotes" disabled></textarea>
          </div>
        </div>

        <!-- Contratto manutenzione -->
        <div class="card">
          <h3>Contratto di manutenzione (se presente)</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="mcStart">Data inizio</label>
              <input type="date" id="mcStart" readonly>
            </div>
            <div class="form-group">
              <label for="mcEnd">Data fine</label>
              <input type="date" id="mcEnd" readonly>
            </div>
          </div>

          <div class="form-group">
            <label for="mcOptions">Opzioni presenti</label>
            <textarea id="mcOptions" readonly></textarea>
          </div>
        </div>

        <!-- KM / Ore -->
        <div class="card">
          <h3>Chilometraggio / ore motore</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="vehicleKm">KM veicolo</label>
              <input type="number" id="vehicleKm" min="0" step="1">
            </div>
            <div class="form-group">
              <label for="engineHours">Ore motore</label>
              <input type="number" id="engineHours" min="0" step="1">
            </div>
          </div>
        </div>

        <!-- Azioni -->
        <div class="actions">
          <button id="btnHome" class="btn btn-secondary">Home Page</button>
          <div>
            <button id="btnSave" class="btn btn-primary">Salva modifiche</button>
            <button id="btnDelete" class="btn btn-danger">Cancella richiesta</button>
          </div>
        </div>

      </div>

      <!-- COLONNA DESTRA -->
      <div class="right-column">
        <div class="right-panel">
          <div class="right-panel-header">
            <h3>Gestione claim collegati alla claim card</h3>
          </div>

          <!-- BOX NUOVO CLAIM -->
          <div class="card" style="margin-bottom: 10px;">
            <div class="card-header-row">
              <h3>Nuovo claim</h3>
              <button id="btnAddRepair" class="btn btn-primary btn-small">Crea claim</button>
            </div>

            <div class="form-group">
              <label for="claimType"><strong>Tipologia claim</strong></label>
              <div id="claimTypeContainer" style="margin-top: 5px; display:none;">
                <select id="claimType"></select>
              </div>
              <input type="hidden" id="fixedClaimType">
              <div class="small-text">
                La lista varia in base alla tipologia della claim card
                (WARRANTY, MAINTENANCE, FSA, GOODWILL).
              </div>
            </div>
          </div>

          <div id="claimsList" class="claims-list"></div>
          <div class="right-panel-placeholder" id="claimsPlaceholder">
            In quest'area verranno gestiti i singoli claim collegati alla stessa claim card.
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Script base -->
  <script src="ftclaims-claims.js?v=3"></script>
  <script src="ftclaims-claimforms.js?v=3"></script>
  <!-- Hook manutenzione: deve stare DOPO claims + claimforms -->
  <script src="ftclaims-maintenance.js?v=1"></script>

  <script>
    window.addEventListener('load', function () {
      if (typeof firebase === 'undefined') {
        console.error('Firebase non Ã¨ definito. Controlla gli script nel <head>.');
        return;
      }

      const auth = firebase.auth();
      const db   = firebase.firestore();

      let currentUser = null;
      let currentClaimId = null;

      // ðŸ‘‡ tipo originale letto da Firestore (es: "Service Contract")
      let currentClaimCardTypeRaw = null;

      // ðŸ‘‡ tipo normalizzato usato per controlli / UI (WARRANTY / MAINTENANCE / FSA / GOODWILL)
      let currentClaimCardType = null;

      let isDistributor = false;
      let currentClaimStatus = null;

      const messageArea = document.getElementById('messageArea');

      function showMessage(text, type) {
        messageArea.textContent = text;
        messageArea.className = 'alert';
        if (type === 'error') messageArea.classList.add('alert-error');
        else if (type === 'success') messageArea.classList.add('alert-success');
        else messageArea.classList.add('alert-info');
        messageArea.style.display = 'block';
      }

      function clearMessage() {
        messageArea.style.display = 'none';
        messageArea.textContent = '';
      }

      function getClaimIdFromContext() {
        let id = null;

        const fromSS = sessionStorage.getItem('ftclaims_claimCode');
        if (fromSS) {
          id = fromSS;
        } else {
          const headerStr = sessionStorage.getItem('currentClaimStep1');
          if (headerStr) {
            try {
              const header = JSON.parse(headerStr);
              if (header && header.claimId) id = header.claimId;
            } catch (e) {
              console.warn('Impossibile leggere currentClaimStep1:', e);
            }
          }
        }

        if (!id) {
          const params = new URLSearchParams(window.location.search);
          id = params.get('id');
        }
        return id;
      }

      // âœ… Normalizza tipo claim card:
      // - "SERVICE CONTRACT" => "MAINTENANCE"
      // - "MANUTENZIONE"     => "MAINTENANCE" (compatibilitÃ  vecchia)
      function normalizeCardTypeForStep2(cardType) {
        const t = (cardType || '').toString().trim().toUpperCase();
        if (t === 'SERVICE CONTRACT') return 'MAINTENANCE';
        if (t === 'MANUTENZIONE') return 'MAINTENANCE';
        return t;
      }

      // âœ… Determina se l'utente Ã¨ distributore:
      // - legge Users/<uid> -> dealerId
      // - poi legge dealers/<dealerId> -> isDistributor
      async function loadUserInfo(user) {
        try {
          const uSnap = await db.collection('Users').doc(user.uid).get();
          if (uSnap.exists) {
            const u = uSnap.data() || {};
            const dealerId =
              u.dealerId || u.dealerID || u.DealerID || u.DealerId || null;

            if (dealerId) {
              const dSnap = await db.collection('dealers').doc(dealerId).get();
              if (dSnap.exists) {
                const d = dSnap.data() || {};
                isDistributor = !!d.isDistributor;
              }
            }
          }
        } catch (err) {
          console.error('Errore caricamento utente/dealer', err);
        }

        const notesRow = document.getElementById('coverageNotesRow');
        if (!isDistributor && notesRow) notesRow.style.display = 'none';
      }

      function getAllowedStatusOptions(status, isDistributorFlag) {
        if (!status) return [];

        if (isDistributorFlag) {
          switch (status) {
            case 'Aperta':         return ['Aperta', 'Inviata', 'Cancellata'];
            case 'Sospesa':        return ['Sospesa', 'Inviata', 'In Valutazione', 'Cancellata'];
            case 'Inviata':        return ['Inviata', 'Sospesa', 'In Valutazione', 'Cancellata'];
            case 'In Valutazione': return ['In Valutazione', 'Sospesa', 'Conclusa', 'Cancellata'];
            case 'Conclusa':       return ['Conclusa', 'In Valutazione', 'Sospesa'];
            case 'Cancellata':     return ['Cancellata'];
            default:               return [status];
          }
        } else {
          switch (status) {
            case 'Aperta':   return ['Aperta', 'Sospesa', 'Inviata', 'Cancellata'];
            case 'Sospesa':  return ['Sospesa', 'Inviata', 'Cancellata'];
            default:         return [status];
          }
        }
      }

      function refreshClaimCardStatusControl() {
        const select = document.getElementById('claimStatus');
        if (!select || !currentClaimStatus) return;

        const options = getAllowedStatusOptions(currentClaimStatus, isDistributor);
        select.innerHTML = '';
        options.forEach(st => {
          const opt = document.createElement('option');
          opt.value = st;
          opt.textContent = st;
          select.appendChild(opt);
        });

        select.value = currentClaimStatus;
        select.disabled = (options.length <= 1);
      }

      function applyStatusLocks() {
        const isLocked =
          currentClaimStatus === 'Conclusa' ||
          currentClaimStatus === 'Cancellata';

        const editableFieldIds = [
          'registrationPlate',
          'registrationDate',
          'vehicleKm',
          'engineHours'
        ];
        editableFieldIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.disabled = isLocked;
        });

        const btnSave = document.getElementById('btnSave');
        if (btnSave) btnSave.disabled = isLocked;

        const btnAddRepair = document.getElementById('btnAddRepair');
        if (btnAddRepair) btnAddRepair.disabled = isLocked;
      }

      async function loadClaimCard() {
        clearMessage();
        currentClaimId = getClaimIdFromContext();

        if (!currentClaimId) {
          showMessage('Errore: nessuna pratica selezionata.', 'error');
          return;
        }

        try {
          const ref = db.collection('ClaimCards').doc(currentClaimId);
          const snap = await ref.get();

          if (!snap.exists) {
            showMessage('La pratica specificata non Ã¨ stata trovata in banca dati.', 'error');
            return;
          }

          const data = snap.data() || {};

          currentClaimCardTypeRaw = (data.type || '').toString().trim();
          currentClaimCardType = normalizeCardTypeForStep2(currentClaimCardTypeRaw);

          document.getElementById('claimCode').value     = data.code || currentClaimId;
          document.getElementById('claimCardType').value = currentClaimCardTypeRaw || currentClaimCardType;

          if (data.openDate)  document.getElementById('openDate').value  = data.openDate;
          if (data.orderDate) document.getElementById('orderDate').value = data.orderDate;

          document.getElementById('openUser').value   = data.openUser || '';
          document.getElementById('openDealer').value = data.openDealer || data.dealerId || '';

          const status = data.status || 'Aperta';
          currentClaimStatus = status;

          const veh = data.vehicle || {};
          document.getElementById('vin').value      = veh.vin || data.vin || '';
          document.getElementById('customer').value = veh.customer || data.customer || '';

          const regPlate = veh.registrationPlate || data.registrationPlate || '';
          const regDate  = veh.registrationDate  || data.registrationDate   || '';

          document.getElementById('registrationPlate').value = regPlate;
          if (regDate) document.getElementById('registrationDate').value = regDate;

          const coverage = data.coverage || {};
          document.getElementById('coverageType').value = coverage.type || '';
          if (coverage.startDate) document.getElementById('coverageStart').value = coverage.startDate;
          if (coverage.endDate)   document.getElementById('coverageEnd').value   = coverage.endDate;
          document.getElementById('coverageNotes').value = coverage.notes || '';

          const mc = data.maintenanceContract || {};
          if (mc.startDate) document.getElementById('mcStart').value = mc.startDate;
          if (mc.endDate)   document.getElementById('mcEnd').value   = mc.endDate;
          document.getElementById('mcOptions').value = mc.options || '';

          const km    = data.km ?? '';
          const hours = data.engineHours ?? '';

          document.getElementById('vehicleKm').value   = km;
          document.getElementById('engineHours').value = hours;

          // âœ… Usa il tipo normalizzato per popolare le tipologie claim
          if (typeof initClaimTypeControls === 'function') {
            initClaimTypeControls(currentClaimCardType, {
              containerId: 'claimTypeContainer',
              selectId: 'claimType',
              fixedId: 'fixedClaimType'
            });
          }

          refreshClaimCardStatusControl();
          applyStatusLocks();

          showMessage('Pratica caricata correttamente.', 'success');

        } catch (err) {
          console.error(err);
          showMessage('Errore nel caricamento della pratica: ' + err.message, 'error');
        }
      }

      async function loadClaims() {
        const list = document.getElementById('claimsList');
        const placeholder = document.getElementById('claimsPlaceholder');
        list.innerHTML = '';

        if (!currentClaimId) return;

        try {
          const snap = await db
            .collection('ClaimCards')
            .doc(currentClaimId)
            .collection('Claims')
            .orderBy('code')
            .get();

          if (snap.empty) {
            placeholder.style.display = 'block';
            return;
          }

          placeholder.style.display = 'none';

          snap.forEach(docSnap => {
            const data = docSnap.data() || {};
            const code = data.code || docSnap.id;
            const type = data.claimType || '';
            const claimStatus = data.status || 'Aperto';

            const card = document.createElement('div');
            card.className = 'claim-card collapsed';

            const header = document.createElement('div');
            header.className = 'claim-card-header';

            const title = document.createElement('div');
            title.className = 'claim-title';
            title.textContent = 'Riparazione ' + code + (type ? ' (' + type + ')' : '');

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'btn btn-secondary btn-small';
            toggleBtn.textContent = 'Mostra dettagli';
            let expanded = false;

            function setExpanded(state) {
              expanded = state;
              if (expanded) {
                card.classList.remove('collapsed');
                toggleBtn.textContent = 'Nascondi dettagli';
              } else {
                card.classList.add('collapsed');
                toggleBtn.textContent = 'Mostra dettagli';
              }
            }

            toggleBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              setExpanded(!expanded);
            });

            const btnDelete = document.createElement('button');
            btnDelete.className = 'btn btn-danger btn-delete-claim btn-small';
            btnDelete.textContent = 'Elimina riparazione';
            btnDelete.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteRepair(code);
            });

            const headerRight = document.createElement('div');
            headerRight.style.display = 'flex';
            headerRight.style.gap = '6px';
            headerRight.style.alignItems = 'center';

            const statusContainer = document.createElement('div');
            statusContainer.style.display = 'flex';
            statusContainer.style.alignItems = 'center';
            statusContainer.style.gap = '4px';

            const statusLabel = document.createElement('span');
            statusLabel.textContent = 'Stato:';
            statusLabel.className = 'small-text';

            const canEditClaimStatus =
              isDistributor && currentClaimStatus === 'In Valutazione' &&
              !(currentClaimStatus === 'Conclusa' || currentClaimStatus === 'Cancellata');

            if (canEditClaimStatus) {
              const statusSelect = document.createElement('select');

              const statusOptions = [
                'Aperto',
                'Inviata',
                'Sospesa',
                'In Valutazione',
                'Conclusa',
                'Cancellata'
              ];

              statusOptions.forEach(st => {
                const opt = document.createElement('option');
                opt.value = st;
                opt.textContent = st;
                statusSelect.appendChild(opt);
              });

              statusSelect.value = claimStatus;

              statusSelect.addEventListener('change', () => {
                const newStatus = statusSelect.value;
                updateSingleClaimStatus(code, newStatus, statusSelect);
              });

              statusContainer.appendChild(statusLabel);
              statusContainer.appendChild(statusSelect);
            } else {
              const statusValue = document.createElement('span');
              statusValue.textContent = claimStatus;
              statusValue.className = 'small-text';

              statusContainer.appendChild(statusLabel);
              statusContainer.appendChild(statusValue);
            }

            headerRight.appendChild(statusContainer);
            headerRight.appendChild(toggleBtn);
            headerRight.appendChild(btnDelete);

            header.appendChild(title);
            header.appendChild(headerRight);

            header.addEventListener('click', (e) => {
              if (e.target === toggleBtn || e.target === btnDelete) return;
              setExpanded(!expanded);
            });

            const details = document.createElement('div');
            details.className = 'claim-details';

            card.appendChild(header);
            card.appendChild(details);
            list.appendChild(card);

            if (typeof renderClaimDetails === 'function') {
              renderClaimDetails(type, details, data, {
                claimCardId: currentClaimId,
                claimCode: code
              });
            }
          });

        } catch (err) {
          console.error(err);
          showMessage('Errore nel caricamento delle riparazioni: ' + err.message, 'error');
        }
      }

      async function updateSingleClaimStatus(claimCode, newStatus, selectEl) {
        if (!currentClaimId || !claimCode) return;

        if (currentClaimStatus === 'Conclusa' || currentClaimStatus === 'Cancellata') {
          showMessage('La pratica Ã¨ ' + currentClaimStatus.toLowerCase() + ': i claim non sono modificabili.', 'error');
          if (selectEl) selectEl.value = selectEl.dataset.oldValue || selectEl.value;
          return;
        }

        if (selectEl) {
          selectEl.disabled = true;
          selectEl.dataset.oldValue = selectEl.dataset.oldValue || selectEl.value;
        }

        try {
          const claimRef = db
            .collection('ClaimCards')
            .doc(currentClaimId)
            .collection('Claims')
            .doc(claimCode);

          await claimRef.update({ status: newStatus });

          showMessage(
            'Stato della riparazione ' + claimCode + ' aggiornato a "' + newStatus + '".',
            'success'
          );
        } catch (err) {
          console.error(err);
          showMessage(
            'Errore nell\'aggiornare lo stato della riparazione: ' + err.message,
            'error'
          );
          if (selectEl) selectEl.value = selectEl.dataset.oldValue || selectEl.value;
        } finally {
          if (selectEl) selectEl.disabled = false;
        }
      }

      async function saveChanges() {
        clearMessage();
        if (!currentClaimId) {
          showMessage('Impossibile salvare: nessuna pratica caricata.', 'error');
          return;
        }

        if (currentClaimStatus === 'Conclusa' || currentClaimStatus === 'Cancellata') {
          showMessage('La pratica Ã¨ ' + currentClaimStatus.toLowerCase() + ': non puÃ² piÃ¹ essere modificata.', 'error');
          return;
        }

        const btnSave = document.getElementById('btnSave');
        btnSave.disabled = true;

        try {
          const regPlate = document.getElementById('registrationPlate').value.trim();
          const regDate  = document.getElementById('registrationDate').value || null;

          const kmRaw = document.getElementById('vehicleKm').value;
          const hRaw  = document.getElementById('engineHours').value;

          const kmVal = kmRaw === '' ? null : Number(kmRaw);
          const hVal  = hRaw === '' ? null : Number(hRaw);

          const updates = {
            registrationPlate: regPlate || null,
            registrationDate:  regDate,
            km: kmVal,
            engineHours: hVal
          };

          await db.collection('ClaimCards').doc(currentClaimId).update(updates);
          showMessage('Salvataggio completato.', 'success');
        } catch (err) {
          console.error(err);
          showMessage('Errore nel salvataggio: ' + err.message, 'error');
        } finally {
          btnSave.disabled = false;
        }
      }

      async function updateClaimStatusWithHistory(newStatus) {
        clearMessage();

        if (!currentClaimId) {
          showMessage('Impossibile aggiornare lo stato: nessuna pratica caricata.', 'error');
          return;
        }

        const user = currentUser || auth.currentUser || null;
        const cardRef = db.collection('ClaimCards').doc(currentClaimId);

        try {
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(cardRef);
            if (!snap.exists) throw new Error('ClaimCard non trovato.');

            const data = snap.data() || {};
            const oldStatus = data.status || null;

            if (oldStatus === newStatus) return;

            const historyCounter = data.historyCounter || 0;
            const newVersion = historyCounter + 1;

            const snapshotData = Object.assign({}, data);
            delete snapshotData.historyCounter;

            const historyRef = cardRef.collection('history').doc();

            tx.update(cardRef, {
              status: newStatus,
              historyCounter: newVersion
            });

            tx.set(historyRef, {
              version: newVersion,
              status: newStatus,
              changedAt: firebase.firestore.FieldValue.serverTimestamp(),
              changedByUid: user ? user.uid : (data.openUserUid || null),
              changedByName: (data.openUser || (user && (user.displayName || user.email)) || null),
              changedDealerId: data.openDealer || data.dealerId || null,
              snapshot: snapshotData
            });
          });

          currentClaimStatus = newStatus;
          refreshClaimCardStatusControl();
          applyStatusLocks();

          showMessage(
            'Stato pratica aggiornato a "' + newStatus + '" e versione salvata nello storico.',
            'success'
          );

          await loadClaims();
        } catch (err) {
          console.error(err);
          showMessage(
            'Errore durante l\'aggiornamento dello stato della pratica: ' + err.message,
            'error'
          );
        }
      }

      async function cancelRequest() {
        clearMessage();
        if (!currentClaimId) {
          showMessage('Impossibile cancellare: nessuna pratica caricata.', 'error');
          return;
        }

        if (!confirm('Sei sicuro di voler cancellare questa richiesta?')) return;
        await updateClaimStatusWithHistory('Cancellata');
      }

      function goHome() {
        window.location.href = 'FTHUBAS.html';
      }

      // âœ… addRepair RESTA UGUALE: la logica manutenzione viene intercettata da ftclaims-maintenance.js
      async function addRepair() {
        clearMessage();
        if (!currentClaimId) {
          showMessage('Impossibile aggiungere: nessuna pratica caricata.', 'error');
          return;
        }

        if (currentClaimStatus === 'Conclusa' || currentClaimStatus === 'Cancellata') {
          showMessage('La pratica Ã¨ ' + currentClaimStatus.toLowerCase() + ': non Ã¨ possibile aggiungere nuovi claim.', 'error');
          return;
        }

        const btn = document.getElementById('btnAddRepair');
        btn.disabled = true;

        try {
          let claimTypeValue = null;

          if (typeof getCurrentClaimType === 'function') {
            claimTypeValue = getCurrentClaimType(currentClaimCardType, {
              containerId: 'claimTypeContainer',
              selectId: 'claimType',
              fixedId: 'fixedClaimType'
            });
          }

          if (!claimTypeValue) {
            showMessage('Seleziona una tipologia di claim valida prima di creare il claim.', 'error');
            btn.disabled = false;
            return;
          }

          const cardRef = db.collection('ClaimCards').doc(currentClaimId);

          const newCode = await db.runTransaction(async (tx) => {
            const snap = await tx.get(cardRef);
            if (!snap.exists) throw new Error('Pratica non trovata.');

            const data = snap.data() || {};
            let lastNum = data.lastClaimNumber || 0;
            const nextNum = lastNum + 1;
            const code = String(nextNum).padStart(3, '0');

            tx.update(cardRef, { lastClaimNumber: nextNum });

            const claimRef = cardRef.collection('Claims').doc(code);

            const claimData = {
              code: code,
              claimType: claimTypeValue,
              status: 'Aperto',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            tx.set(claimRef, claimData);
            return code;
          });

          showMessage('Riparazione ' + newCode + ' (' + claimTypeValue + ') creata.', 'success');
          await loadClaims();
        } catch (err) {
          console.error(err);
          showMessage('Errore nella creazione della riparazione: ' + err.message, 'error');
        } finally {
          btn.disabled = false;
        }
      }

      async function deleteRepair(code) {
        clearMessage();
        if (!currentClaimId || !code) return;

        if (currentClaimStatus === 'Conclusa' || currentClaimStatus === 'Cancellata') {
          showMessage('La pratica Ã¨ ' + currentClaimStatus.toLowerCase() + ': i claim non possono essere eliminati.', 'error');
          return;
        }

        if (!confirm('Vuoi davvero eliminare la riparazione ' + code + '?')) return;

        try {
          const cardRef = db.collection('ClaimCards').doc(currentClaimId);
          await cardRef.collection('Claims').doc(code).delete();
          showMessage('Riparazione ' + code + ' eliminata.', 'success');
          await loadClaims();
        } catch (err) {
          console.error(err);
          showMessage('Errore durante l\'eliminazione della riparazione: ' + err.message, 'error');
        }
      }

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'FTHUBAS.html';
          return;
        }
        currentUser = user;
        await loadUserInfo(user);
        await loadClaimCard();
        await loadClaims();
      });

      document.getElementById('btnSave').addEventListener('click', saveChanges);
      document.getElementById('btnDelete').addEventListener('click', cancelRequest);
      document.getElementById('btnHome').addEventListener('click', goHome);
      document.getElementById('btnAddRepair').addEventListener('click', addRepair);

      const statusSelect = document.getElementById('claimStatus');
      if (statusSelect) {
        statusSelect.addEventListener('change', () => {
          const newStatus = statusSelect.value;
          if (!currentClaimStatus || newStatus === currentClaimStatus) return;
          updateClaimStatusWithHistory(newStatus);
        });
      }
    });
  </script>
</body>
</html>
