<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTCLAIMS - Creazione Pratica (Step 2)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .top-bar {
      background: #003366;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h1 {
      margin: 0;
      font-size: 20px;
    }

    .top-bar .top-actions button {
      margin-left: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .top-bar .home-btn {
      background: #ffffff;
      color: #003366;
      font-weight: bold;
    }

    .top-bar .logout-btn {
      background: #cc0000;
      color: #ffffff;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }

    .section {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #003366;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 13px;
      margin-bottom: 3px;
    }

    .form-group input,
    .form-group textarea {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .form-group input[readonly],
    .form-group textarea[readonly] {
      background: #f0f0f0;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .buttons-row {
      margin-top: 15px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-cancel {
      background: #cc0000;
      color: #fff;
    }

    .status-label {
      font-size: 13px;
      font-style: italic;
      color: #666;
      margin-top: 5px;
    }

    .error-box {
      padding: 10px;
      border-radius: 6px;
      background: #ffe5e5;
      color: #990000;
      border: 1px solid #ffcccc;
      margin-bottom: 15px;
    }

    .info-box {
      padding: 8px;
      border-radius: 6px;
      background: #e6f2ff;
      color: #003366;
      border: 1px solid #b3d1ff;
      margin-bottom: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <h1>FTCLAIMS - Creazione Pratica (Step 2)</h1>
    <div class="top-actions">
      <button class="top-bar home-btn" id="btn-home">Home</button>
      <button class="top-bar logout-btn" id="btn-logout">Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="error-box" class="error-box" style="display:none;"></div>

    <div class="info-box" id="info-box">
      Caricamento dati pratica e veicolo in corso...
    </div>

    <!-- Sezione Pratica -->
    <div class="section">
      <div class="section-title">Dati Pratica</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="claim-code">Richiesta di Garanzia (codice pratica)</label>
          <input type="text" id="claim-code" readonly>
        </div>
        <div class="form-group">
          <label for="open-date">Data Apertura</label>
          <input type="date" id="open-date">
        </div>
        <div class="form-group">
          <label for="open-dealer">Dealer Apertura</label>
          <input type="text" id="open-dealer" readonly>
        </div>
        <div class="form-group">
          <label for="open-user">Utente Apertura</label>
          <input type="text" id="open-user" readonly>
        </div>
      </div>
      <div class="status-label" id="claim-status-label">
        Stato pratica: <span id="claim-status-value">Aperta (in creazione)</span>
      </div>
    </div>

    <!-- Sezione Veicolo -->
    <div class="section">
      <div class="section-title">Dati Veicolo</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="vehicle-vin">VIN</label>
          <input type="text" id="vehicle-vin" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-plate">Registration Plate</label>
          <input type="text" id="vehicle-plate" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-reg-date">Registration Date</label>
          <input type="text" id="vehicle-reg-date" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-customer">Customer</label>
          <input type="text" id="vehicle-customer" readonly>
        </div>
      </div>
    </div>

    <!-- Sezione Copertura Garanzia -->
    <div class="section">
      <div class="section-title">Copertura Garanzia alla data dell'Ordine di Lavoro</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="coverage-order-date">Data Ordine di Lavoro</label>
          <input type="text" id="coverage-order-date" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-type">Warranty Coverage (Full Line / Drive Line)</label>
          <input type="text" id="coverage-type" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-start">Data inizio</label>
          <input type="text" id="coverage-start" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-end">Data fine</label>
          <input type="text" id="coverage-end" readonly>
        </div>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label for="coverage-notes">Note copertura</label>
        <textarea id="coverage-notes" readonly></textarea>
      </div>
    </div>

    <!-- Sezione Contratto di Manutenzione -->
    <div class="section">
      <div class="section-title">Contratto di Manutenzione (se presente)</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="sc-start">Data inizio</label>
          <input type="text" id="sc-start" readonly>
        </div>
        <div class="form-group">
          <label for="sc-end">Data fine</label>
          <input type="text" id="sc-end" readonly>
        </div>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label for="sc-options">Opzioni presenti</label>
        <textarea id="sc-options" readonly></textarea>
      </div>
    </div>

    <!-- Pulsanti azione pratica -->
    <div class="buttons-row">
      <button class="btn btn-cancel" id="btn-cancel-claim">Cancella Richiesta</button>
    </div>
  </div>

  <script>
    console.log("FTCLAIMS_STEP2 – script avviato");

    // Riutilizzo auth/db globali se esistono (come in FTCLAIMS)
    const auth = window.auth || firebase.auth();
    const db   = window.db   || firebase.firestore();
    window.auth = auth;
    window.db   = db;

    let currentUser = null;
    let currentClaimId = null;
    let currentClaimYear = null;
    let currentClaimSequence = null;
    let claimDocRef = null;

    function showError(message) {
      const box = document.getElementById('error-box');
      box.textContent = message;
      box.style.display = 'block';
      console.error("[FTCLAIMS_STEP2] ERRORE:", message);
    }

    function setInfo(message) {
      const box = document.getElementById('info-box');
      box.textContent = message;
      console.log("[FTCLAIMS_STEP2] INFO:", message);
    }

    // ---- Lettura contesto dallo step 1 ----
    function loadContextFromSession() {
      const rawFull  = sessionStorage.getItem('ftclaims_context');
      const rawStep1 = sessionStorage.getItem('currentClaimStep1');

      console.log("sessionStorage.ftclaims_context =", rawFull);
      console.log("sessionStorage.currentClaimStep1 =", rawStep1);

      if (rawFull) {
        try {
          const ctx = JSON.parse(rawFull);
          console.log("ftclaims_context (parsed):", ctx);
          return ctx;
        } catch (e) {
          console.error("Errore parsing ftclaims_context:", e);
        }
      }

      if (rawStep1) {
        try {
          const s1 = JSON.parse(rawStep1);
          console.log("currentClaimStep1 (parsed, fallback):", s1);
          return {
            vin: s1.vin || "",
            registrationPlate: "",
            registrationDate: "",
            customer: "",
            orderDate: s1.dataOrdine || "",
            warrantyCoverage: {
              type: "",
              startDate: "",
              endDate: "",
              notes: ""
            },
            serviceContract: {
              startDate: "",
              endDate: "",
              options: ""
            },
            tipoClaimCard: s1.tipoClaimCard || ""
          };
        } catch (e) {
          console.error("Errore parsing currentClaimStep1:", e);
        }
      }

      return null;
    }

    function fillVehicleAndCoverageFields(context) {
      console.log("Compilo campi con context:", context);

      document.getElementById('vehicle-vin').value        = context.vin || '';
      document.getElementById('vehicle-plate').value      = context.registrationPlate || '';
      document.getElementById('vehicle-reg-date').value   = context.registrationDate || '';
      document.getElementById('vehicle-customer').value   = context.customer || '';

      const cov = context.warrantyCoverage || {};
      document.getElementById('coverage-order-date').value = context.orderDate || '';
      document.getElementById('coverage-type').value       = cov.type || '';
      document.getElementById('coverage-start').value      = cov.startDate || '';
      document.getElementById('coverage-end').value        = cov.endDate || '';
      document.getElementById('coverage-notes').value      = cov.notes || '';

      const sc = context.serviceContract || {};
      document.getElementById('sc-start').value    = sc.startDate || '';
      document.getElementById('sc-end').value      = sc.endDate || '';
      document.getElementById('sc-options').value  = sc.options || '';
    }

    async function loadUserInfo(user) {
      const userDocRef = db.collection('Users').doc(user.uid);
      const snap = await userDocRef.get();
      let dealer = '';
      let fullName = '';

      if (snap.exists) {
        const data = snap.data();
        dealer =
          data.dealerId ||
          data.dealerID ||
          data.DealerID ||
          '';
        fullName =
          data.fullName ||
          data.name ||
          data.displayName ||
          user.email ||
          user.uid;
      } else {
        fullName = user.email || user.uid;
      }

      document.getElementById('open-dealer').value = dealer;
      document.getElementById('open-user').value   = fullName;

      console.log("UserInfo:", { dealer, fullName });
      return { dealer, fullName };
    }

    async function generateClaimCode(orderDateString) {
      let year;
      if (orderDateString) {
        const d = new Date(orderDateString);
        if (!isNaN(d.getTime())) year = d.getFullYear();
      }
      if (!year) year = new Date().getFullYear();

      const counterDocId = `ClaimCardCounter_${year}`;
      const counterRef   = db.collection('Settings').doc(counterDocId);

      const sequence = await db.runTransaction(async (tx) => {
        const snap = await tx.get(counterRef);
        let current = 0;
        if (snap.exists && typeof snap.data().current === 'number') {
          current = snap.data().current;
        }
        const next = current + 1;
        tx.set(counterRef, { current: next }, { merge: true });
        return next;
      });

      const seqStr = String(sequence).padStart(6, '0');
      const code   = `W${year}${seqStr}`;
      console.log("Codice pratica generato:", code);
      return { code, year, sequence };
    }

    async function createClaimDocument(userInfo, context, openDateStr) {
      if (!currentClaimId) return;

      claimDocRef = db.collection('ClaimCards').doc(currentClaimId);

      const payload = {
        code: currentClaimId,
        year: currentClaimYear,
        sequence: currentClaimSequence,

        status: 'Aperta',
        openDate: openDateStr || null,
        openDealer: userInfo.dealer || null,
        openUser: userInfo.fullName || null,
        openUserUid: currentUser.uid,

        vehicle: {
          vin: context.vin || null,
          registrationPlate: context.registrationPlate || null,
          registrationDate: context.registrationDate || null,
          customer: context.customer || null
        },

        coverage: {
          orderDate: context.orderDate || null,
          type: (context.warrantyCoverage && context.warrantyCoverage.type) || null,
          startDate: (context.warrantyCoverage && context.warrantyCoverage.startDate) || null,
          endDate: (context.warrantyCoverage && context.warrantyCoverage.endDate) || null,
          notes: (context.warrantyCoverage && context.warrantyCoverage.notes) || null
        },

        maintenanceContract: {
          startDate: (context.serviceContract && context.serviceContract.startDate) || null,
          endDate: (context.serviceContract && context.serviceContract.endDate) || null,
          options: (context.serviceContract && context.serviceContract.options) || null
        },

        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      console.log("Creo documento ClaimCards con payload:", payload);
      await claimDocRef.set(payload);
    }

    function attachOpenDateListener() {
      if (!claimDocRef) return;
      const openDateInput = document.getElementById('open-date');
      openDateInput.addEventListener('change', async () => {
        try {
          await claimDocRef.update({
            openDate: openDateInput.value || null
          });
        } catch (e) {
          console.error('Errore aggiornamento data apertura:', e);
          alert('Errore durante il salvataggio della data di apertura.');
        }
      });
    }

    async function initPage(user) {
      console.log("initPage() – utente autenticato:", user.uid);
      currentUser = user;

      const context = loadContextFromSession();
      if (!context) {
        showError('Contesto pratica non trovato. Torna alla pagina FTCLAIMS e ripeti la ricerca.');
        setInfo('Impossibile continuare: contesto mancante.');
        return;
      }

      fillVehicleAndCoverageFields(context);

      let userInfo = { dealer: '', fullName: '' };
      try {
        userInfo = await loadUserInfo(user);
      } catch (e) {
        console.error("Errore lettura utente:", e);
        showError('Errore nel caricamento dei dati utente: ' + e.message);
      }

      const openDateInput = document.getElementById('open-date');
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      openDateInput.value = `${yyyy}-${mm}-${dd}`;

      try {
        setInfo('Generazione codice pratica in corso...');
        const { code, year, sequence } = await generateClaimCode(context.orderDate);
        currentClaimId      = code;
        currentClaimYear    = year;
        currentClaimSequence = sequence;
        document.getElementById('claim-code').value = code;

        setInfo('Creazione pratica su Firestore...');
        await createClaimDocument(userInfo, context, openDateInput.value);
        attachOpenDateListener();

        setInfo('Pratica creata. Puoi procedere con la gestione dei claim interni o cancellare la richiesta.');
      } catch (e) {
        console.error('Errore creazione pratica:', e);
        showError('Errore durante la creazione della pratica: ' + e.message);
        setInfo('I dati sono stati caricati a video. Il salvataggio della pratica non è riuscito.');
      }
    }

    auth.onAuthStateChanged(async (user) => {
      console.log("onAuthStateChanged:", user ? user.uid : "NESSUN UTENTE");
      if (!user) {
        window.location.href = 'FTLOGIN.html';
        return;
      }
      try {
        await initPage(user);
      } catch (e) {
        console.error(e);
        showError('Errore durante l\'inizializzazione della pagina: ' + e.message);
        setInfo('Si è verificato un errore.');
      }
    });

    document.getElementById('btn-home').addEventListener('click', () => {
      window.location.href = 'FTHUBAS.html';
    });

    document.getElementById('btn-logout').addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = 'FTLOGIN.html';
      } catch (e) {
        console.error(e);
        alert('Errore durante il logout.');
      }
    });

    document.getElementById('btn-cancel-claim').addEventListener('click', async () => {
      if (!claimDocRef || !currentClaimId) {
        alert('Nessuna richiesta da cancellare (pratica non salvata o errore precedente).');
        return;
      }
      if (!confirm('Sei sicuro di voler cancellare definitivamente questa richiesta?')) {
        return;
      }
      try {
        await claimDocRef.update({
          status: 'Cancellata',
          cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
          cancelledByUid: currentUser ? currentUser.uid : null
        });
        document.getElementById('claim-status-value').textContent = 'Cancellata (definitivamente chiusa)';
        alert('Richiesta cancellata con successo.');
      } catch (e) {
        console.error(e);
        alert('Errore durante la cancellazione della richiesta.');
      }
    });
  </script>
</body>
</html>
