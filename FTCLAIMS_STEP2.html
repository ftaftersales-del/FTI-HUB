<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTCLAIMS - Creazione Pratica (Step 2)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .top-bar {
      background: #003366;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h1 {
      margin: 0;
      font-size: 20px;
    }

    .top-bar .top-actions button {
      margin-left: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .top-bar .home-btn {
      background: #ffffff;
      color: #003366;
      font-weight: bold;
    }

    .top-bar .logout-btn {
      background: #cc0000;
      color: #ffffff;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .section {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #003366;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 13px;
      margin-bottom: 3px;
    }

    .form-group input,
    .form-group textarea {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .form-group input[readonly],
    .form-group textarea[readonly] {
      background: #f0f0f0;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .buttons-row {
      margin-top: 15px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-cancel {
      background: #cc0000;
      color: #fff;
    }

    .status-label {
      font-size: 13px;
      font-style: italic;
      color: #666;
      margin-top: 5px;
    }

    .error-box {
      padding: 10px;
      border-radius: 6px;
      background: #ffe5e5;
      color: #990000;
      border: 1px solid #ffcccc;
      margin-bottom: 15px;
    }

    .info-box {
      padding: 8px;
      border-radius: 6px;
      background: #e6f2ff;
      color: #003366;
      border: 1px solid #b3d1ff;
      margin-bottom: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <h1>FTCLAIMS - Creazione Pratica (Step 2)</h1>
    <div class="top-actions">
      <button class="top-bar home-btn" id="btn-home">Home</button>
      <button class="top-bar logout-btn" id="btn-logout">Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="error-box" class="error-box" style="display:none;"></div>

    <div class="info-box" id="info-box">
      Caricamento dati pratica e veicolo in corso...
    </div>

    <!-- Sezione Pratica -->
    <div class="section">
      <div class="section-title">Dati Pratica</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="claim-code">Richiesta di Garanzia (codice pratica)</label>
          <input type="text" id="claim-code" readonly>
        </div>
        <div class="form-group">
          <label for="open-date">Data Apertura</label>
          <input type="date" id="open-date">
        </div>
        <div class="form-group">
          <label for="open-dealer">Dealer Apertura</label>
          <input type="text" id="open-dealer" readonly>
        </div>
        <div class="form-group">
          <label for="open-user">Utente Apertura</label>
          <input type="text" id="open-user" readonly>
        </div>
      </div>
      <div class="status-label">
        Stato pratica: <span id="claim-status-value">Caricamento...</span>
      </div>
    </div>

    <!-- Sezione Veicolo -->
    <div class="section">
      <div class="section-title">Dati Veicolo</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="vehicle-vin">VIN</label>
          <input type="text" id="vehicle-vin" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-plate">Registration Plate</label>
          <input type="text" id="vehicle-plate" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-reg-date">Registration Date</label>
          <input type="text" id="vehicle-reg-date" readonly>
        </div>
        <div class="form-group">
          <label for="vehicle-customer">Customer</label>
          <input type="text" id="vehicle-customer" readonly>
        </div>
      </div>
    </div>

    <!-- Sezione Copertura Garanzia -->
    <div class="section">
      <div class="section-title">Copertura Garanzia alla data dell'Ordine di Lavoro</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="coverage-order-date">Data Ordine di Lavoro</label>
          <input type="text" id="coverage-order-date" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-type">Warranty Coverage (Full Line / Drive Line)</label>
          <input type="text" id="coverage-type" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-start">Data inizio</label>
          <input type="text" id="coverage-start" readonly>
        </div>
        <div class="form-group">
          <label for="coverage-end">Data fine</label>
          <input type="text" id="coverage-end" readonly>
        </div>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label for="coverage-notes">Note copertura</label>
        <textarea id="coverage-notes" readonly></textarea>
      </div>
    </div>

    <!-- Sezione Contratto di Manutenzione -->
    <div class="section">
      <div class="section-title">Contratto di Manutenzione (se presente)</div>
      <div class="form-grid">
        <div class="form-group">
          <label for="sc-start">Data inizio</label>
          <input type="text" id="sc-start" readonly>
        </div>
        <div class="form-group">
          <label for="sc-end">Data fine</label>
          <input type="text" id="sc-end" readonly>
        </div>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label for="sc-options">Opzioni presenti</label>
        <textarea id="sc-options" readonly></textarea>
      </div>
    </div>

    <!-- Pulsanti azione pratica -->
    <div class="buttons-row">
      <button class="btn btn-cancel" id="btn-cancel-claim">Cancella Richiesta</button>
    </div>
  </div>

<script>
  console.log("FTCLAIMS_STEP2 – script avviato");

  const appAuth = window.auth || firebase.auth();
  const appDb   = window.db   || firebase.firestore();
  window.auth = appAuth;
  window.db   = appDb;

  let currentUser = null;
  let claimDocRef = null;
  let currentClaimCode = null;

  function showError(message) {
    const box = document.getElementById('error-box');
    box.textContent = message;
    box.style.display = 'block';
    console.error("[FTCLAIMS_STEP2] ERRORE:", message);
  }

  function setInfo(message) {
    const box = document.getElementById('info-box');
    box.textContent = message;
    console.log("[FTCLAIMS_STEP2] INFO:", message);
  }

  function loadClaimCodeFromSession() {
    const code = sessionStorage.getItem('ftclaims_claimCode');
    console.log('ftclaims_claimCode da sessionStorage =', code);
    return code || null;
  }

  function fillFormFromClaimData(data) {
    console.log("Compilo campi da documento ClaimCards:", data);

    // Dati pratica
    document.getElementById('claim-code').value = data.code || '';
    document.getElementById('open-date').value  = data.openDate || '';
    document.getElementById('open-dealer').value = data.openDealer || '';
    document.getElementById('open-user').value   = data.openUser || '';
    document.getElementById('claim-status-value').textContent =
      data.status || 'Aperta';

    // Dati veicolo
    const v = data.vehicle || {};
    document.getElementById('vehicle-vin').value      = v.vin || '';
    document.getElementById('vehicle-plate').value    = v.registrationPlate || '';
    document.getElementById('vehicle-reg-date').value = v.registrationDate || '';
    document.getElementById('vehicle-customer').value = v.customer || '';

    // Copertura
    const c = data.coverage || {};
    document.getElementById('coverage-order-date').value = data.orderDate || c.orderDate || '';
    document.getElementById('coverage-type').value       = c.type || '';
    document.getElementById('coverage-start').value      = c.startDate || '';
    document.getElementById('coverage-end').value        = c.endDate || '';
    document.getElementById('coverage-notes').value      = c.notes || '';

    // Contratto manutenzione
    const sc = data.maintenanceContract || {};
    document.getElementById('sc-start').value   = sc.startDate || '';
    document.getElementById('sc-end').value     = sc.endDate || '';
    document.getElementById('sc-options').value = sc.options || '';
  }

  function attachOpenDateListener() {
    if (!claimDocRef) return;
    const openDateInput = document.getElementById('open-date');

    openDateInput.onchange = null;
    openDateInput.addEventListener('change', async () => {
      try {
        await claimDocRef.update({
          openDate: openDateInput.value || null
        });
        console.log('Data apertura aggiornata:', openDateInput.value);
      } catch (e) {
        console.error('Errore aggiornamento data apertura:', e);
        alert('Errore durante il salvataggio della data di apertura.');
      }
    });
  }

  async function loadClaimFromFirestore(claimCode) {
    setInfo('Caricamento pratica da Firestore...');

    // 1) Tentativo con ID = codice pratica (come vogliamo che sia in futuro)
    let snap = null;
    let docRef = appDb.collection('ClaimCards').doc(claimCode);
    try {
      snap = await docRef.get();
      if (snap.exists) {
        console.log('Pratica trovata con ID = codice pratica');
        claimDocRef = docRef;
        return snap.data();
      }
    } catch (e) {
      console.warn('Errore get con ID codice pratica:', e);
    }

    // 2) Fallback per documenti esistenti con ID random ma campo code = claimCode
    try {
      console.log('Tentativo fallback: query dove code == claimCode...');
      const q = await appDb.collection('ClaimCards')
        .where('code', '==', claimCode)
        .limit(1)
        .get();
      if (!q.empty) {
        const doc = q.docs[0];
        claimDocRef = doc.ref;
        console.log('Pratica trovata tramite query code == claimCode, docId =', doc.id);
        return doc.data();
      }
    } catch (e) {
      console.error('Errore query ClaimCards per code:', e);
      throw e;
    }

    // Nessun documento trovato
    return null;
  }

  async function initPage(user) {
    console.log("initPage() – utente autenticato:", user.uid);
    currentUser = user;

    const claimCode = loadClaimCodeFromSession();
    if (!claimCode) {
      showError('Codice pratica non trovato. Torna a FTCLAIMS e ripeti la procedura.');
      setInfo('Impossibile continuare: codice pratica mancante.');
      return;
    }
    currentClaimCode = claimCode;

    document.getElementById('claim-code').value = claimCode;

    try {
      const data = await loadClaimFromFirestore(claimCode);
      if (!data) {
        showError('Nessuna pratica trovata per il codice: ' + claimCode);
        setInfo('Impossibile continuare: pratica inesistente.');
        return;
      }

      fillFormFromClaimData(data);
      attachOpenDateListener();
      setInfo('Pratica caricata correttamente.');
    } catch (e) {
      console.error('Errore caricamento pratica:', e);
      showError('Errore durante il caricamento della pratica: ' + e.message);
      setInfo('Si è verificato un errore nel caricamento.');
    }
  }

  appAuth.onAuthStateChanged(async (user) => {
    console.log("onAuthStateChanged:", user ? user.uid : "NESSUN UTENTE");
    if (!user) {
      window.location.href = 'FTLOGIN.html';
      return;
    }
    try {
      await initPage(user);
    } catch (e) {
      console.error(e);
      showError('Errore durante l\'inizializzazione della pagina: ' + e.message);
      setInfo('Si è verificato un errore.');
    }
  });

  document.getElementById('btn-home').addEventListener('click', () => {
    window.location.href = 'FTHUBAS.html';
  });

  document.getElementById('btn-logout').addEventListener('click', async () => {
    try {
      await appAuth.signOut();
      window.location.href = 'FTLOGIN.html';
    } catch (e) {
      console.error(e);
      alert('Errore durante il logout.');
    }
  });

  document.getElementById('btn-cancel-claim').addEventListener('click', async () => {
    if (!claimDocRef || !currentClaimCode) {
      alert('Nessuna richiesta da cancellare (pratica non caricata).');
      return;
    }
    if (!confirm('Sei sicuro di voler cancellare definitivamente questa richiesta?')) {
      return;
    }
    try {
      await claimDocRef.update({
        status: 'Cancellata',
        cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
        cancelledByUid: currentUser ? currentUser.uid : null
      });
      document.getElementById('claim-status-value').textContent =
        'Cancellata (definitivamente chiusa)';
      alert('Richiesta cancellata con successo.');
    } catch (e) {
      console.error(e);
      alert('Errore durante la cancellazione della richiesta.');
    }
  });
</script>

</body>
</html>
