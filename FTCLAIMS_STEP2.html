<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTCLAIMS - Dettaglio Claim Card</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>

  <!-- tua init -->
  <script src="firebase-config.js"></script>

  <!-- dettagli claim (RSA/Garanzia/Attachments/Notes ecc.) -->
  <script src="ftclaims-claimforms.js"></script>

  <style>
    body{font-family:Arial, sans-serif;background:#f5f5f5;margin:0;}
    .page{padding:16px;}
    .title{font-size:18px;font-weight:700;margin:0 0 2px;}
    .subtitle{font-size:12px;color:#666;margin:0 0 12px;}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:12px;align-items:start;}
    .card{background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.08);padding:12px;}
    .sectionTitle{font-size:12px;font-weight:700;margin:0 0 8px;color:#222;}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
    .form-group{margin-bottom:8px;}
    label{display:block;font-size:11px;color:#333;margin-bottom:4px;}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:6px;padding:7px 8px;font-size:12px;background:#fff;}
    input[readonly],textarea[readonly]{background:#fafafa;}
    textarea{resize:vertical;}
    .small-text{font-size:11px;color:#666;}
    .btn{border:0;border-radius:6px;padding:7px 10px;font-size:12px;cursor:pointer;}
    .btn-small{padding:6px 8px;font-size:11px;}
    .btn-primary{background:#1976d2;color:#fff;}
    .btn-secondary{background:#6c757d;color:#fff;}
    .btn-danger{background:#dc3545;color:#fff;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .toolbar{display:flex;gap:8px;justify-content:flex-end;align-items:center;}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#334155;font-size:11px;}
    .hr{height:1px;background:#eee;margin:10px 0;}
    .claimBlock{border:1px solid #eee;border-radius:10px;padding:10px;margin:10px 0;}
    .claimHeader{display:flex;justify-content:space-between;align-items:center;gap:8px;}
    .claimHeader h4{margin:0;font-size:12px;}
    .claimHeader .meta{display:flex;gap:8px;align-items:center;}
    .collapseBtn{background:#e9ecef;color:#111;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{border-bottom:1px solid #eee;padding:6px 6px;text-align:left;}
    th{font-size:11px;color:#444;background:#fafafa;}
    .right{display:flex;justify-content:flex-end;}
    .warn{background:#fff3cd;border:1px solid #ffeeba;color:#856404;border-radius:8px;padding:8px;font-size:12px;margin-bottom:10px;}
    .ok{background:#d4edda;border:1px solid #c3e6cb;color:#155724;border-radius:8px;padding:8px;font-size:12px;margin-bottom:10px;}
    .err{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24;border-radius:8px;padding:8px;font-size:12px;margin-bottom:10px;}
  </style>
</head>

<body>
<div class="page">
  <div class="title">Dettaglio Claim Card</div>
  <div class="subtitle">Visualizza e gestisci i dati della pratica.</div>

  <div id="banner"></div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="sectionTitle">Dati pratica</div>

      <div class="form-group">
        <label>Codice pratica</label>
        <input id="cc_code" readonly>
      </div>

      <div class="form-group">
        <label>Tipologia</label>
        <input id="cc_type" readonly>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Data apertura</label>
          <input id="cc_openDate" readonly>
        </div>
        <div class="form-group">
          <label>Data ordine di lavoro</label>
          <input id="cc_orderDate" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Nome operatore apertura</label>
          <input id="cc_openBy" readonly>
        </div>
        <div class="form-group">
          <label>Dealer apertura</label>
          <input id="cc_openDealer" readonly>
        </div>
      </div>

      <div class="form-group">
        <label>Stato pratica</label>
        <select id="cc_status">
          <option value="Aperta">Aperta</option>
          <option value="Inviata">Inviata</option>
          <option value="Sospesa">Sospesa</option>
          <option value="In Valutazione">In Valutazione</option>
          <option value="Conclusa">Conclusa</option>
          <option value="Cancellata">Cancellata</option>
        </select>
        <div class="small-text">Stati: Aperta, Inviata, Sospesa, In Valutazione, Conclusa, Cancellata.</div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">Dati veicolo</div>
      <div class="form-row">
        <div class="form-group">
          <label>VIN</label>
          <input id="cc_vin" readonly>
        </div>
        <div class="form-group">
          <label>Customer</label>
          <input id="cc_customer" readonly>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Registration Plate</label>
          <input id="cc_plate" readonly>
        </div>
        <div class="form-group">
          <label>Registration Date</label>
          <input id="cc_regdate" readonly>
        </div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">Copertura garanzia alla data dell'ordine di lavoro</div>
      <div class="form-row">
        <div class="form-group">
          <label>Tipo copertura</label>
          <input id="cc_covType" readonly>
        </div>
        <div class="form-group">
          <label>Data inizio</label>
          <input id="cc_covStart" readonly>
        </div>
      </div>
      <div class="form-group">
        <label>Data fine</label>
        <input id="cc_covEnd" readonly>
      </div>
      <div class="form-group">
        <label>Note copertura (visibili solo al distributore)</label>
        <textarea id="cc_covNotes" rows="2" readonly></textarea>
        <div class="small-text">Copertura ricavata dai dati DBVIN / WARRANTY_* alla data dell'ordine di lavoro.</div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">Service Contract (se presente)</div>
      <div class="form-row">
        <div class="form-group">
          <label>Data inizio</label>
          <input id="cc_scStart" readonly>
        </div>
        <div class="form-group">
          <label>Data fine</label>
          <input id="cc_scEnd" readonly>
        </div>
      </div>
      <div class="form-group">
        <label>Opzioni presenti</label>
        <textarea id="cc_scOptions" rows="2" readonly></textarea>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">Chilometraggio / ore motore</div>
      <div class="form-row">
        <div class="form-group">
          <label>KM veicolo</label>
          <input id="cc_km" type="number" min="0">
        </div>
        <div class="form-group">
          <label>Ore motore</label>
          <input id="cc_hours" type="number" min="0">
        </div>
      </div>

      <div class="toolbar">
        <button id="btnHome" class="btn btn-secondary btn-small">Home Page</button>
        <button id="btnSave" class="btn btn-primary btn-small">Salva modifiche</button>
        <button id="btnCancel" class="btn btn-danger btn-small">Cancella richiesta</button>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="sectionTitle">Gestione claim collegati alla claim card</div>
      <div class="small-text" style="margin-bottom:8px;">
        Tipologia claim: la lista varia in base alla tipologia della claim card (WARRANTY, SERVICE CONTRACT, RSA...).
      </div>

      <div class="form-row" style="align-items:end;">
        <div class="form-group">
          <label>Nuovo claim</label>
          <select id="newClaimType">
            <option value="">Seleziona...</option>
            <option value="SERVICE CONTRACT">Service Contract (Manutenzione)</option>
            <option value="RSA">RSA</option>
            <option value="GARANZIA">Garanzia</option>
            <option value="GARANZIA RICAMBIO">Garanzia Ricambio</option>
          </select>
        </div>
        <div class="right">
          <button id="btnCreateClaim" class="btn btn-primary btn-small">Crea claim</button>
        </div>
      </div>

      <div id="claimsContainer"></div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   FTCLAIMS_STEP2 - versione robusta
   ============================================================ */

(function () {
  const banner = document.getElementById("banner");

  function setBanner(type, text) {
    banner.innerHTML = "";
    if (!text) return;
    const div = document.createElement("div");
    div.className = type;
    div.textContent = text;
    banner.appendChild(div);
  }

  function qs(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  function fmtDate(d) {
    if (!d) return "";
    if (typeof d === "string") return d;
    if (d.toDate) {
      const t = d.toDate();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth() + 1).padStart(2, "0");
      const dd = String(t.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }
    return "";
  }

  function safeStr(v) { return (v == null ? "" : String(v)); }

  // ---- Firebase guards ----
  if (typeof firebase === "undefined" || !firebase.auth || !firebase.firestore) {
    setBanner("err", "Firebase non inizializzato. Controlla firebase-config.js");
    return;
  }

  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---- DOM refs ----
  const cc_code      = document.getElementById("cc_code");
  const cc_type      = document.getElementById("cc_type");
  const cc_openDate  = document.getElementById("cc_openDate");
  const cc_orderDate = document.getElementById("cc_orderDate");
  const cc_openBy    = document.getElementById("cc_openBy");
  const cc_openDealer= document.getElementById("cc_openDealer");
  const cc_status    = document.getElementById("cc_status");

  const cc_vin       = document.getElementById("cc_vin");
  const cc_customer  = document.getElementById("cc_customer");
  const cc_plate     = document.getElementById("cc_plate");
  const cc_regdate   = document.getElementById("cc_regdate");

  const cc_covType   = document.getElementById("cc_covType");
  const cc_covStart  = document.getElementById("cc_covStart");
  const cc_covEnd    = document.getElementById("cc_covEnd");
  const cc_covNotes  = document.getElementById("cc_covNotes");

  const cc_scStart   = document.getElementById("cc_scStart");
  const cc_scEnd     = document.getElementById("cc_scEnd");
  const cc_scOptions = document.getElementById("cc_scOptions");

  const cc_km        = document.getElementById("cc_km");
  const cc_hours     = document.getElementById("cc_hours");

  const btnHome      = document.getElementById("btnHome");
  const btnSave      = document.getElementById("btnSave");
  const btnCancel    = document.getElementById("btnCancel");

  const newClaimType = document.getElementById("newClaimType");
  const btnCreateClaim = document.getElementById("btnCreateClaim");
  const claimsContainer = document.getElementById("claimsContainer");

  // ---- State ----
  let claimCardId = qs("id"); // es: ?id=W2025000019
  let claimCard = null;
  let currentUserInfo = null;

  // Maintenance meta cache
  let maintMeta = null; // {menuOptions:[{key,label:{it}}...]}
  function getMaintLabel(key) {
    if (!maintMeta || !Array.isArray(maintMeta.menuOptions)) return key;
    const hit = maintMeta.menuOptions.find(x => x && x.key === key);
    return hit && hit.label && hit.label.it ? hit.label.it : key;
  }

  // ---- Read current user info (dealers) ----
  async function loadCurrentUserInfo() {
    const u = auth.currentUser;
    if (!u) return { uid:null, dealerId:null, name:null };
    let dealerId = null;
    let name = u.displayName || null;
    try {
      const snap = await db.collection("Users").doc(u.uid).get();
      if (snap.exists) {
        const d = snap.data() || {};
        dealerId = d.dealerId || d.DealerID || d.dealerID || null;
        if (!name) name = d.fullName || d.name || d.displayName || null;
      }
    } catch(e){}
    return { uid:u.uid, dealerId, name };
  }

  // ---- Load claim card ----
  async function loadClaimCard() {
    if (!claimCardId) {
      setBanner("err", "Manca l'ID nella URL. Apri la pagina come: FTCLAIMS_STEP2.html?id=W2025xxxxxxx");
      return null;
    }
    const ref = db.collection("ClaimCards").doc(claimCardId);
    const snap = await ref.get();
    if (!snap.exists) {
      setBanner("err", "ClaimCard non trovata: " + claimCardId);
      return null;
    }
    return { id: snap.id, data: snap.data() || {} };
  }

  function fillLeftPanel(cc) {
    const d = cc.data || {};

    cc_code.value       = safeStr(d.code || cc.id);
    cc_type.value       = safeStr(d.type || d.tipologia || "");
    cc_openDate.value   = safeStr(d.openDate || fmtDate(d.createdAt) || "");
    cc_orderDate.value  = safeStr(d.orderDate || "");
    cc_openBy.value     = safeStr(d.openByName || d.openBy || "");
    cc_openDealer.value = safeStr(d.openDealer || "");

    cc_status.value     = safeStr(d.status || "Aperta");

    cc_vin.value        = safeStr(d.vin || d.VIN || "");
    cc_customer.value   = safeStr(d.customer || d.Customer || "");
    cc_plate.value      = safeStr(d.registrationPlate || d.plate || "");
    cc_regdate.value    = safeStr(d.registrationDate || "");

    const cov = d.coverage || {};
    cc_covType.value    = safeStr(cov.type || "");
    cc_covStart.value   = safeStr(cov.startDate || "");
    cc_covEnd.value     = safeStr(cov.endDate || "");
    cc_covNotes.value   = safeStr(cov.notes || "");

    const sc = d.maintenanceContract || {};
    cc_scStart.value    = safeStr(sc.startDate || "");
    cc_scEnd.value      = safeStr(sc.endDate || "");
    cc_scOptions.value  = safeStr(sc.options || "");

    cc_km.value         = (d.kmVehicle != null ? d.kmVehicle : (d.km != null ? d.km : ""));
    cc_hours.value      = (d.hoursEngine != null ? d.hoursEngine : (d.ore_motore != null ? d.ore_motore : ""));
  }

  async function saveClaimCardEdits() {
    if (!claimCardId) return;
    btnSave.disabled = true;
    try {
      const ref = db.collection("ClaimCards").doc(claimCardId);
      await ref.update({
        status: cc_status.value || "Aperta",
        kmVehicle: cc_km.value === "" ? null : Number(cc_km.value),
        hoursEngine: cc_hours.value === "" ? null : Number(cc_hours.value),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setBanner("ok", "Modifiche salvate.");
      setTimeout(()=>setBanner("", ""), 2000);
    } catch (e) {
      console.error(e);
      setBanner("err", "Errore salvataggio claim card: " + e.message);
    } finally {
      btnSave.disabled = false;
    }
  }

  // ---- Maintenance meta ----
  async function loadMaintenanceMeta() {
    try {
      const snap = await db.collection("Maintenance").doc("_meta").get();
      if (snap.exists) maintMeta = snap.data() || null;
    } catch(e) {
      console.warn("Maintenance/_meta non leggibile:", e);
    }
  }

  // ============================================================
  // RENDER CLAIMS LIST
  // ============================================================
  async function loadClaimsList() {
    claimsContainer.innerHTML = "";
    const ref = db.collection("ClaimCards").doc(claimCardId).collection("Claims");
    const snap = await ref.orderBy("createdAt", "asc").get();

    if (snap.empty) {
      const div = document.createElement("div");
      div.className = "small-text";
      div.textContent = "Nessun claim presente.";
      claimsContainer.appendChild(div);
      return;
    }

    snap.forEach(doc => {
      const claim = doc.data() || {};
      renderClaimBlock(doc.id, claim);
    });
  }

  function renderClaimBlock(claimCode, claimData) {
    const claimType = (claimData.claimType || claimData.type || "").toString();

    const block = document.createElement("div");
    block.className = "claimBlock";

    const header = document.createElement("div");
    header.className = "claimHeader";

    const title = document.createElement("h4");
    title.textContent = `${claimCode} (${claimType || "CLAIM"})`;

    const meta = document.createElement("div");
    meta.className = "meta";

    const st = document.createElement("span");
    st.className = "pill";
    st.textContent = "Stato: " + (claimData.status || "Aperto");
    meta.appendChild(st);

    const btnCollapse = document.createElement("button");
    btnCollapse.type = "button";
    btnCollapse.className = "btn btn-small collapseBtn";
    btnCollapse.textContent = "Nascondi dettagli";

    const btnDelete = document.createElement("button");
    btnDelete.type = "button";
    btnDelete.className = "btn btn-small btn-danger";
    btnDelete.textContent = "Elimina riparazione";

    meta.appendChild(btnCollapse);
    meta.appendChild(btnDelete);

    header.appendChild(title);
    header.appendChild(meta);
    block.appendChild(header);

    const body = document.createElement("div");
    body.style.marginTop = "8px";
    block.appendChild(body);

    // Render specific
    const ctx = { claimCardId, claimCode };

    if (claimType.toUpperCase() === "SERVICE CONTRACT") {
      renderMaintenanceDetails(body, claimData, ctx);
    } else {
      // RSA / Garanzia / Garanzia Ricambio ecc.
      renderClaimDetails(claimType, body, claimData, ctx);
    }

    // Collapse
    let collapsed = false;
    btnCollapse.addEventListener("click", () => {
      collapsed = !collapsed;
      body.style.display = collapsed ? "none" : "block";
      btnCollapse.textContent = collapsed ? "Mostra dettagli" : "Nascondi dettagli";
    });

    // Delete
    btnDelete.addEventListener("click", async () => {
      if (!confirm(`Eliminare ${claimCode}?`)) return;

      try {
        // Se maintenance: rimuovi anche index VIN+template se presente
        if ((claimType || "").toUpperCase() === "SERVICE CONTRACT") {
          await deleteMaintenanceIndexIfNeeded(claimData);
        }
        await db.collection("ClaimCards").doc(claimCardId)
          .collection("Claims").doc(claimCode).delete();
        setBanner("ok", "Riparazione eliminata.");
        setTimeout(()=>setBanner("", ""), 1500);
        await loadClaimsList();
      } catch (e) {
        console.error(e);
        setBanner("err", "Errore eliminazione: " + e.message);
      }
    });

    claimsContainer.appendChild(block);
  }

  // ============================================================
  // SERVICE CONTRACT (MAINTENANCE) UI
  // ============================================================
  function renderMaintenanceDetails(container, claimData, ctx) {
    const m = claimData.maintenance || {};
    const prefix = "mnt_" + ctx.claimCode + "_";

    container.innerHTML = `
      <div class="sectionTitle">Dati Service Contract</div>
      <div class="small-text" style="margin-bottom:8px;">
        Seleziona il pacchetto di manutenzione. Le righe (ricambi/manodopera) vengono caricate dal template.
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="${prefix}family">Famiglia</label>
          <select id="${prefix}family">
            <option value="">Seleziona...</option>
            <option value="470">470</option>
            <option value="510">510</option>
          </select>
        </div>
        <div class="form-group">
          <label for="${prefix}key">Tipo manutenzione</label>
          <select id="${prefix}key">
            <option value="">Seleziona...</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="${prefix}voith" />
          Veicolo con rallentatore VOITH (Intarder/Retarder)
        </label>
        <div class="small-text">
          Se attivo, verranno incluse le righe previste per VOITH (se presenti nel pacchetto).
        </div>
      </div>

      <div class="form-group">
        <button type="button" id="${prefix}save" class="btn btn-primary btn-small">Salva manutenzione</button>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">Righe precompilate</div>
      <div class="small-text">Ricambi e manodopera provenienti dal template selezionato.</div>

      <div style="margin-top:8px;">
        <div class="sectionTitle" style="margin:8px 0 6px;">Manodopera</div>
        <table>
          <thead><tr><th>Codice</th><th>Descrizione</th><th style="text-align:right;">Q.tà</th><th>Note</th></tr></thead>
          <tbody id="${prefix}labBody"><tr><td colspan="4" class="small-text">Nessuna riga.</td></tr></tbody>
        </table>

        <div class="sectionTitle" style="margin:12px 0 6px;">Ricambi</div>
        <table>
          <thead><tr><th>Codice</th><th>Descrizione</th><th style="text-align:right;">Q.tà</th><th>Note</th></tr></thead>
          <tbody id="${prefix}parBody"><tr><td colspan="4" class="small-text">Nessuna riga.</td></tr></tbody>
        </table>
      </div>
    `;

    const familySel = container.querySelector("#" + prefix + "family");
    const keySel    = container.querySelector("#" + prefix + "key");
    const voithChk  = container.querySelector("#" + prefix + "voith");
    const saveBtn   = container.querySelector("#" + prefix + "save");
    const labBody   = container.querySelector("#" + prefix + "labBody");
    const parBody   = container.querySelector("#" + prefix + "parBody");

    // preload
    if (m.family) familySel.value = m.family;
    if (m.key) {
      // key options loaded after meta
      // set later
    }
    voithChk.checked = !!m.voith;

    function fillKeyOptions() {
      keySel.innerHTML = `<option value="">Seleziona...</option>`;
      if (!maintMeta || !Array.isArray(maintMeta.menuOptions)) return;
      // menuOptions keys: "1s","1m","2s","2m","3s","3m"
      maintMeta.menuOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.key;
        o.textContent = (opt.label && opt.label.it) ? opt.label.it : opt.key;
        keySel.appendChild(o);
      });
      if (m.key) keySel.value = m.key;
    }

    function renderItems(items) {
      const labour = (items || []).filter(x => (x.kind || "").toUpperCase() === "LABOUR");
      const parts  = (items || []).filter(x => (x.kind || "").toUpperCase() === "PART");

      function fill(tbody, arr) {
        tbody.innerHTML = "";
        if (!arr.length) {
          tbody.innerHTML = `<tr><td colspan="4" class="small-text">Nessuna riga.</td></tr>`;
          return;
        }
        arr.forEach(it => {
          const tr = document.createElement("tr");
          const code = it.code || "";
          const desc = it.description || "";
          const qty  = (it.qty != null ? it.qty : "");
          const note = it.note || "";
          tr.innerHTML = `
            <td>${code}</td>
            <td>${desc}</td>
            <td style="text-align:right;">${qty}</td>
            <td>${note}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      fill(labBody, labour);
      fill(parBody, parts);
    }

    async function loadTemplatePreview() {
      const family = familySel.value;
      const key = keySel.value;
      const voith = !!voithChk.checked;
      if (!family || !key) {
        renderItems([]);
        return;
      }

      const docId = `${family}_${key}`;
      try {
        const snap = await db.collection("Maintenance").doc(docId).get();
        if (!snap.exists) {
          renderItems([]);
          return;
        }
        const tpl = snap.data() || {};
        let items = Array.isArray(tpl.items) ? tpl.items.slice() : [];

        // filtro VOITH
        if (!voith) {
          items = items.filter(x => !(x.conditions && x.conditions.voithOnly === true));
        }

        // filtro visibilità dealer/distributor: lato UI teniamo dealer=true
        items = items.filter(x => !(x.visibility && x.visibility.dealer === false));

        renderItems(items);
      } catch (e) {
        console.error(e);
        renderItems([]);
      }
    }

    familySel.addEventListener("change", () => loadTemplatePreview());
    keySel.addEventListener("change", () => loadTemplatePreview());
    voithChk.addEventListener("change", () => loadTemplatePreview());

    // load options from meta then preview
    fillKeyOptions();
    loadTemplatePreview();

    saveBtn.addEventListener("click", async () => {
      const family = familySel.value;
      const key = keySel.value;
      const voith = !!voithChk.checked;

      if (!family || !key) {
        alert("Seleziona famiglia e tipo manutenzione.");
        return;
      }

      // 1) blocco doppione dentro la stessa claim card
      const existsInCard = await maintenanceAlreadyInThisClaimCard(family, key);
      // se esiste ed è un altro claim (non quello che stiamo salvando)
      if (existsInCard && existsInCard !== ctx.claimCode) {
        alert("Questa manutenzione è già presente nella claim card (" + existsInCard + ").");
        return;
      }

      // 2) blocco doppione VIN storico (globale)
      const vin = (claimCard && claimCard.data && (claimCard.data.vin || claimCard.data.VIN)) ? (claimCard.data.vin || claimCard.data.VIN) : "";
      if (!vin) {
        alert("VIN mancante sulla claim card: non posso verificare lo storico manutenzioni.");
        return;
      }

      saveBtn.disabled = true;
      try {
        // transaction su index VIN+template (serve regola)
        await reserveMaintenanceIndexOrFail(vin, family, key, ctx);

        // salva su claim
        const label = getMaintLabel(key);
        const docId = `${family}_${key}`;

        await db.collection("ClaimCards").doc(ctx.claimCardId)
          .collection("Claims").doc(ctx.claimCode)
          .update({
            maintenance: {
              family,
              key,
              keyLabel: label,
              templateDocId: docId,
              voith,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }
          });

        setBanner("ok", "Manutenzione salvata.");
        setTimeout(()=>setBanner("", ""), 1500);
        await loadClaimsList();
      } catch (e) {
        console.error(e);
        alert(e.message || String(e));
      } finally {
        saveBtn.disabled = false;
      }
    });

    // IMPORTANTE: su Service Contract NON vogliamo Ticket/Sinistro ecc.
    // Quindi NON chiamiamo addAttachmentsAndNotesSection qui: lo gestiamo sotto con showGeneral=false
    addAttachmentsAndNotesSection(container, ctx, { showGeneral: false });
  }

  async function maintenanceAlreadyInThisClaimCard(family, key) {
    const snap = await db.collection("ClaimCards").doc(claimCardId)
      .collection("Claims")
      .where("claimType", "==", "SERVICE CONTRACT")
      .get();

    let found = null;
    snap.forEach(doc => {
      const d = doc.data() || {};
      const m = d.maintenance || {};
      if (m.family === family && m.key === key) {
        found = doc.id;
      }
    });
    return found;
  }

  // ============================
  // VIN+MAINTENANCE UNIQUE INDEX
  // ============================
  function makeIndexId(vin, family, key) {
    // id stabile e safe
    const v = String(vin).trim().toUpperCase().replace(/[^A-Z0-9]/g, "");
    return `${v}__${family}_${key}`;
  }

  async function reserveMaintenanceIndexOrFail(vin, family, key, ctx) {
    const idxId = makeIndexId(vin, family, key);
    const idxRef = db.collection("MaintenanceIndex").doc(idxId);

    // Transaction: se esiste e non è questo claim -> blocca.
    await db.runTransaction(async (tx) => {
      const snap = await tx.get(idxRef);
      if (snap.exists) {
        const d = snap.data() || {};
        // se è già riservata da un'altra claim, blocca
        const same =
          d.claimCardId === ctx.claimCardId &&
          d.claimCode === ctx.claimCode;
        if (!same) {
          throw new Error(
            `Manutenzione già reclamata in passato su questo VIN. Riferimento: ${d.claimCardId || ""} / ${d.claimCode || ""}`
          );
        }
        // se same, ok (update claim)
        return;
      }

      tx.set(idxRef, {
        vin: String(vin).trim().toUpperCase(),
        family, key,
        claimCardId: ctx.claimCardId,
        claimCode: ctx.claimCode,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
  }

  async function deleteMaintenanceIndexIfNeeded(claimData) {
    try {
      const m = claimData.maintenance || {};
      if (!m.family || !m.key) return;
      const vin = (claimCard && claimCard.data && (claimCard.data.vin || claimCard.data.VIN)) ? (claimCard.data.vin || claimCard.data.VIN) : "";
      if (!vin) return;

      const idxId = makeIndexId(vin, m.family, m.key);
      const idxRef = db.collection("MaintenanceIndex").doc(idxId);

      await db.runTransaction(async (tx) => {
        const snap = await tx.get(idxRef);
        if (!snap.exists) return;
        const d = snap.data() || {};
        // cancella solo se è proprio questa riparazione
        if (d.claimCardId === claimCardId && d.claimCode === claimData.code) {
          tx.delete(idxRef);
        } else {
          // fallback: se claimCode non è salvato come code, prova con doc id
          // (non facciamo delete aggressivo)
        }
      });
    } catch(e) {
      console.warn("Impossibile cancellare MaintenanceIndex:", e);
    }
  }

  // ============================================================
  // CREATE CLAIM
  // ============================================================
  function nextClaimCodeFromExisting(existingCount) {
    const n = existingCount + 1;
    return "R" + String(n).padStart(3, "0");
  }

  async function createClaim(type) {
    const t = (type || "").trim().toUpperCase();
    if (!t) return;

    btnCreateClaim.disabled = true;
    try {
      const claimsRef = db.collection("ClaimCards").doc(claimCardId).collection("Claims");
      const snap = await claimsRef.get();
      const claimCode = nextClaimCodeFromExisting(snap.size);

      const base = {
        code: claimCode,
        claimType: t === "SERVICE CONTRACT" ? "SERVICE CONTRACT" : type, // mantieni label coerente
        status: "Aperto",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (t === "SERVICE CONTRACT") {
        base.claimType = "SERVICE CONTRACT";
        base.maintenance = {
          family: null,
          key: null,
          keyLabel: null,
          templateDocId: null,
          voith: false
        };
      }

      await claimsRef.doc(claimCode).set(base);

      setBanner("ok", claimCode + " creato.");
      setTimeout(()=>setBanner("", ""), 1500);
      await loadClaimsList();
    } catch (e) {
      console.error(e);
      setBanner("err", "Errore creazione claim: " + e.message);
    } finally {
      btnCreateClaim.disabled = false;
    }
  }

  // ============================================================
  // INIT
  // ============================================================
  async function init() {
    setBanner("warn", "Caricamento...");

    // auth guard
    await new Promise((resolve) => {
      const unsub = auth.onAuthStateChanged(async (user) => {
        unsub();
        if (!user) {
          setBanner("err", "Non sei autenticato. Torna al login.");
          resolve();
          return;
        }
        resolve();
      });
    });

    currentUserInfo = await loadCurrentUserInfo();
    await loadMaintenanceMeta();

    const cc = await loadClaimCard();
    if (!cc) return;

    claimCard = cc;
    fillLeftPanel(cc);

    setBanner("", "");

    await loadClaimsList();
  }

  // events
  btnHome.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  btnSave.addEventListener("click", saveClaimCardEdits);

  btnCancel.addEventListener("click", async () => {
    if (!confirm("Vuoi cancellare la richiesta? (non elimina la claim card: imposta stato Cancellata)")) return;
    try {
      await db.collection("ClaimCards").doc(claimCardId).update({
        status: "Cancellata",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setBanner("ok", "Richiesta cancellata.");
      setTimeout(()=>setBanner("", ""), 1500);
    } catch (e) {
      setBanner("err", "Errore: " + e.message);
    }
  });

  btnCreateClaim.addEventListener("click", async () => {
    const type = newClaimType.value;
    if (!type) {
      alert("Seleziona un tipo di claim.");
      return;
    }
    await createClaim(type);
  });

  // start
  init().catch(e => {
    console.error(e);
    setBanner("err", "Errore inizializzazione: " + (e.message || e));
  });
})();
</script>
</body>
</html>
