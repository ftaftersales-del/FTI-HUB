<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTCLAIMS - Dettaglio Claim Card</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Dettagli singoli claim (RSA, Garanzia, ...) -->
  <script src="ftclaims-claimforms.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
    }

    .container {
      width: 100%;
      margin: 0;
      box-sizing: border-box;
      background: #ffffff;
      padding: 20px 30px 25px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      margin-top: 0;
      margin-bottom: 5px;
    }

    .subtitle {
      margin: 0 0 20px;
      color: #666;
      font-size: 14px;
    }

    .alert {
      padding: 10px 15px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }

    .alert-info {
      background-color: #e8f4ff;
      border: 1px solid #bcdcff;
      color: #24527a;
    }
    .alert-error {
      background-color: #ffe8e8;
      border: 1px solid #ffbcbc;
      color: #7a2424;
    }
    .alert-success {
      background-color: #e8ffec;
      border: 1px solid #bcffca;
      color: #247a3a;
    }

    .main-layout {
      display: flex;
      align-items: flex-start;
      gap: 20px;
    }

    .left-column {
      flex: 0 0 420px;
      max-width: 420px;
    }

    .right-column {
      flex: 1;
      min-width: 0;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px 12px 8px;
      background: #fafafa;
      margin-bottom: 12px;
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-column-gap: 10px;
    }

    .form-group {
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: 11px;
      margin-bottom: 3px;
      color: #555;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 5px 7px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
      background-color: #fff;
    }

    input[readonly],
    input:disabled,
    textarea:disabled {
      background-color: #f1f1f1;
      color: #555;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
    }

    .small-text {
      font-size: 11px;
      color: #777;
    }

    .actions {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .btn {
      padding: 7px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-primary {
      background-color: #007bff;
      color: #fff;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-danger {
      background-color: #dc3545;
      color: #fff;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .right-panel {
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fbfbfb;
      padding: 12px;
      margin-bottom: 12px;
    }

    .right-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
    }

    .right-panel h3 {
      margin: 0;
      font-size: 15px;
    }

    .claims-list {
      margin-top: 8px;
    }

    .claim-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #ffffff;
    }

    .claim-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .claim-title {
      font-size: 13px;
      font-weight: bold;
    }

    .claim-meta {
      font-size: 11px;
      color: #555;
      flex: 1;
    }

    .claim-details {
      margin-top: 4px;
      border-top: 1px solid #eee;
      padding-top: 4px;
      margin-bottom: 6px;
    }

    .claim-extra-section {
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px dashed #ddd;
    }

    .claim-extra-title {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 3px;
    }

    .notes-list {
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #ffffff;
      max-height: 160px;
      overflow-y: auto;
      padding: 4px 6px;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .notes-placeholder {
      color: #777;
      font-size: 12px;
    }

    .note-item {
      border-bottom: 1px solid #f0f0f0;
      padding: 3px 0;
    }

    .note-item:last-child {
      border-bottom: none;
    }

    .note-header {
      font-size: 11px;
      color: #555;
      margin-bottom: 1px;
    }

    .note-author {
      font-weight: bold;
    }

    .note-date {
      font-style: italic;
      margin-left: 6px;
    }

    .note-text {
      font-size: 12px;
      color: #222;
      white-space: pre-wrap;
    }

    .notes-input-row {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }

    /* textarea multiriga per le note */
    .notes-input-row textarea {
      flex: 1;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 12px;
      resize: vertical;
      min-height: 40px;
    }

    .attachments-list {
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #ffffff;
      max-height: 160px;
      overflow-y: auto;
      padding: 4px 6px;
      font-size: 12px;
    }

    .attachments-placeholder {
      color: #777;
      font-size: 12px;
    }

    .attachment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f0f0f0;
      padding: 3px 0;
      gap: 6px;
    }

    .attachment-item:last-child {
      border-bottom: none;
    }

    .attachment-info a {
      text-decoration: none;
    }

    .attachment-info a:hover {
      text-decoration: underline;
    }

    .attachment-meta {
      font-size: 11px;
      color: #666;
    }

    .attachment-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    /* RSA shift boxes (usate in ftclaims-claimforms.js) */
    .shift-box {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 12px;
      margin-bottom: 4px;
    }
    .shift-label {
      font-size: 11px;
      font-weight: bold;
    }
    .time-input {
      width: 40px;
      text-align: right;
    }
    .time-separator {
      font-size: 13px;
      font-weight: bold;
    }

    @media (max-width: 992px) {
      .main-layout {
        flex-direction: column;
      }
      .left-column {
        max-width: 100%;
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Dettaglio Claim Card</h2>
    <p class="subtitle">Visualizza e gestisci i dati della pratica.</p>

    <div id="messageArea" class="alert alert-info"></div>

    <div class="main-layout">
      <!-- COLONNA SINISTRA -->
      <div class="left-column">

        <!-- Dati pratica -->
        <div class="card">
          <h3>Dati pratica</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="claimCode">Codice pratica</label>
              <input type="text" id="claimCode" readonly>
            </div>
            <div class="form-group">
              <label for="claimType">Tipologia</label>
              <input type="text" id="claimType" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="openDate">Data apertura</label>
              <input type="date" id="openDate" readonly>
            </div>
            <div class="form-group">
              <label for="orderDate">Data ordine di lavoro</label>
              <input type="date" id="orderDate" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="openUser">Nome operatore apertura</label>
              <input type="text" id="openUser" readonly>
            </div>
            <div class="form-group">
              <label for="openDealer">Dealer apertura</label>
              <input type="text" id="openDealer" readonly>
            </div>
          </div>

          <div class="form-group">
            <label for="claimStatus">Stato pratica</label>
            <input type="text" id="claimStatus" readonly>
            <div class="small-text">
              Stati possibili: Aperta, Inviata, Sospesa, In Valutazione, Conclusa, Chiusa, Cancellata.
            </div>
          </div>
        </div>

        <!-- Dati veicolo -->
        <div class="card">
          <h3>Dati veicolo</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="vin">VIN</label>
              <input type="text" id="vin" readonly>
            </div>
            <div class="form-group">
              <label for="customer">Customer</label>
              <input type="text" id="customer" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="registrationPlate">Registration Plate</label>
              <input type="text" id="registrationPlate">
            </div>
            <div class="form-group">
              <label for="registrationDate">Registration Date</label>
              <input type="date" id="registrationDate">
            </div>
          </div>
        </div>

        <!-- Copertura garanzia -->
        <div class="card">
          <h3>Copertura garanzia alla data dell'ordine di lavoro</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="coverageType">Tipo copertura</label>
              <input type="text" id="coverageType" readonly>
            </div>
            <div class="form-group">
              <label for="coverageStart">Data inizio</label>
              <input type="date" id="coverageStart" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="coverageEnd">Data fine</label>
              <input type="date" id="coverageEnd" readonly>
            </div>
            <div class="form-group"></div>
          </div>

          <div class="form-group" id="coverageNotesRow">
            <label for="coverageNotes">Note copertura (visibili solo al distributore)</label>
            <textarea id="coverageNotes" disabled></textarea>
          </div>
        </div>

        <!-- Contratto manutenzione -->
        <div class="card">
          <h3>Contratto di manutenzione (se presente)</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="mcStart">Data inizio</label>
              <input type="date" id="mcStart" readonly>
            </div>
            <div class="form-group">
              <label for="mcEnd">Data fine</label>
              <input type="date" id="mcEnd" readonly>
            </div>
          </div>

          <div class="form-group">
            <label for="mcOptions">Opzioni presenti</label>
            <textarea id="mcOptions" readonly></textarea>
          </div>
        </div>

        <!-- KM / Ore -->
        <div class="card">
          <h3>Chilometraggio / ore motore</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="vehicleKm">KM veicolo</label>
              <input type="number" id="vehicleKm" min="0" step="1">
            </div>
            <div class="form-group">
              <label for="engineHours">Ore motore</label>
              <input type="number" id="engineHours" min="0" step="1">
            </div>
          </div>
        </div>

        <!-- Azioni -->
        <div class="actions">
          <button id="btnHome" class="btn btn-secondary">Home Page</button>
          <div>
            <button id="btnSave" class="btn btn-primary">Salva modifiche</button>
            <button id="btnDelete" class="btn btn-danger">Cancella richiesta</button>
          </div>
        </div>

      </div>

      <!-- COLONNA DESTRA -->
      <div class="right-column">

        <!-- Gestione CLAIMS -->
        <div class="right-panel">
          <div class="right-panel-header">
            <h3>Gestione claim collegati alla claim card</h3>
          </div>

          <div class="form-row" style="margin-bottom:8px;">
            <div class="form-group">
              <label for="claimTypeSelect">Tipologia claim da creare</label>
              <select id="claimTypeSelect"></select>
              <div class="small-text">
                Seleziona la tipologia e premi "Crea claim".
              </div>
            </div>
            <div class="form-group" style="display:flex; align-items:flex-end; justify-content:flex-end;">
              <button id="btnCreateClaim" class="btn btn-primary btn-small" type="button">
                Crea claim
              </button>
            </div>
          </div>

          <div id="claimsList" class="claims-list"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', function () {
      if (typeof firebase === 'undefined') {
        console.error('Firebase non è definito. Controlla gli script nel <head>.');
        return;
      }

      const auth = firebase.auth();
      const db   = firebase.firestore();

      let currentUser = null;
      let currentClaimId = null;
      let isDistributor = false;
      let currentUserName = '';
      let currentUserDealerId = '';
      let claimCardType = '';

      // Listener per note/allegati per ogni claim (key = claimCode)
      const claimNotesUnsub = {};
      const claimAttachmentsUnsub = {};

      const ALLOWED_ATTACHMENT_EXTENSIONS = [
        'png', 'jpg', 'jpeg',
        'xlsx', 'xls', 'doc', 'docx', 'dox',
        'pdf', 'rar', 'zip',
        'mp4', 'mp3', 'mp33'
      ];

      const messageArea = document.getElementById('messageArea');

      function showMessage(text, type) {
        messageArea.textContent = text;
        messageArea.className = 'alert';
        if (type === 'error') messageArea.classList.add('alert-error');
        else if (type === 'success') messageArea.classList.add('alert-success');
        else messageArea.classList.add('alert-info');
        messageArea.style.display = 'block';
      }

      function clearMessage() {
        messageArea.style.display = 'none';
        messageArea.textContent = '';
      }

      function formatDateTime(ts) {
        if (!ts) return '';
        try {
          const d = ts.toDate ? ts.toDate() : ts;
          const dd = String(d.getDate()).padStart(2, '0');
          const mm = String(d.getMonth() + 1).toString().padStart(2, '0');
          const yyyy = d.getFullYear();
          const hh = String(d.getHours()).padStart(2, '0');
          const min = String(d.getMinutes()).padStart(2, '0');
          return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
        } catch (e) {
          return '';
        }
      }

      function normalizeClaimType(ct) {
        return (ct || '').toString().trim().toUpperCase();
      }

      function getClaimIdFromContext() {
        let id = null;

        const fromSS = sessionStorage.getItem('ftclaims_claimCode');
        if (fromSS) {
          id = fromSS;
        } else {
          const headerStr = sessionStorage.getItem('currentClaimStep1');
          if (headerStr) {
            try {
              const header = JSON.parse(headerStr);
              if (header && header.claimId) {
                id = header.claimId;
              }
            } catch (e) {
              console.warn('Impossibile leggere currentClaimStep1:', e);
            }
          }
        }

        if (!id) {
          const params = new URLSearchParams(window.location.search);
          id = params.get('id');
        }

        return id;
      }

      async function loadUserInfo(user) {
        try {
          const doc = await db.collection('Users').doc(user.uid).get();
          if (doc.exists) {
            const data = doc.data() || {};
            const role = data.role || '';

            if (typeof role === 'string' && role.toLowerCase().includes('distributor')) {
              isDistributor = true;
            }

            currentUserName =
              data.displayName ||
              data.name ||
              data.fullName ||
              data.username ||
              user.email ||
              '';

            currentUserDealerId =
              data.dealerId ||
              data.dealerID ||
              data.DealerID ||
              data.DealerId ||
              null;
          }
        } catch (err) {
          console.error('Errore caricamento utente', err);
        }

        const notesRow = document.getElementById('coverageNotesRow');
        if (!isDistributor && notesRow) {
          notesRow.style.display = 'none';
        }
      }

      function populateClaimTypeSelect() {
        const select = document.getElementById('claimTypeSelect');
        if (!select) return;

        select.innerHTML = '';

        let options = [];
        const cardTypeNorm = normalizeClaimType(claimCardType);

        if (cardTypeNorm === 'WARRANTY' || cardTypeNorm === 'FULL LINE' || cardTypeNorm === 'DRIVE LINE') {
          options = [
            { value: 'RSA', label: 'RSA' },
            { value: 'GARANZIA', label: 'Garanzia' },
            { value: 'GARANZIA RICAMBIO', label: 'Garanzia Ricambio' }
          ];
        } else if (cardTypeNorm === 'MAINTENANCE') {
          options = [
            { value: 'MANUTENZIONE', label: 'Manutenzione' }
          ];
        } else if (cardTypeNorm === 'FSA') {
          options = [
            { value: 'FSA', label: 'FSA' }
          ];
        } else if (cardTypeNorm === 'GOODWILL') {
          options = [
            { value: 'GOODWILL', label: 'Goodwill' }
          ];
        } else {
          options = [
            { value: 'RSA', label: 'RSA' },
            { value: 'GARANZIA', label: 'Garanzia' },
            { value: 'GARANZIA RICAMBIO', label: 'Garanzia Ricambio' },
            { value: 'MANUTENZIONE', label: 'Manutenzione' },
            { value: 'FSA', label: 'FSA' },
            { value: 'GOODWILL', label: 'Goodwill' }
          ];
        }

        const empty = document.createElement('option');
        empty.value = '';
        empty.textContent = 'Seleziona...';
        select.appendChild(empty);

        options.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.label;
          select.appendChild(opt);
        });
      }

      async function loadClaimCard() {
        clearMessage();
        currentClaimId = getClaimIdFromContext();

        if (!currentClaimId) {
          showMessage('Errore: nessuna pratica selezionata.', 'error');
          return;
        }

        try {
          const ref = db.collection('ClaimCards').doc(currentClaimId);
          const snap = await ref.get();

          if (!snap.exists) {
            showMessage('La pratica specificata non è stata trovata in banca dati.', 'error');
            return;
          }

          const data = snap.data() || {};

          document.getElementById('claimCode').value  = data.code || currentClaimId;
          document.getElementById('claimType').value  = data.type || '';

          claimCardType = data.type || '';

          if (data.openDate)  document.getElementById('openDate').value  = data.openDate;
          if (data.orderDate) document.getElementById('orderDate').value = data.orderDate;

          document.getElementById('openUser').value   = data.openUser || '';
          document.getElementById('openDealer').value = data.openDealer || data.dealerId || '';

          let status = data.status || 'Aperta';
          document.getElementById('claimStatus').value = status;

          const veh = data.vehicle || {};
          document.getElementById('vin').value      = veh.vin || data.vin || '';
          document.getElementById('customer').value = veh.customer || data.customer || '';

          const regPlate = veh.registrationPlate || data.registrationPlate || '';
          const regDate  = veh.registrationDate  || data.registrationDate   || '';

          document.getElementById('registrationPlate').value = regPlate;
          if (regDate) document.getElementById('registrationDate').value = regDate;

          const coverage = data.coverage || {};
          document.getElementById('coverageType').value = coverage.type || '';
          if (coverage.startDate) document.getElementById('coverageStart').value = coverage.startDate;
          if (coverage.endDate)   document.getElementById('coverageEnd').value   = coverage.endDate;
          document.getElementById('coverageNotes').value = coverage.notes || '';

          const mc = data.maintenanceContract || {};
          if (mc.startDate) document.getElementById('mcStart').value = mc.startDate;
          if (mc.endDate)   document.getElementById('mcEnd').value   = mc.endDate;
          document.getElementById('mcOptions').value = mc.options || '';

          const km    = data.km ?? '';
          const hours = data.engineHours ?? '';

          document.getElementById('vehicleKm').value   = km;
          document.getElementById('engineHours').value = hours;

          populateClaimTypeSelect();

          showMessage('Pratica caricata correttamente.', 'success');

        } catch (err) {
          console.error(err);
          showMessage('Errore nel caricamento della pratica: ' + err.message, 'error');
        }
      }

      function clearClaimListeners() {
        for (const k in claimNotesUnsub) {
          try { claimNotesUnsub[k](); } catch (e) {}
          delete claimNotesUnsub[k];
        }
        for (const k in claimAttachmentsUnsub) {
          try { claimAttachmentsUnsub[k](); } catch (e) {}
          delete claimAttachmentsUnsub[k];
        }
      }

      async function loadClaims() {
        const list = document.getElementById('claimsList');
        list.innerHTML = '';

        clearClaimListeners();

        if (!currentClaimId) return;

        try {
          const snap = await db
            .collection('ClaimCards')
            .doc(currentClaimId)
            .collection('Claims')
            .orderBy('code')
            .get();

          if (snap.empty) {
            const div = document.createElement('div');
            div.className = 'small-text';
            div.textContent = 'Non sono ancora presenti claim collegati a questa pratica.';
            list.appendChild(div);
            return;
          }

          snap.forEach(docSnap => {
            const data = docSnap.data() || {};
            const code = data.code || docSnap.id;
            const type = data.type || '';

            const card = document.createElement('div');
            card.className = 'claim-card';

            const header = document.createElement('div');
            header.className = 'claim-card-header';

            const title = document.createElement('div');
            title.className = 'claim-title';
            title.textContent = 'Claim ' + code;

            const meta = document.createElement('div');
            meta.className = 'claim-meta';
            meta.textContent = type ? ('Tipo: ' + type) : 'Tipo non specificato';

            const btnDel = document.createElement('button');
            btnDel.className = 'btn btn-danger btn-small';
            btnDel.textContent = 'Elimina claim';
            btnDel.addEventListener('click', () => deleteRepair(code));

            header.appendChild(title);
            header.appendChild(meta);
            header.appendChild(btnDel);

            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'claim-details';

            card.appendChild(header);
            card.appendChild(detailsDiv);

            // Dettagli specifici (RSA, Garanzia, ecc.)
            try {
              renderClaimDetails(
                type,
                detailsDiv,
                data,
                { claimCardId: currentClaimId, claimCode: code }
              );
            } catch (e) {
              console.error('Errore renderClaimDetails per claim', code, e);
            }

            // SEZIONE NOTE CLAIM
            const notesSection = document.createElement('div');
            notesSection.className = 'claim-extra-section';

            const notesTitle = document.createElement('div');
            notesTitle.className = 'claim-extra-title';
            notesTitle.textContent = 'Note claim';

            const notesListEl = document.createElement('div');
            notesListEl.className = 'notes-list';

            const notesInputRow = document.createElement('div');
            notesInputRow.className = 'notes-input-row';

            // textarea multiriga per l'inserimento nota
            const noteInput = document.createElement('textarea');
            noteInput.placeholder = 'Scrivi una nota per questo claim...';

            const btnAddNote = document.createElement('button');
            btnAddNote.type = 'button';
            btnAddNote.className = 'btn btn-primary btn-small';
            btnAddNote.textContent = 'Aggiungi';

            notesInputRow.appendChild(noteInput);
            notesInputRow.appendChild(btnAddNote);

            notesSection.appendChild(notesTitle);
            notesSection.appendChild(notesListEl);
            notesSection.appendChild(notesInputRow);

            // SEZIONE ALLEGATI CLAIM
            const attachSection = document.createElement('div');
            attachSection.className = 'claim-extra-section';

            const attachTitle = document.createElement('div');
            attachTitle.className = 'claim-extra-title';
            attachTitle.textContent = 'Allegati claim';

            const attachUploadRow = document.createElement('div');
            attachUploadRow.className = 'notes-input-row';

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.style.flex = '1';

            const btnUpload = document.createElement('button');
            btnUpload.type = 'button';
            btnUpload.className = 'btn btn-secondary btn-small';
            btnUpload.textContent = 'Carica';

            attachUploadRow.appendChild(fileInput);
            attachUploadRow.appendChild(btnUpload);

            const attachListEl = document.createElement('div');
            attachListEl.className = 'attachments-list';

            attachSection.appendChild(attachTitle);
            attachSection.appendChild(attachUploadRow);
            attachSection.appendChild(attachListEl);

            card.appendChild(notesSection);
            card.appendChild(attachSection);

            list.appendChild(card);

            // Listener note e allegati per questo claim
            startClaimNotesListener(code, notesListEl);
            startClaimAttachmentsListener(code, attachListEl);

            btnAddNote.addEventListener('click', () => addClaimNote(code, noteInput));
            // niente Enter automatico: dentro la textarea va a capo

            btnUpload.addEventListener('click', () => uploadClaimFiles(code, fileInput, btnUpload));
          });

        } catch (err) {
          console.error(err);
          showMessage('Errore nel caricamento dei claim: ' + err.message, 'error');
        }
      }

      async function saveChanges() {
        clearMessage();
        if (!currentClaimId) {
          showMessage('Impossibile salvare: nessuna pratica caricata.', 'error');
          return;
        }

        const btnSave = document.getElementById('btnSave');
        btnSave.disabled = true;

        try {
          const regPlate = document.getElementById('registrationPlate').value.trim();
          const regDate  = document.getElementById('registrationDate').value || null;

          const kmRaw = document.getElementById('vehicleKm').value;
          const hRaw  = document.getElementById('engineHours').value;

          const kmVal = kmRaw === '' ? null : Number(kmRaw);
          const hVal  = hRaw === '' ? null : Number(hRaw);

          const updates = {
            registrationPlate: regPlate || null,
            registrationDate:  regDate,
            km: kmVal,
            engineHours: hVal
          };

          await db.collection('ClaimCards').doc(currentClaimId).update(updates);
          showMessage('Salvataggio completato.', 'success');
        } catch (err) {
          console.error(err);
          showMessage('Errore nel salvataggio: ' + err.message, 'error');
        } finally {
          btnSave.disabled = false;
        }
      }

      async function cancelRequest() {
        clearMessage();
        if (!currentClaimId) {
          showMessage('Impossibile cancellare: nessuna pratica caricata.', 'error');
          return;
        }

        if (!confirm('Sei sicuro di voler cancellare questa richiesta?')) {
          return;
        }

        try {
          const ref = db.collection('ClaimCards').doc(currentClaimId);
          await ref.update({ status: 'Cancellata' });
          document.getElementById('claimStatus').value = 'Cancellata';
          showMessage('Richiesta cancellata (stato impostato su "Cancellata").', 'success');
        } catch (err) {
          console.error(err);
          showMessage('Errore durante la cancellazione della richiesta: ' + err.message, 'error');
        }
      }

      function goHome() {
        window.location.href = 'FTHUBAS.html';
      }

      async function createClaim() {
        clearMessage();
        if (!currentClaimId) {
          showMessage('Impossibile aggiungere claim: nessuna pratica caricata.', 'error');
          return;
        }

        const select = document.getElementById('claimTypeSelect');
        if (!select || !select.value) {
          showMessage('Seleziona una tipologia di claim valida prima di creare il claim.', 'error');
          return;
        }

        const chosenType = select.value;

        const btn = document.getElementById('btnCreateClaim');
        btn.disabled = true;

        try {
          const cardRef = db.collection('ClaimCards').doc(currentClaimId);

          const newCode = await db.runTransaction(async (tx) => {
            const snap = await tx.get(cardRef);
            if (!snap.exists) {
              throw new Error('Pratica non trovata.');
            }
            const data = snap.data() || {};
            let lastNum = data.lastClaimNumber || 0;
            const nextNum = lastNum + 1;
            const code = String(nextNum).padStart(3, '0');

            tx.update(cardRef, { lastClaimNumber: nextNum });

            const claimRef = cardRef.collection('Claims').doc(code);
            tx.set(claimRef, {
              code: code,
              type: chosenType,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            return code;
          });

          showMessage('Claim ' + newCode + ' (' + chosenType + ') creato.', 'success');
          await loadClaims();
        } catch (err) {
          console.error(err);
          showMessage('Errore nella creazione del claim: ' + err.message, 'error');
        } finally {
          btn.disabled = false;
        }
      }

      async function deleteRepair(code) {
        clearMessage();
        if (!currentClaimId || !code) return;

        if (!confirm('Vuoi davvero eliminare il claim ' + code + '?')) {
          return;
        }

        try {
          const cardRef = db.collection('ClaimCards').doc(currentClaimId);
          await cardRef.collection('Claims').doc(code).delete();
          showMessage('Claim ' + code + ' eliminato.', 'success');
          await loadClaims();
        } catch (err) {
          console.error(err);
          showMessage('Errore durante l\'eliminazione del claim: ' + err.message, 'error');
        }
      }

      function startClaimNotesListener(claimCode, containerEl) {
        if (!currentClaimId || !containerEl) return;

        if (claimNotesUnsub[claimCode]) {
          claimNotesUnsub[claimCode]();
          delete claimNotesUnsub[claimCode];
        }

        const ref = db
          .collection('ClaimCards')
          .doc(currentClaimId)
          .collection('Claims')
          .doc(claimCode)
          .collection('Notes');

        claimNotesUnsub[claimCode] = ref
          .orderBy('createdAt', 'asc')
          .onSnapshot(
            (snap) => {
              containerEl.innerHTML = '';

              if (snap.empty) {
                const div = document.createElement('div');
                div.className = 'notes-placeholder';
                div.textContent = 'Nessuna nota per questo claim.';
                containerEl.appendChild(div);
                return;
              }

              snap.forEach(docSnap => {
                const d = docSnap.data() || {};
                const wrapper = document.createElement('div');
                wrapper.className = 'note-item';

                const header = document.createElement('div');
                header.className = 'note-header';

                const authorSpan = document.createElement('span');
                authorSpan.className = 'note-author';
                authorSpan.textContent = d.authorName || 'Sconosciuto';

                const dateSpan = document.createElement('span');
                dateSpan.className = 'note-date';
                dateSpan.textContent = formatDateTime(d.createdAt);

                header.appendChild(authorSpan);
                header.appendChild(dateSpan);

                const textDiv = document.createElement('div');
                textDiv.className = 'note-text';
                textDiv.textContent = d.text || '';

                wrapper.appendChild(header);
                wrapper.appendChild(textDiv);

                containerEl.appendChild(wrapper);
              });

              containerEl.scrollTop = containerEl.scrollHeight;
            },
            (err) => {
              console.error('Errore listener note claim', claimCode, err);
            }
          );
      }

      async function addClaimNote(claimCode, inputEl) {
        if (!currentClaimId || !inputEl) return;
        const text = (inputEl.value || '').trim();
        if (!text) return;

        try {
          const ref = db
            .collection('ClaimCards')
            .doc(currentClaimId)
            .collection('Claims')
            .doc(claimCode)
            .collection('Notes');

          await ref.add({
            text: text,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            authorUid: currentUser ? currentUser.uid : null,
            authorName: currentUserName || null,
            authorDealerId: currentUserDealerId || null
          });

          inputEl.value = '';
        } catch (err) {
          console.error('Errore salvataggio nota claim', claimCode, err);
          alert('Errore nel salvataggio della nota: ' + err.message);
        }
      }

      async function deleteClaimAttachment(claimCode, attachmentId, path) {
        if (!currentClaimId || !attachmentId) return;
        if (!confirm('Vuoi eliminare questo allegato?')) return;

        try {
          // cancello file dallo Storage (se presente)
          if (typeof firebase.storage !== 'undefined' && path) {
            try {
              const storage = firebase.storage();
              await storage.ref(path).delete();
            } catch (e) {
              console.warn('Errore eliminazione file Storage, proseguo con il documento Firestore', e);
            }
          }

          // cancello il documento Firestore
          const docRef = db
            .collection('ClaimCards')
            .doc(currentClaimId)
            .collection('Claims')
            .doc(claimCode)
            .collection('Attachments')
            .doc(attachmentId);

          await docRef.delete();
        } catch (err) {
          console.error('Errore eliminazione allegato claim', claimCode, err);
          alert('Errore durante l\'eliminazione dell\'allegato: ' + err.message);
        }
      }

      function startClaimAttachmentsListener(claimCode, containerEl) {
        if (!currentClaimId || !containerEl) return;

        if (claimAttachmentsUnsub[claimCode]) {
          claimAttachmentsUnsub[claimCode]();
          delete claimAttachmentsUnsub[claimCode];
        }

        const ref = db
          .collection('ClaimCards')
          .doc(currentClaimId)
          .collection('Claims')
          .doc(claimCode)
          .collection('Attachments');

        claimAttachmentsUnsub[claimCode] = ref
          .orderBy('uploadedAt', 'desc')
          .onSnapshot(
            (snap) => {
              containerEl.innerHTML = '';

              if (snap.empty) {
                const div = document.createElement('div');
                div.className = 'attachments-placeholder';
                div.textContent = 'Nessun allegato per questo claim.';
                containerEl.appendChild(div);
                return;
              }

              snap.forEach(docSnap => {
                const d = docSnap.data() || {};

                // escludo fatture precedenti (gestite nel blocco dedicato)
                if (d.category === 'prevRepairInvoice') {
                  return;
                }

                const row = document.createElement('div');
                row.className = 'attachment-item';

                const infoDiv = document.createElement('div');
                infoDiv.className = 'attachment-info';

                const link = document.createElement('a');
                link.href = d.url || '#';
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = d.name || 'file';

                const meta = document.createElement('div');
                meta.className = 'attachment-meta';
                meta.textContent = formatDateTime(d.uploadedAt) +
                  (d.authorName ? ' - ' + d.authorName : '');

                infoDiv.appendChild(link);
                infoDiv.appendChild(meta);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'attachment-actions';

                const btnDel = document.createElement('button');
                btnDel.type = 'button';
                btnDel.className = 'btn btn-danger btn-small';
                btnDel.textContent = 'Elimina';
                btnDel.addEventListener('click', () => {
                  deleteClaimAttachment(claimCode, docSnap.id, d.path);
                });

                actionsDiv.appendChild(btnDel);

                row.appendChild(infoDiv);
                row.appendChild(actionsDiv);

                containerEl.appendChild(row);
              });
            },
            (err) => {
              console.error('Errore listener allegati claim', claimCode, err);
            }
          );
      }

      async function uploadClaimFiles(claimCode, fileInput, btn) {
        if (!currentClaimId || !fileInput) return;
        const files = fileInput.files || [];
        if (!files.length) return;

        if (typeof firebase.storage === 'undefined') {
          alert('Storage Firebase non disponibile.');
          return;
        }

        const invalidFiles = [];
        const validFiles = [];

        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          const name = f.name || '';
          const parts = name.split('.');
          const ext = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';

          if (!ALLOWED_ATTACHMENT_EXTENSIONS.includes(ext)) {
            invalidFiles.push(name);
          } else {
            validFiles.push(f);
          }
        }

        if (invalidFiles.length > 0) {
          alert(
            'I seguenti file hanno un formato non consentito e non sono stati caricati:\n\n' +
            invalidFiles.join('\n') +
            '\n\nFormati ammessi: png, jpg, jpeg, xlsx, xls, doc, docx, dox, pdf, rar, zip, mp4, mp3, mp33.'
          );
        }

        if (!validFiles.length) {
          return;
        }

        const storage = firebase.storage();
        if (btn) btn.disabled = true;

        try {
          const basePath = 'ClaimCards/' + currentClaimId + '/Claims/' + claimCode + '/Attachments/';
          const collRef = db
            .collection('ClaimCards')
            .doc(currentClaimId)
            .collection('Claims')
            .doc(claimCode)
            .collection('Attachments');

          for (let i = 0; i < validFiles.length; i++) {
            const f = validFiles[i];
            const safeName = f.name.replace(/[^\w.\-]/g, '_');
            const path = basePath + Date.now() + '_' + safeName;

            const ref = storage.ref(path);
            await ref.put(f);
            const url = await ref.getDownloadURL();

            await collRef.add({
              name: f.name,
              path: path,
              url: url,
              category: 'claimAttachment',
              uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
              authorUid: currentUser ? currentUser.uid : null,
              authorName: currentUserName || null,
              authorDealerId: currentUserDealerId || null
            });
          }

          fileInput.value = '';
        } catch (err) {
          console.error('Errore caricamento allegati claim', claimCode, err);
          alert('Errore nel caricamento degli allegati: ' + err.message);
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      // INIT AUTH
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'FTHUBAS.html';
          return;
        }
        currentUser = user;
        await loadUserInfo(user);
        await loadClaimCard();
        await loadClaims();
      });

      // LISTENER BOTTONI
      document.getElementById('btnSave').addEventListener('click', saveChanges);
      document.getElementById('btnDelete').addEventListener('click', cancelRequest);
      document.getElementById('btnHome').addEventListener('click', goHome);
      document.getElementById('btnCreateClaim').addEventListener('click', createClaim);
    });
  </script>
</body>
</html>
