<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FTCLAIMS - Dettaglio Claim Card</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
    }

    .container {
      width: 100%;
      box-sizing: border-box;
      background: #ffffff;
      padding: 20px 30px 25px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      margin-top: 0;
      margin-bottom: 5px;
    }

    .subtitle {
      margin: 0 0 20px;
      color: #666;
      font-size: 14px;
    }

    .alert {
      padding: 10px 15px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }

    .alert-info {
      background-color: #e8f4ff;
      border: 1px solid #bcdcff;
      color: #24527a;
    }
    .alert-error {
      background-color: #ffe8e8;
      border: 1px solid #ffbcbc;
      color: #7a2424;
    }
    .alert-success {
      background-color: #e8ffec;
      border: 1px solid #bcffca;
      color: #247a3a;
    }

    .main-layout {
      display: flex;
      align-items: flex-start;
      gap: 20px;
    }

    .left-column {
      flex: 0 0 420px;
      max-width: 420px;
    }

    .right-column {
      flex: 1;
      min-width: 0;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px 12px 8px;
      background: #fafafa;
      margin-bottom: 12px;
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-column-gap: 10px;
    }

    .form-group {
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: 11px;
      margin-bottom: 3px;
      color: #555;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 5px 7px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
      background-color: #fff;
    }

    input[readonly],
    input:disabled,
    textarea:disabled {
      background-color: #f1f1f1;
      color: #555;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
    }

    .small-text {
      font-size: 11px;
      color: #777;
    }

    .actions {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .btn {
      padding: 7px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-primary {
      background-color: #007bff;
      color: #fff;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-danger {
      background-color: #dc3545;
      color: #fff;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
    }

    /* Pannello destra (claim) */
    .right-panel {
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fbfbfb;
      padding: 12px;
      min-height: 400px;
    }

    .right-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .right-panel h3 {
      margin: 0;
      font-size: 15px;
    }

    .right-panel-placeholder {
      font-size: 13px;
      color: #777;
      margin-top: 8px;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .claims-list {
      margin-top: 8px;
    }

    .claim-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .claim-title {
      font-size: 13px;
      font-weight: bold;
    }

    .btn-delete-claim {
      padding: 4px 8px;
      font-size: 11px;
    }

    @media (max-width: 992px) {
      .main-layout {
        flex-direction: column;
      }
      .left-column {
        max-width: 100%;
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Dettaglio Claim Card</h2>
    <p class="subtitle">Visualizza e gestisci i dati della pratica.</p>

    <div id="messageArea" class="alert alert-info"></div>

    <div class="main-layout">
      <!-- COLONNA SINISTRA -->
      <div class="left-column">

        <!-- Dati pratica -->
        <div class="card">
          <h3>Dati pratica</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="claimCode">Codice pratica</label>
              <input type="text" id="claimCode" readonly>
            </div>
            <div class="form-group">
              <label for="claimType">Tipologia</label>
              <input type="text" id="claimType" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="openDate">Data apertura</label>
              <input type="date" id="openDate" readonly>
            </div>
            <div class="form-group">
              <label for="orderDate">Data ordine di lavoro</label>
              <input type="date" id="orderDate" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="openUser">Nome operatore apertura</label>
              <input type="text" id="openUser" readonly>
            </div>
            <div class="form-group">
              <label for="openDealer">Dealer apertura</label>
              <input type="text" id="openDealer" readonly>
            </div>
          </div>

          <div class="form-group">
            <label for="claimStatus">Stato pratica</label>
            <input type="text" id="claimStatus" readonly>
            <div class="small-text">
              Stati possibili: Aperto, Inviato, Sospeso, In Valutazione, Concluso, Chiuso, Cancellato.
            </div>
          </div>
        </div>

        <!-- Dati veicolo -->
        <div class="card">
          <h3>Dati veicolo</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="vin">VIN</label>
              <input type="text" id="vin" readonly>
            </div>
            <div class="form-group">
              <label for="customer">Customer</label>
              <input type="text" id="customer" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="registrationPlate">Registration Plate</label>
              <input type="text" id="registrationPlate">
            </div>
            <div class="form-group">
              <label for="registrationDate">Registration Date</label>
              <input type="date" id="registrationDate">
            </div>
          </div>
        </div>

        <!-- Copertura garanzia -->
        <div class="card">
          <h3>Copertura garanzia alla data dell'ordine di lavoro</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="coverageType">Tipo copertura</label>
              <input type="text" id="coverageType" readonly>
            </div>
            <div class="form-group">
              <label for="coverageStart">Data inizio</label>
              <input type="date" id="coverageStart" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="coverageEnd">Data fine</label>
              <input type="date" id="coverageEnd" readonly>
            </div>
            <div class="form-group"></div>
          </div>

          <div class="form-group" id="coverageNotesRow">
            <label for="coverageNotes">Note copertura (visibili solo al distributore)</label>
            <textarea id="coverageNotes" disabled></textarea>
          </div>
        </div>

        <!-- Contratto manutenzione -->
        <div class="card">
          <h3>Contratto di manutenzione (se presente)</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="mcStart">Data inizio</label>
              <input type="date" id="mcStart" readonly>
            </div>
            <div class="form-group">
              <label for="mcEnd">Data fine</label>
              <input type="date" id="mcEnd" readonly>
            </div>
          </div>

          <div class="form-group">
            <label for="mcOptions">Opzioni presenti</label>
            <textarea id="mcOptions" readonly></textarea>
          </div>
        </div>

        <!-- KM / Ore -->
        <div class="card">
          <h3>Chilometraggio / ore motore</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="vehicleKm">KM veicolo</label>
              <input type="number" id="vehicleKm" min="0" step="1">
            </div>
            <div class="form-group">
              <label for="engineHours">Ore motore</label>
              <input type="number" id="engineHours" min="0" step="1">
            </div>
          </div>
        </div>

        <!-- Azioni -->
        <div class="actions">
          <button id="btnHome" class="btn btn-secondary">Home Page</button>
          <div>
            <button id="btnSave" class="btn btn-primary">Salva modifiche</button>
            <button id="btnDelete" class="btn btn-danger">Cancella richiesta</button>
          </div>
        </div>

      </div>

      <!-- COLONNA DESTRA -->
      <div class="right-column">
        <div class="right-panel">
          <div class="right-panel-header">
            <h3>Gestione claim collegati alla claim card</h3>
            <button id="btnAddRepair" class="btn btn-primary btn-small">Aggiungi riparazione</button>
          </div>
          <div id="claimsList" class="claims-list"></div>
          <div class="right-panel-placeholder" id="claimsPlaceholder">
            In questa area verranno gestiti i singoli claim (FSA, Reclamo di Garanzia,
            Contratto di Manutenzione, ecc.) collegati alla stessa claim card.
            <br>Per il momento sono visibili solo il codice riparazione e il tasto di eliminazione.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const auth = firebase.auth();
    const db   = firebase.firestore();

    let currentUser = null;
    let currentClaimId = null;
    let isDistributor = false;

    function showMessage(text, type) {
      const area = document.getElementById('messageArea');
      area.textContent = text;
      area.className = 'alert';
      if (type === 'error') area.classList.add('alert-error');
      else if (type === 'success') area.classList.add('alert-success');
      else area.classList.add('alert-info');
      area.style.display = 'block';
    }

    function clearMessage() {
      const area = document.getElementById('messageArea');
      area.style.display = 'none';
      area.textContent = '';
    }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    async function loadUserInfo(user) {
      try {
        const doc = await db.collection('Users').doc(user.uid).get();
        if (doc.exists) {
          const data = doc.data() || {};
          const role = data.role || '';
          if (typeof role === 'string' && role.toLowerCase().includes('distributor')) {
            isDistributor = true;
          }
        }
      } catch (err) {
        console.error('Errore caricamento utente', err);
      }

      const notesRow = document.getElementById('coverageNotesRow');
      if (!isDistributor && notesRow) {
        notesRow.style.display = 'none';
      }
    }

    async function loadClaimCard() {
      clearMessage();
      currentClaimId = getQueryParam('id');

      if (!currentClaimId) {
        showMessage('Errore: nessuna pratica specificata (parametro "id" mancante).', 'error');
        return;
      }

      try {
        const ref = db.collection('ClaimCards').doc(currentClaimId);
        const snap = await ref.get();

        if (!snap.exists) {
          showMessage('Pratica non trovata.', 'error');
          return;
        }

        const data = snap.data() || {};

        document.getElementById('claimCode').value  = data.code || '';
        document.getElementById('claimType').value  = data.type || '';

        if (data.openDate)  document.getElementById('openDate').value  = data.openDate;
        if (data.orderDate) document.getElementById('orderDate').value = data.orderDate;

        document.getElementById('openUser').value   = data.openUserName || '';
        document.getElementById('openDealer').value = data.openDealerId || data.dealerId || '';

        let status = data.status || 'Aperto';
        document.getElementById('claimStatus').value = status;
        if (!data.status) {
          await ref.update({ status: status });
        }

        document.getElementById('vin').value      = data.vin || data.vehicleVin || '';
        document.getElementById('customer').value = data.customer || data.customerName || '';

        const regPlate = data.registrationPlate || data.plateNumber || '';
        const regDate  = data.registrationDate   || data.plateDate   || '';

        document.getElementById('registrationPlate').value = regPlate;
        if (regDate) document.getElementById('registrationDate').value = regDate;

        const coverage = data.coverage || {};
        document.getElementById('coverageType').value = coverage.type || '';
        if (coverage.startDate) document.getElementById('coverageStart').value = coverage.startDate;
        if (coverage.endDate)   document.getElementById('coverageEnd').value   = coverage.endDate;
        document.getElementById('coverageNotes').value = coverage.notes || '';

        const mc = data.maintenanceContract || {};
        if (mc.startDate) document.getElementById('mcStart').value = mc.startDate;
        if (mc.endDate)   document.getElementById('mcEnd').value   = mc.endDate;
        document.getElementById('mcOptions').value = mc.options || '';

        const km    = data.vehicleKm   ?? data.kmVehicle   ?? data.km   ?? '';
        const hours = data.engineHours ?? data.vehicleHours ?? data.hours ?? '';

        if (km !== undefined && km !== null) {
          document.getElementById('vehicleKm').value = km;
        }
        if (hours !== undefined && hours !== null) {
          document.getElementById('engineHours').value = hours;
        }

        showMessage('Pratica caricata correttamente.', 'success');

      } catch (err) {
        console.error(err);
        showMessage('Errore nel caricamento della pratica: ' + err.message, 'error');
      }
    }

    async function loadClaims() {
      const list = document.getElementById('claimsList');
      const placeholder = document.getElementById('claimsPlaceholder');
      list.innerHTML = '';

      if (!currentClaimId) return;

      try {
        const snap = await db
          .collection('ClaimCards')
          .doc(currentClaimId)
          .collection('Claims')
          .orderBy('code')
          .get();

        if (snap.empty) {
          placeholder.style.display = 'block';
          return;
        }

        placeholder.style.display = 'none';

        snap.forEach(docSnap => {
          const data = docSnap.data() || {};
          const code = data.code || docSnap.id;

          const div = document.createElement('div');
          div.className = 'claim-card';

          const title = document.createElement('div');
          title.className = 'claim-title';
          title.textContent = 'Riparazione ' + code;

          const btn = document.createElement('button');
          btn.className = 'btn btn-danger btn-delete-claim';
          btn.textContent = 'Elimina riparazione';
          btn.addEventListener('click', () => deleteRepair(code));

          div.appendChild(title);
          div.appendChild(btn);

          list.appendChild(div);
        });

      } catch (err) {
        console.error(err);
        showMessage('Errore nel caricamento delle riparazioni: ' + err.message, 'error');
      }
    }

    async function saveChanges() {
      clearMessage();
      if (!currentClaimId) {
        showMessage('Impossibile salvare: nessuna pratica caricata.', 'error');
        return;
      }

      const btnSave = document.getElementById('btnSave');
      btnSave.disabled = true;

      try {
        const regPlate = document.getElementById('registrationPlate').value.trim();
        const regDate  = document.getElementById('registrationDate').value || null;

        const kmRaw = document.getElementById('vehicleKm').value;
        const hRaw  = document.getElementById('engineHours').value;

        const kmVal = kmRaw === '' ? null : Number(kmRaw);
        const hVal  = hRaw === '' ? null : Number(hRaw);

        const updates = {
          registrationPlate: regPlate || null,
          plateNumber:       regPlate || null,
          registrationDate:  regDate,
          plateDate:         regDate,
          vehicleKm:   kmVal,
          kmVehicle:   kmVal,
          vehicleHours: hVal,
          engineHours: hVal
        };

        await db.collection('ClaimCards').doc(currentClaimId).update(updates);
        showMessage('Salvataggio completato.', 'success');
      } catch (err) {
        console.error(err);
        showMessage('Errore nel salvataggio: ' + err.message, 'error');
      } finally {
        btnSave.disabled = false;
      }
    }

    async function cancelRequest() {
      clearMessage();
      if (!currentClaimId) {
        showMessage('Impossibile cancellare: nessuna pratica caricata.', 'error');
        return;
      }

      if (!confirm('Sei sicuro di voler cancellare questa richiesta?')) {
        return;
      }

      try {
        const ref = db.collection('ClaimCards').doc(currentClaimId);
        await ref.update({ status: 'Cancellato' });
        document.getElementById('claimStatus').value = 'Cancellato';
        showMessage('Richiesta cancellata (stato impostato su "Cancellato").', 'success');
      } catch (err) {
        console.error(err);
        showMessage('Errore durante la cancellazione della richiesta: ' + err.message, 'error');
      }
    }

    function goHome() {
      window.location.href = 'FTHUBAS.html';
    }

    async function addRepair() {
      clearMessage();
      if (!currentClaimId) {
        showMessage('Impossibile aggiungere: nessuna pratica caricata.', 'error');
        return;
      }

      const btn = document.getElementById('btnAddRepair');
      btn.disabled = true;

      try {
        const cardRef = db.collection('ClaimCards').doc(currentClaimId);

        const newCode = await db.runTransaction(async (tx) => {
          const snap = await tx.get(cardRef);
          if (!snap.exists) {
            throw new Error('Pratica non trovata.');
          }
          const data = snap.data() || {};
          let lastNum = data.lastClaimNumber || 0;
          const nextNum = lastNum + 1;
          const code = String(nextNum).padStart(3, '0');

          tx.update(cardRef, { lastClaimNumber: nextNum });

          const claimRef = cardRef.collection('Claims').doc(code);
          tx.set(claimRef, {
            code: code,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          return code;
        });

        showMessage('Riparazione ' + newCode + ' creata.', 'success');
        await loadClaims();
      } catch (err) {
        console.error(err);
        showMessage('Errore nella creazione della riparazione: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
      }
    }

    async function deleteRepair(code) {
      clearMessage();
      if (!currentClaimId || !code) return;

      if (!confirm('Vuoi davvero eliminare la riparazione ' + code + '?')) {
        return;
      }

      try {
        const cardRef = db.collection('ClaimCards').doc(currentClaimId);
        await cardRef.collection('Claims').doc(code).delete();
        showMessage('Riparazione ' + code + ' eliminata.', 'success');
        await loadClaims();
      } catch (err) {
        console.error(err);
        showMessage('Errore durante l\'eliminazione della riparazione: ' + err.message, 'error');
      }
    }

    // INIT
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'FTHUBAS.html';
        return;
      }
      currentUser = user;
      await loadUserInfo(user);
      await loadClaimCard();
      await loadClaims();
    });

    document.getElementById('btnSave').addEventListener('click', saveChanges);
    document.getElementById('btnDelete').addEventListener('click', cancelRequest);
    document.getElementById('btnHome').addEventListener('click', goHome);
    document.getElementById('btnAddRepair').addEventListener('click', addRepair);
  </script>
</body>
</html>
