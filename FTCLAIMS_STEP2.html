<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>FTCLAIMS - Dettaglio Claim Card</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- forms per RSA/Garanzia ecc. -->
  <script src="ftclaims-claimforms.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 18px; }
    h1 { font-size: 18px; margin: 0 0 4px; }
    .subtitle { font-size: 13px; color: #666; margin-bottom: 10px; }

    .banner { margin: 10px 0 12px; padding: 10px 12px; border-radius: 6px; font-size: 13px; display: none; }
    .banner.success { background: #e9fff0; border: 1px solid #bfeccc; color: #0f6a2a; display: block; }
    .banner.error { background: #ffe9ea; border: 1px solid #f1b7bb; color: #8a1f28; display: block; }

    .layout { display: grid; grid-template-columns: 360px 1fr; gap: 12px; align-items: start; }
    .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 10px 12px; }
    .card h3 { font-size: 13px; margin: 0 0 8px; color: #111; }

    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

    label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #333; }
    input, select, textarea { width: 100%; box-sizing: border-box; padding: 7px 8px; border: 1px solid #d6d6d6; border-radius: 4px; font-size: 13px; }
    textarea { resize: vertical; }

    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .small { font-size: 12px; color: #555; }

    .btn { border: none; border-radius: 4px; padding: 7px 10px; font-size: 12px; cursor: pointer; }
    .btn.primary { background: #007bff; color: #fff; }
    .btn.secondary { background: #6c757d; color: #fff; }
    .btn.danger { background: #dc3545; color: #fff; }
    .btn.light { background: #e9ecef; color: #111; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .mutedBox { background: #f8f8f8; border: 1px dashed #ddd; padding: 8px; border-radius: 6px; font-size: 12px; color: #444; }

    .claimsHeader { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }

    .claimItem { border: 1px solid #e6e6e6; border-radius: 8px; margin-top: 10px; background: #fff; overflow: hidden; }
    .claimItemTop { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 8px 10px; background: #fafafa; border-bottom: 1px solid #ededed; }
    .claimTitle { font-size: 13px; font-weight: bold; color: #222; }
    .claimMeta { font-size: 12px; color: #666; }
    .claimBody { padding: 10px; display: block; }
    .rightTopBox { padding: 10px; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 6px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 6px; text-align: left; vertical-align: top; }
    th { background: #fafafa; font-weight: bold; }

    .notesBox { max-height: 160px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 6px; border-radius: 6px; font-size: 12px; }
    .noteLine { border-bottom: 1px solid #f0f0f0; padding: 6px 0; }
    .noteHeader { font-weight: bold; margin-bottom: 2px; font-size: 12px; }
    .hr { height: 1px; background: #eee; margin: 10px 0; }
  </style>
</head>

<body>
  <h1>Dettaglio Claim Card</h1>
  <div class="subtitle">Visualizza e gestisci i dati della pratica.</div>

  <div id="banner" class="banner"></div>

  <div class="layout">
    <!-- LEFT SIDEBAR -->
    <div>
      <div class="card">
        <h3>Dati pratica</h3>
        <div class="grid2">
          <div>
            <label>Codice pratica</label>
            <input id="ui_code" type="text" readonly />
          </div>
          <div>
            <label>Tipologia</label>
            <input id="ui_type" type="text" readonly />
          </div>
          <div>
            <label>Data apertura</label>
            <input id="ui_openDate" type="text" readonly />
          </div>
          <div>
            <label>Data ordine di lavoro</label>
            <input id="ui_orderDate" type="text" readonly />
          </div>
          <div>
            <label>Nome operatore apertura</label>
            <input id="ui_openUser" type="text" readonly />
          </div>
          <div>
            <label>Dealer apertura</label>
            <input id="ui_openDealer" type="text" readonly />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label>Stato pratica</label>
          <select id="ui_status">
            <option value="Aperta">Aperta</option>
            <option value="Inviata">Inviata</option>
            <option value="Sospesa">Sospesa</option>
            <option value="In Valutazione">In Valutazione</option>
            <option value="Conclusa">Conclusa</option>
            <option value="Cancellata">Cancellata</option>
          </select>
          <div class="small" style="margin-top:4px;">
            Stati: Aperta, Inviata, Sospesa, In Valutazione, Conclusa, Cancellata.
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <h3>Dati veicolo</h3>
        <div class="grid2">
          <div>
            <label>VIN</label>
            <input id="ui_vin" type="text" readonly />
          </div>
          <div>
            <label>Customer</label>
            <input id="ui_customer" type="text" readonly />
          </div>
          <div>
            <label>Registration Plate</label>
            <input id="ui_plate" type="text" readonly />
          </div>
          <div>
            <label>Registration Date</label>
            <input id="ui_regDate" type="text" readonly />
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <h3>Copertura garanzia alla data dell'ordine di lavoro</h3>
        <div class="grid2">
          <div>
            <label>Tipo copertura</label>
            <input id="ui_covType" type="text" readonly />
          </div>
          <div>
            <label>Data inizio</label>
            <input id="ui_covStart" type="text" readonly />
          </div>
          <div>
            <label>Data fine</label>
            <input id="ui_covEnd" type="text" readonly />
          </div>
          <div></div>
        </div>
        <div style="margin-top:8px;">
          <label>Note copertura</label>
          <textarea id="ui_covNotes" rows="2" readonly></textarea>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <h3>Contratto di manutenzione (se presente)</h3>
        <div class="grid2">
          <div>
            <label>Data inizio</label>
            <input id="ui_scStart" type="text" readonly />
          </div>
          <div>
            <label>Data fine</label>
            <input id="ui_scEnd" type="text" readonly />
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>Opzioni presenti</label>
          <textarea id="ui_scOptions" rows="2" readonly></textarea>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <h3>Chilometraggio / ore motore</h3>
        <div class="grid2">
          <div>
            <label>KM veicolo</label>
            <input id="ui_km" type="number" min="0" step="1"/>
          </div>
          <div>
            <label>Ore motore</label>
            <input id="ui_hours" type="number" min="0" step="1"/>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnHome" class="btn secondary">Home Page</button>
        <button id="btnSaveCard" class="btn primary">Salva modifiche</button>
        <button id="btnCancelCard" class="btn danger">Cancella richiesta</button>
      </div>
    </div>

    <!-- RIGHT CONTENT -->
    <div>
      <div class="card">
        <div class="claimsHeader">
          <div>
            <h3 style="margin:0;">Gestione claim collegati alla claim card</h3>
            <div class="small">Crea e gestisci le riparazioni collegate.</div>
          </div>
          <button id="btnCreateClaim" class="btn primary">Crea claim</button>
        </div>

        <div class="mutedBox" id="createBox">
          <div class="grid2">
            <div>
              <label>Tipologia claim</label>
              <select id="newClaimType"></select>
              <div class="small" style="margin-top:4px;">
                La lista varia in base alla tipologia della claim card.
              </div>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="btnDoCreateClaim" class="btn primary" style="width:100%;">Crea</button>
            </div>
          </div>
        </div>

        <div id="claimsList"></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // ---------- Helpers ----------
      function banner(type, msg) {
        const b = document.getElementById("banner");
        b.className = "banner " + (type || "");
        b.innerHTML = msg || "";
        b.style.display = "block";
      }
      function pad3(n) { return String(n).padStart(3, "0"); }
      function safeStr(v) { return (v == null) ? "" : String(v); }
      function fmtDateISO(iso) {
        if (!iso) return "";
        try {
          if (typeof iso === "string" && iso.length >= 10 && iso.includes("-")) return iso.slice(0,10);
          const d = new Date(iso);
          if (isNaN(d.getTime())) return "";
          return d.toISOString().slice(0,10);
        } catch { return ""; }
      }
      function normalizeType(t) { return (t || "").toString().trim().toUpperCase(); }

      async function getUserInfo(db, auth) {
        const u = auth.currentUser;
        if (!u) return { uid:null, name:null, dealerId:null };
        let name = u.displayName || u.email || u.uid;
        let dealerId = null;
        try {
          const snap = await db.collection("Users").doc(u.uid).get();
          if (snap.exists) {
            const d = snap.data() || {};
            dealerId = d.dealerId || d.DealerID || d.dealerID || d.DealerId || null;
            name = d.displayName || d.fullName || d.name || name;
          }
        } catch(e) {}
        return { uid: u.uid, name, dealerId };
      }

      // ---------- Firebase ----------
      if (typeof firebase === "undefined") {
        banner("error", "Errore: Firebase non caricato.");
        return;
      }
      const auth = window.auth || firebase.auth();
      const db = window.db || firebase.firestore();
      const storage = firebase.storage();
      window.auth = auth;
      window.db = db;

      // ---------- DOM refs ----------
      const ui = {
        code: document.getElementById("ui_code"),
        type: document.getElementById("ui_type"),
        openDate: document.getElementById("ui_openDate"),
        orderDate: document.getElementById("ui_orderDate"),
        openUser: document.getElementById("ui_openUser"),
        openDealer: document.getElementById("ui_openDealer"),
        status: document.getElementById("ui_status"),

        vin: document.getElementById("ui_vin"),
        customer: document.getElementById("ui_customer"),
        plate: document.getElementById("ui_plate"),
        regDate: document.getElementById("ui_regDate"),

        covType: document.getElementById("ui_covType"),
        covStart: document.getElementById("ui_covStart"),
        covEnd: document.getElementById("ui_covEnd"),
        covNotes: document.getElementById("ui_covNotes"),

        scStart: document.getElementById("ui_scStart"),
        scEnd: document.getElementById("ui_scEnd"),
        scOptions: document.getElementById("ui_scOptions"),

        km: document.getElementById("ui_km"),
        hours: document.getElementById("ui_hours"),
      };

      const btnHome = document.getElementById("btnHome");
      const btnSaveCard = document.getElementById("btnSaveCard");
      const btnCancelCard = document.getElementById("btnCancelCard");

      const newClaimType = document.getElementById("newClaimType");
      const btnCreateClaim = document.getElementById("btnCreateClaim");
      const btnDoCreateClaim = document.getElementById("btnDoCreateClaim");
      const claimsList = document.getElementById("claimsList");

      // ---------- State ----------
      let claimId = null;
      let claimCard = null;
      let currentUser = null;

      // ---------- Navigation ----------
      btnHome.addEventListener("click", () => window.location.href = "FTHUBAS.html");

      // ---------- Load claimId from sessionStorage ----------
      function resolveClaimId() {
        const direct = sessionStorage.getItem("ftclaims_claimCode");
        if (direct) return direct;

        const s = sessionStorage.getItem("currentClaimStep1");
        if (s) {
          try {
            const obj = JSON.parse(s);
            if (obj && obj.claimId) return obj.claimId;
          } catch (e) {}
        }
        return null;
      }

      // ---------- Claim type options for Create Claim ----------
      function allowedClaimTypesByCardType(cardType) {
        const ct = normalizeType(cardType);

        // NOTA: qui mettiamo SOLO le tipologie davvero gestite
        if (ct === "SERVICE CONTRACT") {
          return [{ value: "SERVICE CONTRACT", label: "Service Contract" }];
        }

        if (ct === "WARRANTY") {
          return [
            { value: "GARANZIA", label: "Garanzia" },
            { value: "GARANZIA RICAMBIO", label: "Garanzia Ricambio" },
            { value: "RSA", label: "RSA" }
          ];
        }

        if (ct === "FSA") {
          return [
            { value: "FSA", label: "FSA" },
            { value: "RSA", label: "RSA" },
            { value: "GOODWILL", label: "Goodwill" }
          ];
        }

        if (ct === "GOODWILL") {
          return [
            { value: "GOODWILL", label: "Goodwill" },
            { value: "RSA", label: "RSA" }
          ];
        }

        if (ct === "PDI") {
          return [
            { value: "PDI", label: "PDI" }
          ];
        }

        // fallback minimale: non “tutto”, ma il minimo sensato
        return [
          { value: "RSA", label: "RSA" },
          { value: "GARANZIA", label: "Garanzia" }
        ];
      }

      function fillCreateClaimOptions(cardType) {
        const allowed = allowedClaimTypesByCardType(cardType);

        newClaimType.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "-- Seleziona tipologia claim --";
        opt0.disabled = true;
        opt0.selected = true;
        newClaimType.appendChild(opt0);

        allowed.forEach(x => {
          const o = document.createElement("option");
          o.value = x.value;
          o.textContent = x.label;
          newClaimType.appendChild(o);
        });
      }

      // ---------- ClaimCard CRUD ----------
      async function loadClaimCard() {
        const snap = await db.collection("ClaimCards").doc(claimId).get();
        if (!snap.exists) throw new Error("ClaimCard non trovata: " + claimId);
        claimCard = snap.data() || {};
        return claimCard;
      }

      function renderClaimCard() {
        ui.code.value = claimCard.code || claimId || "";
        ui.type.value = claimCard.type || "";
        ui.openDate.value = fmtDateISO(claimCard.openDate);
        ui.orderDate.value = fmtDateISO(claimCard.orderDate);
        ui.openUser.value = claimCard.openUser || "";
        ui.openDealer.value = claimCard.openDealer || "";
        ui.status.value = claimCard.status || "Aperta";

        const v = claimCard.vehicle || {};
        ui.vin.value = v.vin || "";
        ui.customer.value = v.customer || "";
        ui.plate.value = v.registrationPlate || "";
        ui.regDate.value = fmtDateISO(v.registrationDate);

        const cov = claimCard.coverage || {};
        ui.covType.value = cov.type || "";
        ui.covStart.value = fmtDateISO(cov.startDate);
        ui.covEnd.value = fmtDateISO(cov.endDate);
        ui.covNotes.value = cov.notes || "";

        const sc = claimCard.maintenanceContract || {};
        ui.scStart.value = fmtDateISO(sc.startDate);
        ui.scEnd.value = fmtDateISO(sc.endDate);
        ui.scOptions.value = sc.options || "";

        ui.km.value = (claimCard.km != null) ? claimCard.km : "";
        ui.hours.value = (claimCard.engineHours != null) ? claimCard.engineHours : "";

        // QUI: menu davvero filtrato
        fillCreateClaimOptions(claimCard.type);
      }

      btnSaveCard.addEventListener("click", async () => {
        if (!claimId) return;
        try {
          btnSaveCard.disabled = true;

          const updateObj = {
            status: ui.status.value || "Aperta",
            km: ui.km.value === "" ? null : parseInt(ui.km.value, 10),
            engineHours: ui.hours.value === "" ? null : parseInt(ui.hours.value, 10),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          await db.collection("ClaimCards").doc(claimId).update(updateObj);
          banner("success", "Modifiche salvate.");
        } catch (e) {
          console.error(e);
          banner("error", "Errore salvataggio: " + e.message);
        } finally {
          btnSaveCard.disabled = false;
        }
      });

      btnCancelCard.addEventListener("click", async () => {
        if (!claimId) return;
        if (!confirm("Vuoi cancellare la richiesta? (Stato = Cancellata)")) return;

        try {
          btnCancelCard.disabled = true;
          await db.collection("ClaimCards").doc(claimId).update({
            status: "Cancellata",
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          banner("success", "Richiesta impostata su Cancellata.");
          ui.status.value = "Cancellata";
        } catch (e) {
          console.error(e);
          banner("error", "Errore cancellazione: " + e.message);
        } finally {
          btnCancelCard.disabled = false;
        }
      });

      // ---------- Claims list ----------
      async function getNextRepairCode() {
        const snap = await db.collection("ClaimCards").doc(claimId).collection("Claims")
          .orderBy("createdAt", "desc")
          .limit(50)
          .get();

        let maxIdx = 0;
        snap.forEach(doc => {
          const d = doc.data() || {};
          const ri = (typeof d.repairIndex === "number") ? d.repairIndex : null;
          if (ri != null && ri > maxIdx) maxIdx = ri;
          if (ri == null && doc.id && /^R\d{3}$/.test(doc.id)) {
            const n = parseInt(doc.id.slice(1), 10);
            if (!isNaN(n) && n > maxIdx) maxIdx = n;
          }
        });

        const next = maxIdx + 1;
        return { repairIndex: next, repairCode: "R" + pad3(next) };
      }

      async function createClaim() {
        const t = newClaimType.value;
        if (!t) { alert("Seleziona una tipologia claim."); return; }

        // hard guard: se la claimCard è SERVICE CONTRACT, NON creare altro
        const cardType = normalizeType(claimCard && claimCard.type);
        if (cardType === "SERVICE CONTRACT" && normalizeType(t) !== "SERVICE CONTRACT") {
          alert("Questa pratica è Service Contract: puoi creare solo claim Service Contract.");
          return;
        }

        const { repairIndex, repairCode } = await getNextRepairCode();

        const vin = (claimCard && claimCard.vehicle && claimCard.vehicle.vin) ? String(claimCard.vehicle.vin) : null;

        const docData = {
          claimType: t,
          repairIndex,
          status: "Aperto",
          vin: vin || null,                 // <-- fondamentale per check globali
          claimCardType: claimCard.type || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdByUid: currentUser.uid || null,
          createdByName: currentUser.name || null,
          createdByDealerId: currentUser.dealerId || null
        };

        await db.collection("ClaimCards").doc(claimId).collection("Claims").doc(repairCode).set(docData);
        banner("success", `Riparazione ${repairCode} (${t}) creata.`);
      }

      btnCreateClaim.addEventListener("click", () => {
        document.getElementById("createBox").scrollIntoView({ behavior: "smooth", block: "start" });
      });

      btnDoCreateClaim.addEventListener("click", async () => {
        try {
          btnDoCreateClaim.disabled = true;
          await createClaim();
        } catch (e) {
          console.error(e);
          banner("error", "Errore creazione claim: " + e.message);
        } finally {
          btnDoCreateClaim.disabled = false;
        }
      });

      function toggleClaimBody(bodyEl, btnEl) {
        const isHidden = bodyEl.style.display === "none";
        bodyEl.style.display = isHidden ? "block" : "none";
        btnEl.textContent = isHidden ? "Nascondi dettagli" : "Mostra dettagli";
      }

      // ---------- SERVICE CONTRACT UI ----------
      async function loadMaintenanceFamilies() {
        const snap = await db.collection("Maintenance").limit(200).get();
        const families = new Set();
        snap.forEach(doc => {
          const id = doc.id || "";
          if (id === "_meta") return;
          const parts = id.split("_");
          if (parts.length >= 2) families.add(parts[0]);
        });
        return Array.from(families).sort();
      }

      async function loadMaintenanceMenuOptions() {
        const metaSnap = await db.collection("Maintenance").doc("_meta").get();
        if (!metaSnap.exists) return [];
        const d = metaSnap.data() || {};
        const arr = Array.isArray(d.menuOptions) ? d.menuOptions : [];
        return arr
          .filter(x => x && x.key)
          .map(x => ({
            key: String(x.key),
            label_it: (x.label && x.label.it) ? String(x.label.it) : String(x.key)
          }));
      }

      async function loadMaintenanceTemplate(docId) {
        const snap = await db.collection("Maintenance").doc(docId).get();
        if (!snap.exists) return null;
        return snap.data() || null;
      }

      function canSeeItem(item, isDistributor) {
        const vis = item && item.visibility ? item.visibility : null;
        if (!vis) return true;
        if (isDistributor) return vis.distributor !== false;
        return vis.dealer !== false;
      }

      function isVoithOnly(item) {
        const c = item && item.conditions ? item.conditions : null;
        return !!(c && c.voithOnly === true);
      }

      // ---- CHECK DUPLICATI: stesso pacchetto in ClaimCard ----
      async function existsSameServiceContractInSameCard(claimCardId, currentClaimCode, fam, key) {
        const snap = await db.collection("ClaimCards").doc(claimCardId).collection("Claims")
          .where("claimType", "==", "SERVICE CONTRACT")
          .get();

        let found = false;
        snap.forEach(doc => {
          if (doc.id === currentClaimCode) return;
          const d = doc.data() || {};
          const sc = d.serviceContract || {};
          if (sc.family === fam && sc.key === key) found = true;
        });
        return found;
      }

      // ---- CHECK DUPLICATI: stesso pacchetto sul VIN (globale) ----
      async function existsSameServiceContractOnVinGlobal(vin, fam, key, claimCardId, claimCode) {
        if (!vin) return false;

        // Query su collectionGroup: richiede che ogni Claim abbia campo vin
        const q = db.collectionGroup("Claims")
          .where("claimType", "==", "SERVICE CONTRACT")
          .where("vin", "==", vin)
          .where("serviceContract.family", "==", fam)
          .where("serviceContract.key", "==", key)
          .limit(5);

        const snap = await q.get();
        if (snap.empty) return false;

        // escludi il documento corrente
        let foundOther = false;
        snap.forEach(doc => {
          const path = doc.ref.path || "";
          const isSame = path.includes("/ClaimCards/" + claimCardId + "/Claims/" + claimCode);
          if (!isSame) foundOther = true;
        });

        return foundOther;
      }

      function renderServiceContractDetails(container, claimDoc, ctx, isDistributor) {
        const prefix = "sc_" + ctx.claimCode + "_";
        container.innerHTML = `
          <h4 style="margin: 4px 0 6px; font-size: 13px;">Dati Service Contract</h4>
          <div class="small" style="margin-bottom:8px;">
            Seleziona il pacchetto di manutenzione. Le righe (ricambi/manodopera) vengono caricate dal template.
          </div>

          <div class="grid2">
            <div>
              <label>Famiglia</label>
              <select id="${prefix}family"></select>
            </div>
            <div>
              <label>Tipo manutenzione</label>
              <select id="${prefix}type"></select>
            </div>
          </div>

          <div style="margin-top:8px;">
            <label>
              <input type="checkbox" id="${prefix}voith">
              Veicolo con rallentatore VOITH (Intarder/Retarder)
            </label>
            <div class="small">
              Se attivo, verranno incluse le righe previste per VOITH (se presenti nel pacchetto).
            </div>
          </div>

          <div style="margin-top:10px;">
            <button class="btn primary" id="${prefix}save">Salva manutenzione</button>
          </div>

          <div class="hr"></div>

          <h4 style="margin: 4px 0 6px; font-size: 13px;">Righe precompilate</h4>
          <div class="small">Ricambi e manodopera provenienti dal template selezionato.</div>

          <div style="margin-top:8px;">
            <div class="small" style="font-weight:bold;">Manodopera</div>
            <table>
              <thead>
                <tr><th>Codice</th><th>Descrizione</th><th>Q.tà</th><th>Note</th></tr>
              </thead>
              <tbody id="${prefix}labourBody">
                <tr><td colspan="4" class="small">Nessuna riga.</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top:10px;">
            <div class="small" style="font-weight:bold;">Ricambi</div>
            <table>
              <thead>
                <tr><th>Codice</th><th>Descrizione</th><th>Q.tà</th><th>Note</th></tr>
              </thead>
              <tbody id="${prefix}partsBody">
                <tr><td colspan="4" class="small">Nessuna riga.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hr"></div>

          <h4 style="margin: 4px 0 6px; font-size: 13px;">Allegati</h4>
          <div class="small">Allegati generici relativi a questo claim.</div>
          <div style="margin-top:6px; display:flex; gap:6px; align-items:center;">
            <input type="file" id="${prefix}file" multiple>
            <button class="btn secondary" id="${prefix}upload">Carica</button>
          </div>
          <div id="${prefix}attList" class="small" style="margin-top:8px;">Nessun allegato presente.</div>

          <div class="hr"></div>

          <h4 style="margin: 4px 0 6px; font-size: 13px;">Note</h4>
          <div id="${prefix}notesList" class="notesBox">Nessuna nota.</div>
          <div style="margin-top:6px; display:flex; gap:6px;">
            <textarea id="${prefix}noteText" rows="2" placeholder="Scrivi una nota..."></textarea>
            <button class="btn primary" id="${prefix}sendNote">Invia</button>
          </div>
        `;

        const familySel = container.querySelector("#" + prefix + "family");
        const typeSel   = container.querySelector("#" + prefix + "type");
        const voithChk  = container.querySelector("#" + prefix + "voith");
        const saveBtn   = container.querySelector("#" + prefix + "save");

        const labourBody = container.querySelector("#" + prefix + "labourBody");
        const partsBody  = container.querySelector("#" + prefix + "partsBody");

        const fileInp  = container.querySelector("#" + prefix + "file");
        const upBtn    = container.querySelector("#" + prefix + "upload");
        const attList  = container.querySelector("#" + prefix + "attList");

        const notesList = container.querySelector("#" + prefix + "notesList");
        const noteText  = container.querySelector("#" + prefix + "noteText");
        const sendNote  = container.querySelector("#" + prefix + "sendNote");

        const claimRef = db.collection("ClaimCards").doc(ctx.claimCardId).collection("Claims").doc(ctx.claimCode);

        let menuOptions = [];
        let families = [];
        let currentTemplate = null;

        function clearBodies() {
          labourBody.innerHTML = `<tr><td colspan="4" class="small">Nessuna riga.</td></tr>`;
          partsBody.innerHTML  = `<tr><td colspan="4" class="small">Nessuna riga.</td></tr>`;
        }

        function renderTemplateItems() {
          clearBodies();
          if (!currentTemplate || !Array.isArray(currentTemplate.items)) return;

          const voithOn = !!voithChk.checked;
          const items = currentTemplate.items
            .filter(it => canSeeItem(it, isDistributor))
            .filter(it => voithOn ? true : !isVoithOnly(it));

          const lab = items.filter(it => String(it.kind || "").toUpperCase() === "LABOUR");
          const par = items.filter(it => String(it.kind || "").toUpperCase() === "PART");

          if (lab.length) {
            labourBody.innerHTML = "";
            lab.forEach(it => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${safeStr(it.code || "")}</td>
                <td>${safeStr(it.description || "")}</td>
                <td>${safeStr(it.qty != null ? it.qty : "")}</td>
                <td>${safeStr(it.note || "")}</td>
              `;
              labourBody.appendChild(tr);
            });
          }

          if (par.length) {
            partsBody.innerHTML = "";
            par.forEach(it => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${safeStr(it.code || "")}</td>
                <td>${safeStr(it.description || "")}</td>
                <td>${safeStr(it.qty != null ? it.qty : "")}</td>
                <td>${safeStr(it.note || "")}</td>
              `;
              partsBody.appendChild(tr);
            });
          }
        }

        async function refreshTemplate() {
          const fam = familySel.value;
          const key = typeSel.value;
          if (!fam || !key) {
            currentTemplate = null;
            clearBodies();
            return;
          }
          const docId = fam + "_" + key;
          currentTemplate = await loadMaintenanceTemplate(docId);
          renderTemplateItems();
        }

        function fillTypeOptions(selectedKey) {
          typeSel.innerHTML = "";
          const o0 = document.createElement("option");
          o0.value = "";
          o0.textContent = "-- Seleziona --";
          o0.disabled = true;
          o0.selected = true;
          typeSel.appendChild(o0);

          menuOptions.forEach(m => {
            const o = document.createElement("option");
            o.value = m.key;
            o.textContent = m.label_it;
            typeSel.appendChild(o);
          });

          if (selectedKey) typeSel.value = selectedKey;
        }

        function fillFamilies(selectedFamily) {
          familySel.innerHTML = "";
          families.forEach(f => {
            const o = document.createElement("option");
            o.value = f;
            o.textContent = f;
            familySel.appendChild(o);
          });
          if (selectedFamily) familySel.value = selectedFamily;
        }

        familySel.addEventListener("change", refreshTemplate);
        typeSel.addEventListener("change", refreshTemplate);
        voithChk.addEventListener("change", renderTemplateItems);

        saveBtn.addEventListener("click", async () => {
          const fam = familySel.value;
          const key = typeSel.value;
          if (!fam || !key) {
            alert("Seleziona famiglia e tipo manutenzione.");
            return;
          }

          const vin = (claimCard && claimCard.vehicle && claimCard.vehicle.vin) ? String(claimCard.vehicle.vin) : null;

          // ✅ blocco doppioni nella stessa claimcard
          const dupSameCard = await existsSameServiceContractInSameCard(ctx.claimCardId, ctx.claimCode, fam, key);
          if (dupSameCard) {
            alert("ATTENZIONE: esiste già una manutenzione identica (stessa famiglia + stesso tipo) in questa pratica.");
            return;
          }

          // ✅ blocco doppioni sullo stesso VIN (globale)
          const dupVin = await existsSameServiceContractOnVinGlobal(vin, fam, key, ctx.claimCardId, ctx.claimCode);
          if (dupVin) {
            alert("ATTENZIONE: questa manutenzione risulta già reclamata in passato su questo VIN.");
            return;
          }

          const labelObj = menuOptions.find(x => x.key === key);
          const labelIt = labelObj ? labelObj.label_it : key;

          const docId = fam + "_" + key;
          const payload = {
            vin: vin || null, // assicuriamolo sempre sul claim
            serviceContract: {
              family: fam,
              key: key,
              label_it: labelIt,
              templateDocId: docId,
              voith: !!voithChk.checked,
              savedAt: firebase.firestore.FieldValue.serverTimestamp()
            }
          };

          try {
            saveBtn.disabled = true;
            await claimRef.update(payload);
            banner("success", "Manutenzione salvata.");
          } catch (e) {
            console.error(e);
            banner("error", "Errore salvataggio manutenzione: " + e.message);
          } finally {
            saveBtn.disabled = false;
          }
        });

        // --- Allegati ---
        const attRefBase = claimRef.collection("Attachments");
        async function loadAttachments() {
          try {
            const snap = await attRefBase.orderBy("createdAt", "asc").get();
            const items = [];
            snap.forEach(doc => {
              const d = doc.data() || {};
              items.push({ id: doc.id, name: d.name || "", path: d.path || "", url: d.url || "" });
            });

            if (!items.length) {
              attList.textContent = "Nessun allegato presente.";
              return;
            }

            const ul = document.createElement("ul");
            ul.style.listStyleType = "none";
            ul.style.paddingLeft = "0";
            items.forEach(it => {
              const li = document.createElement("li");
              li.style.marginBottom = "6px";

              const a = document.createElement("a");
              a.href = it.url || "#";
              a.target = "_blank";
              a.rel = "noopener";
              a.textContent = it.name || it.path || "file";

              const del = document.createElement("button");
              del.className = "btn danger";
              del.style.marginLeft = "8px";
              del.textContent = "Elimina";
              del.addEventListener("click", async () => {
                if (!confirm("Vuoi eliminare l'allegato?")) return;
                try {
                  if (it.path) {
                    try { await storage.ref(it.path).delete(); } catch(e){}
                  }
                  await attRefBase.doc(it.id).delete(); // <-- serve rules che lo permettano
                  loadAttachments();
                } catch(e) {
                  alert("Errore eliminazione allegato: " + e.message);
                }
              });

              li.appendChild(a);
              li.appendChild(del);
              ul.appendChild(li);
            });

            attList.innerHTML = "";
            attList.appendChild(ul);
          } catch(e) {
            console.error(e);
            attList.textContent = "Errore nel caricamento allegati.";
          }
        }

        upBtn.addEventListener("click", async () => {
          const files = fileInp.files;
          if (!files || !files.length) { alert("Seleziona almeno un file."); return; }
          upBtn.disabled = true;
          try {
            const basePath = "ClaimCards/" + ctx.claimCardId + "/Claims/" + ctx.claimCode + "/Attachments/";
            for (let i=0;i<files.length;i++) {
              const f = files[i];
              const path = basePath + Date.now() + "_" + i + "_" + f.name;
              const ref = storage.ref(path);
              await ref.put(f);
              const url = await ref.getDownloadURL();
              await attRefBase.add({
                name: f.name,
                path,
                url,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                authorUid: currentUser.uid || null,
                authorName: currentUser.name || null,
                authorDealerId: currentUser.dealerId || null
              });
            }
            fileInp.value = "";
            loadAttachments();
          } catch(e) {
            console.error(e);
            alert("Errore upload allegati: " + e.message);
          } finally {
            upBtn.disabled = false;
          }
        });

        loadAttachments();

        // --- Note ---
        const notesRef = claimRef.collection("Notes");
        function renderNotes(snap) {
          if (snap.empty) {
            notesList.textContent = "Nessuna nota.";
            return;
          }
          notesList.innerHTML = "";
          snap.forEach(doc => {
            const d = doc.data() || {};
            const wrap = document.createElement("div");
            wrap.className = "noteLine";

            const h = document.createElement("div");
            h.className = "noteHeader";

            let when = "";
            if (d.createdAt && d.createdAt.toDate) {
              const t = d.createdAt.toDate();
              const dd = String(t.getDate()).padStart(2,"0");
              const mm = String(t.getMonth()+1).padStart(2,"0");
              const yyyy = t.getFullYear();
              const hh = String(t.getHours()).padStart(2,"0");
              const mi = String(t.getMinutes()).padStart(2,"0");
              when = dd + "/" + mm + "/" + yyyy + " " + hh + ":" + mi;
            }

            const author = d.authorName || d.authorDealerId || "";
            h.textContent = author ? (author + (when ? " ("+when+")" : "")) : (when || "");

            const b = document.createElement("div");
            b.textContent = d.text || "";

            wrap.appendChild(h);
            wrap.appendChild(b);
            notesList.appendChild(wrap);
          });
          notesList.scrollTop = notesList.scrollHeight;
        }

        notesRef.orderBy("createdAt","asc").onSnapshot(renderNotes, (e)=>console.error(e));

        sendNote.addEventListener("click", async () => {
          const txt = (noteText.value || "").trim();
          if (!txt) return;
          sendNote.disabled = true;
          try {
            await notesRef.add({
              text: txt,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              authorUid: currentUser.uid || null,
              authorName: currentUser.name || null,
              authorDealerId: currentUser.dealerId || null
            });
            noteText.value = "";
          } catch(e) {
            console.error(e);
            alert("Errore invio nota: " + e.message);
          } finally {
            sendNote.disabled = false;
          }
        });

        (async function init() {
          menuOptions = await loadMaintenanceMenuOptions();
          families = await loadMaintenanceFamilies();
          if (!families.length) families = ["470"];

          const sc = (claimDoc.serviceContract || {});
          const savedFamily = sc.family || families[0];
          const savedKey = sc.key || null;

          fillFamilies(savedFamily);
          fillTypeOptions(savedKey);

          if (sc.voith === true) voithChk.checked = true;
          await refreshTemplate();
        })();
      }

      // ---------- Render a single claim item ----------
      function renderClaimItem(repairCode, claimData) {
        const wrapper = document.createElement("div");
        wrapper.className = "claimItem";

        const title = `Riparazione ${repairCode} (${claimData.claimType || "?"})`;
        const status = claimData.status || "Aperto";

        const top = document.createElement("div");
        top.className = "claimItemTop";

        const left = document.createElement("div");
        left.innerHTML = `
          <div class="claimTitle">${title}</div>
          <div class="claimMeta">Stato: ${status}</div>
        `;

        const actions = document.createElement("div");
        actions.className = "row";

        const btnToggle = document.createElement("button");
        btnToggle.className = "btn light";
        btnToggle.textContent = "Nascondi dettagli";

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn danger";
        btnDelete.textContent = "Elimina riparazione";

        actions.appendChild(btnToggle);
        actions.appendChild(btnDelete);

        top.appendChild(left);
        top.appendChild(actions);

        const body = document.createElement("div");
        body.className = "claimBody";

        const inner = document.createElement("div");
        inner.className = "rightTopBox";
        body.appendChild(inner);

        wrapper.appendChild(top);
        wrapper.appendChild(body);

        btnToggle.addEventListener("click", () => toggleClaimBody(body, btnToggle));

        btnDelete.addEventListener("click", async () => {
          if (!confirm(`Vuoi eliminare ${repairCode}?`)) return;
          try {
            await db.collection("ClaimCards").doc(claimId).collection("Claims").doc(repairCode).delete();
            banner("success", "Riparazione eliminata.");
          } catch(e) {
            console.error(e);
            banner("error", "Errore eliminazione: " + e.message);
          }
        });

        const ct = normalizeType(claimData.claimType);
        const ctx = { claimCardId: claimId, claimCode: repairCode };
        const isDistributor = (currentUser && currentUser.dealerId === "FT001");

        if (ct === "SERVICE CONTRACT") {
          renderServiceContractDetails(inner, claimData, ctx, isDistributor);
        } else {
          if (typeof renderClaimDetails === "function") {
            renderClaimDetails(claimData.claimType, inner, claimData, ctx);
          } else {
            inner.innerHTML = `<div class="small">Renderer non disponibile per questa tipologia.</div>`;
          }
        }

        return wrapper;
      }

      // ---------- Listen claims ----------
      function listenClaims() {
        const ref = db.collection("ClaimCards").doc(claimId).collection("Claims").orderBy("repairIndex", "asc");
        ref.onSnapshot((snap) => {
          claimsList.innerHTML = "";
          if (snap.empty) {
            claimsList.innerHTML = `<div class="mutedBox">Nessun claim presente. Usa “Crea claim”.</div>`;
            return;
          }
          snap.forEach(doc => {
            claimsList.appendChild(renderClaimItem(doc.id, doc.data() || {}));
          });
        }, (e) => {
          console.error(e);
          banner("error", "Errore caricamento claims: " + e.message);
        });
      }

      // ---------- Boot ----------
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          banner("error", "Utente non autenticato. Reindirizzamento…");
          setTimeout(() => window.location.href = "index.html", 1200);
          return;
        }

        try {
          claimId = resolveClaimId();
          if (!claimId) {
            banner("error", "Nessuna claim card in sessione (manca ftclaims_claimCode). Torna allo STEP1.");
            return;
          }

          currentUser = await getUserInfo(db, auth);

          await loadClaimCard();
          renderClaimCard();

          listenClaims();
          banner("success", "Pratica caricata correttamente.");
        } catch (e) {
          console.error(e);
          banner("error", "Errore caricamento pratica: " + e.message);
        }
      });

    })();
  </script>
</body>
</html>
