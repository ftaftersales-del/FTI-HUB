<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>FTVIN - Verifica copertura contratti</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px 24px 28px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }

    h1 {
      margin: 8px 0 6px;
      font-size: 26px;
      color: #333;
    }

    .subtitle {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .search-box {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .search-box label {
      font-weight: bold;
      margin-right: 6px;
    }

    .search-box input[type="text"] {
      flex: 1;
      min-width: 260px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      text-transform: uppercase;
    }

    .search-box button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .search-box button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .message {
      margin-top: 4px;
      font-size: 13px;
      color: #666;
    }

    .message.error {
      color: #c0392b;
    }

    .message.success {
      color: #2e7d32;
    }

    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #ddd;
      border-top-color: #007bff;
      animation: spin 0.7s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .results {
      margin-top: 20px;
      display: none;
    }

    .section-title {
      font-size: 18px;
      margin: 16px 0 10px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px 18px;
      font-size: 13px;
    }

    .info-item {
      background: #fafafa;
      border-radius: 6px;
      padding: 8px 10px;
    }

    .info-item .label {
      font-weight: bold;
      color: #555;
      display: block;
      margin-bottom: 4px;
    }

    .info-item .value {
      color: #222;
      word-break: break-word;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .badge-ok {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .badge-ko {
      background: #ffebee;
      color: #c62828;
    }

    .bool-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }

    .bool-table th,
    .bool-table td {
      border: 1px solid #e0e0e0;
      padding: 6px 8px;
      text-align: left;
    }

    .bool-table th {
      background: #f3f3f3;
      font-weight: bold;
      white-space: nowrap;
    }

    .small-note {
      font-size: 11px;
      color: #777;
      margin-top: 6px;
    }

    @media (max-width: 600px) {
      .container {
        padding: 16px;
      }
      .search-box {
        flex-direction: column;
        align-items: stretch;
      }
      .search-box label {
        margin-bottom: 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div>FTVIN - Verifica copertura contratti</div>
      <div id="userInfo">Utente: -</div>
    </div>

    <h1>Verifica copertura per telaio (VIN)</h1>
    <div class="subtitle">
      Inserisci un VIN e premi "Cerca" per visualizzare i dettagli di copertura memorizzati in Firestore (collezione <strong>DBVIN</strong>).
    </div>

    <div class="search-box">
      <label for="vinInput">Telaio / VIN</label>
      <input id="vinInput" type="text" maxlength="30" placeholder="Es. NM0KCTP60XSB93275" autocomplete="off" />
      <button id="searchBtn">Cerca</button>
    </div>
    <div id="searchMessage" class="message"></div>

    <div id="results" class="results">
      <div class="section-title">Dati contratto</div>
      <div class="info-grid" id="contractInfo"></div>

      <div class="section-title">Copertura temporale / chilometrica</div>
      <div class="info-grid" id="timeKmInfo"></div>

      <div class="section-title">Opzioni aggiuntive / servizi</div>
      <table class="bool-table" id="boolTable">
        <thead>
          <tr>
            <th>Voce</th>
            <th>Copertura</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small-note">
        Per i campi booleani, eventuali valori null o mancanti sono considerati come <strong>non coperti (NO)</strong>.
      </div>
    </div>
  </div>

  <script>
    // QUI usiamo direttamente auth e db definiti in firebase-config.js
    // const auth = firebase.auth();
    // const db   = firebase.firestore();
    // NON ridichiarare const db / const auth qui, altrimenti si rompe tutto.

    // --- Autenticazione (solo per mostrare "Utente: ...") ---
    if (typeof auth !== 'undefined') {
      auth.onAuthStateChanged(function(user) {
        const userInfoEl = document.getElementById('userInfo');
        if (user) {
          userInfoEl.textContent = 'Utente: ' + (user.email || user.uid);
        } else {
          userInfoEl.textContent = 'Utente: non loggato';
          // se vuoi forzare il login:
          // window.location.href = 'index.html';
        }
      });
    }

    // --- Utility ---
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function formatDate(value) {
      if (!value) return '-';
      return String(value);
    }

    function formatNumber(value) {
      if (value === null || value === undefined) return '-';
      return String(value);
    }

    function formatText(value) {
      if (value === null || value === undefined || value === '') return '-';
      return escapeHtml(value);
    }

    function formatBool(value) {
      const v = !!value; // null/undefined => false
      if (v) {
        return '<span class="badge badge-ok">SI</span>';
      } else {
        return '<span class="badge badge-ko">NO</span>';
      }
    }

    function showMessage(text, type) {
      const el = document.getElementById('searchMessage');
      el.textContent = text || '';
      el.className = 'message' + (type ? ' ' + type : '');
    }

    function setLoading(isLoading) {
      const btn = document.getElementById('searchBtn');
      const msg = document.getElementById('searchMessage');
      if (isLoading) {
        btn.disabled = true;
        btn.innerHTML = 'Caricamento...';
        msg.innerHTML = 'Ricerca in corso<span class="loader"></span>';
        msg.className = 'message';
      } else {
        btn.disabled = false;
        btn.textContent = 'Cerca';
      }
    }

    // --- Rendering risultati ---
    function renderResults(vin, data) {
      const resultsEl      = document.getElementById('results');
      const contractInfoEl = document.getElementById('contractInfo');
      const timeKmInfoEl   = document.getElementById('timeKmInfo');
      const boolTbodyEl    = document.querySelector('#boolTable tbody');

      const contractHtml = `
        <div class="info-item">
          <span class="label">VIN</span>
          <span class="value">${formatText(data.vin || vin)}</span>
        </div>
        <div class="info-item">
          <span class="label">Cliente</span>
          <span class="value">${formatText(data.customer)}</span>
        </div>
        <div class="info-item">
          <span class="label">Tipo contratto</span>
          <span class="value">${formatText(data.contract_type)}</span>
        </div>
        <div class="info-item">
          <span class="label">Validazione contratto</span>
          <span class="value">${formatText(data.validate_contract)}</span>
        </div>
        <div class="info-item">
          <span class="label">Durata contratto</span>
          <span class="value">${formatNumber(data.duration_contract)}</span>
        </div>
        <div class="info-item">
          <span class="label">Inter-market</span>
          <span class="value">${formatText(data.inter_market)}</span>
        </div>
        <div class="info-item">
          <span class="label">Lingua</span>
          <span class="value">${formatText(data.language)}</span>
        </div>
        <div class="info-item">
          <span class="label">Note</span>
          <span class="value">${formatText(data.note)}</span>
        </div>
        <div class="info-item">
          <span class="label">Creato il</span>
          <span class="value">${formatDate(data.created)}</span>
        </div>
        <div class="info-item">
          <span class="label">Creato da</span>
          <span class="value">${formatText(data.created_by)}</span>
        </div>
        <div class="info-item">
          <span class="label">Contratto data start</span>
          <span class="value">${formatDate(data.contratto_data_start)}</span>
        </div>
        <div class="info-item">
          <span class="label">Contratto data end</span>
          <span class="value">${formatDate(data.contratto_data_end)}</span>
        </div>
      `;
      contractInfoEl.innerHTML = contractHtml;

      const timeKmHtml = `
        <div class="info-item">
          <span class="label">Completa - Data inizio</span>
          <span class="value">${formatDate(data.completa_data_start)}</span>
        </div>
        <div class="info-item">
          <span class="label">Completa - Data fine</span>
          <span class="value">${formatDate(data.completa_data_end)}</span>
        </div>
        <div class="info-item">
          <span class="label">Completa - KM inizio</span>
          <span class="value">${formatNumber(data.completa_km_start)}</span>
        </div>
        <div class="info-item">
          <span class="label">Completa - KM fine</span>
          <span class="value">${formatNumber(data.completa_km_end)}</span>
        </div>

        <div class="info-item">
          <span class="label">Cat. cinematica - Data inizio</span>
          <span class="value">${formatDate(data.catcinematica_data_start)}</span>
        </div>
        <div class="info-item">
          <span class="label">Cat. cinematica - Data fine</span>
          <span class="value">${formatDate(data.catcinematica_data_end)}</span>
        </div>
        <div class="info-item">
          <span class="label">Cat. cinematica - KM inizio</span>
          <span class="value">${formatNumber(data.catcinematica_km_start)}</span>
        </div>
        <div class="info-item">
          <span class="label">Cat. cinematica - KM fine</span>
          <span class="value">${formatNumber(data.catcinematica_km_end)}</span>
        </div>
      `;
      timeKmInfoEl.innerHTML = timeKmHtml;

      const boolRows = [
        ['Altre opzioni',      data.altre_opzioni],
        ['Batterie',           data.batterie],
        ['Fusibili / lampadine', data.fusibili_lampadine],
        ['Parti dâ€™usura',      data.parti_usara],
        ['Pulizia FAP',        data.pulizia_fap],
        ['Rabbocco olio',      data.rabbocco_olio],
        ['Tergicristallo',     data.tergicristallo],
        ['Traino',             data.traino],
        ['Uptime service',     data.uptime_service],
      ];

      boolTbodyEl.innerHTML = boolRows.map(row => (
        '<tr>' +
          '<td>' + escapeHtml(row[0]) + '</td>' +
          '<td>' + formatBool(row[1]) + '</td>' +
        '</tr>'
      )).join('');

      resultsEl.style.display = 'block';
    }

    // --- Ricerca VIN ---
    async function searchVIN() {
      const input = document.getElementById('vinInput');
      const resultsEl = document.getElementById('results');
      let vin = input.value.trim().toUpperCase();

      resultsEl.style.display = 'none';
      showMessage('', '');

      if (!vin) {
        showMessage('Inserisci un telaio (VIN) prima di avviare la ricerca.', 'error');
        return;
      }

      if (typeof db === 'undefined') {
        console.error('db non definito: controlla firebase-config.js');
        showMessage('Errore configurazione Firebase.', 'error');
        return;
      }

      setLoading(true);

      try {
        const docRef = db.collection('DBVIN').doc(vin);
        const snap = await docRef.get();

        if (!snap.exists) {
          showMessage('Nessuna copertura trovata per il telaio: ' + vin, 'error');
        } else {
          const data = snap.data() || {};
          renderResults(vin, data);
          showMessage('Copertura trovata per il telaio ' + vin + '.', 'success');
        }
      } catch (err) {
        console.error('Errore lettura DBVIN:', err);
        showMessage('Errore durante la lettura dei dati. Controlla la console.', 'error');
      } finally {
        setLoading(false);
      }
    }

    // --- Event listeners ---
    document.getElementById('searchBtn').addEventListener('click', searchVIN);
    document.getElementById('vinInput').addEventListener('keyup', function(e) {
      if (e.key === 'Enter') {
        searchVIN();
      }
    });
  </script>
</body>
</html>
