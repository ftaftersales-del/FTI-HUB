<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTVIN - Verifica copertura contratti</title>

  <!-- STILE HUB -->
  <link rel="stylesheet" href="ftstyle.css?v=6">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- CSS pagina (solo ciò che ftstyle non copre) -->
  <style>
    /* evita scroll strani con drawer */
    body{ overscroll-behavior: none; }

    /* headline pagina dentro la card */
    .page-kicker{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-bottom: 4px;
    }
    .page-title{
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.2px;
    }
    .page-subtitle{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* search section */
    .search-row{
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 10px;
      align-items: end;
      margin-top: 10px;
    }
    @media (max-width: 720px){
      .search-row{ grid-template-columns: 1fr; }
    }

    .help-hint{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .field-invalid{
      border-color: rgba(180,35,24,.45) !important;
      box-shadow: 0 0 0 4px rgba(180,35,24,.10) !important;
    }

    /* message box */
    .msg{
      margin-top: 10px;
      font-size: 13px;
    }
    .msg.success{
      color: var(--ok-tx);
      background: var(--ok-bg);
      border: 1px solid var(--ok-bd);
      padding: 10px 12px;
      border-radius: 12px;
    }
    .msg.error{
      color: var(--err-tx);
      background: var(--err-bg);
      border: 1px solid var(--err-bd);
      padding: 10px 12px;
      border-radius: 12px;
    }

    /* grid key/value */
    .kv-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .kv{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(230,232,240,.95);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
      min-height: 56px;
    }
    .kv .k{
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .kv .v{
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      word-break: break-word;
    }
    .kv .v.mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    /* section header row */
    .sec-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* pills */
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(230,232,240,.95);
      background: rgba(255,255,255,.92);
      color: var(--text);
      white-space: nowrap;
    }
    .pill.ok{
      border-color: rgba(191,236,204,.95);
      background: rgba(233,255,240,.95);
      color: var(--ok-tx);
    }
    .pill.err{
      border-color: rgba(254,205,211,.95);
      background: rgba(255,241,242,.95);
      color: var(--err-tx);
    }
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      opacity: .85;
    }

    /* options table */
    .ft-table{
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid rgba(230,232,240,.95);
      background: rgba(255,255,255,.92);
    }
    .ft-table td{
      padding: 10px 12px;
      font-size: 13px;
      border-bottom: 1px solid rgba(230,232,240,.75);
      vertical-align: middle;
    }
    .ft-table tr:last-child td{ border-bottom: none; }
    .ft-table tr:nth-child(even) td{
      background: rgba(255,255,255,.82);
    }
    .ft-table .td-right{
      text-align: right;
      white-space: nowrap;
      font-weight: 900;
    }
    .yn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(230,232,240,.95);
      font-size: 12px;
      font-weight: 900;
      min-width: 88px;
    }
    .yn.yes{
      border-color: rgba(191,236,204,.95);
      background: rgba(233,255,240,.95);
      color: var(--ok-tx);
    }
    .yn.no{
      border-color: rgba(254,205,211,.95);
      background: rgba(255,241,242,.95);
      color: var(--err-tx);
    }

    /* loader inline */
    .loader{
      display:inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(102,112,133,.25);
      border-top-color: var(--primary2);
      animation: spin .7s linear infinite;
      margin-left: 8px;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    /* RESULTS wrapper */
    .results{ display:none; margin-top: 12px; }

    /* ADMIN toolbar */
    .admin-toolbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
    }
    .admin-toolbar .left{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
    }
    .admin-mode-label{
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
      font-weight: 700;
    }

    /* DRAWER */
    .drawer-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 9980;
    }
    .drawer-backdrop.open{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0;
      right: -440px;
      width: 420px;
      max-width: 92vw;
      height: 100vh;
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(8px);
      border-left: 1px solid rgba(230,232,240,.95);
      box-shadow: -14px 0 34px rgba(15,23,42,.14);
      transition: right .22s ease;
      z-index: 9990;
      display:flex;
      flex-direction: column;
      overflow: hidden;
    }
    .drawer.open{ right: 0; }

    .drawer-header{
      position: sticky;
      top: 0;
      background: rgba(255,255,255,.96);
      border-bottom: 1px solid rgba(230,232,240,.95);
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      z-index: 2;
    }
    .drawer-title{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: -0.1px;
    }
    .drawer-close-btn{
      border: 1px solid rgba(230,232,240,.95);
      background: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 900;
    }

    .drawer-body{
      flex: 1;
      overflow-y: auto;
      padding: 14px;
    }

    .drawer-footer{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.96);
      border-top: 1px solid rgba(230,232,240,.95);
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      z-index: 2;
    }

    /* checkbox block */
    .check-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 420px){
      .check-grid{ grid-template-columns: 1fr; }
    }
    .check{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(230,232,240,.95);
      background: rgba(255,255,255,.92);
    }
    .check label{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      color: var(--text);
    }
  </style>
</head>

<body class="ft-page has-topbar">

  <!-- TOPBAR HUB -->
  <div class="ft-topbar">
    <div class="ft-topbar__inner">
      <div class="ft-topbar__left">
        <a href="FTHUBAS.html" class="ft-home-btn">← HOME</a>
        <div class="ft-topbar__subtitle">FTVIN • Verifica copertura VIN</div>
      </div>

      <div class="ft-topbar__center">
        <div id="topUserInfo" class="ft-topbar__userinfo">Utente: -</div>
      </div>

      <div class="ft-topbar__right">
        <!-- se vuoi aggiungere logout anche qui in futuro, lo metti qui -->
      </div>
    </div>
  </div>

  <div class="ft-container">

    <div class="card pad">

      <div class="page-kicker">FTVIN - Verifica copertura contratti</div>
      <h1 class="page-title">Verifica copertura per telaio (VIN)</h1>
      <p class="page-subtitle">
        Inserisci un VIN e premi <b>Cerca</b> per visualizzare i dettagli di copertura memorizzati in Firestore (collezione <b>DBVIN</b>) o sul portale Ford.
      </p>

      <hr class="sep">

      <!-- RICERCA -->
      <div class="section">
        <div class="section-head">
          <div>
            <h3 class="section-title">Ricerca VIN</h3>
            <div class="section-sub">Il VIN deve contenere esattamente 17 caratteri.</div>
          </div>
        </div>

        <div class="search-row">
          <div>
            <label for="vinInput">VIN</label>
            <input id="vinInput" type="text" placeholder="Es. NM0KCTP60XSB93275" maxlength="30" autocomplete="off" />
            <div class="help-hint">Suggerimento: incolla il VIN completo e premi INVIO.</div>
          </div>

          <div>
            <label>&nbsp;</label>
            <button id="searchBtn" class="btn btn-primary" type="button" style="width:100%; justify-content:center;">
              Cerca
            </button>
          </div>
        </div>

        <div id="searchMessage" class="msg" aria-live="polite"></div>
      </div>

      <!-- RISULTATI -->
      <div id="results" class="results">

        <hr class="sep">

        <!-- DATI VEICOLO -->
        <div class="section">
          <div class="sec-row">
            <h3 class="section-title" style="margin:0;">Dati Veicolo</h3>
          </div>
          <div id="vehicleInfo" class="kv-grid"></div>
        </div>

        <!-- NOTE (solo distributore) -->
        <div id="noteSection" class="section" style="margin-top:12px;">
          <div class="sec-row">
            <h3 class="section-title" style="margin:0;">Note</h3>
          </div>
          <div class="kv">
            <div class="v" id="noteValue" style="white-space:pre-wrap; font-weight:700;"></div>
          </div>
        </div>

        <!-- FULL LINE -->
        <div class="section" style="margin-top:12px;">
          <div class="sec-row">
            <h3 class="section-title" style="margin:0;">Full Line</h3>
            <span id="flagFullLine" class="pill"><span class="dot"></span><span>—</span></span>
          </div>
          <div id="fullLineInfo" class="kv-grid"></div>
        </div>

        <!-- DRIVE LINE -->
        <div class="section" style="margin-top:12px;">
          <div class="sec-row">
            <h3 class="section-title" style="margin:0;">Drive Line</h3>
            <span id="flagDriveLine" class="pill"><span class="dot"></span><span>—</span></span>
          </div>
          <div id="driveLineInfo" class="kv-grid"></div>
        </div>

        <!-- MANUTENZIONE -->
        <div class="section" style="margin-top:12px;">
          <div class="sec-row">
            <h3 class="section-title" style="margin:0;">Contratto di Manutenzione</h3>
            <span id="flagMaint" class="pill"><span class="dot"></span><span>—</span></span>
          </div>
          <div id="contractMaintInfo" class="kv-grid"></div>
        </div>

        <!-- OPZIONI -->
        <div class="section" style="margin-top:12px;">
          <div class="sec-row">
            <h3 class="section-title" style="margin:0;">Opzioni aggiuntive / Servizi</h3>
            <span id="flagOptions" class="pill"><span class="dot"></span><span>—</span></span>
          </div>

          <table class="ft-table" aria-label="Opzioni aggiuntive">
            <tbody id="boolTable"></tbody>
          </table>
        </div>

      </div><!-- /results -->

      <!-- AREA ADMIN -->
      <div id="adminEditSection" class="section" style="margin-top:12px; display:none;">
        <div class="section-head">
          <div>
            <h3 class="section-title">Area amministratore (coperture VIN)</h3>
            <div class="section-sub">Creazione e modifica coperture in DBVIN (solo Admin).</div>
          </div>
        </div>

        <div class="admin-toolbar">
          <div class="left">
            <button id="btnNewCoverage" class="btn btn-primary" type="button">Crea nuova copertura</button>
            <button id="btnEditCoverage" class="btn" type="button" disabled>Modifica copertura caricata</button>
          </div>
          <span id="adminModeLabel" class="admin-mode-label"></span>
        </div>
      </div>

    </div><!-- /card -->
  </div><!-- /ft-container -->

  <!-- BACKDROP + DRAWER ADMIN -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>

  <div id="adminDrawer" class="drawer" aria-label="Drawer copertura VIN">
    <div class="drawer-header">
      <div id="drawerTitle" class="drawer-title">Copertura VIN</div>
      <button id="drawerCloseBtn" class="drawer-close-btn" type="button">✕</button>
    </div>

    <div class="drawer-body">
      <form id="coverageForm" onsubmit="return false;">

        <div class="section">
          <div class="section-head">
            <div>
              <h3 class="section-title">Dati veicolo</h3>
              <div class="section-sub">Compila i campi principali della copertura.</div>
            </div>
          </div>

          <div class="kv-grid">
            <div class="kv">
              <div class="k">VIN</div>
              <div class="v"><input id="f_vin" class="field-input" /></div>
            </div>
            <div class="kv">
              <div class="k">Cliente</div>
              <div class="v"><input id="f_customer" class="field-input" /></div>
            </div>
            <div class="kv">
              <div class="k">Tipo contratto</div>
              <div class="v"><input id="f_contract_type" class="field-input" /></div>
            </div>
            <div class="kv">
              <div class="k">Validazione contratto</div>
              <div class="v"><input id="f_validate_contract" class="field-input" /></div>
            </div>
            <div class="kv">
              <div class="k">Durata contratto</div>
              <div class="v"><input id="f_duration_contract" class="field-input" type="number" /></div>
            </div>
            <div class="kv">
              <div class="k">Inter-market</div>
              <div class="v"><input id="f_inter_market" class="field-input" /></div>
            </div>
            <div class="kv">
              <div class="k">Lingua</div>
              <div class="v"><input id="f_language" class="field-input" /></div>
            </div>
          </div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-head">
            <div>
              <h3 class="section-title">Note</h3>
              <div class="section-sub">Visibili solo al distributore (se previsto dalla logica).</div>
            </div>
          </div>
          <textarea id="f_note" class="field-textarea" style="width:100%;"></textarea>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-head">
            <div><h3 class="section-title">Full Line</h3></div>
          </div>
          <div class="kv-grid">
            <div class="kv"><div class="k">Completa - Data inizio</div><div class="v"><input id="f_completa_data_start" class="field-input" placeholder="YYYY-MM-DD" /></div></div>
            <div class="kv"><div class="k">Completa - Data fine</div><div class="v"><input id="f_completa_data_end" class="field-input" placeholder="YYYY-MM-DD" /></div></div>
            <div class="kv"><div class="k">Completa - KM inizio</div><div class="v"><input id="f_completa_km_start" class="field-input" type="number" /></div></div>
            <div class="kv"><div class="k">Completa - KM fine</div><div class="v"><input id="f_completa_km_end" class="field-input" type="number" /></div></div>
          </div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-head">
            <div><h3 class="section-title">Drive Line</h3></div>
          </div>
          <div class="kv-grid">
            <div class="kv"><div class="k">Cat. cinematica - Data inizio</div><div class="v"><input id="f_catcinematica_data_start" class="field-input" placeholder="YYYY-MM-DD" /></div></div>
            <div class="kv"><div class="k">Cat. cinematica - Data fine</div><div class="v"><input id="f_catcinematica_data_end" class="field-input" placeholder="YYYY-MM-DD" /></div></div>
            <div class="kv"><div class="k">Cat. cinematica - KM inizio</div><div class="v"><input id="f_catcinematica_km_start" class="field-input" type="number" /></div></div>
            <div class="kv"><div class="k">Cat. cinematica - KM fine</div><div class="v"><input id="f_catcinematica_km_end" class="field-input" type="number" /></div></div>
          </div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-head">
            <div><h3 class="section-title">Contratto di Manutenzione</h3></div>
          </div>
          <div class="kv-grid">
            <div class="kv"><div class="k">Contratto - Data inizio</div><div class="v"><input id="f_contratto_data_start" class="field-input" placeholder="YYYY-MM-DD" /></div></div>
            <div class="kv"><div class="k">Contratto - Data fine</div><div class="v"><input id="f_contratto_data_end" class="field-input" placeholder="YYYY-MM-DD" /></div></div>
          </div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-head">
            <div>
              <h3 class="section-title">Opzioni aggiuntive / servizi</h3>
              <div class="section-sub">Seleziona le opzioni applicabili e, se necessario, specifica il tipo di Uptime.</div>
            </div>
          </div>

          <div class="check-grid">
            <div class="check"><input id="f_altre_opzioni" type="checkbox" /><label for="f_altre_opzioni">Altre opzioni</label></div>
            <div class="check"><input id="f_batterie" type="checkbox" /><label for="f_batterie">Batterie</label></div>
            <div class="check"><input id="f_fusibili_lampadine" type="checkbox" /><label for="f_fusibili_lampadine">Fusibili / lampadine</label></div>
            <div class="check"><input id="f_parti_usara" type="checkbox" /><label for="f_parti_usara">Parti d’usura</label></div>
            <div class="check"><input id="f_pulizia_fap" type="checkbox" /><label for="f_pulizia_fap">Pulizia FAP</label></div>
            <div class="check"><input id="f_rabbocco_olio" type="checkbox" /><label for="f_rabbocco_olio">Rabbocco olio</label></div>
            <div class="check"><input id="f_tergicristallo" type="checkbox" /><label for="f_tergicristallo">Tergicristallo</label></div>
            <div class="check"><input id="f_traino" type="checkbox" /><label for="f_traino">Traino</label></div>
            <div class="check"><input id="f_uptime_service" type="checkbox" /><label for="f_uptime_service">Uptime service</label></div>
          </div>

          <div style="margin-top:12px;">
            <label for="f_uptime_service_type">Uptime service type</label>
            <input id="f_uptime_service_type" class="field-input" placeholder="Es. GOLD, BASIC..." />
          </div>
        </div>

      </form>

      <div id="drawerMessage" class="msg" style="margin-top:12px;"></div>
    </div>

    <div class="drawer-footer">
      <button id="drawerCancelBtn" type="button" class="btn">Annulla</button>
      <button id="saveCoverageBtn" type="button" class="btn btn-primary">Salva</button>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const topUserInfoEl   = document.getElementById('topUserInfo');

    const vinInput        = document.getElementById('vinInput');
    const searchBtn       = document.getElementById('searchBtn');
    const searchMessageEl = document.getElementById('searchMessage');

    const resultsEl       = document.getElementById('results');
    const vehicleInfoEl   = document.getElementById('vehicleInfo');
    const noteValueEl     = document.getElementById('noteValue');
    const noteSection     = document.getElementById('noteSection');
    const fullLineInfoEl  = document.getElementById('fullLineInfo');
    const driveLineInfoEl = document.getElementById('driveLineInfo');
    const contractInfoEl  = document.getElementById('contractMaintInfo');
    const boolTableEl     = document.getElementById('boolTable');

    const flagFullLine  = document.getElementById('flagFullLine');
    const flagDriveLine = document.getElementById('flagDriveLine');
    const flagMaint     = document.getElementById('flagMaint');
    const flagOptions   = document.getElementById('flagOptions');

    // Admin toolbar
    const adminSection     = document.getElementById('adminEditSection');
    const btnNewCoverage   = document.getElementById('btnNewCoverage');
    const btnEditCoverage  = document.getElementById('btnEditCoverage');
    const adminModeLabel   = document.getElementById('adminModeLabel');

    // Drawer
    const drawer           = document.getElementById('adminDrawer');
    const drawerBackdrop   = document.getElementById('drawerBackdrop');
    const drawerTitle      = document.getElementById('drawerTitle');
    const drawerMessage    = document.getElementById('drawerMessage');
    const drawerCloseBtn   = document.getElementById('drawerCloseBtn');
    const drawerCancelBtn  = document.getElementById('drawerCancelBtn');
    const saveCoverageBtn  = document.getElementById('saveCoverageBtn');

    // Form fields
    const f_vin  = document.getElementById('f_vin');
    const f_customer            = document.getElementById('f_customer');
    const f_contract_type       = document.getElementById('f_contract_type');
    const f_validate_contract   = document.getElementById('f_validate_contract');
    const f_duration_contract   = document.getElementById('f_duration_contract');
    const f_inter_market        = document.getElementById('f_inter_market');
    const f_language            = document.getElementById('f_language');
    const f_note                = document.getElementById('f_note');
    const f_completa_data_start = document.getElementById('f_completa_data_start');
    const f_completa_data_end   = document.getElementById('f_completa_data_end');
    const f_completa_km_start   = document.getElementById('f_completa_km_start');
    const f_completa_km_end     = document.getElementById('f_completa_km_end');
    const f_catcinematica_data_start = document.getElementById('f_catcinematica_data_start');
    const f_catcinematica_data_end   = document.getElementById('f_catcinematica_data_end');
    const f_catcinematica_km_start   = document.getElementById('f_catcinematica_km_start');
    const f_catcinematica_km_end     = document.getElementById('f_catcinematica_km_end');
    const f_contratto_data_start     = document.getElementById('f_contratto_data_start');
    const f_contratto_data_end       = document.getElementById('f_contratto_data_end');

    const f_altre_opzioni       = document.getElementById('f_altre_opzioni');
    const f_batterie            = document.getElementById('f_batterie');
    const f_fusibili_lampadine  = document.getElementById('f_fusibili_lampadine');
    const f_parti_usara         = document.getElementById('f_parti_usara');
    const f_pulizia_fap         = document.getElementById('f_pulizia_fap');
    const f_rabbocco_olio       = document.getElementById('f_rabbocco_olio');
    const f_tergicristallo      = document.getElementById('f_tergicristallo');
    const f_traino              = document.getElementById('f_traino');
    const f_uptime_service      = document.getElementById('f_uptime_service');
    const f_uptime_service_type = document.getElementById('f_uptime_service_type');

    let isAdmin        = false;
    let isDistributor  = false;
    let currentVin     = null;
    let lastDocData    = null;
    let adminMode      = null;      // "create" | "edit" | null
    let coverageSource = null;      // "dbvin" | "backend" | "none"
    let coverageView   = null;      // oggetto normalizzato per la UI

    // --------- Utility ---------
    function escapeHtml(text) {
      if (text === null || text === undefined) return "";
      return String(text)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function fmtText(v) {
      if (v === null || v === undefined || v === "") return "-";
      return escapeHtml(v);
    }

    function fmtNum(v) {
      if (v === null || v === undefined || v === "") return "-";
      return escapeHtml(v);
    }

    function fmtDate(v) {
      if (!v) return "-";
      return escapeHtml(v);
    }

    function setInputInvalid(isInvalid){
      if (isInvalid) vinInput.classList.add("field-invalid");
      else vinInput.classList.remove("field-invalid");
    }

    function showMessage(text, type) {
      searchMessageEl.textContent = text || "";
      searchMessageEl.className = "msg" + (type ? " " + type : "");
    }

    function setLoading(isLoading) {
      if (isLoading) {
        searchBtn.disabled = true;
        searchBtn.innerHTML = 'Caricamento<span class="loader"></span>';
      } else {
        searchBtn.disabled = false;
        searchBtn.textContent = "Cerca";
      }
    }

    function normalizeBool(v) {
      if (v === null || v === undefined) return false;
      if (typeof v === "boolean") return v;
      const s = String(v).toLowerCase();
      return s === "1" || s === "true" || s === "si" || s === "yes";
    }

    function cutDate(v) {
      if (!v) return null;
      return String(v).slice(0, 10); // "YYYY-MM-DD"
    }

    function isActiveDate(start, end) {
      if (!start || !end) return false;
      const today = new Date().toISOString().slice(0,10);
      return start <= today && today <= end;
    }

    function setPill(el, active){
      if (!el) return;
      el.classList.remove("ok","err");
      if (active){
        el.classList.add("pill","ok");
        el.innerHTML = '<span class="dot"></span><span>ATTIVA</span>';
      } else {
        el.classList.add("pill","err");
        el.innerHTML = '<span class="dot"></span><span>NON ATTIVA</span>';
      }
    }

    function ynPill(val){
      if (!!val) return '<span class="yn yes"><span class="dot"></span>SI</span>';
      return '<span class="yn no"><span class="dot"></span>NO</span>';
    }

    function buildCoverageFromDbVin(vin, data) {
      data = data || {};
      return {
        vin,
        customer:          data.customer || null,
        contract_type:     data.contract_type || null,
        validate_contract: data.validate_contract || null,
        duration_contract: data.duration_contract != null ? data.duration_contract : 0,
        inter_market:      data.inter_market || null,
        language:          data.language || null,
        note:              data.note || null,

        fullLine: {
          start_date: data.completa_data_start || null,
          end_date:   data.completa_data_end   || null,
          km_start:   data.completa_km_start != null ? data.completa_km_start : 0,
          km_end:     data.completa_km_end   != null ? data.completa_km_end   : 0,
        },

        driveLine: {
          start_date: data.catcinematica_data_start || null,
          end_date:   data.catcinematica_data_end   || null,
          km_start:   data.catcinematica_km_start != null ? data.catcinematica_km_start : 0,
          km_end:     data.catcinematica_km_end   != null ? data.catcinematica_km_end   : 0,
        },

        maintenance: {
          start_date: data.contratto_data_start || null,
          end_date:   data.contratto_data_end   || null,
        },

        options: {
          altre_opzioni:      normalizeBool(data.altre_opzioni),
          batterie:           normalizeBool(data.batterie),
          fusibili_lampadine: normalizeBool(data.fusibili_lampadine),
          parti_usura:        normalizeBool(data.parti_usara),
          pulizia_fap:        normalizeBool(data.pulizia_fap),
          rabbocco_olio:      normalizeBool(data.rabbocco_olio),
          tergicristallo:     normalizeBool(data.tergicristallo),
          traino:             normalizeBool(data.traino),
          uptime_service:     normalizeBool(data.uptime_service),
          uptime_service_type: data.uptime_service_type || null,
        }
      };
    }

    function buildCoverageFromBackend(vin, backendData) {
      const cli = backendData.cliente_veicolo || {};
      const c   = backendData.copertura || {};

      const hasTow = !!(c.FREETOWING_START_DATE || c.FREETOWING_END_DATE);
      const uptimeName = (c.UPTIME_NAME && c.UPTIME_NAME !== "0") ? c.UPTIME_NAME : null;

      return {
        vin:                c.VIN || vin,
        customer:           cli.rag_sociale || null,
        contract_type:      c.WARRANTY_TYPE || null,
        validate_contract:  c.WARRANTY_TYPE || null,
        duration_contract:  0,
        inter_market:       null,
        language:           null,
        note:               null,

        fullLine: {
          start_date: cutDate(c.WARRANTY_START_DATE),
          end_date:   cutDate(c.WARRANTY_END_DATE),
          km_start:   0,
          km_end:     0,
        },

        driveLine: {
          start_date: null,
          end_date:   null,
          km_start:   0,
          km_end:     0,
        },

        maintenance: {
          start_date: cutDate(c.SC_DT_START_DATE),
          end_date:   cutDate(c.SC_DT_END_DATE),
        },

        options: {
          altre_opzioni:      normalizeBool(c.HAS_VEHICLE_SC),
          batterie:           normalizeBool(c.HAS_BATTERY),
          fusibili_lampadine: normalizeBool(c.HAS_FUSESBULBS),
          parti_usura:        normalizeBool(c.HAS_WEARTEAR),
          pulizia_fap:        normalizeBool(c.HAS_DPFFILTER),
          rabbocco_olio:      normalizeBool(c.HAS_OILTOP),
          tergicristallo:     false,
          traino:             hasTow,
          uptime_service:     normalizeBool(c.HAS_UPTIME),
          uptime_service_type: uptimeName,
        }
      };
    }

    function openDrawer(mode, titleText) {
      adminMode = mode; // "create" | "edit"
      drawerTitle.textContent = titleText || "Copertura VIN";
      drawerMessage.textContent = "";
      drawer.classList.add("open");
      drawerBackdrop.classList.add("open");

      if (mode === "create") {
        adminModeLabel.textContent = "Modalità: creazione nuova copertura";
      } else if (mode === "edit") {
        adminModeLabel.textContent = "Modalità: modifica copertura VIN " + (currentVin || "");
      }
    }

    function closeDrawer() {
      adminMode = null;
      drawer.classList.remove("open");
      drawerBackdrop.classList.remove("open");
      adminModeLabel.textContent = "";
    }

    function resetAdminForm() {
      f_vin.value = "";
      f_customer.value = "";
      f_contract_type.value = "";
      f_validate_contract.value = "";
      f_duration_contract.value = "";
      f_inter_market.value = "";
      f_language.value = "";
      f_note.value = "";

      f_completa_data_start.value = "";
      f_completa_data_end.value = "";
      f_completa_km_start.value = "";
      f_completa_km_end.value = "";

      f_catcinematica_data_start.value = "";
      f_catcinematica_data_end.value = "";
      f_catcinematica_km_start.value = "";
      f_catcinematica_km_end.value = "";

      f_contratto_data_start.value = "";
      f_contratto_data_end.value = "";

      f_altre_opzioni.checked = false;
      f_batterie.checked = false;
      f_fusibili_lampadine.checked = false;
      f_parti_usara.checked = false;
      f_pulizia_fap.checked = false;
      f_rabbocco_olio.checked = false;
      f_tergicristallo.checked = false;
      f_traino.checked = false;
      f_uptime_service.checked = false;
      f_uptime_service_type.value = "";

      drawerMessage.textContent = "";
      drawerMessage.className = "msg";
    }

    function fillAdminForm(vin, data) {
      data = data || {};
      f_vin.value                 = vin || "";
      f_customer.value            = data.customer || "";
      f_contract_type.value       = data.contract_type || "";
      f_validate_contract.value   = data.validate_contract || "";
      f_duration_contract.value   = data.duration_contract != null ? data.duration_contract : "";
      f_inter_market.value        = data.inter_market || "";
      f_language.value            = data.language || "";
      f_note.value                = data.note || "";

      f_completa_data_start.value = data.completa_data_start || "";
      f_completa_data_end.value   = data.completa_data_end || "";
      f_completa_km_start.value   = data.completa_km_start != null ? data.completa_km_start : "";
      f_completa_km_end.value     = data.completa_km_end != null ? data.completa_km_end : "";

      f_catcinematica_data_start.value = data.catcinematica_data_start || "";
      f_catcinematica_data_end.value   = data.catcinematica_data_end || "";
      f_catcinematica_km_start.value   = data.catcinematica_km_start != null ? data.catcinematica_km_start : "";
      f_catcinematica_km_end.value     = data.catcinematica_km_end != null ? data.catcinematica_km_end : "";

      f_contratto_data_start.value     = data.contratto_data_start || "";
      f_contratto_data_end.value       = data.contratto_data_end || "";

      f_altre_opzioni.checked      = !!data.altre_opzioni;
      f_batterie.checked           = !!data.batterie;
      f_fusibili_lampadine.checked = !!data.fusibili_lampadine;
      f_parti_usara.checked        = !!data.parti_usara;
      f_pulizia_fap.checked        = !!data.pulizia_fap;
      f_rabbocco_olio.checked      = !!data.rabbocco_olio;
      f_tergicristallo.checked     = !!data.tergicristallo;
      f_traino.checked             = !!data.traino;
      f_uptime_service.checked     = !!data.uptime_service;
      f_uptime_service_type.value  = data.uptime_service_type || "";

      drawerMessage.textContent = "";
      drawerMessage.className = "msg";
    }

    function updateAdminButtons(hasExistingDoc) {
      if (!isAdmin) {
        adminSection.style.display = "none";
        return;
      }

      adminSection.style.display = "block";

      if (coverageSource === "dbvin") {
        btnNewCoverage.disabled  = false;
        btnEditCoverage.disabled = !hasExistingDoc;
      } else if (coverageSource === "backend") {
        btnNewCoverage.disabled  = true;
        btnEditCoverage.disabled = true;
      } else if (coverageSource === "none") {
        btnNewCoverage.disabled  = false;
        btnEditCoverage.disabled = true;
      } else {
        btnNewCoverage.disabled  = true;
        btnEditCoverage.disabled = true;
      }
    }

    function renderCoverage() {
      if (!coverageView) {
        resultsEl.style.display = "none";
        return;
      }

      const cv = coverageView;

      // Dati veicolo
      vehicleInfoEl.innerHTML = `
        <div class="kv"><div class="k">VIN</div><div class="v mono">${fmtText(cv.vin)}</div></div>
        <div class="kv"><div class="k">Cliente</div><div class="v">${fmtText(cv.customer)}</div></div>
        <div class="kv"><div class="k">Tipo Contratto</div><div class="v">${fmtText(cv.contract_type)}</div></div>
        <div class="kv"><div class="k">Validazione Contratto</div><div class="v">${fmtText(cv.validate_contract)}</div></div>
        <div class="kv"><div class="k">Durata Contratto</div><div class="v">${fmtNum(cv.duration_contract)}</div></div>
        <div class="kv"><div class="k">Inter-market</div><div class="v">${fmtText(cv.inter_market)}</div></div>
        <div class="kv"><div class="k">Lingua</div><div class="v">${fmtText(cv.language)}</div></div>
      `;

      // Note (solo distributore)
      if (noteSection) {
        if (isDistributor) {
          noteSection.style.display = "block";
          noteValueEl.innerHTML = fmtText(cv.note);
        } else {
          noteSection.style.display = "none";
        }
      }

      // Full Line
      fullLineInfoEl.innerHTML = `
        <div class="kv"><div class="k">Data inizio</div><div class="v">${fmtDate(cv.fullLine.start_date)}</div></div>
        <div class="kv"><div class="k">Data fine</div><div class="v">${fmtDate(cv.fullLine.end_date)}</div></div>
        <div class="kv"><div class="k">KM inizio</div><div class="v">${fmtNum(cv.fullLine.km_start)}</div></div>
        <div class="kv"><div class="k">KM fine</div><div class="v">${fmtNum(cv.fullLine.km_end)}</div></div>
      `;
      setPill(flagFullLine, isActiveDate(cv.fullLine.start_date, cv.fullLine.end_date));

      // Drive Line
      driveLineInfoEl.innerHTML = `
        <div class="kv"><div class="k">Data inizio</div><div class="v">${fmtDate(cv.driveLine.start_date)}</div></div>
        <div class="kv"><div class="k">Data fine</div><div class="v">${fmtDate(cv.driveLine.end_date)}</div></div>
        <div class="kv"><div class="k">KM inizio</div><div class="v">${fmtNum(cv.driveLine.km_start)}</div></div>
        <div class="kv"><div class="k">KM fine</div><div class="v">${fmtNum(cv.driveLine.km_end)}</div></div>
      `;
      setPill(flagDriveLine, isActiveDate(cv.driveLine.start_date, cv.driveLine.end_date));

      // Contratto manutenzione
      contractInfoEl.innerHTML = `
        <div class="kv"><div class="k">Data inizio</div><div class="v">${fmtDate(cv.maintenance.start_date)}</div></div>
        <div class="kv"><div class="k">Data fine</div><div class="v">${fmtDate(cv.maintenance.end_date)}</div></div>
      `;
      setPill(flagMaint, isActiveDate(cv.maintenance.start_date, cv.maintenance.end_date));

      // Opzioni
      const o = cv.options;
      const options = [
        ["Altre opzioni", o.altre_opzioni],
        ["Batterie", o.batterie],
        ["Fusibili / lampadine", o.fusibili_lampadine],
        ["Parti d’usura", o.parti_usura],
        ["Pulizia FAP", o.pulizia_fap],
        ["Rabbocco olio", o.rabbocco_olio],
        ["Tergicristallo", o.tergicristallo],
        ["Traino", o.traino],
        ["Uptime service", o.uptime_service],
        ["Uptime service type", (o.uptime_service_type ? fmtText(o.uptime_service_type) : "-")],
      ];

      boolTableEl.innerHTML = options.map(([label, val]) => {
        const isBool = typeof val === "boolean";
        const valueHtml = isBool ? ynPill(val) : `<span style="font-weight:900;">${val}</span>`;
        return `<tr><td>${escapeHtml(label)}</td><td class="td-right">${valueHtml}</td></tr>`;
      }).join("");

      const hasOptionActive = [
        o.altre_opzioni, o.batterie, o.fusibili_lampadine,
        o.parti_usura, o.pulizia_fap, o.rabbocco_olio,
        o.tergicristallo, o.traino, o.uptime_service
      ].some(v => !!v);

      setPill(flagOptions, hasOptionActive);

      resultsEl.style.display = "block";
    }

    async function fetchBackendCoverage(vin) {
      const resp = await fetch("https://verifica-garanzia-backend.onrender.com/verifica", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telaio: vin }),
      });
      if (!resp.ok) {
        throw new Error("Errore HTTP backend: " + resp.status);
      }
      return await resp.json();
    }

    // --------- Auth ---------
    try {
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          topUserInfoEl.textContent = "Utente: non loggato";
          isAdmin = false;
          isDistributor = false;
          adminSection.style.display = "none";
          closeDrawer();
          return;
        }

        topUserInfoEl.textContent = "Utente: " + (user.email || user.uid);

        try {
          const userSnap = await db.collection('Users').doc(user.uid).get();
          const data = userSnap.exists ? userSnap.data() : {};
          isAdmin = data.role === "Admin";

          const dealerId = data.DealerID || data.dealerId || null;
          // Logica distributore: ad esempio FT001
          isDistributor = dealerId === "FT001";
        } catch (e) {
          console.error("Errore lettura ruolo utente:", e);
          isAdmin = false;
          isDistributor = false;
        }

        updateAdminButtons(false);
        closeDrawer();
      });
    } catch (e) {
      console.error("Errore auth:", e);
    }

    // --------- Ricerca VIN ---------
    async function searchVIN() {
      const vin = (vinInput.value || "").trim().toUpperCase();
      vinInput.value = vin; // normalizza UI
      setInputInvalid(false);

      if (!vin) {
        showMessage("Inserisci un VIN prima di cercare.", "error");
        setInputInvalid(true);
        return;
      }

      if (vin.length !== 17) {
        showMessage("Il VIN deve contenere esattamente 17 caratteri.", "error");
        setInputInvalid(true);
        return;
      }

      showMessage("", "");
      resultsEl.style.display = "none";
      lastDocData    = null;
      currentVin     = null;
      coverageView   = null;
      coverageSource = null;
      closeDrawer();
      updateAdminButtons(false);

      setLoading(true);
      try {
        // 1) Firestore
        const ref  = db.collection("DBVIN").doc(vin);
        const snap = await ref.get();

        if (snap.exists) {
          const data = snap.data() || {};
          lastDocData    = data;
          currentVin     = vin;
          coverageSource = "dbvin";
          coverageView   = buildCoverageFromDbVin(vin, data);
          renderCoverage();
          showMessage("Copertura caricata dal database locale (DBVIN).", "success");
          updateAdminButtons(true);
          return;
        }

        // 2) Backend se non esiste in DBVIN
        try {
          const backendData = await fetchBackendCoverage(vin);

          if (backendData.success && backendData.copertura && backendData.copertura.HAS_WARRANTY) {
            currentVin     = vin;
            lastDocData    = null;
            coverageSource = "backend";
            coverageView   = buildCoverageFromBackend(vin, backendData);
            renderCoverage();
            showMessage("Copertura trovata sul portale Ford (backend).", "success");
            updateAdminButtons(false); // solo lettura
          } else {
            // nessuna copertura in backend
            coverageSource = "none";
            coverageView   = null;
            resultsEl.style.display = "none";
            showMessage("Telaio inesistente nelle banche dati.", "error");
            updateAdminButtons(false);
            if (isAdmin) {
              coverageSource = "none";
              updateAdminButtons(false);
              adminModeLabel.textContent = "Nessuna copertura trovata: puoi creare una nuova copertura.";
            }
          }
        } catch (err2) {
          console.error("Errore backend:", err2);
          coverageSource = "none";
          coverageView   = null;
          resultsEl.style.display = "none";
          showMessage("Errore nel backend di verifica garanzia.", "error");
          updateAdminButtons(false);
          if (isAdmin) {
            adminModeLabel.textContent = "Errore backend: puoi comunque creare una nuova copertura.";
          }
        }

      } catch (err) {
        console.error("Errore Firestore:", err);
        showMessage("Errore durante la lettura dei dati.", "error");
        coverageSource = "none";
        coverageView   = null;
        resultsEl.style.display = "none";
        updateAdminButtons(false);
      } finally {
        setLoading(false);
      }
    }

    // --------- Salvataggio copertura (Admin) ---------
    async function saveCoverage() {
      if (!isAdmin) {
        drawerMessage.textContent = "Non hai i permessi per salvare.";
        drawerMessage.className = "msg error";
        return;
      }

      let vin;
      if (adminMode === "create") {
        vin = (f_vin.value || "").trim().toUpperCase();
        f_vin.value = vin;
        if (!vin) {
          drawerMessage.textContent = "Inserisci un VIN per creare la copertura.";
          drawerMessage.className = "msg error";
          return;
        }
        if (vin.length !== 17) {
          drawerMessage.textContent = "Il VIN deve contenere esattamente 17 caratteri.";
          drawerMessage.className = "msg error";
          return;
        }
      } else if (adminMode === "edit") {
        vin = currentVin;
        if (!vin) {
          drawerMessage.textContent = "Nessun VIN caricato da modificare.";
          drawerMessage.className = "msg error";
          return;
        }
      } else {
        drawerMessage.textContent = "Seleziona prima se creare o modificare.";
        drawerMessage.className = "msg error";
        return;
      }

      const payload = {
        vin: vin,
        customer: f_customer.value.trim() || null,
        contract_type: f_contract_type.value.trim() || null,
        validate_contract: f_validate_contract.value.trim() || null,
        inter_market: f_inter_market.value.trim() || null,
        language: f_language.value.trim() || null,
        note: f_note.value.trim() || null,

        duration_contract: f_duration_contract.value
          ? parseInt(f_duration_contract.value, 10) || 0
          : 0,

        completa_data_start: f_completa_data_start.value.trim() || null,
        completa_data_end:   f_completa_data_end.value.trim()   || null,
        completa_km_start:   f_completa_km_start.value
          ? parseInt(f_completa_km_start.value, 10) || 0
          : 0,
        completa_km_end:     f_completa_km_end.value
          ? parseInt(f_completa_km_end.value, 10) || 0
          : 0,

        catcinematica_data_start: f_catcinematica_data_start.value.trim() || null,
        catcinematica_data_end:   f_catcinematica_data_end.value.trim()   || null,
        catcinematica_km_start:   f_catcinematica_km_start.value
          ? parseInt(f_catcinematica_km_start.value, 10) || 0
          : 0,
        catcinematica_km_end:     f_catcinematica_km_end.value
          ? parseInt(f_catcinematica_km_end.value, 10) || 0
          : 0,

        contratto_data_start: f_contratto_data_start.value.trim() || null,
        contratto_data_end:   f_contratto_data_end.value.trim()   || null,

        altre_opzioni:      !!f_altre_opzioni.checked,
        batterie:           !!f_batterie.checked,
        fusibili_lampadine: !!f_fusibili_lampadine.checked,
        parti_usara:        !!f_parti_usara.checked,
        pulizia_fap:        !!f_pulizia_fap.checked,
        rabbocco_olio:      !!f_rabbocco_olio.checked,
        tergicristallo:     !!f_tergicristallo.checked,
        traino:             !!f_traino.checked,
        uptime_service:     !!f_uptime_service.checked,

        uptime_service_type: f_uptime_service_type.value.trim() || null
      };

      try {
        const user = auth.currentUser;
        const today = new Date().toISOString().slice(0,10);
        if (!lastDocData || !lastDocData.created) {
          payload.created = today;
        }
        if (!lastDocData || !lastDocData.created_by) {
          payload.created_by = user ? (user.email || user.uid) : "system";
        }
      } catch (e) {
        console.warn("Errore set created/created_by:", e);
      }

      drawerMessage.textContent = "Salvataggio in corso...";
      drawerMessage.className = "msg";

      try {
        await db.collection("DBVIN").doc(vin).set(payload, { merge: true });
        lastDocData = Object.assign({}, lastDocData || {}, payload);
        currentVin  = vin;
        coverageSource = "dbvin";
        coverageView   = buildCoverageFromDbVin(vin, lastDocData);

        renderCoverage();
        updateAdminButtons(true);
        drawerMessage.textContent = "Copertura salvata correttamente.";
        drawerMessage.className = "msg success";
      } catch (err) {
        console.error("Errore salvataggio:", err);
        drawerMessage.textContent = "Errore durante il salvataggio.";
        drawerMessage.className = "msg error";
      }
    }

    // --------- Eventi ---------
    searchBtn.addEventListener('click', searchVIN);
    vinInput.addEventListener('keyup', (e) => {
      if (e.key === "Enter") searchVIN();
    });

    if (btnNewCoverage) {
      btnNewCoverage.addEventListener('click', () => {
        if (!isAdmin) return;
        resetAdminForm();
        const typedVin = (vinInput.value || "").trim().toUpperCase();
        f_vin.value = typedVin;
        f_vin.readOnly = false;
        openDrawer("create", "Crea nuova copertura");
      });
    }

    if (btnEditCoverage) {
      btnEditCoverage.addEventListener('click', () => {
        if (!isAdmin) return;
        if (!currentVin || !lastDocData || Object.keys(lastDocData).length === 0) {
          drawerMessage.textContent = "Nessuna copertura caricata da modificare.";
          drawerMessage.className = "msg error";
          openDrawer("edit", "Modifica copertura");
          return;
        }
        resetAdminForm();
        f_vin.readOnly = true;
        fillAdminForm(currentVin, lastDocData);
        openDrawer("edit", "Modifica copertura");
      });
    }

    drawerCloseBtn.addEventListener('click', closeDrawer);
    drawerCancelBtn.addEventListener('click', closeDrawer);
    drawerBackdrop.addEventListener('click', closeDrawer);

    saveCoverageBtn.addEventListener('click', saveCoverage);
  });
</script>

</body>
</html>
