<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>FTVIN - Verifica copertura contratti</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      overscroll-behavior: none; /* evita scroll strani con il drawer */
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px 24px 28px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
      position: relative;
      z-index: 1;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-actions button {
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fafafa;
      cursor: pointer;
      font-size: 12px;
    }

    h1 {
      margin: 8px 0 6px;
      font-size: 26px;
      color: #333;
    }

    .subtitle {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .search-box {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .search-box input {
      flex: 1;
      min-width: 260px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      text-transform: uppercase;
    }

    .search-box button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .message {
      font-size: 13px;
      margin-top: 4px;
    }

    .message.error { color: #c0392b; }
    .message.success { color: #2e7d32; }

    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #ddd;
      border-top-color: #007bff;
      animation: spin 0.7s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .results { margin-top: 20px; display: none; }

    .section-title {
      font-size: 18px;
      margin: 16px 0 10px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-flag {
      font-size: 14px;
      font-weight: bold;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px 18px;
      font-size: 13px;
    }

    .info-item {
      background: #fafafa;
      border-radius: 6px;
      padding: 8px 10px;
    }

    .label {
      font-weight: bold;
      margin-bottom: 3px;
      display: block;
      color: #555;
    }

    .note-box {
      background: #fafafa;
      border-radius: 6px;
      padding: 10px;
      min-height: 80px;
    }

    .note-value {
      white-space: pre-wrap;
    }

    table.bool-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    table.bool-table td, table.bool-table th {
      border: 1px solid #ddd;
      padding: 6px 8px;
    }

    table.bool-table th {
      background: #f3f3f3;
    }

    /* ADMIN AREA ------------------------------------------------------ */

    .admin-section {
      margin-top: 24px;
      padding-top: 10px;
      border-top: 1px dashed #ccc;
      display: none;
    }

    .admin-toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 6px;
    }

    .admin-toolbar button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 13px;
      background: #f5f5f5;
    }

    .admin-toolbar button.primary {
      background: #007bff;
      border-color: #007bff;
      color: white;
    }

    .admin-toolbar button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .admin-mode-label {
      font-size: 12px;
      color: #555;
      margin-left: auto;
      font-style: italic;
    }

    /* DRAWER laterale ------------------------------------------------- */

    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 998;
    }

    .drawer-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: -420px;
      width: 390px;
      max-width: 90%;
      height: 100vh;          /* <- fix: occupa esattamente il viewport */
      background: #ffffff;
      box-shadow: -2px 0 10px rgba(0,0,0,0.15);
      padding: 16px 16px 20px;
      transition: right 0.25s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;       /* evita che il contenuto sbordi sotto la barra */
    }

    .drawer.open {
      right: 0;
    }

    .drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .drawer-title {
      font-size: 18px;
      font-weight: bold;
    }

    .drawer-close-btn {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      padding: 2px 6px;
    }

    .drawer-body {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 6px;
      font-size: 13px;
    }

    .drawer-footer {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .field-input, .field-textarea {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 13px;
      box-sizing: border-box;
    }

    .field-textarea { min-height: 80px; resize: vertical; }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 4px 0;
    }

    .btn-secondary {
      background: #6c757d;
      color: #fff;
      border-radius: 6px;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #28a745;
      color: #fff;
      border-radius: 6px;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      .container { padding: 14px; }
      .section-title { flex-direction: column; align-items: flex-start; }
      .top-bar { flex-direction: column; align-items: flex-start; gap: 4px; }
      .top-actions { align-self: flex-end; }
    }
  </style>
</head>

<body>
<div class="container">

  <div class="top-bar">
    <div>FTVIN - Verifica copertura contratti</div>
    <div class="top-actions">
      <button onclick="goHome()">Home</button>
      <span id="userInfo">Utente: -</span>
    </div>
  </div>

  <h1>Verifica copertura per telaio (VIN)</h1>
  <div class="subtitle">
    Inserisci un VIN e premi "Cerca" per visualizzare i dettagli di copertura memorizzati in Firestore (collezione <b>DBVIN</b>).
  </div>

  <div class="search-box">
    <input id="vinInput" type="text" placeholder="Es. NM0KCTP60XSB93275" maxlength="30" />
    <button id="searchBtn">Cerca</button>
  </div>

  <div id="searchMessage" class="message"></div>

  <!-- RISULTATI -->
  <div id="results" class="results">

    <!-- Dati Veicolo -->
    <div class="section-title">
      <span>Dati Veicolo</span>
    </div>
    <div id="vehicleInfo" class="info-grid"></div>

    <!-- Note -->
    <div class="section-title">
      <span>Note</span>
    </div>
    <div class="note-box">
      <div id="noteValue" class="note-value"></div>
    </div>

    <!-- Full Line -->
    <div class="section-title">
      <span>Full Line</span>
      <span id="flagFullLine" class="status-flag"></span>
    </div>
    <div id="fullLineInfo" class="info-grid"></div>

    <!-- Drive Line -->
    <div class="section-title">
      <span>Drive Line</span>
      <span id="flagDriveLine" class="status-flag"></span>
    </div>
    <div id="driveLineInfo" class="info-grid"></div>

    <!-- Contratto di Manutenzione -->
    <div class="section-title">
      <span>Contratto di Manutenzione</span>
      <span id="flagMaint" class="status-flag"></span>
    </div>
    <div id="contractMaintInfo" class="info-grid"></div>

    <!-- Opzioni aggiuntive -->
    <div class="section-title">
      <span>Opzioni aggiuntive / Servizi</span>
      <span id="flagOptions" class="status-flag"></span>
    </div>

    <table class="bool-table">
      <tbody id="boolTable"></tbody>
    </table>
  </div>

  <!-- AREA ADMIN (toolbar) -->
  <div id="adminEditSection" class="admin-section">
    <h2>Area amministratore (coperture VIN)</h2>
    <div class="admin-toolbar">
      <button id="btnNewCoverage" class="primary" type="button">Crea nuova copertura</button>
      <button id="btnEditCoverage" type="button" disabled>Modifica copertura caricata</button>
      <span id="adminModeLabel" class="admin-mode-label"></span>
    </div>
  </div>

</div>

<!-- BACKDROP E DRAWER LATERALE -->
<div id="drawerBackdrop" class="drawer-backdrop"></div>

<div id="adminDrawer" class="drawer">
  <div class="drawer-header">
    <div id="drawerTitle" class="drawer-title">Copertura VIN</div>
    <button id="drawerCloseBtn" class="drawer-close-btn" type="button">&times;</button>
  </div>

  <div class="drawer-body">
    <form id="coverageForm" onsubmit="return false;">
      <h3>Dati veicolo</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">VIN</span>
          <input id="f_vin" class="field-input" />
        </div>
        <div class="info-item">
          <span class="label">Cliente</span>
          <input id="f_customer" class="field-input" />
        </div>
        <div class="info-item">
          <span class="label">Tipo contratto</span>
          <input id="f_contract_type" class="field-input" />
        </div>
        <div class="info-item">
          <span class="label">Validazione contratto</span>
          <input id="f_validate_contract" class="field-input" />
        </div>
        <div class="info-item">
          <span class="label">Durata contratto</span>
          <input id="f_duration_contract" class="field-input" type="number" />
        </div>
        <div class="info-item">
          <span class="label">Inter-market</span>
          <input id="f_inter_market" class="field-input" />
        </div>
        <div class="info-item">
          <span class="label">Lingua</span>
          <input id="f_language" class="field-input" />
        </div>
      </div>

      <h3>Note</h3>
      <textarea id="f_note" class="field-textarea"></textarea>

      <h3>Full Line</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Completa - Data inizio</span>
          <input id="f_completa_data_start" class="field-input" placeholder="YYYY-MM-DD" />
        </div>
        <div class="info-item">
          <span class="label">Completa - Data fine</span>
          <input id="f_completa_data_end" class="field-input" placeholder="YYYY-MM-DD" />
        </div>
        <div class="info-item">
          <span class="label">Completa - KM inizio</span>
          <input id="f_completa_km_start" class="field-input" type="number" />
        </div>
        <div class="info-item">
          <span class="label">Completa - KM fine</span>
          <input id="f_completa_km_end" class="field-input" type="number" />
        </div>
      </div>

      <h3>Drive Line</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Cat. cinematica - Data inizio</span>
          <input id="f_catcinematica_data_start" class="field-input" placeholder="YYYY-MM-DD" />
        </div>
        <div class="info-item">
          <span class="label">Cat. cinematica - Data fine</span>
          <input id="f_catcinematica_data_end" class="field-input" placeholder="YYYY-MM-DD" />
        </div>
        <div class="info-item">
          <span class="label">Cat. cinematica - KM inizio</span>
          <input id="f_catcinematica_km_start" class="field-input" type="number" />
        </div>
        <div class="info-item">
          <span class="label">Cat. cinematica - KM fine</span>
          <input id="f_catcinematica_km_end" class="field-input" type="number" />
        </div>
      </div>

      <h3>Contratto di Manutenzione</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Contratto data start</span>
          <input id="f_contratto_data_start" class="field-input" placeholder="YYYY-MM-DD" />
        </div>
        <div class="info-item">
          <span class="label">Contratto data end</span>
          <input id="f_contratto_data_end" class="field-input" placeholder="YYYY-MM-DD" />
        </div>
      </div>

      <h3>Opzioni aggiuntive / servizi</h3>
      <div class="info-item">
        <div class="checkbox-row">
          <input id="f_altre_opzioni" type="checkbox" />
          <label for="f_altre_opzioni">Altre opzioni</label>
        </div>
        <div class="checkbox-row">
          <input id="f_batterie" type="checkbox" />
          <label for="f_batterie">Batterie</label>
        </div>
        <div class="checkbox-row">
          <input id="f_fusibili_lampadine" type="checkbox" />
          <label for="f_fusibili_lampadine">Fusibili / lampadine</label>
        </div>
        <div class="checkbox-row">
          <input id="f_parti_usara" type="checkbox" />
          <label for="f_parti_usara">Parti dâ€™usura</label>
        </div>
        <div class="checkbox-row">
          <input id="f_pulizia_fap" type="checkbox" />
          <label for="f_pulizia_fap">Pulizia FAP</label>
        </div>
        <div class="checkbox-row">
          <input id="f_rabbocco_olio" type="checkbox" />
          <label for="f_rabbocco_olio">Rabbocco olio</label>
        </div>
        <div class="checkbox-row">
          <input id="f_tergicristallo" type="checkbox" />
          <label for="f_tergicristallo">Tergicristallo</label>
        </div>
        <div class="checkbox-row">
          <input id="f_traino" type="checkbox" />
          <label for="f_traino">Traino</label>
        </div>
        <div class="checkbox-row">
          <input id="f_uptime_service" type="checkbox" />
          <label for="f_uptime_service">Uptime service</label>
        </div>
        <div style="margin-top:10px;">
          <span class="label">Uptime service type</span>
          <input id="f_uptime_service_type" class="field-input" placeholder="Es. GOLD, BASIC..." />
        </div>
      </div>
    </form>
  </div>

  <div class="drawer-footer">
    <button id="drawerCancelBtn" type="button" class="btn-secondary">Annulla</button>
    <button id="saveCoverageBtn" type="button" class="btn-primary">Salva</button>
  </div>

  <div id="drawerMessage" class="message" style="margin-top:6px;"></div>
</div>

<script>
  function goHome() {
    window.location.href = "FTHUBAS.html"; // cambia se la home ha un nome diverso
  }

  document.addEventListener('DOMContentLoaded', function () {
    const userInfoEl      = document.getElementById('userInfo');
    const vinInput        = document.getElementById('vinInput');
    const searchBtn       = document.getElementById('searchBtn');
    const searchMessageEl = document.getElementById('searchMessage');

    const resultsEl       = document.getElementById('results');
    const vehicleInfoEl   = document.getElementById('vehicleInfo');
    const noteValueEl     = document.getElementById('noteValue');
    const fullLineInfoEl  = document.getElementById('fullLineInfo');
    const driveLineInfoEl = document.getElementById('driveLineInfo');
    const contractInfoEl  = document.getElementById('contractMaintInfo');
    const boolTableEl     = document.getElementById('boolTable');

    const flagFullLine  = document.getElementById('flagFullLine');
    const flagDriveLine = document.getElementById('flagDriveLine');
    const flagMaint     = document.getElementById('flagMaint');
    const flagOptions   = document.getElementById('flagOptions');

    // Admin toolbar
    const adminSection     = document.getElementById('adminEditSection');
    const btnNewCoverage   = document.getElementById('btnNewCoverage');
    const btnEditCoverage  = document.getElementById('btnEditCoverage');
    const adminModeLabel   = document.getElementById('adminModeLabel');

    // Drawer
    const drawer           = document.getElementById('adminDrawer');
    const drawerBackdrop   = document.getElementById('drawerBackdrop');
    const drawerTitle      = document.getElementById('drawerTitle');
    const drawerMessage    = document.getElementById('drawerMessage');
    const drawerCloseBtn   = document.getElementById('drawerCloseBtn');
    const drawerCancelBtn  = document.getElementById('drawerCancelBtn');
    const saveCoverageBtn  = document.getElementById('saveCoverageBtn');

    // Form fields
    const f_vin  = document.getElementById('f_vin');
    const f_customer            = document.getElementById('f_customer');
    const f_contract_type       = document.getElementById('f_contract_type');
    const f_validate_contract   = document.getElementById('f_validate_contract');
    const f_duration_contract   = document.getElementById('f_duration_contract');
    const f_inter_market        = document.getElementById('f_inter_market');
    const f_language            = document.getElementById('f_language');
    const f_note                = document.getElementById('f_note');
    const f_completa_data_start = document.getElementById('f_completa_data_start');
    const f_completa_data_end   = document.getElementById('f_completa_data_end');
    const f_completa_km_start   = document.getElementById('f_completa_km_start');
    const f_completa_km_end     = document.getElementById('f_completa_km_end');
    const f_catcinematica_data_start = document.getElementById('f_catcinematica_data_start');
    const f_catcinematica_data_end   = document.getElementById('f_catcinematica_data_end');
    const f_catcinematica_km_start   = document.getElementById('f_catcinematica_km_start');
    const f_catcinematica_km_end     = document.getElementById('f_catcinematica_km_end');
    const f_contratto_data_start     = document.getElementById('f_contratto_data_start');
    const f_contratto_data_end       = document.getElementById('f_contratto_data_end');

    const f_altre_opzioni       = document.getElementById('f_altre_opzioni');
    const f_batterie            = document.getElementById('f_batterie');
    const f_fusibili_lampadine  = document.getElementById('f_fusibili_lampadine');
    const f_parti_usara         = document.getElementById('f_parti_usara');
    const f_pulizia_fap         = document.getElementById('f_pulizia_fap');
    const f_rabbocco_olio       = document.getElementById('f_rabbocco_olio');
    const f_tergicristallo      = document.getElementById('f_tergicristallo');
    const f_traino              = document.getElementById('f_traino');
    const f_uptime_service      = document.getElementById('f_uptime_service');
    const f_uptime_service_type = document.getElementById('f_uptime_service_type');

    let isAdmin     = false;
    let currentVin  = null;
    let lastDocData = null;
    let adminMode   = null; // "create" | "edit" | null

    // --------- Utility ---------
    function escapeHtml(text) {
      if (text === null || text === undefined) return "";
      return String(text)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function fmtText(v) {
      if (v === null || v === undefined || v === "") return "-";
      return escapeHtml(v);
    }

    function fmtNum(v) {
      if (v === null || v === undefined) return "-";
      return v;
    }

    function fmtDate(v) {
      if (!v) return "-";
      return v;
    }

    function fmtBool(v) {
      v = !!v;
      return v ? "ðŸŸ¢ SI" : "ðŸ”´ NO";
    }

    function isActiveDate(start, end) {
      if (!start || !end) return false;
      const today = new Date().toISOString().slice(0,10);
      return start <= today && today <= end;
    }

    function badge(active) {
      return active ? "ðŸŸ¢ ATTIVA" : "ðŸ”´ NON ATTIVA";
    }

    function showMessage(text, type) {
      searchMessageEl.textContent = text || "";
      searchMessageEl.className = "message" + (type ? " " + type : "");
    }

    function setLoading(isLoading) {
      if (isLoading) {
        searchBtn.disabled = true;
        searchBtn.innerHTML = 'Caricamento<span class="loader"></span>';
      } else {
        searchBtn.disabled = false;
        searchBtn.textContent = "Cerca";
      }
    }

    function openDrawer(mode, titleText) {
      adminMode = mode; // "create" | "edit"
      drawerTitle.textContent = titleText || "Copertura VIN";
      drawerMessage.textContent = "";
      drawer.classList.add("open");
      drawerBackdrop.classList.add("open");

      if (mode === "create") {
        adminModeLabel.textContent = "ModalitÃ : creazione nuova copertura";
      } else if (mode === "edit") {
        adminModeLabel.textContent = "ModalitÃ : modifica copertura VIN " + (currentVin || "");
      }
    }

    function closeDrawer() {
      adminMode = null;
      drawer.classList.remove("open");
      drawerBackdrop.classList.remove("open");
      adminModeLabel.textContent = "";
    }

    function resetAdminForm() {
      f_vin.value = "";
      f_customer.value = "";
      f_contract_type.value = "";
      f_validate_contract.value = "";
      f_duration_contract.value = "";
      f_inter_market.value = "";
      f_language.value = "";
      f_note.value = "";

      f_completa_data_start.value = "";
      f_completa_data_end.value = "";
      f_completa_km_start.value = "";
      f_completa_km_end.value = "";

      f_catcinematica_data_start.value = "";
      f_catcinematica_data_end.value = "";
      f_catcinematica_km_start.value = "";
      f_catcinematica_km_end.value = "";

      f_contratto_data_start.value = "";
      f_contratto_data_end.value = "";

      f_altre_opzioni.checked = false;
      f_batterie.checked = false;
      f_fusibili_lampadine.checked = false;
      f_parti_usara.checked = false;
      f_pulizia_fap.checked = false;
      f_rabbocco_olio.checked = false;
      f_tergicristallo.checked = false;
      f_traino.checked = false;
      f_uptime_service.checked = false;
      f_uptime_service_type.value = "";

      drawerMessage.textContent = "";
    }

    function fillAdminForm(vin, data) {
      data = data || {};
      f_vin.value                 = vin || "";
      f_customer.value            = data.customer || "";
      f_contract_type.value       = data.contract_type || "";
      f_validate_contract.value   = data.validate_contract || "";
      f_duration_contract.value   = data.duration_contract != null ? data.duration_contract : "";
      f_inter_market.value        = data.inter_market || "";
      f_language.value            = data.language || "";
      f_note.value                = data.note || "";

      f_completa_data_start.value = data.completa_data_start || "";
      f_completa_data_end.value   = data.completa_data_end || "";
      f_completa_km_start.value   = data.completa_km_start != null ? data.completa_km_start : "";
      f_completa_km_end.value     = data.completa_km_end != null ? data.completa_km_end : "";

      f_catcinematica_data_start.value = data.catcinematica_data_start || "";
      f_catcinematica_data_end.value   = data.catcinematica_data_end || "";
      f_catcinematica_km_start.value   = data.catcinematica_km_start != null ? data.catcinematica_km_start : "";
      f_catcinematica_km_end.value     = data.catcinematica_km_end != null ? data.catcinematica_km_end : "";

      f_contratto_data_start.value     = data.contratto_data_start || "";
      f_contratto_data_end.value       = data.contratto_data_end || "";

      f_altre_opzioni.checked      = !!data.altre_opzioni;
      f_batterie.checked           = !!data.batterie;
      f_fusibili_lampadine.checked = !!data.fusibili_lampadine;
      f_parti_usara.checked        = !!data.parti_usara;
      f_pulizia_fap.checked        = !!data.pulizia_fap;
      f_rabbocco_olio.checked      = !!data.rabbocco_olio;
      f_tergicristallo.checked     = !!data.tergicristallo;
      f_traino.checked             = !!data.traino;
      f_uptime_service.checked     = !!data.uptime_service;
      f_uptime_service_type.value  = data.uptime_service_type || "";

      drawerMessage.textContent = "";
    }

    function updateAdminButtons(hasExistingDoc) {
      if (!isAdmin) {
        adminSection.style.display = "none";
        return;
      }
      adminSection.style.display = "block";
      btnEditCoverage.disabled = !hasExistingDoc;
    }

    // --------- Auth ---------
    try {
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          userInfoEl.textContent = "Utente: non loggato";
          isAdmin = false;
          adminSection.style.display = "none";
          closeDrawer();
          return;
        }
        userInfoEl.textContent = "Utente: " + (user.email || user.uid);

        try {
          const userSnap = await db.collection('Users').doc(user.uid).get();
          const data = userSnap.exists ? userSnap.data() : {};
          isAdmin = data.role === "Admin";
        } catch (e) {
          console.error("Errore lettura ruolo utente:", e);
          isAdmin = false;
        }

        updateAdminButtons(false);
        closeDrawer();
      });
    } catch (e) {
      console.error("Errore auth:", e);
    }

    // --------- Rendering risultati ---------
    function renderResults(vin, data) {
      data = data || {};

      // Dati veicolo
      vehicleInfoEl.innerHTML = `
        <div class="info-item"><span class="label">VIN</span>${fmtText(vin)}</div>
        <div class="info-item"><span class="label">Cliente</span>${fmtText(data.customer)}</div>
        <div class="info-item"><span class="label">Tipo Contratto</span>${fmtText(data.contract_type)}</div>
        <div class="info-item"><span class="label">Validazione Contratto</span>${fmtText(data.validate_contract)}</div>
        <div class="info-item"><span class="label">Durata Contratto</span>${fmtNum(data.duration_contract)}</div>
        <div class="info-item"><span class="label">Inter-market</span>${fmtText(data.inter_market)}</div>
        <div class="info-item"><span class="label">Lingua</span>${fmtText(data.language)}</div>
      `;

      // Note
      noteValueEl.innerHTML = fmtText(data.note);

      // Full Line
      fullLineInfoEl.innerHTML = `
        <div class="info-item"><span class="label">Data inizio</span>${fmtDate(data.completa_data_start)}</div>
        <div class="info-item"><span class="label">Data fine</span>${fmtDate(data.completa_data_end)}</div>
        <div class="info-item"><span class="label">KM inizio</span>${fmtNum(data.completa_km_start)}</div>
        <div class="info-item"><span class="label">KM fine</span>${fmtNum(data.completa_km_end)}</div>
      `;
      flagFullLine.textContent = badge(isActiveDate(data.completa_data_start, data.completa_data_end));

      // Drive Line
      driveLineInfoEl.innerHTML = `
        <div class="info-item"><span class="label">Data inizio</span>${fmtDate(data.catcinematica_data_start)}</div>
        <div class="info-item"><span class="label">Data fine</span>${fmtDate(data.catcinematica_data_end)}</div>
        <div class="info-item"><span class="label">KM inizio</span>${fmtNum(data.catcinematica_km_start)}</div>
        <div class="info-item"><span class="label">KM fine</span>${fmtNum(data.catcinematica_km_end)}</div>
      `;
      flagDriveLine.textContent = badge(isActiveDate(data.catcinematica_data_start, data.catcinematica_data_end));

      // Contratto manutenzione
      contractInfoEl.innerHTML = `
        <div class="info-item"><span class="label">Data inizio</span>${fmtDate(data.contratto_data_start)}</div>
        <div class="info-item"><span class="label">Data fine</span>${fmtDate(data.contratto_data_end)}</div>
      `;
      flagMaint.textContent = badge(isActiveDate(data.contratto_data_start, data.contratto_data_end));

      // Opzioni
      const options = [
        ["Altre opzioni", data.altre_opzioni],
        ["Batterie", data.batterie],
        ["Fusibili / lampadine", data.fusibili_lampadine],
        ["Parti dâ€™usura", data.parti_usara],
        ["Pulizia FAP", data.pulizia_fap],
        ["Rabbocco olio", data.rabbocco_olio],
        ["Tergicristallo", data.tergicristallo],
        ["Traino", data.traino],
        ["Uptime service", data.uptime_service],
        ["Uptime service type", fmtText(data.uptime_service_type)]
      ];

      boolTableEl.innerHTML = options.map(([label, val]) => {
        const valueHtml = typeof val === "boolean" ? fmtBool(val) : val;
        return `<tr><td>${escapeHtml(label)}</td><td>${valueHtml}</td></tr>`;
      }).join("");

      const hasOptionActive = [
        data.altre_opzioni, data.batterie, data.fusibili_lampadine,
        data.parti_usara, data.pulizia_fap, data.rabbocco_olio,
        data.tergicristallo, data.traino, data.uptime_service
      ].some(v => !!v);

      flagOptions.textContent = badge(hasOptionActive);

      lastDocData = data;
      currentVin  = vin;

      resultsEl.style.display = "block";
    }

    // --------- Ricerca VIN ---------
    async function searchVIN() {
      const vin = (vinInput.value || "").trim().toUpperCase();
      if (!vin) {
        showMessage("Inserisci un VIN prima di cercare.", "error");
        return;
      }

      showMessage("", "");
      resultsEl.style.display = "none";
      lastDocData = null;
      currentVin  = null;
      closeDrawer();
      updateAdminButtons(false);

      setLoading(true);
      try {
        const ref = db.collection("DBVIN").doc(vin);
        const snap = await ref.get();

        if (!snap.exists) {
          showMessage("Nessuna copertura trovata per " + vin, "error");
          renderResults(vin, {});
          updateAdminButtons(false);
        } else {
          const data = snap.data() || {};
          renderResults(vin, data);
          showMessage("Copertura caricata correttamente.", "success");
          updateAdminButtons(true);
        }
      } catch (err) {
        console.error("Errore Firestore:", err);
        showMessage("Errore durante la lettura dei dati.", "error");
        updateAdminButtons(false);
      } finally {
        setLoading(false);
      }
    }

    // --------- Salvataggio copertura (Admin) ---------
    async function saveCoverage() {
      if (!isAdmin) {
        drawerMessage.textContent = "Non hai i permessi per salvare.";
        drawerMessage.className = "message error";
        return;
      }

      let vin;
      if (adminMode === "create") {
        vin = (f_vin.value || "").trim().toUpperCase();
        if (!vin) {
          drawerMessage.textContent = "Inserisci un VIN per creare la copertura.";
          drawerMessage.className = "message error";
          return;
        }
      } else if (adminMode === "edit") {
        vin = currentVin;
        if (!vin) {
          drawerMessage.textContent = "Nessun VIN caricato da modificare.";
          drawerMessage.className = "message error";
          return;
        }
      } else {
        drawerMessage.textContent = "Seleziona prima se creare o modificare.";
        drawerMessage.className = "message error";
        return;
      }

      const payload = {
        vin: vin,
        customer: f_customer.value.trim() || null,
        contract_type: f_contract_type.value.trim() || null,
        validate_contract: f_validate_contract.value.trim() || null,
        inter_market: f_inter_market.value.trim() || null,
        language: f_language.value.trim() || null,
        note: f_note.value.trim() || null,

        duration_contract: f_duration_contract.value
          ? parseInt(f_duration_contract.value, 10) || 0
          : 0,

        completa_data_start: f_completa_data_start.value.trim() || null,
        completa_data_end:   f_completa_data_end.value.trim()   || null,
        completa_km_start:   f_completa_km_start.value
          ? parseInt(f_completa_km_start.value, 10) || 0
          : 0,
        completa_km_end:     f_completa_km_end.value
          ? parseInt(f_completa_km_end.value, 10) || 0
          : 0,

        catcinematica_data_start: f_catcinematica_data_start.value.trim() || null,
        catcinematica_data_end:   f_catcinematica_data_end.value.trim()   || null,
        catcinematica_km_start:   f_catcinematica_km_start.value
          ? parseInt(f_catcinematica_km_start.value, 10) || 0
          : 0,
        catcinematica_km_end:     f_catcinematica_km_end.value
          ? parseInt(f_catcinematica_km_end.value, 10) || 0
          : 0,

        contratto_data_start: f_contratto_data_start.value.trim() || null,
        contratto_data_end:   f_contratto_data_end.value.trim()   || null,

        altre_opzioni:      !!f_altre_opzioni.checked,
        batterie:           !!f_batterie.checked,
        fusibili_lampadine: !!f_fusibili_lampadine.checked,
        parti_usara:        !!f_parti_usara.checked,
        pulizia_fap:        !!f_pulizia_fap.checked,
        rabbocco_olio:      !!f_rabbocco_olio.checked,
        tergicristallo:     !!f_tergicristallo.checked,
        traino:             !!f_traino.checked,
        uptime_service:     !!f_uptime_service.checked,

        uptime_service_type: f_uptime_service_type.value.trim() || null
      };

      try {
        const user = auth.currentUser;
        const today = new Date().toISOString().slice(0,10);
        if (!lastDocData || !lastDocData.created) {
          payload.created = today;
        }
        if (!lastDocData || !lastDocData.created_by) {
          payload.created_by = user ? (user.email || user.uid) : "system";
        }
      } catch (e) {
        console.warn("Errore set created/created_by:", e);
      }

      drawerMessage.textContent = "Salvataggio in corso...";
      drawerMessage.className = "message";

      try {
        await db.collection("DBVIN").doc(vin).set(payload, { merge: true });
        lastDocData = Object.assign({}, lastDocData || {}, payload);
        currentVin  = vin;
        renderResults(vin, lastDocData);
        updateAdminButtons(true);
        drawerMessage.textContent = "Copertura salvata correttamente.";
        drawerMessage.className = "message success";
      } catch (err) {
        console.error("Errore salvataggio:", err);
        drawerMessage.textContent = "Errore durante il salvataggio.";
        drawerMessage.className = "message error";
      }
    }

    // --------- Eventi ---------
    searchBtn.addEventListener('click', searchVIN);
    vinInput.addEventListener('keyup', (e) => {
      if (e.key === "Enter") searchVIN();
    });

    if (btnNewCoverage) {
      btnNewCoverage.addEventListener('click', () => {
        if (!isAdmin) return;
        resetAdminForm();
        const typedVin = (vinInput.value || "").trim().toUpperCase();
        // Se vuoi precompilare il VIN con quello cercato, scommenta:
        // f_vin.value = typedVin;
        f_vin.readOnly = false;
        openDrawer("create", "Crea nuova copertura");
      });
    }

    if (btnEditCoverage) {
      btnEditCoverage.addEventListener('click', () => {
        if (!isAdmin) return;
        if (!currentVin || !lastDocData || Object.keys(lastDocData).length === 0) {
          drawerMessage.textContent = "Nessuna copertura caricata da modificare.";
          drawerMessage.className = "message error";
          openDrawer("edit", "Modifica copertura");
          return;
        }
        resetAdminForm();
        f_vin.readOnly = true;
        fillAdminForm(currentVin, lastDocData);
        openDrawer("edit", "Modifica copertura");
      });
    }

    drawerCloseBtn.addEventListener('click', () => {
      closeDrawer();
    });

    drawerCancelBtn.addEventListener('click', () => {
      closeDrawer();
    });

    drawerBackdrop.addEventListener('click', () => {
      closeDrawer();
    });

    saveCoverageBtn.addEventListener('click', saveCoverage);
  });
</script>
</body>
</html>
