<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>FTVIN - Verifica copertura contratti</title>
  <link rel="stylesheet" href="ftstyle.css?v=6">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Page-only CSS (solo per layout specifico FTVIN / drawer) -->
  <style>
    /* evita scroll strani con il drawer */
    body{ overscroll-behavior: none; }

    /* header pagina */
    .page-head{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 12px;
    }
    .page-eyebrow{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .page-title{
      margin: 0;
      font-size: 24px;
      letter-spacing: -0.2px;
    }
    .page-subtitle{
      margin: 0;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
    }

    /* search row */
    .search-row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    #vinInput{
      flex: 1;
      min-width: 260px;
      text-transform: uppercase;
    }

    /* risultati */
    .results{ display:none; margin-top: 14px; }
    .section-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 0 0 10px 0;
    }
    .status-flag{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      white-space: nowrap;
    }

    .info-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      font-size: 13px;
    }
    .info-item{
      background: var(--surface-3);
      border: 1px solid rgba(230,232,240,.95);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .label{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .note-box{
      background: var(--surface-3);
      border: 1px solid rgba(230,232,240,.95);
      border-radius: 14px;
      padding: 12px;
      min-height: 80px;
    }
    .note-value{ white-space: pre-wrap; }

    table.bool-table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(230,232,240,.95);
      border-radius: 14px;
      overflow: hidden;
    }
    table.bool-table td, table.bool-table th{
      border-top: 1px solid rgba(230,232,240,.95);
      padding: 8px 10px;
      vertical-align: top;
    }
    table.bool-table tr:first-child td{ border-top: none; }

    .message{
      font-size: 13px;
      margin-top: 8px;
    }
    .message.error{ color: var(--err-tx); }
    .message.success{ color: var(--ok-tx); }

    /* loader su bottone */
    .loader{
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.55);
      border-top-color: rgba(255,255,255,.98);
      animation: spin .7s linear infinite;
      margin-left: 8px;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ADMIN AREA */
    .admin-section{
      margin-top: 16px;
      display: none;
    }
    .admin-toolbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .admin-mode-label{
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
      font-style: italic;
    }

    /* DRAWER laterale */
    .drawer-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 998;
    }
    .drawer-backdrop.open{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0;
      right: -420px;
      width: 390px;
      max-width: 92%;
      height: 100vh;
      background: rgba(255,255,255,.98);
      backdrop-filter: blur(8px);
      box-shadow: -14px 0 34px rgba(15,23,42,.16);
      border-left: 1px solid rgba(230,232,240,.95);
      padding: 14px 14px 16px;
      transition: right 0.25s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .drawer.open{ right: 0; }

    .drawer-header{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(230,232,240,.95);
    }
    .drawer-title{
      font-size: 15px;
      font-weight: 900;
      letter-spacing: -0.1px;
    }
    .drawer-close-btn{
      border: 1px solid rgba(230,232,240,.95);
      background: rgba(255,255,255,.96);
      border-radius: 12px;
      width: 38px;
      height: 34px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
    }

    .drawer-body{
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 10px;
      font-size: 13px;
    }

    .drawer-body h3{
      margin: 14px 0 8px;
      font-size: 13px;
      font-weight: 900;
      color: var(--text);
    }

    .field-input, .field-textarea{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
      color: var(--text);
      outline: none;
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
      font-size: 13px;
    }
    .field-textarea{ min-height: 90px; resize: vertical; }

    .checkbox-row{
      display:flex;
      align-items:center;
      gap: 8px;
      margin: 6px 0;
    }
    .checkbox-row label{
      margin: 0;
      font-weight: 800;
      color: var(--text);
      font-size: 13px;
    }

    .drawer-footer{
      margin-top: 10px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(230,232,240,.95);
    }

    /* compat classi vecchie: le mappo ai bottoni del tema */
    .btn-secondary{
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 800;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
    }
    .btn-primary{
      background: linear-gradient(180deg, var(--primary2), var(--primary));
      color: #fff;
      border: none;
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.10);
    }

    @media (max-width: 600px){
      .btn-wide{ min-width: unset; width: 100%; }
    }
  </style>
</head>

<body class="ft-page has-topbar" id="page-ftvin">

  <!-- TOPBAR (stile HUB) -->
  <div class="ft-topbar">
    <div class="ft-topbar__inner">
      <div class="ft-topbar__left">
        <a href="FTHUBAS.html" class="ft-home-btn">‚Üê HOME</a>
        <div class="ft-topbar__subtitle">FTVIN ‚Ä¢ Verifica copertura VIN</div>
      </div>

      <div class="ft-topbar__center">
        <div class="ft-topbar__userinfo" id="topbarUserLine">Accesso in corso‚Ä¶</div>
      </div>

      <div class="ft-topbar__right">
        <!-- volutamente vuoto: niente logout qui per evitare rotture UX; l‚Äôaccesso resta gestito da Firebase -->
      </div>
    </div>
  </div>

  <div class="ft-container">
    <div class="card pad">

      <!-- HEADER PAGINA -->
      <div class="page-head">
        <div class="page-eyebrow">FTVIN - Verifica copertura contratti</div>
        <h1 class="page-title">Verifica copertura per telaio (VIN)</h1>
        <p class="page-subtitle">
          Inserisci un VIN e premi "Cerca" per visualizzare i dettagli di copertura memorizzati in Firestore
          (collezione <b>DBVIN</b>) o sul portale Ford.
        </p>
      </div>

      <hr class="sep">

      <!-- SEARCH -->
      <div class="section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Ricerca VIN</h2>
            <div class="section-sub">Il VIN deve contenere esattamente 17 caratteri.</div>
          </div>
        </div>

        <div class="search-row">
          <input id="vinInput" type="text" placeholder="Es. NM0KCTP60XSB93275" maxlength="30" />
          <button id="searchBtn" class="btn btn-primary btn-wide" type="button">Cerca</button>
        </div>

        <div id="searchMessage" class="message"></div>
      </div>

      <!-- RISULTATI -->
      <div id="results" class="results">

        <div class="section">
          <div class="section-title-row">
            <h2 class="section-title" style="margin:0;">Dati Veicolo</h2>
          </div>
          <div id="vehicleInfo" class="info-grid"></div>
        </div>

        <!-- Note (solo distributore) -->
        <div id="noteSection" class="section" style="margin-top:12px;">
          <div class="section-title-row">
            <h2 class="section-title" style="margin:0;">Note</h2>
          </div>
          <div class="note-box">
            <div id="noteValue" class="note-value"></div>
          </div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-title-row">
            <h2 class="section-title" style="margin:0;">Full Line</h2>
            <span id="flagFullLine" class="status-flag"></span>
          </div>
          <div id="fullLineInfo" class="info-grid"></div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-title-row">
            <h2 class="section-title" style="margin:0;">Drive Line</h2>
            <span id="flagDriveLine" class="status-flag"></span>
          </div>
          <div id="driveLineInfo" class="info-grid"></div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-title-row">
            <h2 class="section-title" style="margin:0;">Contratto di Manutenzione</h2>
            <span id="flagMaint" class="status-flag"></span>
          </div>
          <div id="contractMaintInfo" class="info-grid"></div>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="section-title-row">
            <h2 class="section-title" style="margin:0;">Opzioni aggiuntive / Servizi</h2>
            <span id="flagOptions" class="status-flag"></span>
          </div>
          <table class="bool-table">
            <tbody id="boolTable"></tbody>
          </table>
        </div>

      </div>

      <!-- AREA ADMIN (toolbar) -->
      <div id="adminEditSection" class="admin-section">
        <hr class="sep">
        <div class="section">
          <div class="section-head">
            <div>
              <h2 class="section-title">Area amministratore (coperture VIN)</h2>
              <div class="section-sub">Creazione e modifica coperture in DBVIN (solo Admin).</div>
            </div>
          </div>

          <div class="admin-toolbar">
            <button id="btnNewCoverage" class="btn btn-primary" type="button">Crea nuova copertura</button>
            <button id="btnEditCoverage" class="btn" type="button" disabled>Modifica copertura caricata</button>
            <span id="adminModeLabel" class="admin-mode-label"></span>
          </div>
        </div>
      </div>

      <!-- user info compat -->
      <div style="display:none;">
        <span id="userInfo">Utente: -</span>
      </div>

    </div>
  </div>

  <!-- BACKDROP E DRAWER LATERALE -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>

  <div id="adminDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div id="drawerTitle" class="drawer-title">Copertura VIN</div>
      <button id="drawerCloseBtn" class="drawer-close-btn" type="button" aria-label="Chiudi">&times;</button>
    </div>

    <div class="drawer-body">
      <form id="coverageForm" onsubmit="return false;">
        <h3>Dati veicolo</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">VIN</span>
            <input id="f_vin" class="field-input" />
          </div>
          <div class="info-item">
            <span class="label">Cliente</span>
            <input id="f_customer" class="field-input" />
          </div>
          <div class="info-item">
            <span class="label">Tipo contratto</span>
            <input id="f_contract_type" class="field-input" />
          </div>
          <div class="info-item">
            <span class="label">Validazione contratto</span>
            <input id="f_validate_contract" class="field-input" />
          </div>
          <div class="info-item">
            <span class="label">Durata contratto</span>
            <input id="f_duration_contract" class="field-input" type="number" />
          </div>
          <div class="info-item">
            <span class="label">Inter-market</span>
            <input id="f_inter_market" class="field-input" />
          </div>
          <div class="info-item">
            <span class="label">Lingua</span>
            <input id="f_language" class="field-input" />
          </div>
        </div>

        <h3>Note</h3>
        <textarea id="f_note" class="field-textarea"></textarea>

        <h3>Full Line</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Completa - Data inizio</span>
            <input id="f_completa_data_start" class="field-input" placeholder="YYYY-MM-DD" />
          </div>
          <div class="info-item">
            <span class="label">Completa - Data fine</span>
            <input id="f_completa_data_end" class="field-input" placeholder="YYYY-MM-DD" />
          </div>
          <div class="info-item">
            <span class="label">Completa - KM inizio</span>
            <input id="f_completa_km_start" class="field-input" type="number" />
          </div>
          <div class="info-item">
            <span class="label">Completa - KM fine</span>
            <input id="f_completa_km_end" class="field-input" type="number" />
          </div>
        </div>

        <h3>Drive Line</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Cat. cinematica - Data inizio</span>
            <input id="f_catcinematica_data_start" class="field-input" placeholder="YYYY-MM-DD" />
          </div>
          <div class="info-item">
            <span class="label">Cat. cinematica - Data fine</span>
            <input id="f_catcinematica_data_end" class="field-input" placeholder="YYYY-MM-DD" />
          </div>
          <div class="info-item">
            <span class="label">Cat. cinematica - KM inizio</span>
            <input id="f_catcinematica_km_start" class="field-input" type="number" />
          </div>
          <div class="info-item">
            <span class="label">Cat. cinematica - KM fine</span>
            <input id="f_catcinematica_km_end" class="field-input" type="number" />
          </div>
        </div>

        <h3>Contratto di Manutenzione</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Contratto data start</span>
            <input id="f_contratto_data_start" class="field-input" placeholder="YYYY-MM-DD" />
          </div>
          <div class="info-item">
            <span class="label">Contratto data end</span>
            <input id="f_contratto_data_end" class="field-input" placeholder="YYYY-MM-DD" />
          </div>
        </div>

        <h3>Opzioni aggiuntive / servizi</h3>
        <div class="info-item">
          <div class="checkbox-row">
            <input id="f_altre_opzioni" type="checkbox" />
            <label for="f_altre_opzioni">Altre opzioni</label>
          </div>
          <div class="checkbox-row">
            <input id="f_batterie" type="checkbox" />
            <label for="f_batterie">Batterie</label>
          </div>
          <div class="checkbox-row">
            <input id="f_fusibili_lampadine" type="checkbox" />
            <label for="f_fusibili_lampadine">Fusibili / lampadine</label>
          </div>
          <div class="checkbox-row">
            <input id="f_parti_usara" type="checkbox" />
            <label for="f_parti_usara">Parti d‚Äôusura</label>
          </div>
          <div class="checkbox-row">
            <input id="f_pulizia_fap" type="checkbox" />
            <label for="f_pulizia_fap">Pulizia FAP</label>
          </div>
          <div class="checkbox-row">
            <input id="f_rabbocco_olio" type="checkbox" />
            <label for="f_rabbocco_olio">Rabbocco olio</label>
          </div>
          <div class="checkbox-row">
            <input id="f_tergicristallo" type="checkbox" />
            <label for="f_tergicristallo">Tergicristallo</label>
          </div>
          <div class="checkbox-row">
            <input id="f_traino" type="checkbox" />
            <label for="f_traino">Traino</label>
          </div>
          <div class="checkbox-row">
            <input id="f_uptime_service" type="checkbox" />
            <label for="f_uptime_service">Uptime service</label>
          </div>

          <div style="margin-top:10px;">
            <span class="label">Uptime service type</span>
            <input id="f_uptime_service_type" class="field-input" placeholder="Es. GOLD, BASIC..." />
          </div>
        </div>
      </form>
    </div>

    <div class="drawer-footer">
      <button id="drawerCancelBtn" type="button" class="btn-secondary">Annulla</button>
      <button id="saveCoverageBtn" type="button" class="btn-primary">Salva</button>
    </div>

    <div id="drawerMessage" class="message" style="margin-top:8px;"></div>
  </div>

<script>
  function goHome() {
    window.location.href = "FTHUBAS.html";
  }

  document.addEventListener('DOMContentLoaded', function () {
    const userInfoEl      = document.getElementById('userInfo');
    const vinInput        = document.getElementById('vinInput');
    const searchBtn       = document.getElementById('searchBtn');
    const searchMessageEl = document.getElementById('searchMessage');
    const topbarUserLine  = document.getElementById('topbarUserLine');

    const resultsEl       = document.getElementById('results');
    const vehicleInfoEl   = document.getElementById('vehicleInfo');
    const noteValueEl     = document.getElementById('noteValue');
    const noteSection     = document.getElementById('noteSection');
    const fullLineInfoEl  = document.getElementById('fullLineInfo');
    const driveLineInfoEl = document.getElementById('driveLineInfo');
    const contractInfoEl  = document.getElementById('contractMaintInfo');
    const boolTableEl     = document.getElementById('boolTable');

    const flagFullLine  = document.getElementById('flagFullLine');
    const flagDriveLine = document.getElementById('flagDriveLine');
    const flagMaint     = document.getElementById('flagMaint');
    const flagOptions   = document.getElementById('flagOptions');

    // Admin toolbar
    const adminSection     = document.getElementById('adminEditSection');
    const btnNewCoverage   = document.getElementById('btnNewCoverage');
    const btnEditCoverage  = document.getElementById('btnEditCoverage');
    const adminModeLabel   = document.getElementById('adminModeLabel');

    // Drawer
    const drawer           = document.getElementById('adminDrawer');
    const drawerBackdrop   = document.getElementById('drawerBackdrop');
    const drawerTitle      = document.getElementById('drawerTitle');
    const drawerMessage    = document.getElementById('drawerMessage');
    const drawerCloseBtn   = document.getElementById('drawerCloseBtn');
    const drawerCancelBtn  = document.getElementById('drawerCancelBtn');
    const saveCoverageBtn  = document.getElementById('saveCoverageBtn');

    // Form fields
    const f_vin  = document.getElementById('f_vin');
    const f_customer            = document.getElementById('f_customer');
    const f_contract_type       = document.getElementById('f_contract_type');
    const f_validate_contract   = document.getElementById('f_validate_contract');
    const f_duration_contract   = document.getElementById('f_duration_contract');
    const f_inter_market        = document.getElementById('f_inter_market');
    const f_language            = document.getElementById('f_language');
    const f_note                = document.getElementById('f_note');
    const f_completa_data_start = document.getElementById('f_completa_data_start');
    const f_completa_data_end   = document.getElementById('f_completa_data_end');
    const f_completa_km_start   = document.getElementById('f_completa_km_start');
    const f_completa_km_end     = document.getElementById('f_completa_km_end');
    const f_catcinematica_data_start = document.getElementById('f_catcinematica_data_start');
    const f_catcinematica_data_end   = document.getElementById('f_catcinematica_data_end');
    const f_catcinematica_km_start   = document.getElementById('f_catcinematica_km_start');
    const f_catcinematica_km_end     = document.getElementById('f_catcinematica_km_end');
    const f_contratto_data_start     = document.getElementById('f_contratto_data_start');
    const f_contratto_data_end       = document.getElementById('f_contratto_data_end');

    const f_altre_opzioni       = document.getElementById('f_altre_opzioni');
    const f_batterie            = document.getElementById('f_batterie');
    const f_fusibili_lampadine  = document.getElementById('f_fusibili_lampadine');
    const f_parti_usara         = document.getElementById('f_parti_usara');
    const f_pulizia_fap         = document.getElementById('f_pulizia_fap');
    const f_rabbocco_olio       = document.getElementById('f_rabbocco_olio');
    const f_tergicristallo      = document.getElementById('f_tergicristallo');
    const f_traino              = document.getElementById('f_traino');
    const f_uptime_service      = document.getElementById('f_uptime_service');
    const f_uptime_service_type = document.getElementById('f_uptime_service_type');

    let isAdmin        = false;
    let isDistributor  = false;
    let currentVin     = null;
    let lastDocData    = null;
    let adminMode      = null;      // "create" | "edit" | null
    let coverageSource = null;      // "dbvin" | "backend" | "none"
    let coverageView   = null;      // oggetto normalizzato per la UI

    // --------- Utility ---------
    function escapeHtml(text) {
      if (text === null || text === undefined) return "";
      return String(text)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function fmtText(v) {
      if (v === null || v === undefined || v === "") return "-";
      return escapeHtml(v);
    }

    function fmtNum(v) {
      if (v === null || v === undefined) return "-";
      return v;
    }

    function fmtDate(v) {
      if (!v) return "-";
      return escapeHtml(v);
    }

    function fmtBool(v) {
      v = !!v;
      return v ? "üü¢ SI" : "üî¥ NO";
    }

    function isActiveDate(start, end) {
      if (!start || !end) return false;
      const today = new Date().toISOString().slice(0,10);
      return start <= today && today <= end;
    }

    function badge(active) {
      return active ? "üü¢ ATTIVA" : "üî¥ NON ATTIVA";
    }

    function showMessage(text, type) {
      searchMessageEl.textContent = text || "";
      searchMessageEl.className = "message" + (type ? " " + type : "");
    }

    function setLoading(isLoading) {
      if (isLoading) {
        searchBtn.disabled = true;
        searchBtn.innerHTML = 'Caricamento<span class="loader"></span>';
      } else {
        searchBtn.disabled = false;
        searchBtn.textContent = "Cerca";
      }
    }

    function normalizeBool(v) {
      if (v === null || v === undefined) return false;
      if (typeof v === "boolean") return v;
      const s = String(v).toLowerCase();
      return s === "1" || s === "true" || s === "si" || s === "yes";
    }

    function cutDate(v) {
      if (!v) return null;
      return String(v).slice(0, 10); // "YYYY-MM-DD"
    }

    function buildCoverageFromDbVin(vin, data) {
      data = data || {};
      return {
        vin,
        customer:          data.customer || null,
        contract_type:     data.contract_type || null,
        validate_contract: data.validate_contract || null,
        duration_contract: data.duration_contract != null ? data.duration_contract : 0,
        inter_market:      data.inter_market || null,
        language:          data.language || null,
        note:              data.note || null,

        fullLine: {
          start_date: data.completa_data_start || null,
          end_date:   data.completa_data_end   || null,
          km_start:   data.completa_km_start != null ? data.completa_km_start : 0,
          km_end:     data.completa_km_end   != null ? data.completa_km_end   : 0,
        },

        driveLine: {
          start_date: data.catcinematica_data_start || null,
          end_date:   data.catcinematica_data_end   || null,
          km_start:   data.catcinematica_km_start != null ? data.catcinematica_km_start : 0,
          km_end:     data.catcinematica_km_end   != null ? data.catcinematica_km_end   : 0,
        },

        maintenance: {
          start_date: data.contratto_data_start || null,
          end_date:   data.contratto_data_end   || null,
        },

        options: {
          altre_opzioni:      normalizeBool(data.altre_opzioni),
          batterie:           normalizeBool(data.batterie),
          fusibili_lampadine: normalizeBool(data.fusibili_lampadine),
          parti_usura:        normalizeBool(data.parti_usara),
          pulizia_fap:        normalizeBool(data.pulizia_fap),
          rabbocco_olio:      normalizeBool(data.rabbocco_olio),
          tergicristallo:     normalizeBool(data.tergicristallo),
          traino:             normalizeBool(data.traino),
          uptime_service:     normalizeBool(data.uptime_service),
          uptime_service_type: data.uptime_service_type || null,
        }
      };
    }

    function buildCoverageFromBackend(vin, backendData) {
      const cli = backendData.cliente_veicolo || {};
      const c   = backendData.copertura || {};

      const hasTow = !!(c.FREETOWING_START_DATE || c.FREETOWING_END_DATE);
      const uptimeName = (c.UPTIME_NAME && c.UPTIME_NAME !== "0") ? c.UPTIME_NAME : null;

      return {
        vin:                c.VIN || vin,
        customer:           cli.rag_sociale || null,
        contract_type:      c.WARRANTY_TYPE || null,
        validate_contract:  c.WARRANTY_TYPE || null,
        duration_contract:  0,
        inter_market:       null,
        language:           null,
        note:               null,

        fullLine: {
          start_date: cutDate(c.WARRANTY_START_DATE),
          end_date:   cutDate(c.WARRANTY_END_DATE),
          km_start:   0,
          km_end:     0,
        },

        driveLine: {
          start_date: null,
          end_date:   null,
          km_start:   0,
          km_end:     0,
        },

        maintenance: {
          start_date: cutDate(c.SC_DT_START_DATE),
          end_date:   cutDate(c.SC_DT_END_DATE),
        },

        options: {
          altre_opzioni:      normalizeBool(c.HAS_VEHICLE_SC),
          batterie:           normalizeBool(c.HAS_BATTERY),
          fusibili_lampadine: normalizeBool(c.HAS_FUSESBULBS),
          parti_usura:        normalizeBool(c.HAS_WEARTEAR),
          pulizia_fap:        normalizeBool(c.HAS_DPFFILTER),
          rabbocco_olio:      normalizeBool(c.HAS_OILTOP),
          tergicristallo:     false,
          traino:             hasTow,
          uptime_service:     normalizeBool(c.HAS_UPTIME),
          uptime_service_type: uptimeName,
        }
      };
    }

    function openDrawer(mode, titleText) {
      adminMode = mode; // "create" | "edit"
      drawerTitle.textContent = titleText || "Copertura VIN";
      drawerMessage.textContent = "";

      drawer.classList.add("open");
      drawerBackdrop.classList.add("open");
      drawer.setAttribute("aria-hidden", "false");

      if (mode === "create") {
        adminModeLabel.textContent = "Modalit√†: creazione nuova copertura";
      } else if (mode === "edit") {
        adminModeLabel.textContent = "Modalit√†: modifica copertura VIN " + (currentVin || "");
      }
    }

    function closeDrawer() {
      adminMode = null;
      drawer.classList.remove("open");
      drawerBackdrop.classList.remove("open");
      drawer.setAttribute("aria-hidden", "true");
      adminModeLabel.textContent = "";
    }

    function resetAdminForm() {
      f_vin.value = "";
      f_customer.value = "";
      f_contract_type.value = "";
      f_validate_contract.value = "";
      f_duration_contract.value = "";
      f_inter_market.value = "";
      f_language.value = "";
      f_note.value = "";

      f_completa_data_start.value = "";
      f_completa_data_end.value = "";
      f_completa_km_start.value = "";
      f_completa_km_end.value = "";

      f_catcinematica_data_start.value = "";
      f_catcinematica_data_end.value = "";
      f_catcinematica_km_start.value = "";
      f_catcinematica_km_end.value = "";

      f_contratto_data_start.value = "";
      f_contratto_data_end.value = "";

      f_altre_opzioni.checked = false;
      f_batterie.checked = false;
      f_fusibili_lampadine.checked = false;
      f_parti_usara.checked = false;
      f_pulizia_fap.checked = false;
      f_rabbocco_olio.checked = false;
      f_tergicristallo.checked = false;
      f_traino.checked = false;
      f_uptime_service.checked = false;
      f_uptime_service_type.value = "";

      drawerMessage.textContent = "";
      drawerMessage.className = "message";
    }

    function fillAdminForm(vin, data) {
      data = data || {};
      f_vin.value                 = vin || "";
      f_customer.value            = data.customer || "";
      f_contract_type.value       = data.contract_type || "";
      f_validate_contract.value   = data.validate_contract || "";
      f_duration_contract.value   = data.duration_contract != null ? data.duration_contract : "";
      f_inter_market.value        = data.inter_market || "";
      f_language.value            = data.language || "";
      f_note.value                = data.note || "";

      f_completa_data_start.value = data.completa_data_start || "";
      f_completa_data_end.value   = data.completa_data_end || "";
      f_completa_km_start.value   = data.completa_km_start != null ? data.completa_km_start : "";
      f_completa_km_end.value     = data.completa_km_end != null ? data.completa_km_end : "";

      f_catcinematica_data_start.value = data.catcinematica_data_start || "";
      f_catcinematica_data_end.value   = data.catcinematica_data_end || "";
      f_catcinematica_km_start.value   = data.catcinematica_km_start != null ? data.catcinematica_km_start : "";
      f_catcinematica_km_end.value     = data.catcinematica_km_end != null ? data.catcinematica_km_end : "";

      f_contratto_data_start.value     = data.contratto_data_start || "";
      f_contratto_data_end.value       = data.contratto_data_end || "";

      f_altre_opzioni.checked      = !!data.altre_opzioni;
      f_batterie.checked           = !!data.batterie;
      f_fusibili_lampadine.checked = !!data.fusibili_lampadine;
      f_parti_usara.checked        = !!data.parti_usara;
      f_pulizia_fap.checked        = !!data.pulizia_fap;
      f_rabbocco_olio.checked      = !!data.rabbocco_olio;
      f_tergicristallo.checked     = !!data.tergicristallo;
      f_traino.checked             = !!data.traino;
      f_uptime_service.checked     = !!data.uptime_service;
      f_uptime_service_type.value  = data.uptime_service_type || "";

      drawerMessage.textContent = "";
      drawerMessage.className = "message";
    }

    function updateAdminButtons(hasExistingDoc) {
      if (!isAdmin) {
        adminSection.style.display = "none";
        return;
      }

      adminSection.style.display = "block";

      if (coverageSource === "dbvin") {
        btnNewCoverage.disabled  = false;
        btnEditCoverage.disabled = !hasExistingDoc;
      } else if (coverageSource === "backend") {
        btnNewCoverage.disabled  = true;
        btnEditCoverage.disabled = true;
      } else if (coverageSource === "none") {
        btnNewCoverage.disabled  = false;
        btnEditCoverage.disabled = true;
      } else {
        btnNewCoverage.disabled  = true;
        btnEditCoverage.disabled = true;
      }
    }

    function renderCoverage() {
      if (!coverageView) {
        resultsEl.style.display = "none";
        return;
      }

      const cv = coverageView;

      vehicleInfoEl.innerHTML = `
        <div class="info-item"><span class="label">VIN</span>${fmtText(cv.vin)}</div>
        <div class="info-item"><span class="label">Cliente</span>${fmtText(cv.customer)}</div>
        <div class="info-item"><span class="label">Tipo Contratto</span>${fmtText(cv.contract_type)}</div>
        <div class="info-item"><span class="label">Validazione Contratto</span>${fmtText(cv.validate_contract)}</div>
        <div class="info-item"><span class="label">Durata Contratto</span>${fmtNum(cv.duration_contract)}</div>
        <div class="info-item"><span class="label">Inter-market</span>${fmtText(cv.inter_market)}</div>
        <div class="info-item"><span class="label">Lingua</span>${fmtText(cv.language)}</div>
      `;

      if (noteSection) {
        if (isDistributor) {
          noteSection.style.display = "block";
          noteValueEl.innerHTML = fmtText(cv.note);
        } else {
          noteSection.style.display = "none";
        }
      }

      fullLineInfoEl.innerHTML = `
        <div class="info-item"><span class="label">Data inizio</span>${fmtDate(cv.fullLine.start_date)}</div>
        <div class="info-item"><span class="label">Data fine</span>${fmtDate(cv.fullLine.end_date)}</div>
        <div class="info-item"><span class="label">KM inizio</span>${fmtNum(cv.fullLine.km_start)}</div>
        <div class="info-item"><span class="label">KM fine</span>${fmtNum(cv.fullLine.km_end)}</div>
      `;
      flagFullLine.textContent = badge(isActiveDate(cv.fullLine.start_date, cv.fullLine.end_date));

      driveLineInfoEl.innerHTML = `
        <div class="info-item"><span class="label">Data inizio</span>${fmtDate(cv.driveLine.start_date)}</div>
        <div class="info-item"><span class="label">Data fine</span>${fmtDate(cv.driveLine.end_date)}</div>
        <div class="info-item"><span class="label">KM inizio</span>${fmtNum(cv.driveLine.km_start)}</div>
        <div class="info-item"><span class="label">KM fine</span>${fmtNum(cv.driveLine.km_end)}</div>
      `;
      flagDriveLine.textContent = badge(isActiveDate(cv.driveLine.start_date, cv.driveLine.end_date));

      contractInfoEl.innerHTML = `
        <div class="info-item"><span class="label">Data inizio</span>${fmtDate(cv.maintenance.start_date)}</div>
        <div class="info-item"><span class="label">Data fine</span>${fmtDate(cv.maintenance.end_date)}</div>
      `;
      flagMaint.textContent = badge(isActiveDate(cv.maintenance.start_date, cv.maintenance.end_date));

      const o = cv.options;
      const options = [
        ["Altre opzioni", o.altre_opzioni],
        ["Batterie", o.batterie],
        ["Fusibili / lampadine", o.fusibili_lampadine],
        ["Parti d‚Äôusura", o.parti_usura],
        ["Pulizia FAP", o.pulizia_fap],
        ["Rabbocco olio", o.rabbocco_olio],
        ["Tergicristallo", o.tergicristallo],
        ["Traino", o.traino],
        ["Uptime service", o.uptime_service],
        ["Uptime service type", fmtText(o.uptime_service_type)],
      ];

      boolTableEl.innerHTML = options.map(([label, val]) => {
        const valueHtml = typeof val === "boolean" ? fmtBool(val) : val;
        return `<tr><td>${escapeHtml(label)}</td><td>${valueHtml}</td></tr>`;
      }).join("");

      const hasOptionActive = [
        o.altre_opzioni, o.batterie, o.fusibili_lampadine,
        o.parti_usura, o.pulizia_fap, o.rabbocco_olio,
        o.tergicristallo, o.traino, o.uptime_service
      ].some(v => !!v);

      flagOptions.textContent = badge(hasOptionActive);

      resultsEl.style.display = "block";
    }

    async function fetchBackendCoverage(vin) {
      const resp = await fetch("https://verifica-garanzia-backend.onrender.com/verifica", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telaio: vin }),
      });
      if (!resp.ok) throw new Error("Errore HTTP backend: " + resp.status);
      return await resp.json();
    }

    // --------- Auth ---------
    try {
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          userInfoEl.textContent = "Utente: non loggato";
          if (topbarUserLine) topbarUserLine.textContent = "Non autenticato";
          isAdmin = false;
          isDistributor = false;
          adminSection.style.display = "none";
          closeDrawer();
          return;
        }

        const userLabel = (user.email || user.uid);
        userInfoEl.textContent = "Utente: " + userLabel;
        if (topbarUserLine) topbarUserLine.textContent = userLabel;

        try {
          const userSnap = await db.collection('Users').doc(user.uid).get();
          const data = userSnap.exists ? userSnap.data() : {};
          isAdmin = data.role === "Admin";

          const dealerId = data.DealerID || data.dealerId || null;
          isDistributor = dealerId === "FT001";

          if (topbarUserLine) {
            const roleTxt = isAdmin ? "Admin" : (data.role || "User");
            const dealerTxt = dealerId || "-";
            topbarUserLine.textContent = `${dealerTxt} ‚Ä¢ ${roleTxt} ‚Ä¢ ${userLabel}`;
          }

        } catch (e) {
          console.error("Errore lettura ruolo utente:", e);
          isAdmin = false;
          isDistributor = false;
        }

        updateAdminButtons(false);
        closeDrawer();
      });
    } catch (e) {
      console.error("Errore auth:", e);
    }

    // --------- Ricerca VIN ---------
    async function searchVIN() {
      const vin = (vinInput.value || "").trim().toUpperCase();
      if (!vin) {
        showMessage("Inserisci un VIN prima di cercare.", "error");
        return;
      }

      if (vin.length !== 17) {
        showMessage("Il VIN deve contenere esattamente 17 caratteri.", "error");
        return;
      }

      showMessage("", "");
      resultsEl.style.display = "none";
      lastDocData    = null;
      currentVin     = null;
      coverageView   = null;
      coverageSource = null;
      closeDrawer();
      updateAdminButtons(false);

      setLoading(true);
      try {
        // 1) Firestore
        const ref  = db.collection("DBVIN").doc(vin);
        const snap = await ref.get();

        if (snap.exists) {
          const data = snap.data() || {};
          lastDocData    = data;
          currentVin     = vin;
          coverageSource = "dbvin";
          coverageView   = buildCoverageFromDbVin(vin, data);
          renderCoverage();
          showMessage("Copertura caricata dal database locale (DBVIN).", "success");
          updateAdminButtons(true);
          return;
        }

        // 2) Backend se non esiste in DBVIN
        try {
          const backendData = await fetchBackendCoverage(vin);

          if (backendData.success && backendData.copertura && backendData.copertura.HAS_WARRANTY) {
            currentVin     = vin;
            lastDocData    = null;
            coverageSource = "backend";
            coverageView   = buildCoverageFromBackend(vin, backendData);
            renderCoverage();
            showMessage("Copertura trovata sul portale Ford (backend).", "success");
            updateAdminButtons(false); // solo lettura
          } else {
            coverageSource = "none";
            coverageView   = null;
            resultsEl.style.display = "none";
            showMessage("Telaio inesistente nelle banche dati.", "error");
            updateAdminButtons(false);
            if (isAdmin) {
              adminModeLabel.textContent = "Nessuna copertura trovata: puoi creare una nuova copertura.";
            }
          }
        } catch (err2) {
          console.error("Errore backend:", err2);
          coverageSource = "none";
          coverageView   = null;
          resultsEl.style.display = "none";
          showMessage("Errore nel backend di verifica garanzia.", "error");
          updateAdminButtons(false);
          if (isAdmin) {
            adminModeLabel.textContent = "Errore backend: puoi comunque creare una nuova copertura.";
          }
        }

      } catch (err) {
        console.error("Errore Firestore:", err);
        showMessage("Errore durante la lettura dei dati.", "error");
        coverageSource = "none";
        coverageView   = null;
        resultsEl.style.display = "none";
        updateAdminButtons(false);
      } finally {
        setLoading(false);
      }
    }

    // --------- Salvataggio copertura (Admin) ---------
    async function saveCoverage() {
      if (!isAdmin) {
        drawerMessage.textContent = "Non hai i permessi per salvare.";
        drawerMessage.className = "message error";
        return;
      }

      let vin;
      if (adminMode === "create") {
        vin = (f_vin.value || "").trim().toUpperCase();
        if (!vin) {
          drawerMessage.textContent = "Inserisci un VIN per creare la copertura.";
          drawerMessage.className = "message error";
          return;
        }
        if (vin.length !== 17) {
          drawerMessage.textContent = "Il VIN deve contenere esattamente 17 caratteri.";
          drawerMessage.className = "message error";
          return;
        }
      } else if (adminMode === "edit") {
        vin = currentVin;
        if (!vin) {
          drawerMessage.textContent = "Nessun VIN caricato da modificare.";
          drawerMessage.className = "message error";
          return;
        }
      } else {
        drawerMessage.textContent = "Seleziona prima se creare o modificare.";
        drawerMessage.className = "message error";
        return;
      }

      const payload = {
        vin: vin,
        customer: f_customer.value.trim() || null,
        contract_type: f_contract_type.value.trim() || null,
        validate_contract: f_validate_contract.value.trim() || null,
        inter_market: f_inter_market.value.trim() || null,
        language: f_language.value.trim() || null,
        note: f_note.value.trim() || null,

        duration_contract: f_duration_contract.value
          ? parseInt(f_duration_contract.value, 10) || 0
          : 0,

        completa_data_start: f_completa_data_start.value.trim() || null,
        completa_data_end:   f_completa_data_end.value.trim()   || null,
        completa_km_start:   f_completa_km_start.value
          ? parseInt(f_completa_km_start.value, 10) || 0
          : 0,
        completa_km_end:     f_completa_km_end.value
          ? parseInt(f_completa_km_end.value, 10) || 0
          : 0,

        catcinematica_data_start: f_catcinematica_data_start.value.trim() || null,
        catcinematica_data_end:   f_catcinematica_data_end.value.trim()   || null,
        catcinematica_km_start:   f_catcinematica_km_start.value
          ? parseInt(f_catcinematica_km_start.value, 10) || 0
          : 0,
        catcinematica_km_end:     f_catcinematica_km_end.value
          ? parseInt(f_catcinematica_km_end.value, 10) || 0
          : 0,

        contratto_data_start: f_contratto_data_start.value.trim() || null,
        contratto_data_end:   f_contratto_data_end.value.trim()   || null,

        altre_opzioni:      !!f_altre_opzioni.checked,
        batterie:           !!f_batterie.checked,
        fusibili_lampadine: !!f_fusibili_lampadine.checked,
        parti_usara:        !!f_parti_usara.checked,
        pulizia_fap:        !!f_pulizia_fap.checked,
        rabbocco_olio:      !!f_rabbocco_olio.checked,
        tergicristallo:     !!f_tergicristallo.checked,
        traino:             !!f_traino.checked,
        uptime_service:     !!f_uptime_service.checked,

        uptime_service_type: f_uptime_service_type.value.trim() || null
      };

      try {
        const user = auth.currentUser;
        const today = new Date().toISOString().slice(0,10);
        if (!lastDocData || !lastDocData.created) payload.created = today;
        if (!lastDocData || !lastDocData.created_by) {
          payload.created_by = user ? (user.email || user.uid) : "system";
        }
      } catch (e) {
        console.warn("Errore set created/created_by:", e);
      }

      drawerMessage.textContent = "Salvataggio in corso...";
      drawerMessage.className = "message";

      try {
        await db.collection("DBVIN").doc(vin).set(payload, { merge: true });
        lastDocData = Object.assign({}, lastDocData || {}, payload);
        currentVin  = vin;
        coverageSource = "dbvin";
        coverageView   = buildCoverageFromDbVin(vin, lastDocData);

        renderCoverage();
        updateAdminButtons(true);
        drawerMessage.textContent = "Copertura salvata correttamente.";
        drawerMessage.className = "message success";
      } catch (err) {
        console.error("Errore salvataggio:", err);
        drawerMessage.textContent = "Errore durante il salvataggio.";
        drawerMessage.className = "message error";
      }
    }

    // --------- Eventi ---------
    searchBtn.addEventListener('click', searchVIN);
    vinInput.addEventListener('keyup', (e) => {
      if (e.key === "Enter") searchVIN();
    });

    if (btnNewCoverage) {
      btnNewCoverage.addEventListener('click', () => {
        if (!isAdmin) return;
        resetAdminForm();
        const typedVin = (vinInput.value || "").trim().toUpperCase();
        f_vin.value = typedVin;
        f_vin.readOnly = false;
        openDrawer("create", "Crea nuova copertura");
      });
    }

    if (btnEditCoverage) {
      btnEditCoverage.addEventListener('click', () => {
        if (!isAdmin) return;
        if (!currentVin || !lastDocData || Object.keys(lastDocData).length === 0) {
          drawerMessage.textContent = "Nessuna copertura caricata da modificare.";
          drawerMessage.className = "message error";
          openDrawer("edit", "Modifica copertura");
          return;
        }
        resetAdminForm();
        f_vin.readOnly = true;
        fillAdminForm(currentVin, lastDocData);
        openDrawer("edit", "Modifica copertura");
      });
    }

    drawerCloseBtn.addEventListener('click', closeDrawer);
    drawerCancelBtn.addEventListener('click', closeDrawer);
    drawerBackdrop.addEventListener('click', closeDrawer);
    saveCoverageBtn.addEventListener('click', saveCoverage);

    // ESC per chiudere drawer (solo UX, funzionalit√† invariata)
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && drawer.classList.contains("open")) closeDrawer();
    });
  });
</script>

</body>
</html>
