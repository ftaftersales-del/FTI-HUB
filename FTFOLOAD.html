<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FTFOLOAD</title>

  <link rel="stylesheet" href="ftstyle.css?v=6"/>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- XLSX export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* ===============================
       FTFOLOAD - Page glue (v3)
       - topbar HUB + card/pad/btn
       - sidebar sinistra con pad funzioni
       - sinistro è nel CLAIM: ClaimCards/<W>/Claims/<R>/sinistro
       =============================== */

    .fo-wrap{
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px;
      min-height: calc(100vh - 58px);
    }

    .fo-layout{
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 1050px){
      .fo-layout{ grid-template-columns: 1fr; }
    }

    .fo-left{
      display: grid;
      gap: 12px;
      position: sticky;
      top: 74px;
      align-self: start;
      z-index: 2;
    }
    @media (max-width: 1050px){
      .fo-left{ position: relative; top: auto; }
    }

    .fo-h1{ margin:0; font-size:18px; line-height:1.15; }
    .fo-sub{ margin:6px 0 0; font-size:13px; color:var(--muted); }

    .fo-guard{
      display:none;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffd0d0;
      background: #fff1f1;
      color: #8a1f1f;
      font-size: 13px;
    }

    .fo-pad-title{ margin:0 0 8px; font-size:14px; font-weight:800; }
    .fo-pad-sub{ margin:0 0 10px; font-size:12px; color:var(--muted); }

    .fo-grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .fo-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .fo-chiprow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      font-size:12px; color:var(--text);
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
      user-select:none; white-space:nowrap;
    }
    .chip .n{ font-weight:900; }

    .fo-kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }
    .fo-kv b{ color:var(--text); }

    .fo-progress{
      display:none;
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }

    .fo-note{ margin-top:10px; font-size:12px; color:var(--muted); }
    .fo-small{ font-size:12px; color:var(--muted); }

    .fo-check{
      display:flex; gap:8px; align-items:center;
      font-size:12px; color:var(--text);
      user-select:none; margin-top:8px;
    }
    .fo-check input{ transform: translateY(1px); }

    .fo-search{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap; margin-top:10px;
    }
    .fo-search input{
      flex:1;
      min-width:280px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      padding:0 12px;
      outline:none;
      background:#fff;
    }

    .fo-tablewrap{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.86);
    }
    table.fo-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .fo-table thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.2px;
      color:var(--muted);
      padding:10px 12px;
      background: rgba(255,255,255,.92);
      border-bottom:1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }
    .fo-table tbody td{
      padding:10px 12px;
      border-bottom: 1px solid rgba(230,232,240,.7);
      vertical-align: middle;
    }
    .fo-table tbody tr:hover{ background: rgba(0,94,220,0.04); }

    .fo-empty{ padding:18px; color:var(--muted); font-size:13px; }

    .fo-row-main{ display:grid; gap:2px; }
    .fo-wcode{ font-weight:900; letter-spacing:.2px; }
    .fo-mini{ color:var(--muted); font-size:12px; }

    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.9);
      color:var(--text);
      white-space: nowrap;
    }
    .pill-ok{
      background: var(--ok-bg);
      border-color: var(--ok-bd);
      color: var(--ok-tx);
    }
    .pill-warn{
      background: #fff7e8;
      border-color: #f2d7a8;
      color: #8a5a00;
    }
  </style>
</head>

<body class="ft-page has-topbar" id="page-ftfoload">

  <!-- TOPBAR HUB -->
  <div class="ft-topbar">
    <div class="ft-topbar__inner">
      <div class="ft-topbar__left">
        <div class="ft-topbar__brand">FTI-HUB</div>
        <div class="ft-topbar__subtitle">FTFOLOAD • batch FO</div>
      </div>

      <div class="ft-topbar__center">
        <div class="ft-topbar__userinfo" id="topbar-userline">Accesso in corso…</div>
      </div>

      <div class="ft-topbar__right">
        <button class="btn btn-small" onclick="goHome()">Home</button>
        <button class="btn btn-primary btn-small" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div class="fo-wrap">
    <div id="fo-guard" class="fo-guard">
      Accesso non autorizzato. Questa pagina è visibile solo agli utenti distributore.
    </div>

    <div id="fo-app" class="fo-layout" style="display:none;">

      <!-- LEFT -->
      <div class="fo-left">

        <div class="card pad">
          <h1 class="fo-h1">Queue FO</h1>
          <p class="fo-sub">
            ClaimCards con <b>status = "In valutazione FO"</b> e Claims con <b>sinistro vuoto</b>.
          </p>

          <div class="fo-chiprow">
            <div class="chip"><span class="n" id="cnt-total">0</span> righe</div>
            <div class="chip"><span class="n" id="cnt-filtered">0</span> filtrate</div>
            <div class="chip"><span class="n" id="cnt-selected">0</span> selezionate</div>
          </div>

          <div class="fo-kv">
            <div>Stato</div><div><b>In valutazione FO</b></div>
            <div>Campo</div><div><b>Claims/Rxxx.sinistro</b></div>
          </div>

          <div class="fo-progress" id="load-progress">Caricamento…</div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Selezione pratiche</div>
          <div class="fo-pad-sub">Gestisci rapidamente il batch di lavoro.</div>

          <div class="fo-grid2">
            <button class="btn btn-small" onclick="selectAllFiltered()">Seleziona filtrate</button>
            <button class="btn btn-small" onclick="clearSelection()">Deseleziona</button>
          </div>

          <div class="fo-row" style="margin-top:8px;">
            <button class="btn btn-small" onclick="invertSelection()">Inverti selezione</button>
            <button class="btn btn-small" onclick="reloadQueue()">Ricarica</button>
          </div>

          <div class="fo-note">
            Suggerimento: batch da <b>30–50</b> righe (W+R).
          </div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Export Excel (Selenium)</div>
          <div class="fo-pad-sub">Genera XLSX strutturato per inserimento seriale via Selenium.</div>

          <div class="fo-grid2">
            <button class="btn btn-primary btn-small" onclick="exportExcelSelected()">Export selezionate</button>
            <button class="btn btn-small" onclick="exportExcelFiltered()">Export filtrate</button>
          </div>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-notes" checked />
            Includi Notes
          </label>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-att" checked />
            Includi Attachments (url/path)
          </label>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-items" checked />
            Includi ricambi/manodopera (parts/labour)
          </label>

          <div class="fo-small" style="margin-top:8px;">
            Sheet <b>CLAIMS</b> + opzionali <b>NOTES</b> e <b>ATTACHMENTS</b>.
          </div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Power Automate</div>
          <div class="fo-pad-sub">Avvio processo automatico (in sviluppo).</div>

          <button class="btn btn-small" onclick="notReadyPA()">Avvia flusso (coming soon)</button>

          <div class="fo-note">
            Qui collegheremo una Flow che prende il batch e gestisce step/notify.
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="fo-right">
        <div class="card pad">

          <div class="fo-row" style="justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div class="fo-pad-title" style="margin:0;">Elenco claims da inserire</div>
              <div class="fo-pad-sub" style="margin:4px 0 0;">
                Seleziona righe (W+R). Dopo upload, Selenium valorizza <b>Claims/Rxxx.sinistro</b>.
              </div>
            </div>

            <div class="fo-row">
              <span class="pill pill-warn">Queue FO</span>
              <span class="pill">Solo distributore</span>
            </div>
          </div>

          <div class="fo-search">
            <input id="q" type="text" placeholder="Cerca (W-code / Rxxx / VIN / dealer / customer / testo…)" oninput="applyFilter()" />
          </div>

          <div class="fo-tablewrap">
            <table class="fo-table" aria-label="Queue FO">
              <thead>
                <tr>
                  <th style="width:44px;">Sel</th>
                  <th>Pratica</th>
                  <th style="width:140px;">Dealer</th>
                  <th style="width:190px;">VIN</th>
                  <th style="width:220px;">Cliente</th>
                  <th style="width:120px;">Apertura</th>
                  <th style="width:190px;">Stato</th>
                  <th style="width:160px;">Sinistro (claim)</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>

            <div id="empty" class="fo-empty" style="display:none;">
              Nessuna riga trovata con i filtri attuali.
            </div>
          </div>

          <div class="fo-note">
            “Sinistro vuoto” = pronto per inserimento FO. Il numero FO va scritto in <b>Claims/Rxxx.sinistro</b>.
          </div>

        </div>
      </div>

    </div>
  </div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentAccount = null;

  // rows = claim-level (W + R)
  let allItems = [];
  let filteredItems = [];
  let selectedSet = new Set(); // key = `${wcode}::${rcode}`

  // dettagli per export
  const detailCache = new Map(); // key -> { cc, claim, notes[], attachments[] }

  // ===== Access control =====
  async function computeDistributorAccess(userData){
    const direct = (userData?.isDistributorUser === true || userData?.IsDistributorUser === true);
    if (direct) return true;

    const dealerId = userData?.dealerId || userData?.dealerID || userData?.DealerID || null;
    if (!dealerId) return false;

    try{
      const dSnap = await db.collection("dealers").doc(dealerId).get();
      if (!dSnap.exists) return false;
      const d = dSnap.data() || {};
      return (d.isDistributor === true || d.IsDistributor === true);
    }catch(e){
      console.warn("Errore lettura dealers/<dealerId>:", e);
      return false;
    }
  }

  function setTopbarLine(user, userData){
    const dealer = userData?.dealerId || "-";
    const role = userData?.role || "User";
    const el = document.getElementById("topbar-userline");
    if (el) el.textContent = `${dealer} • ${role} • ${user.email}`;
  }

  function showGuard(show){
    document.getElementById("fo-guard").style.display = show ? "block" : "none";
    document.getElementById("fo-app").style.display = show ? "none" : "grid";
  }

  function setProgress(txt){
    const el = document.getElementById("load-progress");
    if (!el) return;
    if (!txt){
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = txt;
  }

  // ===== UI helpers =====
  function keyOf(it){ return `${it.wcode}::${it.rcode}`; }

  function updateCounters(){
    document.getElementById("cnt-total").textContent = String(allItems.length);
    document.getElementById("cnt-filtered").textContent = String(filteredItems.length);
    document.getElementById("cnt-selected").textContent = String(selectedSet.size);
  }

  function clearSelection(){
    selectedSet.clear();
    renderTable();
  }

  function selectAllFiltered(){
    filteredItems.forEach(it => selectedSet.add(keyOf(it)));
    renderTable();
  }

  function invertSelection(){
    const next = new Set(selectedSet);
    filteredItems.forEach(it => {
      const k = keyOf(it);
      if (next.has(k)) next.delete(k);
      else next.add(k);
    });
    selectedSet = next;
    renderTable();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toggleSelect(key, isOn){
    if (isOn) selectedSet.add(key);
    else selectedSet.delete(key);
    updateCounters();
  }

  function isEmptyValue(v){
    if (v === null || v === undefined) return true;
    if (typeof v === "string" && v.trim() === "") return true;
    return false;
  }

  function rowHTML(item){
    const k = keyOf(item);
    const checked = selectedSet.has(k) ? "checked" : "";
    const sin = (item.sinistro ?? "").toString().trim();
    const sinBadge = sin ? `<span class="pill">${escapeHtml(sin)}</span>` : `<span class="pill pill-ok">vuoto</span>`;

    return `
      <tr>
        <td><input type="checkbox" ${checked} onchange="toggleSelect('${escapeHtml(k)}', this.checked)"></td>
        <td>
          <div class="fo-row-main">
            <div class="fo-wcode">${escapeHtml(item.wcode)} <span class="pill" style="margin-left:6px;">${escapeHtml(item.rcode)}</span></div>
            <div class="fo-mini">${escapeHtml(item.claimType || "")} • ${escapeHtml(item.claimStatus || "")}</div>
          </div>
        </td>
        <td>${escapeHtml(item.openDealer || "-")}</td>
        <td>${escapeHtml(item.vin || "-")}</td>
        <td>${escapeHtml(item.customer || "-")}</td>
        <td>${escapeHtml(item.openDate || "-")}</td>
        <td><span class="pill pill-warn">${escapeHtml(item.statusCard || "-")}</span></td>
        <td>${sinBadge}</td>
      </tr>
    `;
  }

  function renderTable(){
    const tbody = document.getElementById("rows");
    const empty = document.getElementById("empty");
    tbody.innerHTML = "";

    if (!filteredItems.length){
      empty.style.display = "block";
      updateCounters();
      return;
    }
    empty.style.display = "none";
    tbody.innerHTML = filteredItems.map(rowHTML).join("");
    updateCounters();
  }

  function applyFilter(){
    const q = (document.getElementById("q").value || "").trim().toLowerCase();
    if (!q){
      filteredItems = [...allItems];
      renderTable();
      return;
    }
    filteredItems = allItems.filter(it => {
      const hay = [
        it.wcode, it.rcode, it.vin, it.openDealer, it.customer,
        it.statusCard, it.claimType, it.claimStatus, it.sinistro
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });
    renderTable();
  }

  // ===== Load queue =====
  async function reloadQueue(){
    setProgress("Caricamento queue…");
    detailCache.clear();
    selectedSet.clear();
    allItems = [];
    filteredItems = [];
    renderTable();

    try{
      const ccSnap = await db.collection("ClaimCards")
        .where("status", "==", "In valutazione FO")
        .get();

      const claimCards = ccSnap.docs.map(d => ({ id: d.id, ref: d.ref, data: d.data() || {} }));
      setProgress(`Trovate ${claimCards.length} claim card. Lettura claims…`);

      const rows = [];
      const batchSize = 10;

      for (let i=0; i<claimCards.length; i+=batchSize){
        const slice = claimCards.slice(i, i+batchSize);

        await Promise.all(slice.map(async cc => {
          const ccData = cc.data;

          const wcode = ccData.code || cc.id;
          const statusCard = ccData.status || "";
          const openDealer = ccData.openDealer || "";
          const openDate = ccData.openDate || "";
          const customer = (ccData.vehicle && ccData.vehicle.customer) ? ccData.vehicle.customer : "";
          const vin = (ccData.vehicle && ccData.vehicle.vin) ? ccData.vehicle.vin : "";

          const claimsSnap = await cc.ref.collection("Claims").get();
          claimsSnap.forEach(clDoc => {
            const cd = clDoc.data() || {};
            const rcode = clDoc.id;

            // sinistro è nel claim
            const sinistro = cd.sinistro;

            // filtro: sinistro vuoto
            if (!isEmptyValue(sinistro)) return;

            rows.push({
              wcode,
              rcode,
              statusCard,
              openDealer,
              openDate,
              customer,
              vin,
              claimType: cd.claimType || cd.claimCardType || "",
              claimStatus: cd.status || "",
              sinistro: sinistro ?? "",
              _ccRef: cc.ref,
              _claimRef: clDoc.ref,
              _ccData: ccData,
              _claimData: cd
            });
          });
        }));

        setProgress(`Caricamento… ${Math.min(i+batchSize, claimCards.length)}/${claimCards.length} claim card analizzate…`);
      }

      rows.sort((a,b) => {
        const aw = a.wcode || "", bw = b.wcode || "";
        if (aw < bw) return -1;
        if (aw > bw) return 1;
        return (a.rcode || "").localeCompare(b.rcode || "");
      });

      allItems = rows;
      filteredItems = [...allItems];
      setProgress(null);
      renderTable();

    }catch(e){
      console.error(e);
      setProgress(null);
      alert("Errore caricamento queue: " + (e.message || e));
    }
  }

  // ===== Export XLSX =====
  function nowStamp(){
    const d = new Date();
    const p2 = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}${p2(d.getMonth()+1)}${p2(d.getDate())}_${p2(d.getHours())}${p2(d.getMinutes())}${p2(d.getSeconds())}`;
  }
  function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
  function joinItems(arr, mapper){
    if (!Array.isArray(arr) || !arr.length) return "";
    return arr.map(mapper).filter(Boolean).join(" | ");
  }

  async function ensureDetailsFor(item, opts){
    const k = keyOf(item);
    if (detailCache.has(k)) return detailCache.get(k);

    const out = { cc: item._ccData || {}, claim: item._claimData || {}, notes: [], attachments: [] };

    if (opts.includeNotes){
      try{
        const ns = await item._claimRef.collection("Notes").orderBy("createdAt","asc").get();
        out.notes = ns.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
      }catch(e){ console.warn("Notes load fail", item.wcode, item.rcode, e); }
    }

    if (opts.includeAttachments){
      try{
        const as = await item._claimRef.collection("Attachments").orderBy("createdAt","asc").get();
        out.attachments = as.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
      }catch(e){ console.warn("Attachments load fail", item.wcode, item.rcode, e); }
    }

    detailCache.set(k, out);
    return out;
  }

  function buildClaimsSheetRows(items, detailsMap, opts){
    const rows = [];

    items.forEach(it => {
      const det = detailsMap.get(keyOf(it)) || { cc: it._ccData || {}, claim: it._claimData || {}, notes: [], attachments: [] };
      const cc = det.cc || {};
      const claim = det.claim || {};
      const g = (claim.garanzia || {}) || {};

      const vehicle = cc.vehicle || {};
      const coverage = cc.coverage || {};

      const symptom = g.symptom || claim.symptom || {};
      const causaPart = (g.causaPart || claim.causaPart || {});
      const ccc = (g.ccc || claim.ccc || {});
      const labourRateStd = g.labourRateStd ?? claim.labourRateStd ?? "";

      const parts = g.parts || claim.parts || [];
      const labour = g.labour || claim.labour || [];

      const partsFlat = opts.includeItems ? joinItems(parts, p => {
        const code = p.codice || "";
        const ext = p.codice_esteso || "";
        const qty = p.quantita ?? "";
        const tot = p.totale ?? "";
        return `${code}${ext?` (${ext})`:``} x${qty} = ${tot}`;
      }) : "";

      const labourFlat = opts.includeItems ? joinItems(labour, l => {
        const code = l.codice_labour || "";
        const qty = l.quantita ?? "";
        const tot = l.totale ?? "";
        return `${code} x${qty} = ${tot}`;
      }) : "";

      const notesFlat = det.notes?.length
        ? det.notes.map(n => safeStr(n.text)).filter(Boolean).join(" || ")
        : "";

      const attCount = det.attachments?.length || 0;
      const attFlat = det.attachments?.length
        ? det.attachments.map(a => `${safeStr(a.name)}::${safeStr(a.path)}::${safeStr(a.url)}`).join(" || ")
        : "";

      rows.push({
        WCODE: safeStr(it.wcode),
        RCODE: safeStr(it.rcode),

        DEALER_OPEN: safeStr(it.openDealer),
        OPEN_DATE: safeStr(it.openDate),
        STATUS_CLAIMCARD: safeStr(it.statusCard),

        VIN: safeStr(vehicle.vin || it.vin),
        CUSTOMER: safeStr(vehicle.customer || it.customer),

        ORDER_DATE: safeStr(cc.orderDate || ""),
        ORDER_NUMBER: safeStr(cc.orderNumber || ""),
        KM: safeStr(cc.km ?? ""),
        ENGINE_HOURS: safeStr(cc.engineHours ?? ""),

        COVERAGE_TYPE: safeStr(coverage.type || ""),
        COVERAGE_START: safeStr(coverage.startDate || ""),
        COVERAGE_END: safeStr(coverage.endDate || ""),

        CLAIM_TYPE: safeStr(it.claimType),
        CLAIM_STATUS: safeStr(it.claimStatus),

        CCC_ID: safeStr(ccc.id || ""),
        CCC_TEXT: safeStr(ccc.text || ""),

        SYMPTOM_ID: safeStr(symptom.id || ""),
        SYMPTOM_LABEL: safeStr(symptom.label || ""),

        CAUSA_PART_CODE: safeStr(causaPart.codice || ""),
        CAUSA_PART_EXT: safeStr(causaPart.codice_esteso || ""),
        CAUSA_PART_DESC: safeStr(causaPart.descrizione || ""),

        COMMENTO_TECNICO: safeStr(g.commentoTecnico || claim.commentoTecnico || ""),

        TOTALE_MANODOPERA: safeStr(symptom.totaleManodopera ?? g.totaleManodopera ?? ""),
        TOTALE_RICAMBI: safeStr(symptom.totaleRicambi ?? g.totaleRicambi ?? ""),

        LABOUR_RATE_STD: safeStr(labourRateStd),

        LABOUR_ITEMS: safeStr(labourFlat),
        PARTS_ITEMS: safeStr(partsFlat),

        SINISTRO: safeStr(claim.sinistro ?? ""),

        NOTES: safeStr(opts.includeNotes ? notesFlat : ""),
        ATTACHMENTS_COUNT: safeStr(opts.includeAttachments ? attCount : ""),
        ATTACHMENTS: safeStr(opts.includeAttachments ? attFlat : "")
      });
    });

    return rows;
  }

  function buildNotesSheetRows(items, detailsMap){
    const rows = [];
    items.forEach(it => {
      const det = detailsMap.get(keyOf(it));
      if (!det?.notes?.length) return;
      det.notes.forEach(n => rows.push({
        WCODE: safeStr(it.wcode),
        RCODE: safeStr(it.rcode),
        NOTE_ID: safeStr(n.id),
        AUTHOR: safeStr(n.authorName || ""),
        AUTHOR_DEALER: safeStr(n.authorDealerId || ""),
        CREATED_AT: n.createdAt?.toDate ? n.createdAt.toDate().toISOString() : safeStr(n.createdAt || ""),
        TEXT: safeStr(n.text || "")
      }));
    });
    return rows;
  }

  function buildAttachmentsSheetRows(items, detailsMap){
    const rows = [];
    items.forEach(it => {
      const det = detailsMap.get(keyOf(it));
      if (!det?.attachments?.length) return;
      det.attachments.forEach(a => rows.push({
        WCODE: safeStr(it.wcode),
        RCODE: safeStr(it.rcode),
        ATT_ID: safeStr(a.id),
        NAME: safeStr(a.name || ""),
        PATH: safeStr(a.path || ""),
        URL: safeStr(a.url || ""),
        CREATED_AT: a.createdAt?.toDate ? a.createdAt.toDate().toISOString() : safeStr(a.createdAt || ""),
        AUTHOR: safeStr(a.authorName || ""),
        AUTHOR_DEALER: safeStr(a.authorDealerId || "")
      }));
    });
    return rows;
  }

  async function exportToXlsx(items, modeLabel){
    if (!items?.length){
      alert("Nessuna riga da esportare.");
      return;
    }

    const opts = {
      includeNotes: document.getElementById("opt-include-notes").checked,
      includeAttachments: document.getElementById("opt-include-att").checked,
      includeItems: document.getElementById("opt-include-items").checked
    };

    setProgress(`Export XLSX (${modeLabel})… raccolta dettagli…`);

    const detailsMap = new Map();
    const batchSize = 10;

    for (let i=0; i<items.length; i+=batchSize){
      const slice = items.slice(i, i+batchSize);
      await Promise.all(slice.map(async it => {
        const det = await ensureDetailsFor(it, opts);
        detailsMap.set(keyOf(it), det);
      }));
      setProgress(`Export… ${Math.min(i+batchSize, items.length)}/${items.length} righe preparate…`);
    }

    const wb = XLSX.utils.book_new();

    const claimsRows = buildClaimsSheetRows(items, detailsMap, opts);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(claimsRows), "CLAIMS");

    if (opts.includeNotes){
      const notesRows = buildNotesSheetRows(items, detailsMap);
      XLSX.utils.book_append_sheet(
        wb,
        XLSX.utils.json_to_sheet(notesRows.length ? notesRows : [{INFO:"Nessuna nota"}]),
        "NOTES"
      );
    }

    if (opts.includeAttachments){
      const attRows = buildAttachmentsSheetRows(items, detailsMap);
      XLSX.utils.book_append_sheet(
        wb,
        XLSX.utils.json_to_sheet(attRows.length ? attRows : [{INFO:"Nessun allegato"}]),
        "ATTACHMENTS"
      );
    }

    const fname = `FTFOLOAD_${modeLabel}_${nowStamp()}.xlsx`;
    setProgress(`Scrittura file ${fname}…`);
    XLSX.writeFile(wb, fname);
    setProgress(null);
  }

  function exportExcelSelected(){
    const items = allItems.filter(it => selectedSet.has(keyOf(it)));
    exportToXlsx(items, "SELECTED").catch(e => {
      console.error(e);
      setProgress(null);
      alert("Errore export: " + (e.message || e));
    });
  }

  function exportExcelFiltered(){
    exportToXlsx(filteredItems, "FILTERED").catch(e => {
      console.error(e);
      setProgress(null);
      alert("Errore export: " + (e.message || e));
    });
  }

  function notReadyPA(){
    alert("Funzionalità Power Automate non ancora implementata.");
  }

  function goHome(){ location.href = "FTHUBAS.html"; }
  function logout(){ auth.signOut().then(()=>location.href="index.html"); }

  // ===== Boot =====
  auth.onAuthStateChanged(async user => {
    if (!user) return location.href = "index.html";

    const uSnap = await db.collection("Users").doc(user.uid).get();
    if (!uSnap.exists){
      showGuard(true);
      return;
    }

    const userData = uSnap.data() || {};
    currentAccount = { user, userData };
    setTopbarLine(user, userData);

    const allowed = await computeDistributorAccess(userData);
    if (!allowed){
      showGuard(true);
      return;
    }

    showGuard(false);
    await reloadQueue();
  });
</script>

<script src="ft-topbar.js?v=4"></script>
</body>
</html>
