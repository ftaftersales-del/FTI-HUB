<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FTFOLOAD</title>

  <link rel="stylesheet" href="ftstyle.css?v=6"/>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- XLSX export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* ===============================
       FTFOLOAD - Page glue (v4)
       - stile hub + layout left pads
       - export reale XLSX multi-sheet (CLAIMS / PARTS / LABOUR / NOTES / ATTACHMENTS)
       =============================== */

    .fo-wrap{
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px;
      min-height: calc(100vh - 58px);
    }

    .fo-layout{
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 1050px){
      .fo-layout{ grid-template-columns: 1fr; }
    }

    .fo-left{
      display: grid;
      gap: 12px;
      position: sticky;
      top: 74px;
      align-self: start;
      z-index: 2;
    }
    @media (max-width: 1050px){
      .fo-left{ position: relative; top: auto; }
    }

    .fo-h1{ margin:0; font-size:18px; line-height:1.15; }
    .fo-sub{ margin:6px 0 0; font-size:13px; color:var(--muted); }

    .fo-guard{
      display:none;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffd0d0;
      background: #fff1f1;
      color: #8a1f1f;
      font-size: 13px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
    }
    .fo-guard b{ color:#6f1414; }
    .fo-guard .small{ margin-top:6px; font-size:12px; opacity:.9; white-space:pre-wrap; }

    .fo-pad-title{ margin:0 0 8px; font-size:14px; font-weight:800; }
    .fo-pad-sub{ margin:0 0 10px; font-size:12px; color:var(--muted); }

    .fo-grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .fo-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .fo-chiprow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      font-size:12px; color:var(--text);
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
      user-select:none; white-space:nowrap;
    }
    .chip .n{ font-weight:900; }

    .fo-kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }
    .fo-kv b{ color:var(--text); }

    .fo-progress{
      display:none;
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }

    .fo-note{ margin-top:10px; font-size:12px; color:var(--muted); }
    .fo-small{ font-size:12px; color:var(--muted); }

    .fo-check{
      display:flex; gap:8px; align-items:center;
      font-size:12px; color:var(--text);
      user-select:none; margin-top:8px;
    }
    .fo-check input{ transform: translateY(1px); }

    .fo-search{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap; margin-top:10px;
    }
    .fo-search input{
      flex:1;
      min-width:280px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      padding:0 12px;
      outline:none;
      background:#fff;
    }

    .fo-tablewrap{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.86);
    }
    table.fo-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .fo-table thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.2px;
      color:var(--muted);
      padding:10px 12px;
      background: rgba(255,255,255,.92);
      border-bottom:1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }
    .fo-table tbody td{
      padding:10px 12px;
      border-bottom: 1px solid rgba(230,232,240,.7);
      vertical-align: middle;
    }
    .fo-table tbody tr:hover{ background: rgba(0,94,220,0.04); }

    .fo-empty{ padding:18px; color:var(--muted); font-size:13px; }

    .fo-row-main{ display:grid; gap:2px; }
    .fo-wcode{ font-weight:900; letter-spacing:.2px; }
    .fo-mini{ color:var(--muted); font-size:12px; }

    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.9);
      color:var(--text);
      white-space: nowrap;
    }
    .pill-ok{
      background: var(--ok-bg);
      border-color: var(--ok-bd);
      color: var(--ok-tx);
    }
    .pill-warn{
      background: #fff7e8;
      border-color: #f2d7a8;
      color: #8a5a00;
    }
  </style>
</head>

<body class="ft-page has-topbar" id="page-ftfoload">

  <!-- TOPBAR HUB -->
  <div class="ft-topbar">
    <div class="ft-topbar__inner">
      <div class="ft-topbar__left">
        <div class="ft-topbar__brand">FTI-HUB</div>
        <div class="ft-topbar__subtitle">FTFOLOAD • batch FO</div>
      </div>

      <div class="ft-topbar__center">
        <div class="ft-topbar__userinfo" id="topbar-userline">Accesso in corso…</div>
      </div>

      <div class="ft-topbar__right">
        <button class="btn btn-small" onclick="goHome()">Home</button>
        <button class="btn btn-primary btn-small" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div class="fo-wrap">
    <div id="fo-guard" class="fo-guard">
      <b>Accesso non disponibile.</b>
      <div class="small" id="fo-guard-msg"></div>
    </div>

    <div id="fo-app" class="fo-layout" style="display:none;">

      <!-- LEFT -->
      <div class="fo-left">

        <div class="card pad">
          <h1 class="fo-h1">Queue FO</h1>
          <p class="fo-sub">
            ClaimCards con <b>status = "In Valutazione FO"</b> (o variante) e Claims con <b>sinistro vuoto</b>.
          </p>

          <div class="fo-chiprow">
            <div class="chip"><span class="n" id="cnt-total">0</span> righe</div>
            <div class="chip"><span class="n" id="cnt-filtered">0</span> filtrate</div>
            <div class="chip"><span class="n" id="cnt-selected">0</span> selezionate</div>
          </div>

          <div class="fo-kv">
            <div>Stato</div><div><b>In Valutazione FO</b></div>
            <div>Campo</div><div><b>Claim.sinistro (Claims/Rxxx)</b></div>
          </div>

          <div class="fo-progress" id="load-progress">Caricamento…</div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Selezione pratiche</div>
          <div class="fo-pad-sub">Gestisci rapidamente il batch di lavoro.</div>

          <div class="fo-grid2">
            <button class="btn btn-small" onclick="selectAllFiltered()">Seleziona filtrate</button>
            <button class="btn btn-small" onclick="clearSelection()">Deseleziona</button>
          </div>

          <div class="fo-row" style="margin-top:8px;">
            <button class="btn btn-small" onclick="invertSelection()">Inverti selezione</button>
            <button class="btn btn-small" onclick="reloadQueue()">Ricarica</button>
          </div>

          <div class="fo-note">
            Suggerimento: batch da <b>30–50</b> righe (W+R).
          </div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Export Excel (Selenium)</div>
          <div class="fo-pad-sub">XLSX multi-sheet: <b>CLAIMS</b> + <b>PARTS</b> + <b>LABOUR</b> (+ opzionali).</div>

          <div class="fo-grid2">
            <button class="btn btn-primary btn-small" onclick="exportExcelSelected()">Export selezionate</button>
            <button class="btn btn-small" onclick="exportExcelFiltered()">Export filtrate</button>
          </div>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-notes" checked />
            Includi Notes
          </label>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-att" checked />
            Includi Attachments (url/path)
          </label>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-items" checked />
            Includi ricambi/manodopera (PARTS/LABOUR)
          </label>

          <div class="fo-small" style="margin-top:8px;">
            Nessun limite: ricambi e manodopera vanno in sheet dedicati.
          </div>

          <div class="fo-progress" id="export-progress"></div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Power Automate</div>
          <div class="fo-pad-sub">Avvio processo automatico (in sviluppo).</div>

          <button class="btn btn-small" onclick="notReadyPA()">Avvia flusso (coming soon)</button>

          <div class="fo-note">
            Qui collegheremo una Flow che prende il batch e gestisce step/notify.
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="fo-right">
        <div class="card pad">

          <div class="fo-row" style="justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div class="fo-pad-title" style="margin:0;">Elenco claims da inserire</div>
              <div class="fo-pad-sub" style="margin:4px 0 0;">
                Seleziona righe (W+R). Dopo upload, Selenium valorizza <b>Claims/Rxxx.sinistro</b>.
              </div>
            </div>

            <div class="fo-row">
              <span class="pill pill-warn">Queue FO</span>
              <span class="pill">Solo distributore</span>
            </div>
          </div>

          <div class="fo-search">
            <input id="q" type="text" placeholder="Cerca (W-code / Rxxx / VIN / dealer / customer / testo…)" oninput="applyFilter()" />
          </div>

          <div class="fo-tablewrap">
            <table class="fo-table" aria-label="Queue FO">
              <thead>
                <tr>
                  <th style="width:44px;">Sel</th>
                  <th>Pratica</th>
                  <th style="width:140px;">Dealer</th>
                  <th style="width:190px;">VIN</th>
                  <th style="width:220px;">Cliente</th>
                  <th style="width:120px;">Apertura</th>
                  <th style="width:190px;">Stato</th>
                  <th style="width:160px;">Sinistro (claim)</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>

            <div id="empty" class="fo-empty" style="display:none;">
              Nessuna riga trovata con i filtri attuali.
            </div>
          </div>

          <div class="fo-note">
            “Sinistro vuoto” = pronto per inserimento FO. Il numero FO va scritto in <b>Claims/Rxxx.sinistro</b>.
          </div>

        </div>
      </div>

    </div>
  </div>

<script>
  // ===== BOOT / GLOBALS =====
  // Se firebase-config.js crea già window.auth / window.db, usiamo quelli.
  // Altrimenti li inizializziamo qui.
  const AUTH = (window.auth && typeof window.auth.onAuthStateChanged === "function")
    ? window.auth
    : firebase.auth();

  const DB = (window.db && typeof window.db.collection === "function")
    ? window.db
    : firebase.firestore();

  console.info("[FTFOLOAD] boot: using globals?", {authGlobal: !!window.auth, dbGlobal: !!window.db});

  let currentAccount = null;

  let allItems = [];
  let filteredItems = [];
  let selectedSet = new Set(); // key = `${wcode}::${rcode}`

  // cache export: key -> {notes:[], att:[]}
  const exportDetailCache = new Map();

  // ===== UI helpers =====
  function showGuard(message, errorObj){
    const g = document.getElementById("fo-guard");
    const m = document.getElementById("fo-guard-msg");
    g.style.display = "block";
    document.getElementById("fo-app").style.display = "none";

    let txt = message || "Non autorizzato o errore di accesso.";
    if (errorObj){
      const em = (errorObj?.message || errorObj || "").toString();
      txt += "\n\nDettaglio:\n" + em;
    }
    m.textContent = txt;
  }

  function showApp(){
    document.getElementById("fo-guard").style.display = "none";
    document.getElementById("fo-app").style.display = "grid";
  }

  function setTopbarLine(user, userData){
    const dealer = userData?.dealerId || userData?.dealerID || userData?.DealerID || "-";
    const role = userData?.role || "User";
    const el = document.getElementById("topbar-userline");
    if (el) el.textContent = `${dealer} • ${role} • ${user.email}`;
  }

  async function computeDistributorAccess(userData){
    const direct = (userData?.isDistributorUser === true || userData?.IsDistributorUser === true);
    if (direct) return true;

    const dealerId = userData?.dealerId || userData?.dealerID || userData?.DealerID || null;
    if (!dealerId) return false;

    const dSnap = await DB.collection("dealers").doc(dealerId).get();
    if (!dSnap.exists) return false;
    const d = dSnap.data() || {};
    return (d.isDistributor === true || d.IsDistributor === true);
  }

  function setProgress(txt){
    const el = document.getElementById("load-progress");
    if (!el) return;
    if (!txt){
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = txt;
  }

  function setExportProgress(txt){
    const el = document.getElementById("export-progress");
    if (!el) return;
    if (!txt){
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = txt;
  }

  function updateCounters(){
    document.getElementById("cnt-total").textContent = String(allItems.length);
    document.getElementById("cnt-filtered").textContent = String(filteredItems.length);
    document.getElementById("cnt-selected").textContent = String(selectedSet.size);
  }

  function keyOf(it){ return `${it.wcode}::${it.rcode}`; }

  function clearSelection(){ selectedSet.clear(); renderTable(); }
  function selectAllFiltered(){ filteredItems.forEach(it => selectedSet.add(keyOf(it))); renderTable(); }
  function invertSelection(){
    const next = new Set(selectedSet);
    filteredItems.forEach(it => {
      const k = keyOf(it);
      if (next.has(k)) next.delete(k); else next.add(k);
    });
    selectedSet = next;
    renderTable();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toggleSelect(key, isOn){
    if (isOn) selectedSet.add(key);
    else selectedSet.delete(key);
    updateCounters();
  }

  function isEmptyValue(v){
    if (v === null || v === undefined) return true;
    if (typeof v === "string" && v.trim() === "") return true;
    return false;
  }

  function rowHTML(item){
    const k = keyOf(item);
    const checked = selectedSet.has(k) ? "checked" : "";
    const sin = (item.sinistro ?? "").toString().trim();
    const sinBadge = sin ? `<span class="pill">${escapeHtml(sin)}</span>` : `<span class="pill pill-ok">vuoto</span>`;

    return `
      <tr>
        <td><input type="checkbox" ${checked} onchange="toggleSelect('${escapeHtml(k)}', this.checked)"></td>
        <td>
          <div class="fo-row-main">
            <div class="fo-wcode">${escapeHtml(item.wcode)} <span class="pill" style="margin-left:6px;">${escapeHtml(item.rcode)}</span></div>
            <div class="fo-mini">${escapeHtml(item.claimType || "")} • ${escapeHtml(item.claimStatus || "")}</div>
          </div>
        </td>
        <td>${escapeHtml(item.openDealer || "-")}</td>
        <td>${escapeHtml(item.vin || "-")}</td>
        <td>${escapeHtml(item.customer || "-")}</td>
        <td>${escapeHtml(item.openDate || "-")}</td>
        <td><span class="pill pill-warn">${escapeHtml(item.statusCard || "-")}</span></td>
        <td>${sinBadge}</td>
      </tr>
    `;
  }

  function renderTable(){
    const tbody = document.getElementById("rows");
    const empty = document.getElementById("empty");
    tbody.innerHTML = "";

    if (!filteredItems.length){
      empty.style.display = "block";
      updateCounters();
      return;
    }
    empty.style.display = "none";
    tbody.innerHTML = filteredItems.map(rowHTML).join("");
    updateCounters();
  }

  function applyFilter(){
    const q = (document.getElementById("q").value || "").trim().toLowerCase();
    if (!q){
      filteredItems = [...allItems];
      renderTable();
      return;
    }
    filteredItems = allItems.filter(it => {
      const hay = [
        it.wcode, it.rcode, it.vin, it.openDealer, it.customer,
        it.statusCard, it.claimType, it.claimStatus, it.sinistro
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });
    renderTable();
  }

  // ===== Queue load =====
  async function reloadQueue(){
    setProgress("Caricamento queue…");
    exportDetailCache.clear();
    selectedSet.clear();
    allItems = [];
    filteredItems = [];
    renderTable();

    try{
      // robust: alcune pratiche potrebbero essere "In valutazione FO" vs "In Valutazione FO"
      const q1 = DB.collection("ClaimCards").where("status", "==", "In Valutazione FO").get();
      const q2 = DB.collection("ClaimCards").where("status", "==", "In valutazione FO").get();
      const [s1, s2] = await Promise.all([q1, q2]);

      const map = new Map();
      s1.docs.forEach(d => map.set(d.id, d));
      s2.docs.forEach(d => map.set(d.id, d));
      const docs = Array.from(map.values());

      const claimCards = docs.map(d => ({ id: d.id, ref: d.ref, data: d.data() || {} }));
      console.info("[FTFOLOAD] ClaimCards found:", claimCards.length);

      setProgress(`Trovate ${claimCards.length} claim card. Lettura claims…`);

      const rows = [];
      const batchSize = 10;

      for (let i=0; i<claimCards.length; i+=batchSize){
        const slice = claimCards.slice(i, i+batchSize);

        await Promise.all(slice.map(async cc => {
          const ccData = cc.data;
          const wcode = ccData.code || cc.id;

          const statusCard = ccData.status || "";
          const openDealer = ccData.openDealer || "";
          const openDate = ccData.openDate || "";
          const customer = (ccData.vehicle && ccData.vehicle.customer) ? ccData.vehicle.customer : "";
          const vin = (ccData.vehicle && ccData.vehicle.vin) ? ccData.vehicle.vin : "";

          const claimsSnap = await cc.ref.collection("Claims").get();
          claimsSnap.forEach(clDoc => {
            const cd = clDoc.data() || {};
            const rcode = clDoc.id;

            // filtro: sinistro vuoto (NEL CLAIM)
            const sinistro = cd.sinistro;
            if (!isEmptyValue(sinistro)) return;

            rows.push({
              wcode, rcode,
              statusCard, openDealer, openDate, customer, vin,
              claimType: cd.claimType || cd.claimCardType || "",
              claimStatus: cd.status || "",
              sinistro: sinistro ?? "",
              _ccRef: cc.ref,
              _claimRef: clDoc.ref,
              _ccData: ccData,
              _claimData: cd
            });
          });
        }));

        setProgress(`Caricamento… ${Math.min(i+batchSize, claimCards.length)}/${claimCards.length} claim card analizzate…`);
      }

      rows.sort((a,b) => (a.wcode||"").localeCompare(b.wcode||"") || (a.rcode||"").localeCompare(b.rcode||""));

      allItems = rows;
      filteredItems = [...allItems];
      setProgress(null);
      renderTable();

    }catch(e){
      console.error("[FTFOLOAD] reloadQueue error:", e);
      setProgress(null);
      showGuard("Errore caricamento queue (permessi/connessione).", e);
    }
  }

  // ===== Export helpers =====
  function safeStr(v){
    if (v === null || v === undefined) return "";
    if (typeof v === "object"){
      try{ return JSON.stringify(v); }catch(e){ return String(v); }
    }
    return String(v);
  }
  function safeNum(v){
    if (v === null || v === undefined || v === "") return "";
    const n = Number(v);
    return Number.isFinite(n) ? n : "";
  }

  function getGaranziaBlock(claimData){
    // nel tuo DB: claim.garanzia.{parts,labour,ccc,commentoTecnico,...}
    // ma restiamo robusti
    if (!claimData || typeof claimData !== "object") return null;
    return claimData.garanzia || claimData.Garanzia || null;
  }

  function buildClaimRow(it){
    const cc = it._ccData || {};
    const cl = it._claimData || {};
    const g = getGaranziaBlock(cl);

    return {
      WCODE: safeStr(it.wcode),
      RCODE: safeStr(it.rcode),

      CLAIMCARD_STATUS: safeStr(it.statusCard),
      CLAIM_STATUS: safeStr(it.claimStatus),
      CLAIM_TYPE: safeStr(it.claimType),

      DEALER_OPEN: safeStr(it.openDealer),
      OPEN_DATE: safeStr(it.openDate),
      ORDER_DATE: safeStr(cc.orderDate),
      ORDER_NUMBER: safeStr(cc.orderNumber),

      CUSTOMER: safeStr(it.customer),
      VIN: safeStr(it.vin),
      KM: safeNum(cc.km),
      ENGINE_HOURS: safeNum(cc.engineHours),

      CCC_ID: safeStr(g?.ccc?.id),
      CCC_TEXT: safeStr(g?.ccc?.text),
      COMMENTO_TECNICO: safeStr(g?.commentoTecnico),
      SYMPTOM_ID: safeStr(g?.symptom?.id),
      SYMPTOM_LABEL: safeStr(g?.symptom?.label),

      TOTALE_RICAMBI: safeNum(g?.totaleRicambi),
      TOTALE_MANODOPERA: safeNum(g?.totaleManodopera),
      LABOUR_RATE_STD: safeNum(g?.labourRateStd),

      // valorizzati da Selenium e/o da processo di write-back
      SINISTRO_DB: "",                // in queue è vuoto
      FO_SINISTRO_RESULT: "",         // selenium lo compila
      WRITEBACK_OK: "",               // eventuale esito update Firestore
      WRITEBACK_AT: "",               // timestamp writeback

      CC_REF_PATH: safeStr(it._ccRef?.path),
      CLAIM_REF_PATH: safeStr(it._claimRef?.path)
    };
  }

  function buildPartsRows(it){
    const cl = it._claimData || {};
    const g = getGaranziaBlock(cl);
    const parts = Array.isArray(g?.parts) ? g.parts : [];
    return parts.map((p, idx) => ({
      WCODE: safeStr(it.wcode),
      RCODE: safeStr(it.rcode),
      INDEX: idx + 1,
      CODICE: safeStr(p.codice),
      CODICE_ESTESO: safeStr(p.codice_esteso),
      DESCRIZIONE: safeStr(p.descrizione),
      QTY: safeNum(p.quantita),
      TOTALE: safeNum(p.totale),
      RIMBORSO_GARANZIA: safeNum(p.rimborso_garanzia),
      ID: safeStr(p.id)
    }));
  }

  function buildLabourRows(it){
    const cl = it._claimData || {};
    const g = getGaranziaBlock(cl);
    const labour = Array.isArray(g?.labour) ? g.labour : [];
    return labour.map((l, idx) => ({
      WCODE: safeStr(it.wcode),
      RCODE: safeStr(it.rcode),
      INDEX: idx + 1,
      CODICE_LABOUR: safeStr(l.codice_labour),
      DESCRIZIONE: safeStr(l.descrizione_tradotta || l.descrizione || ""),
      QTY: safeNum(l.quantita),
      TOTALE: safeNum(l.totale),
      ID: safeStr(l.id)
    }));
  }

  async function fetchNotesAndAttachmentsForItem(it){
    const k = keyOf(it);
    if (exportDetailCache.has(k)) return exportDetailCache.get(k);

    const claimRef = it._claimRef;
    const out = { notes: [], attachments: [] };

    if (!claimRef || typeof claimRef.collection !== "function"){
      exportDetailCache.set(k, out);
      return out;
    }

    try{
      const [nSnap, aSnap] = await Promise.all([
        claimRef.collection("Notes").get().catch(()=>null),
        claimRef.collection("Attachments").get().catch(()=>null)
      ]);

      if (nSnap && nSnap.forEach){
        nSnap.forEach(d => {
          const x = d.data() || {};
          out.notes.push({
            WCODE: safeStr(it.wcode),
            RCODE: safeStr(it.rcode),
            NOTE_ID: safeStr(d.id),
            CREATED_AT: safeStr(x.createdAt?.toDate ? x.createdAt.toDate().toISOString() : (x.createdAt || "")),
            AUTHOR_DEALER: safeStr(x.authorDealerId),
            AUTHOR_NAME: safeStr(x.authorName),
            TEXT: safeStr(x.text)
          });
        });
      }

      if (aSnap && aSnap.forEach){
        aSnap.forEach(d => {
          const x = d.data() || {};
          out.attachments.push({
            WCODE: safeStr(it.wcode),
            RCODE: safeStr(it.rcode),
            ATT_ID: safeStr(d.id),
            CREATED_AT: safeStr(x.createdAt?.toDate ? x.createdAt.toDate().toISOString() : (x.createdAt || "")),
            AUTHOR_DEALER: safeStr(x.authorDealerId),
            AUTHOR_NAME: safeStr(x.authorName),
            NAME: safeStr(x.name),
            PATH: safeStr(x.path),
            URL: safeStr(x.url)
          });
        });
      }

    }catch(e){
      console.warn("[FTFOLOAD] fetchNotesAndAttachments error:", it.wcode, it.rcode, e);
    }

    exportDetailCache.set(k, out);
    return out;
  }

  function makeFilename(prefix){
    const now = new Date();
    const pad2 = (n)=> String(n).padStart(2,"0");
    const y = now.getFullYear();
    const m = pad2(now.getMonth()+1);
    const d = pad2(now.getDate());
    const hh = pad2(now.getHours());
    const mm = pad2(now.getMinutes());
    return `${prefix}_${y}${m}${d}_${hh}${mm}.xlsx`;
  }

  async function exportExcelFor(items, modeLabel){
    if (!items || !items.length){
      alert("Nessuna riga da esportare.");
      return;
    }

    const includeNotes = document.getElementById("opt-include-notes").checked;
    const includeAtt = document.getElementById("opt-include-att").checked;
    const includeItems = document.getElementById("opt-include-items").checked;

    setExportProgress(`Preparazione export (${items.length} righe)…`);

    // base
    const claimsRows = items.map(it => buildClaimRow(it));

    // parts/labour rows (illimitati)
    const partsRows = [];
    const labourRows = [];
    if (includeItems){
      items.forEach(it => {
        partsRows.push(...buildPartsRows(it));
        labourRows.push(...buildLabourRows(it));
      });
    }

    // notes/attachments (letture firestore)
    const notesRows = [];
    const attRows = [];
    if (includeNotes || includeAtt){
      const concurrency = 12;
      for (let i=0; i<items.length; i+=concurrency){
        const slice = items.slice(i, i+concurrency);
        setExportProgress(`Lettura Notes/Attachments… ${Math.min(i+concurrency, items.length)}/${items.length}`);
        const res = await Promise.all(slice.map(it => fetchNotesAndAttachmentsForItem(it)));

        res.forEach(x => {
          if (includeNotes) notesRows.push(...(x.notes || []));
          if (includeAtt) attRows.push(...(x.attachments || []));
        });
      }
    }

    setExportProgress("Creazione file XLSX…");

    // workbook
    const wb = XLSX.utils.book_new();

    // CLAIMS
    const wsClaims = XLSX.utils.json_to_sheet(claimsRows, { skipHeader: false });
    XLSX.utils.book_append_sheet(wb, wsClaims, "CLAIMS");

    // PARTS + LABOUR
    if (includeItems){
      const wsParts = XLSX.utils.json_to_sheet(partsRows, { skipHeader: false });
      XLSX.utils.book_append_sheet(wb, wsParts, "PARTS");

      const wsLabour = XLSX.utils.json_to_sheet(labourRows, { skipHeader: false });
      XLSX.utils.book_append_sheet(wb, wsLabour, "LABOUR");
    }

    // NOTES + ATTACHMENTS
    if (includeNotes){
      const wsNotes = XLSX.utils.json_to_sheet(notesRows, { skipHeader: false });
      XLSX.utils.book_append_sheet(wb, wsNotes, "NOTES");
    }
    if (includeAtt){
      const wsAtt = XLSX.utils.json_to_sheet(attRows, { skipHeader: false });
      XLSX.utils.book_append_sheet(wb, wsAtt, "ATTACHMENTS");
    }

    // meta sheet (utile per selenium)
    const meta = [{
      EXPORT_MODE: modeLabel,
      EXPORTED_AT: new Date().toISOString(),
      STATUS_FILTER: "In Valutazione FO / In valutazione FO",
      CLAIM_FILTER: "claim.sinistro vuoto",
      ROWS: items.length
    }];
    const wsMeta = XLSX.utils.json_to_sheet(meta, { skipHeader:false });
    XLSX.utils.book_append_sheet(wb, wsMeta, "META");

    const filename = makeFilename(`FTFOLOAD_${modeLabel}`);
    XLSX.writeFile(wb, filename);

    setExportProgress(null);
  }

  function exportExcelSelected(){
    const items = allItems.filter(it => selectedSet.has(keyOf(it)));
    exportExcelFor(items, "selected");
  }

  function exportExcelFiltered(){
    exportExcelFor(filteredItems, "filtered");
  }

  function notReadyPA(){ alert("Funzionalità Power Automate non ancora implementata."); }

  // ===== Nav =====
  function goHome(){ location.href="FTHUBAS.html"; }
  function logout(){ AUTH.signOut().then(()=>location.href="index.html"); }

  // ===== AUTH BOOT =====
  AUTH.onAuthStateChanged(async (user) => {
    try{
      console.info("[FTFOLOAD] auth state changed:", !!user);

      if (!user){
        return location.href = "index.html";
      }

      // Users/<uid>
      const uSnap = await DB.collection("Users").doc(user.uid).get();
      if (!uSnap.exists){
        console.warn("[FTFOLOAD] Users doc missing for uid:", user.uid);
        return showGuard("Profilo utente non trovato in Users/<uid>. Verifica che esista e che le rules permettano la lettura.");
      }

      const userData = uSnap.data() || {};
      currentAccount = { user, userData };

      setTopbarLine(user, userData);

      // Accesso distributore
      let allowed = false;
      try{
        allowed = await computeDistributorAccess(userData);
      }catch(e){
        console.error("[FTFOLOAD] computeDistributorAccess error:", e);
        return showGuard("Impossibile verificare i permessi distributore (lettura dealers/<dealerId> negata?).", e);
      }

      if (!allowed){
        return showGuard("Accesso negato: pagina riservata agli utenti distributore (isDistributorUser o dealers/<dealerId>.isDistributor).");
      }

      showApp();
      await reloadQueue();

    }catch(e){
      console.error("[FTFOLOAD] boot error:", e);
      showGuard("Errore di inizializzazione pagina (molto probabile: rules Firestore su Users/dealers).", e);
    }
  });
</script>

<script src="ft-topbar.js?v=4"></script>
</body>
</html>
