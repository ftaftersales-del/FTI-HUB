<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FTFOLOAD</title>

  <link rel="stylesheet" href="ftstyle.css?v=6"/>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- XLSX export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* ===============================
       FTFOLOAD - Page glue (v3.2)
       - filtro: ClaimCard.status == "In Valutazione FO"
       - filtro: Claim.sinistro === null
       - export XLSX reale
       =============================== */

    .fo-wrap{
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px;
      min-height: calc(100vh - 58px);
    }

    .fo-layout{
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 1050px){
      .fo-layout{ grid-template-columns: 1fr; }
    }

    .fo-left{
      display: grid;
      gap: 12px;
      position: sticky;
      top: 74px;
      align-self: start;
      z-index: 2;
    }
    @media (max-width: 1050px){
      .fo-left{ position: relative; top: auto; }
    }

    .fo-h1{ margin:0; font-size:18px; line-height:1.15; }
    .fo-sub{ margin:6px 0 0; font-size:13px; color:var(--muted); }

    .fo-guard{
      display:none;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffd0d0;
      background: #fff1f1;
      color: #8a1f1f;
      font-size: 13px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
    }
    .fo-guard b{ color:#6f1414; }
    .fo-guard .small{ margin-top:6px; font-size:12px; opacity:.9; white-space:pre-wrap; }

    .fo-pad-title{ margin:0 0 8px; font-size:14px; font-weight:800; }
    .fo-pad-sub{ margin:0 0 10px; font-size:12px; color:var(--muted); }

    .fo-grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .fo-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .fo-chiprow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      font-size:12px; color:var(--text);
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
      user-select:none; white-space:nowrap;
    }
    .chip .n{ font-weight:900; }

    .fo-kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }
    .fo-kv b{ color:var(--text); }

    .fo-progress{
      display:none;
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }

    .fo-note{ margin-top:10px; font-size:12px; color:var(--muted); }
    .fo-small{ font-size:12px; color:var(--muted); }

    .fo-check{
      display:flex; gap:8px; align-items:center;
      font-size:12px; color:var(--text);
      user-select:none; margin-top:8px;
    }
    .fo-check input{ transform: translateY(1px); }

    .fo-search{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap; margin-top:10px;
    }
    .fo-search input{
      flex:1;
      min-width:280px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      padding:0 12px;
      outline:none;
      background:#fff;
    }

    .fo-tablewrap{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.86);
    }
    table.fo-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .fo-table thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.2px;
      color:var(--muted);
      padding:10px 12px;
      background: rgba(255,255,255,.92);
      border-bottom:1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }
    .fo-table tbody td{
      padding:10px 12px;
      border-bottom: 1px solid rgba(230,232,240,.7);
      vertical-align: middle;
    }
    .fo-table tbody tr:hover{ background: rgba(0,94,220,0.04); }

    .fo-empty{ padding:18px; color:var(--muted); font-size:13px; }

    .fo-row-main{ display:grid; gap:2px; }
    .fo-wcode{ font-weight:900; letter-spacing:.2px; }
    .fo-mini{ color:var(--muted); font-size:12px; }

    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.9);
      color:var(--text);
      white-space: nowrap;
    }
    .pill-ok{
      background: var(--ok-bg);
      border-color: var(--ok-bd);
      color: var(--ok-tx);
    }
    .pill-warn{
      background: #fff7e8;
      border-color: #f2d7a8;
      color: #8a5a00;
    }
  </style>
</head>

<body class="ft-page has-topbar" id="page-ftfoload">

  <!-- TOPBAR HUB -->
  <div class="ft-topbar">
    <div class="ft-topbar__inner">
      <div class="ft-topbar__left">
        <div class="ft-topbar__brand">FTI-HUB</div>
        <div class="ft-topbar__subtitle">FTFOLOAD • batch FO</div>
      </div>

      <div class="ft-topbar__center">
        <div class="ft-topbar__userinfo" id="topbar-userline">Accesso in corso…</div>
      </div>

      <div class="ft-topbar__right">
        <button class="btn btn-small" onclick="goHome()">Home</button>
        <button class="btn btn-primary btn-small" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div class="fo-wrap">
    <div id="fo-guard" class="fo-guard">
      <b>Accesso non disponibile.</b>
      <div class="small" id="fo-guard-msg"></div>
    </div>

    <div id="fo-app" class="fo-layout" style="display:none;">

      <!-- LEFT -->
      <div class="fo-left">

        <div class="card pad">
          <h1 class="fo-h1">Queue FO</h1>
          <p class="fo-sub">
            ClaimCards con <b>status = "In Valutazione FO"</b> e Claims con <b>sinistro = NULL</b>.
          </p>

          <div class="fo-chiprow">
            <div class="chip"><span class="n" id="cnt-total">0</span> righe</div>
            <div class="chip"><span class="n" id="cnt-filtered">0</span> filtrate</div>
            <div class="chip"><span class="n" id="cnt-selected">0</span> selezionate</div>
          </div>

          <div class="fo-kv">
            <div>Stato</div><div><b>In Valutazione FO</b></div>
            <div>Campo</div><div><b>Claims/Rxxx.sinistro</b></div>
          </div>

          <div class="fo-progress" id="load-progress">Caricamento…</div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Selezione pratiche</div>
          <div class="fo-pad-sub">Gestisci rapidamente il batch di lavoro.</div>

          <div class="fo-grid2">
            <button class="btn btn-small" onclick="selectAllFiltered()">Seleziona filtrate</button>
            <button class="btn btn-small" onclick="clearSelection()">Deseleziona</button>
          </div>

          <div class="fo-row" style="margin-top:8px;">
            <button class="btn btn-small" onclick="invertSelection()">Inverti selezione</button>
            <button class="btn btn-small" onclick="reloadQueue()">Ricarica</button>
          </div>

          <div class="fo-note">
            Suggerimento: batch da <b>30–50</b> righe (W+R).
          </div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Export Excel (Selenium)</div>
          <div class="fo-pad-sub">Genera XLSX strutturato per inserimento seriale via Selenium.</div>

          <div class="fo-grid2">
            <button class="btn btn-primary btn-small" onclick="exportExcelSelected()">Export selezionate</button>
            <button class="btn btn-small" onclick="exportExcelFiltered()">Export filtrate</button>
          </div>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-notes" checked />
            Includi Notes
          </label>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-att" checked />
            Includi Attachments (url/path)
          </label>

          <label class="fo-check">
            <input type="checkbox" id="opt-include-items" checked />
            Includi ricambi/manodopera (parts/labour)
          </label>

          <div class="fo-small" style="margin-top:8px;">
            Sheet <b>CLAIMS</b> + opzionali <b>NOTES</b> e <b>ATTACHMENTS</b>.
          </div>
        </div>

        <div class="card pad">
          <div class="fo-pad-title">Power Automate</div>
          <div class="fo-pad-sub">Avvio processo automatico (in sviluppo).</div>

          <button class="btn btn-small" onclick="notReadyPA()">Avvia flusso (coming soon)</button>

          <div class="fo-note">
            Qui collegheremo una Flow che prende il batch e gestisce step/notify.
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="fo-right">
        <div class="card pad">

          <div class="fo-row" style="justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div class="fo-pad-title" style="margin:0;">Elenco claims da inserire</div>
              <div class="fo-pad-sub" style="margin:4px 0 0;">
                Seleziona righe (W+R). Dopo upload, Selenium valorizza <b>Claims/Rxxx.sinistro</b>.
              </div>
            </div>

            <div class="fo-row">
              <span class="pill pill-warn">Queue FO</span>
              <span class="pill">Solo distributore</span>
            </div>
          </div>

          <div class="fo-search">
            <input id="q" type="text" placeholder="Cerca (W-code / Rxxx / VIN / dealer / customer / testo…)" oninput="applyFilter()" />
          </div>

          <div class="fo-tablewrap">
            <table class="fo-table" aria-label="Queue FO">
              <thead>
                <tr>
                  <th style="width:44px;">Sel</th>
                  <th>Pratica</th>
                  <th style="width:140px;">Dealer</th>
                  <th style="width:190px;">VIN</th>
                  <th style="width:220px;">Cliente</th>
                  <th style="width:120px;">Apertura</th>
                  <th style="width:190px;">Stato</th>
                  <th style="width:160px;">Sinistro (claim)</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>

            <div id="empty" class="fo-empty" style="display:none;">
              Nessuna riga trovata con i filtri attuali.
            </div>
          </div>

          <div class="fo-note">
            “Sinistro = <b>NULL</b>” = pronto per inserimento FO. Il numero FO va scritto in <b>Claims/Rxxx.sinistro</b>.
          </div>

        </div>
      </div>

    </div>
  </div>

<script>
  // ===============================
  // BOOT / GLOBALS
  // ===============================
  const AUTH = (window.auth && typeof window.auth.onAuthStateChanged === "function")
    ? window.auth
    : firebase.auth();

  const DB = (window.db && typeof window.db.collection === "function")
    ? window.db
    : firebase.firestore();

  console.info("[FTFOLOAD] boot: using globals?", {authGlobal: !!window.auth, dbGlobal: !!window.db});

  let currentAccount = null;

  let allItems = [];
  let filteredItems = [];
  let selectedSet = new Set(); // key = `${wcode}::${rcode}`
  const detailCache = new Map(); // key => {notes[], atts[], builtAt}

  const MAX_PARTS = 10;
  const MAX_LABOUR = 10;

  function showGuard(message, errorObj){
    const g = document.getElementById("fo-guard");
    const m = document.getElementById("fo-guard-msg");
    g.style.display = "block";
    document.getElementById("fo-app").style.display = "none";

    let txt = message || "Non autorizzato o errore di accesso.";
    if (errorObj){
      const em = (errorObj?.message || errorObj || "").toString();
      txt += "\n\nDettaglio:\n" + em;
    }
    m.textContent = txt;
  }

  function showApp(){
    document.getElementById("fo-guard").style.display = "none";
    document.getElementById("fo-app").style.display = "grid";
  }

  function setTopbarLine(user, userData){
    const dealer = userData?.dealerId || userData?.dealerID || userData?.DealerID || "-";
    const role = userData?.role || "User";
    const el = document.getElementById("topbar-userline");
    if (el) el.textContent = `${dealer} • ${role} • ${user.email}`;
  }

  async function computeDistributorAccess(userData){
    const direct = (userData?.isDistributorUser === true || userData?.IsDistributorUser === true);
    if (direct) return true;

    const dealerId = userData?.dealerId || userData?.dealerID || userData?.DealerID || null;
    if (!dealerId) return false;

    const dSnap = await DB.collection("dealers").doc(dealerId).get();
    if (!dSnap.exists) return false;
    const d = dSnap.data() || {};
    return (d.isDistributor === true || d.IsDistributor === true);
  }

  function setProgress(txt){
    const el = document.getElementById("load-progress");
    if (!el) return;
    if (!txt){
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = txt;
  }

  function updateCounters(){
    document.getElementById("cnt-total").textContent = String(allItems.length);
    document.getElementById("cnt-filtered").textContent = String(filteredItems.length);
    document.getElementById("cnt-selected").textContent = String(selectedSet.size);
  }

  function keyOf(it){ return `${it.wcode}::${it.rcode}`; }

  function clearSelection(){ selectedSet.clear(); renderTable(); }
  function selectAllFiltered(){ filteredItems.forEach(it => selectedSet.add(keyOf(it))); renderTable(); }
  function invertSelection(){
    const next = new Set(selectedSet);
    filteredItems.forEach(it => {
      const k = keyOf(it);
      if (next.has(k)) next.delete(k); else next.add(k);
    });
    selectedSet = next;
    renderTable();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toggleSelect(key, isOn){
    if (isOn) selectedSet.add(key);
    else selectedSet.delete(key);
    updateCounters();
  }

  // === CORREZIONE RICHIESTA: sinistro deve essere SOLO null ===
  function isSinistroNull(v){
    return v === null; // SOLO null (undefined o "" NON passano)
  }

  function rowHTML(item){
    const k = keyOf(item);
    const checked = selectedSet.has(k) ? "checked" : "";

    const sinistroIsNull = isSinistroNull(item.sinistro);
    const sinBadge = sinistroIsNull
      ? `<span class="pill pill-ok">NULL</span>`
      : `<span class="pill">${escapeHtml(String(item.sinistro ?? ""))}</span>`;

    return `
      <tr>
        <td><input type="checkbox" ${checked} onchange="toggleSelect('${escapeHtml(k)}', this.checked)"></td>
        <td>
          <div class="fo-row-main">
            <div class="fo-wcode">${escapeHtml(item.wcode)} <span class="pill" style="margin-left:6px;">${escapeHtml(item.rcode)}</span></div>
            <div class="fo-mini">${escapeHtml(item.claimType || "")} • ${escapeHtml(item.claimStatus || "")}</div>
          </div>
        </td>
        <td>${escapeHtml(item.openDealer || "-")}</td>
        <td>${escapeHtml(item.vin || "-")}</td>
        <td>${escapeHtml(item.customer || "-")}</td>
        <td>${escapeHtml(item.openDate || "-")}</td>
        <td><span class="pill pill-warn">${escapeHtml(item.statusCard || "-")}</span></td>
        <td>${sinBadge}</td>
      </tr>
    `;
  }

  function renderTable(){
    const tbody = document.getElementById("rows");
    const empty = document.getElementById("empty");
    tbody.innerHTML = "";

    if (!filteredItems.length){
      empty.style.display = "block";
      updateCounters();
      return;
    }
    empty.style.display = "none";
    tbody.innerHTML = filteredItems.map(rowHTML).join("");
    updateCounters();
  }

  function applyFilter(){
    const q = (document.getElementById("q").value || "").trim().toLowerCase();
    if (!q){
      filteredItems = [...allItems];
      renderTable();
      return;
    }
    filteredItems = allItems.filter(it => {
      const hay = [
        it.wcode, it.rcode, it.vin, it.openDealer, it.customer,
        it.statusCard, it.claimType, it.claimStatus,
        (it.sinistro === null ? "null" : it.sinistro)
      ].filter(v => v !== undefined && v !== null && String(v).length).join(" ").toLowerCase();
      return hay.includes(q);
    });
    renderTable();
  }

  // ===============================
  // LOAD QUEUE
  // ===============================
  async function reloadQueue(){
    setProgress("Caricamento queue…");
    detailCache.clear();
    selectedSet.clear();
    allItems = [];
    filteredItems = [];
    renderTable();

    try{
      // CORREZIONE: stringa esatta
      const ccSnap = await DB.collection("ClaimCards")
        .where("status", "==", "In Valutazione FO")
        .get();

      const claimCards = ccSnap.docs.map(d => ({ id: d.id, ref: d.ref, data: d.data() || {} }));
      console.info("[FTFOLOAD] ClaimCards found:", claimCards.length);

      setProgress(`Trovate ${claimCards.length} claim card. Lettura claims…`);

      const rows = [];
      const batchSize = 10;

      for (let i=0; i<claimCards.length; i+=batchSize){
        const slice = claimCards.slice(i, i+batchSize);

        await Promise.all(slice.map(async cc => {
          const ccData = cc.data;
          const wcode = ccData.code || cc.id;

          const statusCard = ccData.status || "";
          const openDealer = ccData.openDealer || "";
          const openDate = ccData.openDate || "";
          const customer = (ccData.vehicle && ccData.vehicle.customer) ? ccData.vehicle.customer : "";
          const vin = (ccData.vehicle && ccData.vehicle.vin) ? ccData.vehicle.vin : "";

          const claimsSnap = await cc.ref.collection("Claims").get();
          claimsSnap.forEach(clDoc => {
            const cd = clDoc.data() || {};
            const rcode = clDoc.id;

            // CORREZIONE: sinistro deve essere SOLO null
            const sinistro = cd.sinistro;
            if (!isSinistroNull(sinistro)) return;

            rows.push({
              wcode, rcode,
              statusCard, openDealer, openDate, customer, vin,
              claimType: cd.claimType || cd.claimCardType || "",
              claimStatus: cd.status || "",
              sinistro: sinistro, // qui è null
              _ccRef: cc.ref,
              _claimRef: clDoc.ref,
              _ccData: ccData,
              _claimData: cd
            });
          });
        }));

        setProgress(`Caricamento… ${Math.min(i+batchSize, claimCards.length)}/${claimCards.length} claim card analizzate…`);
      }

      rows.sort((a,b) => (a.wcode||"").localeCompare(b.wcode||"") || (a.rcode||"").localeCompare(b.rcode||""));

      allItems = rows;
      filteredItems = [...allItems];
      setProgress(null);
      renderTable();

    }catch(e){
      console.error("[FTFOLOAD] reloadQueue error:", e);
      setProgress(null);
      showGuard("Errore caricamento queue (permessi/connessione).", e);
    }
  }

  // ===============================
  // EXPORT XLSX (REALE)
  // ===============================
  function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
  function safeNum(v){ return (typeof v === "number" && isFinite(v)) ? v : (v === null || v === undefined || v === "" ? "" : Number(v)); }

  function fmtDateAny(v){
    // support stringhe come "2025-12-26" oppure timestamp Firestore
    try{
      if (!v) return "";
      if (typeof v === "string") return v;
      if (v.toDate && typeof v.toDate === "function") return v.toDate().toISOString();
      return safeStr(v);
    }catch(e){
      return safeStr(v);
    }
  }

  function getGaranziaBlock(claimData){
    // Nel tuo esempio i campi principali stanno dentro claimData.garanzia (map)
    if (claimData && claimData.garanzia && typeof claimData.garanzia === "object") return claimData.garanzia;
    return claimData || {};
  }

  function buildClaimRow(it, includeItems){
    const cc = it._ccData || {};
    const cl = it._claimData || {};
    const g = getGaranziaBlock(cl);

    const base = {
      WCODE: safeStr(it.wcode),
      RCODE: safeStr(it.rcode),

      CLAIMCARD_STATUS: safeStr(it.statusCard),
      CLAIM_STATUS: safeStr(it.claimStatus),
      CLAIM_TYPE: safeStr(it.claimType),

      DEALER_OPEN: safeStr(it.openDealer),
      OPEN_DATE: safeStr(it.openDate),
      ORDER_DATE: safeStr(cc.orderDate),
      ORDER_NUMBER: safeStr(cc.orderNumber),

      CUSTOMER: safeStr(it.customer),
      VIN: safeStr(it.vin),
      KM: safeNum(cc.km),
      ENGINE_HOURS: safeNum(cc.engineHours),

      CCC_ID: safeStr(g?.ccc?.id),
      CCC_TEXT: safeStr(g?.ccc?.text),
      COMMENTO_TECNICO: safeStr(g?.commentoTecnico),
      SYMPTOM_ID: safeStr(g?.symptom?.id),
      SYMPTOM_LABEL: safeStr(g?.symptom?.label),

      TOTALE_RICAMBI: safeNum(g?.totaleRicambi),
      TOTALE_MANODOPERA: safeNum(g?.totaleManodopera),
      LABOUR_RATE_STD: safeNum(g?.labourRateStd),

      SINISTRO_DB: "", // deve essere null in DB, ma Excel vuole cella vuota
      FO_SINISTRO_RESULT: "", // compilato da Selenium
      WRITEBACK_OK: "",       // compilato da Selenium
      WRITEBACK_AT: "",       // compilato da Selenium

      CC_REF_PATH: safeStr(it._ccRef?.path),
      CLAIM_REF_PATH: safeStr(it._claimRef?.path)
    };

    if (!includeItems) return base;

    // Flatten parts/labour
    const parts = Array.isArray(g?.parts) ? g.parts : [];
    const labour = Array.isArray(g?.labour) ? g.labour : [];

    for (let i=0; i<MAX_PARTS; i++){
      const p = parts[i] || {};
      const n = i+1;
      base[`PART_${n}_CODICE`] = safeStr(p.codice);
      base[`PART_${n}_CODICE_ESTESO`] = safeStr(p.codice_esteso);
      base[`PART_${n}_DESCRIZIONE`] = safeStr(p.descrizione);
      base[`PART_${n}_QTY`] = safeNum(p.quantita);
      base[`PART_${n}_TOTALE`] = safeNum(p.totale);
      base[`PART_${n}_RIMBORSO`] = safeNum(p.rimborso_garanzia);
    }

    for (let i=0; i<MAX_LABOUR; i++){
      const l = labour[i] || {};
      const n = i+1;
      base[`LAB_${n}_CODICE`] = safeStr(l.codice_labour);
      base[`LAB_${n}_DESCRIZIONE`] = safeStr(l.descrizione_tradotta);
      base[`LAB_${n}_QTY`] = safeNum(l.quantita);
      base[`LAB_${n}_TOTALE`] = safeNum(l.totale);
    }

    return base;
  }

  async function fetchNotesAndAttachments(it, includeNotes, includeAtt){
    const k = keyOf(it);
    const cached = detailCache.get(k);
    if (cached) return cached;

    const res = { notes: [], atts: [] };

    const tasks = [];

    if (includeNotes){
      tasks.push(
        it._claimRef.collection("Notes").get().then(snap => {
          snap.forEach(d => {
            const nd = d.data() || {};
            res.notes.push({
              WCODE: it.wcode,
              RCODE: it.rcode,
              NOTE_ID: d.id,
              CREATED_AT: fmtDateAny(nd.createdAt),
              AUTHOR_DEALER: safeStr(nd.authorDealerId),
              AUTHOR_NAME: safeStr(nd.authorName),
              TEXT: safeStr(nd.text)
            });
          });
        })
      );
    }

    if (includeAtt){
      tasks.push(
        it._claimRef.collection("Attachments").get().then(snap => {
          snap.forEach(d => {
            const ad = d.data() || {};
            res.atts.push({
              WCODE: it.wcode,
              RCODE: it.rcode,
              ATT_ID: d.id,
              CREATED_AT: fmtDateAny(ad.createdAt),
              AUTHOR_DEALER: safeStr(ad.authorDealerId),
              AUTHOR_NAME: safeStr(ad.authorName),
              NAME: safeStr(ad.name),
              PATH: safeStr(ad.path),
              URL: safeStr(ad.url)
            });
          });
        })
      );
    }

    await Promise.all(tasks);
    detailCache.set(k, res);
    return res;
  }

  async function exportExcelFor(items, modeLabel){
    if (!items || !items.length){
      alert("Nessuna riga da esportare.");
      return;
    }

    const includeNotes = document.getElementById("opt-include-notes").checked;
    const includeAtt = document.getElementById("opt-include-att").checked;
    const includeItems = document.getElementById("opt-include-items").checked;

    setProgress(`Export XLSX… preparazione (${items.length} righe)`);
    try{
      // 1) CLAIMS rows (flat)
      const claimsRows = items.map(it => buildClaimRow(it, includeItems));

      // 2) optional sheets
      const notesRows = [];
      const attRows = [];

      if (includeNotes || includeAtt){
        // throttling leggero (batch 10)
        const batchSize = 10;
        for (let i=0; i<items.length; i+=batchSize){
          const slice = items.slice(i, i+batchSize);
          setProgress(`Export XLSX… lettura Notes/Attachments ${Math.min(i+batchSize, items.length)}/${items.length}`);

          const details = await Promise.all(slice.map(it => fetchNotesAndAttachments(it, includeNotes, includeAtt)));
          details.forEach(d => {
            if (includeNotes) notesRows.push(...(d.notes || []));
            if (includeAtt) attRows.push(...(d.atts || []));
          });
        }
      }

      // 3) create workbook
      const wb = XLSX.utils.book_new();

      const wsClaims = XLSX.utils.json_to_sheet(claimsRows, { skipHeader: false });
      XLSX.utils.book_append_sheet(wb, wsClaims, "CLAIMS");

      if (includeNotes){
        const wsNotes = XLSX.utils.json_to_sheet(notesRows, { skipHeader: false });
        XLSX.utils.book_append_sheet(wb, wsNotes, "NOTES");
      }
      if (includeAtt){
        const wsAtt = XLSX.utils.json_to_sheet(attRows, { skipHeader: false });
        XLSX.utils.book_append_sheet(wb, wsAtt, "ATTACHMENTS");
      }

      // 4) filename
      const now = new Date();
      const pad2 = (n)=>String(n).padStart(2,"0");
      const stamp = `${now.getFullYear()}${pad2(now.getMonth()+1)}${pad2(now.getDate())}_${pad2(now.getHours())}${pad2(now.getMinutes())}`;
      const fname = `FO_BATCH_${modeLabel}_${stamp}_${items.length}.xlsx`;

      setProgress("Export XLSX… download file");
      XLSX.writeFile(wb, fname);

      setProgress(null);

    }catch(e){
      console.error("[FTFOLOAD] export error:", e);
      setProgress(null);
      alert("Errore export XLSX: " + (e?.message || e));
    }
  }

  function exportExcelSelected(){
    const list = allItems.filter(it => selectedSet.has(keyOf(it)));
    exportExcelFor(list, "SELECTED");
  }

  function exportExcelFiltered(){
    exportExcelFor([...filteredItems], "FILTERED");
  }

  function notReadyPA(){ alert("Funzionalità Power Automate non ancora implementata."); }

  function goHome(){ location.href="FTHUBAS.html"; }
  function logout(){ AUTH.signOut().then(()=>location.href="index.html"); }

  // ===============================
  // AUTH BOOT
  // ===============================
  AUTH.onAuthStateChanged(async (user) => {
    try{
      console.info("[FTFOLOAD] auth state changed:", !!user);

      if (!user){
        return location.href = "index.html";
      }

      // Users/<uid>
      const uSnap = await DB.collection("Users").doc(user.uid).get();
      if (!uSnap.exists){
        console.warn("[FTFOLOAD] Users doc missing for uid:", user.uid);
        return showGuard("Profilo utente non trovato in Users/<uid>. Verifica che esista e che le rules permettano la lettura.");
      }

      const userData = uSnap.data() || {};
      currentAccount = { user, userData };

      setTopbarLine(user, userData);

      // Accesso distributore
      let allowed = false;
      try{
        allowed = await computeDistributorAccess(userData);
      }catch(e){
        console.error("[FTFOLOAD] computeDistributorAccess error:", e);
        return showGuard("Impossibile verificare i permessi distributore (lettura dealers/<dealerId> negata?).", e);
      }

      if (!allowed){
        return showGuard("Accesso negato: pagina riservata agli utenti distributore (isDistributorUser o dealers/<dealerId>.isDistributor).");
      }

      showApp();
      await reloadQueue();

    }catch(e){
      console.error("[FTFOLOAD] boot error:", e);
      showGuard("Errore di inizializzazione pagina (molto probabile: rules Firestore su Users/dealers).", e);
    }
  });
</script>

<script src="ft-topbar.js?v=4"></script>
</body>
</html>
